<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OdfDrawImage.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ODFDOM</a> &gt; <a href="index.source.html" class="el_package">org.odftoolkit.odfdom.incubator.doc.draw</a> &gt; <span class="el_source">OdfDrawImage.java</span></div><h1>OdfDrawImage.java</h1><pre class="source lang-java linenums">/**
 * **********************************************************************
 *
 * &lt;p&gt;DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER
 *
 * &lt;p&gt;Copyright 2008, 2010 Oracle and/or its affiliates. All rights reserved.
 *
 * &lt;p&gt;Use is subject to license terms.
 *
 * &lt;p&gt;Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License at
 * http://www.apache.org/licenses/LICENSE-2.0. You can also obtain a copy of the License at
 * http://odftoolkit.org/docs/license.txt
 *
 * &lt;p&gt;Unless required by applicable law or agreed to in writing, software distributed under the
 * License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 * express or implied.
 *
 * &lt;p&gt;See the License for the specific language governing permissions and limitations under the
 * License.
 *
 * &lt;p&gt;**********************************************************************
 */
package org.odftoolkit.odfdom.incubator.doc.draw;

import java.awt.image.BufferedImage;
import java.io.InputStream;
import java.net.URI;
import java.net.URISyntaxException;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Set;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.imageio.ImageIO;
import org.odftoolkit.odfdom.dom.OdfDocumentNamespace;
import org.odftoolkit.odfdom.dom.OdfSchemaDocument;
import org.odftoolkit.odfdom.dom.element.draw.DrawFrameElement;
import org.odftoolkit.odfdom.dom.element.draw.DrawImageElement;
import org.odftoolkit.odfdom.pkg.OdfFileDom;
import org.odftoolkit.odfdom.pkg.OdfPackage;
import org.odftoolkit.odfdom.pkg.manifest.OdfFileEntry;
import org.odftoolkit.odfdom.type.AnyURI;
import org.odftoolkit.odfdom.type.Length;
import org.odftoolkit.odfdom.type.Length.Unit;
import org.w3c.dom.NodeList;

/** Convenient functionality for the parent ODF OpenDocument element */
public class OdfDrawImage extends DrawImageElement {

  private static final long serialVersionUID = 8409319888919451149L;
  private URI mImageURI;
  // OdfPackage necessary to adapt the manifest referencing the image
  private OdfPackage mOdfPackage;
  private OdfSchemaDocument mOdfSchemaDocument;
  private static final String SLASH = &quot;/&quot;;

  /**
   * Creates a new instance of this class
   *
   * @param ownerDoc The XML DOM containing the draw:image element
   */
  public OdfDrawImage(OdfFileDom ownerDoc) {
<span class="fc" id="L66">    super(ownerDoc);</span>
<span class="fc" id="L67">    mOdfSchemaDocument = (OdfSchemaDocument) ownerDoc.getDocument();</span>
<span class="fc" id="L68">    mOdfPackage = mOdfSchemaDocument.getPackage();</span>
<span class="fc" id="L69">  }</span>

  /**
   * Return the URI for this image
   *
   * @return the URI of image
   */
  public URI getImageUri() {
    try {
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">      if (mImageURI == null) {</span>
<span class="nc" id="L79">        mImageURI = new URI(AnyURI.encodePath(this.getXlinkHrefAttribute().toString()));</span>
      }
<span class="nc" id="L81">    } catch (URISyntaxException ex) {</span>
<span class="nc" id="L82">      Logger.getLogger(OdfDrawImage.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="fc" id="L83">    }</span>
<span class="fc" id="L84">    return mImageURI;</span>
  }

  /**
   * The image path will be stored as URI of the href attribute
   *
   * @param packagePath The relative path from the package root to the image
   */
  public void setImagePath(String packagePath) {
    try {
<span class="fc" id="L94">      packagePath = packagePath.replaceFirst(mOdfSchemaDocument.getDocumentPath(), &quot;&quot;);</span>
<span class="fc" id="L95">      URI uri = new URI(AnyURI.encodePath(packagePath).toString());</span>
<span class="fc" id="L96">      this.setXlinkHrefAttribute(AnyURI.decodePath(uri.toString()));</span>
<span class="fc" id="L97">      mImageURI = uri;</span>
<span class="nc" id="L98">    } catch (URISyntaxException ex) {</span>
<span class="nc" id="L99">      Logger.getLogger(OdfDrawImage.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="fc" id="L100">    }</span>
<span class="fc" id="L101">  }</span>

  /* Helper method */
  private String getPackagePath(String imageRef) {
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">    if (imageRef.contains(SLASH)) {</span>
<span class="fc" id="L106">      imageRef = imageRef.substring(imageRef.lastIndexOf(SLASH) + 1, imageRef.length());</span>
    }
<span class="fc" id="L108">    String packagePath = OdfPackage.OdfFile.IMAGE_DIRECTORY.getPath() + SLASH + imageRef;</span>
<span class="fc" id="L109">    return packagePath = mOdfSchemaDocument.getDocumentPath() + packagePath;</span>
  }

  /* Helper method */
  private void configureInsertedImage(String packagePath) throws Exception {
    // Set path to image attribute
<span class="fc" id="L115">    setImagePath(packagePath);</span>
    // Set mandatory attribute xlink:type
<span class="fc" id="L117">    setXlinkTypeAttribute(&quot;simple&quot;);</span>
    // A draw:image is always embedded in a draw:frame
<span class="fc" id="L119">    InputStream is = mOdfPackage.getInputStream(packagePath);</span>
<span class="fc" id="L120">    DrawFrameElement odfFrame = (DrawFrameElement) this.getParentNode();</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">    if (odfFrame != null) {</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">      if (!odfFrame.hasAttributeNS(OdfDocumentNamespace.SVG.getUri(), &quot;height&quot;)</span>
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">          &amp;&amp; !odfFrame.hasAttributeNS(OdfDocumentNamespace.SVG.getUri(), &quot;width&quot;)) {</span>
<span class="fc" id="L124">        BufferedImage image = ImageIO.read(is);</span>
        // some image formats like SVG might not be understood by ImageIO
<span class="fc bfc" id="L126" title="All 2 branches covered.">        if (image != null) {</span>
<span class="fc" id="L127">          int height = image.getHeight(null);</span>
<span class="fc" id="L128">          int width = image.getWidth(null);</span>
<span class="fc" id="L129">          odfFrame.setSvgHeightAttribute(</span>
<span class="fc" id="L130">              Length.mapToUnit(String.valueOf(height) + &quot;px&quot;, Unit.CENTIMETER));</span>
<span class="fc" id="L131">          odfFrame.setSvgWidthAttribute(</span>
<span class="fc" id="L132">              Length.mapToUnit(String.valueOf(width) + &quot;px&quot;, Unit.CENTIMETER));</span>
        }
      }
    }
<span class="fc" id="L136">  }</span>

  /**
   * Inserts the image file from the URI to the ODF package named similar as in the URI. The
   * manifest is adapted using the media type according to the suffix. Existing images are replaced.
   * Note: Default image seize will only be set, if the draw:image had been added to its draw:frame
   * prior.
   *
   * @param imageUri The URI of the image that will be added as stream to the package in the
   *     'Pictures/' graphic directory with the same image file name as in the URI. If the imageURI
   *     is relative first the user.dir is taken to make it absolute.
   * @return Returns the package path of the image, which was created based on the given URI.
   * @throws Exception If the image provided by the URI, could not be added as stream to the ODF
   *     package.
   */
  public String newImage(URI imageUri) throws Exception {
<span class="fc" id="L152">    String imageRef = imageUri.toString();</span>
<span class="fc" id="L153">    String mediaType = OdfFileEntry.getMediaTypeString(imageRef);</span>
<span class="fc" id="L154">    String packagePath = getPackagePath(imageRef);</span>
<span class="fc" id="L155">    mOdfPackage.insert(imageUri, packagePath, mediaType);</span>
<span class="fc" id="L156">    configureInsertedImage(packagePath);</span>
<span class="fc" id="L157">    return packagePath;</span>
  }

  /**
   * Inserts the image file from the stream to the ODF package named similar as in the provided
   * path.. The manifest is adapted using given media type. Existing images are replaced.
   *
   * @param is InputStream to be added to the ODF package
   * @param packagePath Internal path of the image in the package
   * @param mediaType The mediaType of the image. Can be obtained by the OdfFileEntry class
   *     findMediaType(String fileRef).
   * @throws Exception If the given stream could not be added to the ODF package at the packagePatch
   */
  public void newImage(InputStream is, String packagePath, String mediaType) throws Exception {
<span class="fc" id="L171">    mOdfPackage.insert(is, packagePath, mediaType);</span>
<span class="fc" id="L172">    configureInsertedImage(packagePath);</span>
<span class="fc" id="L173">  }</span>

  /**
   * Inserts the image file from the stream to the ODF package named similar as in the provided
   * path.. The manifest is adapted using given media type. Existing images are replaced.
   *
   * @param fileBytes - data of the file stream to be stored in package. If NULL a directory with
   *     the given media type will be created.
   * @param packagePath Internal path of the image in the package
   * @param mediaType The mediaType of the image. Can be obtained by the OdfFileEntry class
   *     findMediaType(String fileRef).
   * @throws Exception If the given stream could not be added to the ODF package at the packagePatch
   */
  public void newImage(byte[] fileBytes, String packagePath, String mediaType) throws Exception {
<span class="fc" id="L187">    mOdfPackage.insert(fileBytes, packagePath, mediaType);</span>
<span class="fc" id="L188">    configureInsertedImage(packagePath);</span>
<span class="fc" id="L189">  }</span>

  /**
   * The method returns the specific one or more images by image path since the image may be
   * inserted to the document several times.
   *
   * @param doc the document the image belongs to
   * @param imagePath the internal package path of the image.
   * @return an Image list that match the given image path if no images is found under the given
   *     path, return an empty list.
   */
  public static List&lt;OdfDrawImage&gt; getImageByPath(OdfSchemaDocument doc, String imagePath) {
<span class="fc" id="L201">    ArrayList&lt;OdfDrawImage&gt; imageList = new ArrayList&lt;OdfDrawImage&gt;();</span>

    try {
<span class="fc" id="L204">      NodeList imageNodes =</span>
<span class="fc" id="L205">          doc.getContentDom().getElementsByTagNameNS(OdfDocumentNamespace.DRAW.getUri(), &quot;image&quot;);</span>

<span class="fc bfc" id="L207" title="All 2 branches covered.">      for (int i = 0; i &lt; imageNodes.getLength(); i++) {</span>
<span class="fc" id="L208">        OdfDrawImage image = (OdfDrawImage) imageNodes.item(i);</span>
<span class="fc bfc" id="L209" title="All 2 branches covered.">        if (image.getXlinkHrefAttribute().equals(imagePath)) {</span>
<span class="fc" id="L210">          imageList.add(image);</span>
        }
      }
<span class="fc bfc" id="L213" title="All 2 branches covered.">      if (imageList.size() &gt; 0) {</span>
<span class="fc" id="L214">        return imageList;</span>
      }
<span class="nc" id="L216">    } catch (Exception ex) {</span>
<span class="nc" id="L217">      Logger.getLogger(OdfDrawImage.class.getName()).log(Level.SEVERE, ex.getMessage(), ex);</span>
<span class="fc" id="L218">    }</span>
<span class="fc" id="L219">    return imageList;</span>
  }

  /**
   * The method deletes one or more images from image container by image path.
   *
   * @param doc the document the image should be deleted from
   * @param imagePath the internal package path of the image.
   */
  public static void deleteImageByPath(OdfSchemaDocument doc, String imagePath) {
<span class="fc" id="L229">    List&lt;OdfDrawImage&gt; imageList = getImageByPath(doc, imagePath);</span>
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">    if (imageList != null) {</span>
<span class="fc" id="L231">      Iterator&lt;OdfDrawImage&gt; it = imageList.iterator();</span>
<span class="fc bfc" id="L232" title="All 2 branches covered.">      while (it.hasNext()) {</span>
<span class="fc" id="L233">        OdfDrawImage image = it.next();</span>
        // remove the inserted picture
<span class="fc" id="L235">        String ref = image.getXlinkHrefAttribute().toString();</span>
<span class="fc" id="L236">        doc.getPackage().remove(ref);</span>

        // remove the draw:frame element in main document
<span class="pc bpc" id="L239" title="1 of 2 branches missed.">        if (image.getParentNode() instanceof OdfDrawFrame) {</span>
<span class="fc" id="L240">          OdfDrawFrame frame = (OdfDrawFrame) image.getParentNode();</span>
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">          if (frame.getChildNodes().getLength() == 1) {</span>
<span class="fc" id="L242">            frame.getParentNode().removeChild(frame);</span>
          } else {
<span class="nc" id="L244">            image.getParentNode().removeChild(image);</span>
          }
<span class="fc" id="L246">        } else {</span>
<span class="nc" id="L247">          image.getParentNode().removeChild(image);</span>
        }

        // remove Pictures/ directory if container does not have images
<span class="fc bfc" id="L251" title="All 2 branches covered.">        if (getImageCount(doc) == 0) {</span>
<span class="fc" id="L252">          doc.getPackage().remove(OdfPackage.OdfFile.IMAGE_DIRECTORY.getPath() + SLASH);</span>
        }
<span class="fc" id="L254">      }</span>
    }
<span class="fc" id="L256">  }</span>

  /**
   * The method deletes the specified image from image container.
   *
   * @param doc the document the image should be deleted from
   * @param image the image which need to be deleted
   */
  public static void deleteImage(OdfSchemaDocument doc, OdfDrawImage image) {

    // remove the inserted picture if it does not have reference any more
<span class="fc" id="L267">    String ref = image.getXlinkHrefAttribute().toString();</span>
<span class="fc" id="L268">    List&lt;OdfDrawImage&gt; imageList = getImageByPath(doc, ref);</span>
<span class="fc bfc" id="L269" title="All 2 branches covered.">    if (imageList.size() == 1) {</span>
<span class="fc" id="L270">      doc.getPackage().remove(ref);</span>
    }

    // remove the draw:frame element in main document
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">    if (image.getParentNode() instanceof OdfDrawFrame) {</span>
<span class="fc" id="L275">      OdfDrawFrame frame = (OdfDrawFrame) image.getParentNode();</span>
<span class="pc bpc" id="L276" title="1 of 2 branches missed.">      if (frame.getChildNodes().getLength() == 1) {</span>
<span class="fc" id="L277">        frame.getParentNode().removeChild(frame);</span>
      } else {
<span class="nc" id="L279">        image.getParentNode().removeChild(image);</span>
      }
<span class="fc" id="L281">    } else {</span>
<span class="nc" id="L282">      image.getParentNode().removeChild(image);</span>
    }

    // remove Pictures/ directory if container does not have images
<span class="pc bpc" id="L286" title="1 of 2 branches missed.">    if (getImageCount(doc) == 0) {</span>
<span class="nc" id="L287">      doc.getPackage().remove(OdfPackage.OdfFile.IMAGE_DIRECTORY.getPath() + SLASH);</span>
    }
<span class="fc" id="L289">  }</span>

  /**
   * Get the count of image objects in the image container.
   *
   * @param doc the document the image should be counted from
   * @return the number of image in this document if no image is found, return zero
   */
  public static int getImageCount(OdfSchemaDocument doc) {
    try {
<span class="fc" id="L299">      NodeList imageNodes =</span>
<span class="fc" id="L300">          doc.getContentDom().getElementsByTagNameNS(OdfDocumentNamespace.DRAW.getUri(), &quot;image&quot;);</span>
<span class="fc" id="L301">      return imageNodes.getLength();</span>
<span class="nc" id="L302">    } catch (Exception ex) {</span>
<span class="nc" id="L303">      Logger.getLogger(OdfDrawImage.class.getName()).log(Level.SEVERE, ex.getMessage(), ex);</span>
    }
<span class="nc" id="L305">    return 0;</span>
  }

  /**
   * The method return the image list in the image container.
   *
   * @param doc the document the list of images should be returned from
   * @return an image list in this document if no images is found, return an empty list.
   */
  public static List&lt;OdfDrawImage&gt; getImages(OdfSchemaDocument doc) {
<span class="fc" id="L315">    ArrayList&lt;OdfDrawImage&gt; imageList = new ArrayList&lt;OdfDrawImage&gt;();</span>
    try {
<span class="fc" id="L317">      NodeList imageNodes =</span>
<span class="fc" id="L318">          doc.getContentDom().getElementsByTagNameNS(OdfDocumentNamespace.DRAW.getUri(), &quot;image&quot;);</span>
<span class="fc bfc" id="L319" title="All 2 branches covered.">      for (int i = 0; i &lt; imageNodes.getLength(); i++) {</span>
<span class="fc" id="L320">        OdfDrawImage image = (OdfDrawImage) imageNodes.item(i);</span>
<span class="fc" id="L321">        imageList.add(image);</span>
      }
<span class="nc" id="L323">    } catch (Exception ex) {</span>
<span class="nc" id="L324">      Logger.getLogger(OdfDrawImage.class.getName()).log(Level.SEVERE, ex.getMessage(), ex);</span>
<span class="fc" id="L325">    }</span>
<span class="fc" id="L326">    return imageList;</span>
  }

  /**
   * The method return the set of all the image paths.
   *
   * @param doc the document the image path set should be obtained from
   * @return an image path set in this document
   */
  public static Set&lt;String&gt; getImagePathSet(OdfSchemaDocument doc) {
<span class="fc" id="L336">    Set&lt;String&gt; paths = new HashSet&lt;String&gt;();</span>
<span class="fc" id="L337">    List&lt;OdfDrawImage&gt; imageList = getImages(doc);</span>
<span class="fc" id="L338">    Iterator&lt;OdfDrawImage&gt; it = imageList.iterator();</span>
<span class="fc bfc" id="L339" title="All 2 branches covered.">    while (it.hasNext()) {</span>
<span class="fc" id="L340">      OdfDrawImage image = it.next();</span>
<span class="fc" id="L341">      paths.add(image.getXlinkHrefAttribute().toString());</span>
<span class="fc" id="L342">    }</span>
<span class="fc" id="L343">    return paths;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>