<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JsonOperationConsumer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ODFDOM</a> &gt; <a href="index.source.html" class="el_package">org.odftoolkit.odfdom.changes</a> &gt; <span class="el_source">JsonOperationConsumer.java</span></div><h1>JsonOperationConsumer.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2012 The Apache Software Foundation.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS952&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.odftoolkit.odfdom.changes;

import static org.odftoolkit.odfdom.changes.ChangesFileSaxHandler.COMMENT_PREFIX;
import static org.odftoolkit.odfdom.changes.JsonOperationProducer.BLACK;
import static org.odftoolkit.odfdom.changes.OperationConstants.*;
import static org.odftoolkit.odfdom.changes.PageArea.FOOTER_DEFAULT;
import static org.odftoolkit.odfdom.changes.PageArea.FOOTER_EVEN;
import static org.odftoolkit.odfdom.changes.PageArea.FOOTER_FIRST;
import static org.odftoolkit.odfdom.changes.PageArea.HEADER_DEFAULT;
import static org.odftoolkit.odfdom.changes.PageArea.HEADER_EVEN;
import static org.odftoolkit.odfdom.changes.PageArea.HEADER_FIRST;

import java.io.IOException;
import java.lang.reflect.Constructor;
import java.lang.reflect.InvocationTargetException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Random;
import java.util.Set;
import java.util.logging.Level;
import java.util.logging.Logger;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;
import org.odftoolkit.odfdom.doc.OdfDocument;
import org.odftoolkit.odfdom.doc.table.OdfTable;
import org.odftoolkit.odfdom.doc.table.OdfTableRow;
import org.odftoolkit.odfdom.dom.OdfContentDom;
import org.odftoolkit.odfdom.dom.OdfDocumentNamespace;
import org.odftoolkit.odfdom.dom.OdfSchemaConstraint;
import org.odftoolkit.odfdom.dom.OdfSchemaDocument;
import org.odftoolkit.odfdom.dom.OdfStylesDom;
import org.odftoolkit.odfdom.dom.attribute.draw.DrawStyleNameAttribute;
import org.odftoolkit.odfdom.dom.attribute.style.StyleRunThroughAttribute;
import org.odftoolkit.odfdom.dom.attribute.table.TableDefaultCellStyleNameAttribute;
import org.odftoolkit.odfdom.dom.attribute.table.TableStyleNameAttribute;
import org.odftoolkit.odfdom.dom.attribute.text.TextStyleNameAttribute;
import org.odftoolkit.odfdom.dom.element.OdfStylableElement;
import org.odftoolkit.odfdom.dom.element.OdfStyleBase;
import org.odftoolkit.odfdom.dom.element.OdfStylePropertiesBase;
import org.odftoolkit.odfdom.dom.element.dc.DcCreatorElement;
import org.odftoolkit.odfdom.dom.element.dc.DcDateElement;
import org.odftoolkit.odfdom.dom.element.draw.DrawFrameElement;
import org.odftoolkit.odfdom.dom.element.draw.DrawGElement;
import org.odftoolkit.odfdom.dom.element.draw.DrawImageElement;
import org.odftoolkit.odfdom.dom.element.draw.DrawShapeElementBase;
import org.odftoolkit.odfdom.dom.element.draw.DrawTextBoxElement;
import org.odftoolkit.odfdom.dom.element.office.OfficeAnnotationElement;
import org.odftoolkit.odfdom.dom.element.office.OfficeAnnotationEndElement;
import org.odftoolkit.odfdom.dom.element.office.OfficeFontFaceDeclsElement;
import org.odftoolkit.odfdom.dom.element.style.StyleChartPropertiesElement;
import org.odftoolkit.odfdom.dom.element.style.StyleDefaultStyleElement;
import org.odftoolkit.odfdom.dom.element.style.StyleDrawingPagePropertiesElement;
import org.odftoolkit.odfdom.dom.element.style.StyleFontFaceElement;
import org.odftoolkit.odfdom.dom.element.style.StyleGraphicPropertiesElement;
import org.odftoolkit.odfdom.dom.element.style.StyleHeaderFooterPropertiesElement;
import org.odftoolkit.odfdom.dom.element.style.StyleListLevelLabelAlignmentElement;
import org.odftoolkit.odfdom.dom.element.style.StyleListLevelPropertiesElement;
import org.odftoolkit.odfdom.dom.element.style.StyleMasterPageElement;
import org.odftoolkit.odfdom.dom.element.style.StylePageLayoutPropertiesElement;
import org.odftoolkit.odfdom.dom.element.style.StyleParagraphPropertiesElement;
import org.odftoolkit.odfdom.dom.element.style.StyleRubyPropertiesElement;
import org.odftoolkit.odfdom.dom.element.style.StyleSectionPropertiesElement;
import org.odftoolkit.odfdom.dom.element.style.StyleStyleElement;
import org.odftoolkit.odfdom.dom.element.style.StyleTabStopElement;
import org.odftoolkit.odfdom.dom.element.style.StyleTabStopsElement;
import org.odftoolkit.odfdom.dom.element.style.StyleTableCellPropertiesElement;
import org.odftoolkit.odfdom.dom.element.style.StyleTableColumnPropertiesElement;
import org.odftoolkit.odfdom.dom.element.style.StyleTablePropertiesElement;
import org.odftoolkit.odfdom.dom.element.style.StyleTableRowPropertiesElement;
import org.odftoolkit.odfdom.dom.element.style.StyleTextPropertiesElement;
import org.odftoolkit.odfdom.dom.element.table.TableTableCellElement;
import org.odftoolkit.odfdom.dom.element.table.TableTableCellElementBase;
import org.odftoolkit.odfdom.dom.element.table.TableTableColumnElement;
import org.odftoolkit.odfdom.dom.element.table.TableTableElement;
import org.odftoolkit.odfdom.dom.element.table.TableTableRowElement;
import org.odftoolkit.odfdom.dom.element.text.TextHElement;
import org.odftoolkit.odfdom.dom.element.text.TextLineBreakElement;
import org.odftoolkit.odfdom.dom.element.text.TextListElement;
import org.odftoolkit.odfdom.dom.element.text.TextListHeaderElement;
import org.odftoolkit.odfdom.dom.element.text.TextListItemElement;
import org.odftoolkit.odfdom.dom.element.text.TextListLevelStyleElementBase;
import org.odftoolkit.odfdom.dom.element.text.TextListLevelStyleImageElement;
import org.odftoolkit.odfdom.dom.element.text.TextPElement;
import org.odftoolkit.odfdom.dom.element.text.TextParagraphElementBase;
import org.odftoolkit.odfdom.dom.element.text.TextSpanElement;
import org.odftoolkit.odfdom.dom.element.text.TextTabElement;
import org.odftoolkit.odfdom.dom.style.OdfStyleFamily;
import org.odftoolkit.odfdom.dom.style.props.OdfStylePropertiesSet;
import org.odftoolkit.odfdom.dom.style.props.OdfStyleProperty;
import org.odftoolkit.odfdom.incubator.doc.draw.OdfDrawImage;
import org.odftoolkit.odfdom.incubator.doc.number.OdfNumberDateStyle;
import org.odftoolkit.odfdom.incubator.doc.number.OdfNumberTimeStyle;
import org.odftoolkit.odfdom.incubator.doc.office.OdfOfficeAutomaticStyles;
import org.odftoolkit.odfdom.incubator.doc.office.OdfOfficeMasterStyles;
import org.odftoolkit.odfdom.incubator.doc.office.OdfOfficeStyles;
import org.odftoolkit.odfdom.incubator.doc.style.OdfDefaultStyle;
import org.odftoolkit.odfdom.incubator.doc.style.OdfStyle;
import org.odftoolkit.odfdom.incubator.doc.style.OdfStylePageLayout;
import org.odftoolkit.odfdom.incubator.doc.text.OdfTextListStyle;
import org.odftoolkit.odfdom.pkg.OdfElement;
import org.odftoolkit.odfdom.pkg.OdfFileDom;
import org.odftoolkit.odfdom.pkg.OdfPackage;
import org.odftoolkit.odfdom.pkg.OdfValidationException;
import org.odftoolkit.odfdom.pkg.manifest.OdfFileEntry;
import org.odftoolkit.odfdom.type.Base64Binary;
import org.odftoolkit.odfdom.type.StyleName;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;
import org.w3c.dom.Text;
import org.xml.sax.ErrorHandler;
import org.xml.sax.SAXException;

/**
 * ToDo: Is it more flexible to build a different queue for OperationQueue and create an JSON
 * exporter? Can a JSONArray / JSONObject be initialized with an existing queue?
 *
 * @author svante.schubertATgmail.com
 */
<span class="nc bnc" id="L140" title="All 2 branches missed.">public class JsonOperationConsumer {</span>

<span class="nc" id="L142">  private static final Logger LOG = Logger.getLogger(JsonOperationConsumer.class.getName());</span>
<span class="nc" id="L143">  private static JSONObject CELL_WITH_BORDER_ATTRS = null;</span>
  // Mode for column insertion
  private static final String INSERT_BEFORE = &quot;before&quot;;
  private static final String INSERT_AFTER = &quot;after&quot;;
  private static final String HUNDRED_PERCENT = &quot;100%&quot;;

  static {
    try {
<span class="nc" id="L151">      CELL_WITH_BORDER_ATTRS =</span>
          new JSONObject(
              &quot;{\&quot;cell\&quot;:{\&quot;padding\&quot;:97,\&quot;borderLeft\&quot;:{\&quot;width\&quot;:2,\&quot;style\&quot;:\&quot;solid\&quot;,\&quot;color\&quot;:{\&quot;value\&quot;:\&quot;000000\&quot;,\&quot;type\&quot;:\&quot;rgb\&quot;}},\&quot;borderBottom\&quot;:{\&quot;width\&quot;:2,\&quot;style\&quot;:\&quot;solid\&quot;,\&quot;color\&quot;:{\&quot;value\&quot;:\&quot;000000\&quot;,\&quot;type\&quot;:\&quot;rgb\&quot;}},\&quot;borderTop\&quot;:{\&quot;width\&quot;:2,\&quot;style\&quot;:\&quot;solid\&quot;,\&quot;color\&quot;:{\&quot;value\&quot;:\&quot;000000\&quot;,\&quot;type\&quot;:\&quot;rgb\&quot;}},\&quot;borderRight\&quot;:{\&quot;width\&quot;:2,\&quot;style\&quot;:\&quot;solid\&quot;,\&quot;color\&quot;:{\&quot;value\&quot;:\&quot;000000\&quot;,\&quot;type\&quot;:\&quot;rgb\&quot;}}}}&quot;);
<span class="nc" id="L154">    } catch (JSONException ex) {</span>
<span class="nc" id="L155">      Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L156">    }</span>
<span class="nc" id="L157">  }</span>

  public static int applyOperations(CollabTextDocument opsDoc, JSONArray ops) throws Exception {
<span class="nc" id="L160">    LOG.log(Level.FINEST, &quot;*************** INCOMING OPERATIONS **********\n{0}&quot;, ops);</span>
<span class="nc" id="L161">    int acceptedOpCount = 0;</span>
<span class="nc" id="L162">    final OdfDocument doc = opsDoc.getDocument();</span>

    // creating styles first, triggering DOM creation
<span class="nc" id="L165">    final OdfStylesDom stylesDom = doc.getStylesDom();</span>
<span class="nc" id="L166">    final OdfContentDom contentDom = doc.getContentDom();</span>

<span class="nc" id="L168">    Component rootComponent = null;</span>
<span class="nc" id="L169">    JSONObject op = null;</span>
    try {
<span class="nc bnc" id="L171" title="All 2 branches missed.">      for (int i = 0; i &lt; ops.length(); i++) {</span>
<span class="nc" id="L172">        opsDoc.setAppliedChangesCount(i);</span>
<span class="nc" id="L173">        op = (JSONObject) ops.get(i);</span>
<span class="nc" id="L174">        String opName = op.getString(OPK_NAME);</span>
<span class="nc" id="L175">        String context = op.optString(OPK_CONTEXT);</span>
<span class="nc bnc" id="L176" title="All 4 branches missed.">        if (context == null || context.isEmpty()) {</span>
<span class="nc" id="L177">          rootComponent = doc.getRootComponent();</span>
        } else {
<span class="nc" id="L179">          String masterPageName = null;</span>
<span class="nc" id="L180">          PageArea pageArea = null;</span>
<span class="nc" id="L181">          OdfElement targetElement = null;</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">          if (context.startsWith(&quot;header&quot;)) {</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">            if (context.startsWith(HEADER_DEFAULT.getPageAreaName())) {</span>
<span class="nc" id="L184">              masterPageName =</span>
<span class="nc" id="L185">                  context.substring(</span>
<span class="nc" id="L186">                      HEADER_DEFAULT.getPageAreaName().length() + 1, context.length());</span>
<span class="nc" id="L187">              pageArea = HEADER_DEFAULT;</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">            } else if (context.startsWith(HEADER_FIRST.getPageAreaName())) {</span>
<span class="nc" id="L189">              masterPageName =</span>
<span class="nc" id="L190">                  context.substring(HEADER_FIRST.getPageAreaName().length() + 1, context.length());</span>
<span class="nc" id="L191">              pageArea = HEADER_FIRST;</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">            } else if (context.startsWith(HEADER_EVEN.getPageAreaName())) {</span>
<span class="nc" id="L193">              masterPageName =</span>
<span class="nc" id="L194">                  context.substring(HEADER_EVEN.getPageAreaName().length() + 1, context.length());</span>
<span class="nc" id="L195">              pageArea = HEADER_EVEN;</span>
            }
<span class="nc" id="L197">            targetElement = doc.getRootComponentElement(masterPageName, pageArea, false);</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">          } else if (context.startsWith(&quot;footer&quot;)) {</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">            if (context.startsWith(FOOTER_DEFAULT.getPageAreaName())) {</span>
<span class="nc" id="L200">              masterPageName =</span>
<span class="nc" id="L201">                  context.substring(</span>
<span class="nc" id="L202">                      FOOTER_DEFAULT.getPageAreaName().length() + 1, context.length());</span>
<span class="nc" id="L203">              pageArea = FOOTER_DEFAULT;</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">            } else if (context.startsWith(FOOTER_FIRST.getPageAreaName())) {</span>
<span class="nc" id="L205">              masterPageName =</span>
<span class="nc" id="L206">                  context.substring(FOOTER_FIRST.getPageAreaName().length() + 1, context.length());</span>
<span class="nc" id="L207">              pageArea = FOOTER_FIRST;</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">            } else if (context.startsWith(FOOTER_EVEN.getPageAreaName())) {</span>
<span class="nc" id="L209">              masterPageName =</span>
<span class="nc" id="L210">                  context.substring(FOOTER_EVEN.getPageAreaName().length() + 1, context.length());</span>
<span class="nc" id="L211">              pageArea = FOOTER_EVEN;</span>
            }
<span class="nc" id="L213">            targetElement = doc.getRootComponentElement(masterPageName, pageArea, false);</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">          } else if (context.startsWith(COMMENT_PREFIX)) {</span>
<span class="nc" id="L215">            doc.getRootComponent(); // force loading if not done, yet</span>
            // find comment with the given id
<span class="nc" id="L217">            targetElement =</span>
<span class="nc" id="L218">                opsDoc.getDocument().getAnnotation(context.substring(COMMENT_PREFIX.length()));</span>
          }
<span class="nc" id="L220">          rootComponent = targetElement.getComponent();</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">          if (rootComponent == null) {</span>
<span class="nc" id="L222">            rootComponent = new Component(targetElement);</span>
          }
        }
<span class="nc bnc" id="L225" title="All 2 branches missed.">        if (opName.equals(OP_PARAGRAPH)) {</span>
<span class="nc" id="L226">          acceptedOpCount++;</span>
<span class="nc" id="L227">          JSONArray start = decrementAll(op.getJSONArray(OPK_START));</span>
<span class="nc" id="L228">          JSONObject attrs = op.optJSONObject(OPK_ATTRS);</span>
<span class="nc" id="L229">          addParagraph(rootComponent, start, attrs);</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">        } else if (opName.equals(OP_DELETE)) {</span>
<span class="nc" id="L231">          acceptedOpCount++;</span>
<span class="nc" id="L232">          JSONArray start = decrementAll(op.getJSONArray(OPK_START));</span>
<span class="nc" id="L233">          JSONArray end = decrementAll(op.optJSONArray(OPK_END));</span>
<span class="nc" id="L234">          delete(rootComponent, start, end);</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">        } else if (opName.equals(OP_TEXT)) { // missing the mapping of whitespaces</span>
<span class="nc" id="L236">          acceptedOpCount++;</span>
<span class="nc" id="L237">          JSONObject attrs = op.optJSONObject(OPK_ATTRS);</span>
<span class="nc" id="L238">          JSONArray start = decrementAll(op.getJSONArray(OPK_START));</span>
<span class="nc" id="L239">          String text = op.getString(&quot;text&quot;);</span>
<span class="nc" id="L240">          JsonOperationConsumer.addText(rootComponent, start, attrs, text);</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">        } else if (opName.equals(OP_TABLE)) {</span>
<span class="nc" id="L242">          acceptedOpCount++;</span>
<span class="nc" id="L243">          JSONArray start = decrementAll(op.getJSONArray(OPK_START));</span>
<span class="nc" id="L244">          JSONObject attrs = op.optJSONObject(OPK_ATTRS);</span>
<span class="nc" id="L245">          JSONObject sizeExceeded = op.optJSONObject(&quot;sizeExceeded&quot;);</span>
<span class="nc" id="L246">          addTable(rootComponent, start, attrs, sizeExceeded, null);</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">        } else if (opName.equals(OP_ROWS)) {</span>
<span class="nc" id="L248">          acceptedOpCount++;</span>
<span class="nc" id="L249">          JSONArray start = decrementAll(op.getJSONArray(OPK_START));</span>
<span class="nc" id="L250">          JSONObject attrs = op.optJSONObject(OPK_ATTRS);</span>
<span class="nc" id="L251">          int count = op.optInt(&quot;count&quot;, 1);</span>
<span class="nc" id="L252">          boolean addDefaultCells = op.optBoolean(&quot;addDefaultCells&quot;);</span>
<span class="nc" id="L253">          int referenceRow = op.optInt(&quot;referenceRow&quot;, -1);</span>
<span class="nc" id="L254">          addRows(rootComponent, start, attrs, count, addDefaultCells, referenceRow, true);</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">        } else if (opName.equals(OP_CELLS)) {</span>
<span class="nc" id="L256">          acceptedOpCount++;</span>
<span class="nc" id="L257">          JSONArray start = decrementAll(op.getJSONArray(OPK_START));</span>
<span class="nc" id="L258">          JSONObject attrs = op.optJSONObject(OPK_ATTRS);</span>
<span class="nc" id="L259">          int count = op.optInt(&quot;count&quot;, 1);</span>
<span class="nc" id="L260">          addCells(rootComponent, start, attrs, count, null, null, true);</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">        } else if (opName.equals(OP_COLUMN)) {</span>
<span class="nc" id="L262">          acceptedOpCount++;</span>
<span class="nc" id="L263">          JSONArray start = decrementAll(op.getJSONArray(OPK_START));</span>
<span class="nc" id="L264">          Integer gridPosition = op.getInt(&quot;gridPosition&quot;);</span>
<span class="nc" id="L265">          JSONArray tableGrid = op.getJSONArray(&quot;tableGrid&quot;);</span>
<span class="nc" id="L266">          String insertMode = op.optString(&quot;insertMode&quot;);</span>
<span class="nc" id="L267">          addColumns(rootComponent, start, tableGrid, gridPosition, insertMode);</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">        } else if (opName.equals(OP_COLUMNS_DELETE)) {</span>
<span class="nc" id="L269">          acceptedOpCount++;</span>
<span class="nc" id="L270">          JSONArray start = decrementAll(op.getJSONArray(OPK_START));</span>
<span class="nc" id="L271">          Integer startGrid = op.getInt(&quot;startGrid&quot;);</span>
<span class="nc" id="L272">          Integer endGrid = op.optInt(&quot;endGrid&quot;);</span>
<span class="nc" id="L273">          deleteColumns(rootComponent, start, startGrid, endGrid);</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">        } else if (opName.equalsIgnoreCase(OP_NOTE)) {</span>
<span class="nc" id="L275">          JSONArray start = decrementAll(op.getJSONArray(OPK_START));</span>
<span class="nc" id="L276">          String id = op.getString(OPK_ID);</span>
<span class="nc" id="L277">          String author = op.optString(&quot;author&quot;);</span>
<span class="nc" id="L278">          String date = op.optString(&quot;date&quot;);</span>
<span class="nc" id="L279">          JSONObject attrs = op.optJSONObject(OPK_ATTRS);</span>
<span class="nc" id="L280">          addAnnotation(rootComponent, start, attrs, id, author, date);</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">        } else if (opName.equalsIgnoreCase(OP_NOTE_SELECTION)) {</span>
<span class="nc" id="L282">          JSONArray start = decrementAll(op.getJSONArray(OPK_START));</span>
<span class="nc" id="L283">          String id = op.getString(OPK_ID);</span>
<span class="nc" id="L284">          String type = op.optString(OPK_TYPE);</span>
<span class="nc" id="L285">          String position = op.optString(OPK_POSITION);</span>
<span class="nc" id="L286">          JSONObject attrs = op.optJSONObject(OPK_ATTRS);</span>
<span class="nc" id="L287">          addNoteSelection(rootComponent, start, type, position, attrs, id);</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">        } else if (opName.equalsIgnoreCase(OP_HEADER_FOOTER)) {</span>
          //                        String type = op.getString(OPK_TYPE);
<span class="nc" id="L290">          String id = op.getString(OPK_ID);</span>
<span class="nc" id="L291">          addDeleteHeaderFooter(doc, true, id);</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">        } else if (opName.equalsIgnoreCase(OP_HEADER_FOOTER_DELETE)) {</span>
<span class="nc" id="L293">          String id = op.getString(OPK_ID);</span>
<span class="nc" id="L294">          addDeleteHeaderFooter(doc, false, id);</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">        } else if (opName.equalsIgnoreCase(OP_DOCUMENT_LAYOUT)) {</span>
<span class="nc" id="L296">          JSONObject attrs = op.optJSONObject(OPK_ATTRS);</span>
<span class="nc" id="L297">          modifyPages(doc, attrs);</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">        } else if (opName.equals(OP_FORMAT)) {</span>
<span class="nc" id="L299">          acceptedOpCount++;</span>
<span class="nc" id="L300">          JSONObject attrs = op.optJSONObject(OPK_ATTRS);</span>
<span class="nc" id="L301">          JSONArray start = decrementAll(op.getJSONArray(OPK_START));</span>
<span class="nc" id="L302">          JSONArray end = decrementAll(op.optJSONArray(OPK_END));</span>
<span class="nc" id="L303">          JsonOperationConsumer.format(rootComponent, start, end, attrs);</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">        } else if (opName.equals(OP_PARAGRAPH_MERGE)) {</span>
<span class="nc" id="L305">          acceptedOpCount++;</span>
<span class="nc" id="L306">          JSONArray start = decrementAll(op.getJSONArray(OPK_START));</span>
<span class="nc" id="L307">          mergeParagraph(rootComponent, start);</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">        } else if (opName.equals(OP_PARAGRAPH_SPLIT)) {</span>
<span class="nc" id="L309">          acceptedOpCount++;</span>
<span class="nc" id="L310">          JSONArray start = decrementAll(op.getJSONArray(OPK_START));</span>
<span class="nc" id="L311">          splitParagraph(rootComponent, start);</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">        } else if (opName.equals(OP_STYLE)) {</span>
<span class="nc" id="L313">          acceptedOpCount++;</span>
<span class="nc" id="L314">          String type = op.getString(OPK_TYPE);</span>
<span class="nc" id="L315">          String styleId = op.getString(OPK_STYLE_ID);</span>
<span class="nc" id="L316">          String styleName = op.optString(&quot;styleName&quot;);</span>
<span class="nc" id="L317">          JSONObject attrs = op.optJSONObject(OPK_ATTRS);</span>
<span class="nc" id="L318">          String parent = op.optString(&quot;parent&quot;);</span>
<span class="nc" id="L319">          Boolean hidden = op.optBoolean(&quot;hidden&quot;);</span>
<span class="nc" id="L320">          Boolean custom = op.optBoolean(&quot;custom&quot;);</span>
<span class="nc" id="L321">          addStyles(doc, type, styleId, styleName, attrs, parent, hidden, custom);</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">        } else if (opName.equals(OP_STYLE_CHANGE)) {</span>
<span class="nc" id="L323">          acceptedOpCount++;</span>
<span class="nc" id="L324">          String type = op.getString(OPK_TYPE);</span>
<span class="nc" id="L325">          String styleId = op.getString(OPK_STYLE_ID);</span>
<span class="nc" id="L326">          String styleName = op.optString(&quot;styleName&quot;);</span>
<span class="nc" id="L327">          JSONObject attrs = op.optJSONObject(OPK_ATTRS);</span>
<span class="nc" id="L328">          changeStyle(doc, type, styleId, styleName, attrs);</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">        } else if (opName.equals(OP_STYLE_DELETE)) {</span>
<span class="nc" id="L330">          acceptedOpCount++;</span>
<span class="nc" id="L331">          String type = op.getString(OPK_TYPE);</span>
<span class="nc" id="L332">          String styleId = op.getString(OPK_STYLE_ID);</span>
<span class="nc" id="L333">          deleteStyle(doc, styleId, type);</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">        } else if (opName.equals(OP_FONT_DECL)) {</span>
<span class="nc" id="L335">          acceptedOpCount++;</span>
<span class="nc" id="L336">          JSONObject attrs = op.getJSONObject(OPK_ATTRS);</span>
<span class="nc" id="L337">          JSONArray panose1 = attrs.optJSONArray(&quot;panose1&quot;);</span>
<span class="nc" id="L338">          String panose1Value = null;</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">          if (panose1 != null) {</span>
<span class="nc" id="L340">            panose1Value = panose1.toString();</span>
          }
<span class="nc" id="L342">          String fontName = op.getString(&quot;fontName&quot;);</span>
<span class="nc" id="L343">          String[] altNames = (String[]) attrs.opt(&quot;altNames&quot;);</span>
<span class="nc" id="L344">          String family = attrs.optString(&quot;family&quot;);</span>
<span class="nc" id="L345">          String familyGeneric = attrs.optString(&quot;familyGeneric&quot;);</span>
<span class="nc" id="L346">          String pitch = attrs.optString(&quot;pitch&quot;);</span>
<span class="nc" id="L347">          addFontData(doc, fontName, altNames, family, familyGeneric, pitch, panose1Value);</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">        } else if (opName.equals(OP_TAB)) {</span>
<span class="nc" id="L349">          acceptedOpCount++;</span>
<span class="nc" id="L350">          JSONArray start = decrementAll(op.getJSONArray(OPK_START));</span>
<span class="nc" id="L351">          JSONObject attrs = op.optJSONObject(OPK_ATTRS);</span>
<span class="nc" id="L352">          addTab(rootComponent, start, attrs);</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">        } else if (opName.equals(OP_LINE_BREAK)) {</span>
<span class="nc" id="L354">          acceptedOpCount++;</span>
<span class="nc" id="L355">          JSONArray start = decrementAll(op.getJSONArray(OPK_START));</span>
<span class="nc" id="L356">          JSONObject attrs = op.optJSONObject(OPK_ATTRS);</span>
<span class="nc" id="L357">          addLineBreak(rootComponent, start, attrs);</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">        } else if (opName.equals(OP_DRAWING)) {</span>
<span class="nc" id="L359">          acceptedOpCount++;</span>
<span class="nc" id="L360">          JSONArray start = decrementAll(op.getJSONArray(OPK_START));</span>
<span class="nc" id="L361">          String type = op.optString(OPK_TYPE);</span>
<span class="nc" id="L362">          JSONObject attrs = op.optJSONObject(OPK_ATTRS);</span>
<span class="nc" id="L363">          addDrawing(rootComponent, start, attrs, type, opsDoc);</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">        } else if (opName.equals(OP_FIELD)) {</span>
<span class="nc" id="L365">          acceptedOpCount++;</span>
<span class="nc" id="L366">          JSONArray start = decrementAll(op.getJSONArray(OPK_START));</span>
<span class="nc" id="L367">          String representation = op.optString(&quot;representation&quot;);</span>
<span class="nc" id="L368">          String type = op.optString(OPK_TYPE);</span>
<span class="nc" id="L369">          JSONObject attrs = op.optJSONObject(OPK_ATTRS);</span>
<span class="nc" id="L370">          addField(</span>
              rootComponent,
<span class="nc" id="L372">              opsDoc.getDocument().getContentDom(),</span>
              start,
              type,
              representation,
              attrs);
<span class="nc bnc" id="L377" title="All 2 branches missed.">        } else if (opName.equals(OP_FIELD_UPDATE)) {</span>
<span class="nc" id="L378">          acceptedOpCount++;</span>
<span class="nc" id="L379">          JSONArray start = decrementAll(op.getJSONArray(OPK_START));</span>
<span class="nc" id="L380">          String representation = op.optString(&quot;representation&quot;);</span>
<span class="nc" id="L381">          String type = op.optString(OPK_TYPE);</span>
<span class="nc" id="L382">          JSONObject attrs = op.optJSONObject(OPK_ATTRS);</span>
<span class="nc" id="L383">          changeField(</span>
              rootComponent,
<span class="nc" id="L385">              opsDoc.getDocument().getContentDom(),</span>
              start,
              type,
              representation,
              attrs);
<span class="nc bnc" id="L390" title="All 2 branches missed.">        } else if (opName.equals(OP_MOVE)) {</span>
<span class="nc" id="L391">          acceptedOpCount++;</span>
<span class="nc" id="L392">          JSONArray start = decrementAll(op.getJSONArray(OPK_START));</span>
<span class="nc" id="L393">          JSONArray to = decrementAll(op.getJSONArray(&quot;to&quot;));</span>
          //	JSONArray end = decrementAll(op.optJSONArray(OPK_END));
<span class="nc" id="L395">          move(rootComponent, start, to);</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">        } else if (opName.equals(OP_LIST_STYLE)) {</span>
<span class="nc" id="L397">          acceptedOpCount++;</span>
<span class="nc" id="L398">          String listStyle = op.optString(&quot;listStyleId&quot;);</span>
<span class="nc" id="L399">          JSONObject listDefinition = op.optJSONObject(&quot;listDefinition&quot;);</span>
<span class="nc" id="L400">          addListStyle(listStyle, listDefinition, doc);</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">        } else if (opName.equals(OP_ERROR)) {</span>
<span class="nc" id="L402">          throw new Exception(&quot;ERROR_SIMULATED&quot;);</span>
        } else { // unknown operation
<span class="nc" id="L404">          LOG.log(Level.FINEST, &quot;Operation is unknown: {0}&quot;, opName);</span>
        }
      }
<span class="nc" id="L407">      opsDoc.setAppliedChangesCount(ops.length());</span>
<span class="nc" id="L408">    } catch (Exception e) {</span>
<span class="nc" id="L409">      LOG.log(</span>
          Level.SEVERE,
          &quot;An error occurred in the operation number {0}{1}&quot;,
<span class="nc" id="L412">          new Object[] {acceptedOpCount, 1});</span>
<span class="nc" id="L413">      LOG.severe(&quot;The operation was: &quot; + op);</span>
<span class="nc" id="L414">      throw e;</span>
<span class="nc" id="L415">    }</span>
<span class="nc" id="L416">    return acceptedOpCount;</span>
  }

  /**
   * For the demo document &quot;FruitDepot-SeasonalFruits.odt&quot; the tableElement looks like &lt;text:p
   * text:style-name=&quot;Text_20_body&quot;/&gt;
   *
   * @param rootComponent high level document structure
   * @param paraPos position of the paragraph starting with 0 and one over the existing is allowed
   * @throws IndexOutOfBoundsException - if index is out of range (index &lt; 0 || index &gt; size()). One
   *     over size is allowed to append a paragraph.
   */
  public static void addParagraph(Component rootComponent, JSONArray start, JSONObject attrs)
      throws IndexOutOfBoundsException {
    // Parent will not change and have to exist to insert the new component
<span class="nc" id="L431">    final Component parentComponent = rootComponent.getParentOf(start);</span>

<span class="nc bnc" id="L433" title="All 2 branches missed.">    if (parentComponent == null) {</span>
<span class="nc" id="L434">      LOG.log(</span>
          Level.SEVERE, &quot;The parent component of the table should exist at position {0}&quot;, start);
    } else {
<span class="nc" id="L437">      int newPosition = start.optInt(start.length() - 1);</span>
<span class="nc" id="L438">      addParagraph(parentComponent, newPosition, attrs);</span>
    }
<span class="nc" id="L440">  }</span>

  /**
   * For the demo document &quot;FruitDepot-SeasonalFruits.odt&quot; the tableElement looks like &lt;text:p
   * text:style-name=&quot;Text_20_body&quot;/&gt;
   *
   * @param rootComponent high level document structure
   * @param paraPos position of the paragraph starting with 0 and one over the existing is allowed
   * @throws IndexOutOfBoundsException - if index is out of range (index &lt; 0 || index &gt; size()). One
   *     over size is allowed to append a paragraph.
   */
  public static TextParagraphElementBase addParagraph(
      Component parentComponent, int newPosition, JSONObject attrs)
      throws IndexOutOfBoundsException {
    // CREATING NEW ROOT ELEMENT
<span class="nc" id="L455">    OdfFileDom xmlDoc = (OdfFileDom) parentComponent.getOwnerDocument();</span>
    // If there are any list properties there have to be a list inserted, check if preceding- &amp;
    // following-sibling is a list?
    TextParagraphElementBase paragraphBaseElement;
<span class="nc" id="L459">    JSONObject paraProps = null;</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">    if (attrs != null) {</span>
<span class="nc" id="L461">      paraProps = attrs.optJSONObject(&quot;paragraph&quot;);</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">      if (paraProps != null) {</span>
<span class="nc" id="L463">        int outlineLevel = paraProps.optInt(&quot;outlineLevel&quot;);</span>
<span class="nc bnc" id="L464" title="All 2 branches missed.">        if (outlineLevel != 0) {</span>
<span class="nc" id="L465">          paragraphBaseElement = new TextHElement(xmlDoc);</span>
<span class="nc" id="L466">          ((TextHElement) paragraphBaseElement).setTextOutlineLevelAttribute(outlineLevel);</span>
        } else {
<span class="nc" id="L468">          paragraphBaseElement = new TextPElement(xmlDoc);</span>
        }
<span class="nc" id="L470">      } else {</span>
<span class="nc" id="L471">        paragraphBaseElement = new TextPElement(xmlDoc);</span>
      }
    } else {
<span class="nc" id="L474">      paragraphBaseElement = new TextPElement(xmlDoc);</span>
    }

    // ADDING COMPONENT
<span class="nc" id="L478">    addElementAsComponent(parentComponent, paragraphBaseElement, newPosition);</span>

    // ADDING STYLES TO THE NEW ELEMENT
<span class="nc" id="L481">    StyleStyleElement autoStyle = addStyle(attrs, paragraphBaseElement, xmlDoc);</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">    if (paraProps != null) {</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">      if (paraProps.has(&quot;listLevel&quot;)) {</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">        if (paraProps.has(&quot;listStyleId&quot;)) {</span>
<span class="nc" id="L485">          String listStyleId = paraProps.optString(&quot;listStyleId&quot;);</span>
<span class="nc bnc" id="L486" title="All 4 branches missed.">          if (listStyleId != null &amp;&amp; !listStyleId.isEmpty()) {</span>
<span class="nc" id="L487">            autoStyle.setStyleListStyleNameAttribute(listStyleId);</span>
          }
        }
<span class="nc" id="L490">        int listLevel = getListLevel(paragraphBaseElement);</span>
        int newListLevel;
<span class="nc bnc" id="L492" title="All 2 branches missed.">        if (paraProps.isNull(&quot;listLevel&quot;)) {</span>
<span class="nc" id="L493">          newListLevel = -1;</span>
        } else {
<span class="nc" id="L495">          newListLevel = paraProps.optInt(&quot;listLevel&quot;, -2);</span>
          // if the list level should be unchanged
<span class="nc bnc" id="L497" title="All 2 branches missed.">          if (newListLevel == -2) {</span>
            // use the current listlevel..
<span class="nc" id="L499">            newListLevel = listLevel;</span>
          }
        }
        // we need to keep the existing top level list attributes, at least the list style
<span class="nc" id="L503">        String currentListStyleName = null;</span>
<span class="nc" id="L504">        TextListElement rootListElement = getListRootElement(paragraphBaseElement);</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">        if (rootListElement != null) {</span>
<span class="nc" id="L506">          currentListStyleName = rootListElement.getTextStyleNameAttribute();</span>
        }
<span class="nc" id="L508">        setParagraphListProperties(</span>
            paragraphBaseElement, paraProps, xmlDoc, listLevel, newListLevel, currentListStyleName);
      }
    }
<span class="nc" id="L512">    return paragraphBaseElement;</span>
  }

  public static void addTab(Component rootComponent, JSONArray start, JSONObject attrs)
      throws IndexOutOfBoundsException {
    // Parent will not change and have to exist to insert the new component
<span class="nc" id="L518">    final Component parentComponent = rootComponent.getParentOf(start);</span>

<span class="nc bnc" id="L520" title="All 2 branches missed.">    if (parentComponent == null) {</span>
<span class="nc" id="L521">      LOG.log(</span>
          Level.SEVERE, &quot;The parent component of the table should exist at position {0}&quot;, start);
    } else {
      // CREATING NEW ROOT ELEMENT
<span class="nc" id="L525">      OdfFileDom xmlDoc = (OdfFileDom) parentComponent.getOwnerDocument();</span>
<span class="nc" id="L526">      OdfElement newElement = new TextTabElement(xmlDoc);</span>
      // If there are hard coded styles on the line break, addChild them to a text:span element
      // surrounding the text:line-break
      // At all places of a text:tab a text:span as potential parentComponentElement is allowed:
      // http://docs.oasis-open.org/office/v1.2/os/OpenDocument-v1.2-os-part1.html#element-text_tab
<span class="nc bnc" id="L531" title="All 2 branches missed.">      if (attrs != null) {</span>
<span class="nc" id="L532">        TextSpanElement newSpanElement = new TextSpanElement(xmlDoc);</span>

        // ADDING STYLES TO THE NEW ELEMENT
<span class="nc" id="L535">        addStyle(attrs, newSpanElement, xmlDoc);</span>
<span class="nc" id="L536">        newSpanElement.appendChild(newElement);</span>
<span class="nc" id="L537">        newElement = newSpanElement;</span>
      }
      try {
        // ADDING COMPONENT
<span class="nc" id="L541">        addElementAsComponent(parentComponent, newElement, start.getInt(start.length() - 1));</span>
<span class="nc" id="L542">      } catch (JSONException ex) {</span>
<span class="nc" id="L543">        Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L544">      }</span>
    }
<span class="nc" id="L546">  }</span>

  public static void addLineBreak(Component rootComponent, JSONArray start, JSONObject attrs)
      throws IndexOutOfBoundsException {
    // Parent will not change and have to exist to insert the new component
<span class="nc" id="L551">    final Component parentComponent = rootComponent.getParentOf(start);</span>

<span class="nc bnc" id="L553" title="All 2 branches missed.">    if (parentComponent == null) {</span>
<span class="nc" id="L554">      LOG.log(</span>
          Level.SEVERE, &quot;The parent component of the table should exist at position {0}&quot;, start);
    } else {
      // CREATING NEW ROOT ELEMENT
<span class="nc" id="L558">      OdfFileDom xmlDoc = (OdfFileDom) parentComponent.getOwnerDocument();</span>
<span class="nc" id="L559">      OdfElement newElement = new TextLineBreakElement(xmlDoc);</span>
      // If there are hard coded styles on the line break, addChild them to a text:span element
      // surrounding the text:line-break
      // At all places of a text:line-break a text:span as potential parentComponentElement is
      // allowed:
      // http://docs.oasis-open.org/office/v1.2/os/OpenDocument-v1.2-os-part1.html#element-text_line-break
<span class="nc bnc" id="L565" title="All 2 branches missed.">      if (attrs != null) {</span>
<span class="nc" id="L566">        TextSpanElement newSpanElement = new TextSpanElement(xmlDoc);</span>

        // ADDING STYLES TO THE NEW ELEMENT
<span class="nc" id="L569">        addStyle(attrs, newSpanElement, xmlDoc);</span>
<span class="nc" id="L570">        newSpanElement.appendChild(newElement);</span>
<span class="nc" id="L571">        newElement = newSpanElement;</span>
      }
      try {
        // ADDING COMPONENT
<span class="nc" id="L575">        addElementAsComponent(parentComponent, newElement, start.getInt(start.length() - 1));</span>
<span class="nc" id="L576">      } catch (JSONException ex) {</span>
<span class="nc" id="L577">        Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L578">      }</span>
    }
<span class="nc" id="L580">  }</span>

  /**
   * At the the given newElement from the given ownerDocument the given style changes from attrs are
   * being applied. In addition automatic styles might being created, as ODF does not apply hard
   * styles directly to the element.
   *
   * @param attrs Map with style changes
   * @param newElement the element the style changes will be applied to
   * @param ownerDocument the XML file the element belongs to
   * @return the prior given newElement after all style changes had been applied.
   */
  // ToDo-Clean-Up: Move this to styleable Element
  public static StyleStyleElement addStyle(
      JSONObject attrs, OdfStylableElement newElement, OdfFileDom ownerDocument) {
<span class="nc" id="L595">    StyleStyleElement autoStyle = null;</span>
    // temporary font properties taken into adapter
<span class="nc" id="L597">    OdfDocument doc = ((OdfDocument) ownerDocument.getDocument());</span>

    // if there are style changes
<span class="nc bnc" id="L600" title="All 2 branches missed.">    if (attrs != null) {</span>
<span class="nc" id="L601">      OdfStyleFamily styleFamily = newElement.getStyleFamily();</span>
<span class="nc" id="L602">      boolean hasHardFormatting = hasHardProperties(attrs, styleFamily);</span>
      // IF THERE IS A NEW TEMPLATE STYLE
<span class="nc bnc" id="L604" title="All 4 branches missed.">      if (attrs.has(OPK_STYLE_ID) &amp;&amp; !attrs.isNull(OPK_STYLE_ID)) {</span>
        // IF ONLY TEMPLATE STYLE
<span class="nc" id="L606">        String styleName = attrs.optString(OPK_STYLE_ID);</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">        if (!hasHardFormatting) {</span>
          // Add template style, if there was no hard formatting it will be set directly, otherwise
          // the template style has to reference
<span class="nc" id="L610">          addStyleNameAttribute(newElement, styleFamily, ownerDocument, styleName);</span>
          // IF THERE ARE HARD FORMATTING STYLES AND TEMPLATE STYLES
        } else {
<span class="nc" id="L613">          autoStyle = newElement.getOrCreateUnqiueAutomaticStyle();</span>

          // adding/removing list style reference from style
<span class="nc" id="L616">          modifyListStyleName(attrs, autoStyle);</span>

          // adding the style name
<span class="nc" id="L619">          addStyleNameAttribute(</span>
<span class="nc" id="L620">              newElement, styleFamily, ownerDocument, autoStyle.getStyleNameAttribute());</span>
<span class="nc" id="L621">          autoStyle.setStyleParentStyleNameAttribute(styleName);</span>
          // APPLY HARD FORMATTING PROPERTIES OF ODF FAMILY
<span class="nc" id="L623">          mapProperties(styleFamily, attrs, autoStyle, doc);</span>
        }
<span class="nc" id="L625">      } else { // IF NO NEW TEMPLATE STYLE</span>
        // if Element has no Automatic Styles &amp;&amp; styles will not add any --&gt; skip
<span class="nc" id="L627">        String styleName = newElement.getStyleName();</span>
<span class="nc bnc" id="L628" title="All 2 branches missed.">        if (styleName != null) {</span>
<span class="nc bnc" id="L629" title="All 4 branches missed.">          if (styleName.isEmpty() &amp;&amp; !hasHardFormatting) {</span>
            // remove the invalid attribute
<span class="nc" id="L631">            newElement.removeAttributeNS(OdfDocumentNamespace.TEXT.getUri(), &quot;style-name&quot;);</span>
          } else {
            // if there are automatic styles adjust them
<span class="nc bnc" id="L634" title="All 4 branches missed.">            boolean removeTemplateStyle = attrs.has(OPK_STYLE_ID) &amp;&amp; attrs.isNull(OPK_STYLE_ID);</span>

<span class="nc bnc" id="L636" title="All 2 branches missed.">            if (newElement instanceof TableTableColumnElement) {</span>
              // if the template style is being removed
<span class="nc bnc" id="L638" title="All 2 branches missed.">              if (removeTemplateStyle) {</span>
<span class="nc" id="L639">                autoStyle = newElement.getOrCreateUnqiueAutomaticStyle();</span>
<span class="nc" id="L640">                autoStyle.removeAttributeNS(</span>
<span class="nc" id="L641">                    OdfDocumentNamespace.STYLE.getUri(), &quot;parent-style-name&quot;);</span>
              }
<span class="nc bnc" id="L643" title="All 2 branches missed.">              if (attrs.has(&quot;column&quot;)) {</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">                if (autoStyle == null) {</span>
<span class="nc" id="L645">                  autoStyle = newElement.getOrCreateUnqiueAutomaticStyle();</span>
                }
                // APPLY HARD FORMATTING PROPERTIES OF ODF FAMILY
<span class="nc" id="L648">                mapProperties(styleFamily, attrs, autoStyle, doc);</span>

                // if the template style is being removed
<span class="nc bnc" id="L651" title="All 2 branches missed.">                if (removeTemplateStyle) {</span>
<span class="nc" id="L652">                  addStyleNameAttribute(</span>
<span class="nc" id="L653">                      newElement, styleFamily, ownerDocument, autoStyle.getStyleNameAttribute());</span>
                }
              }
<span class="nc bnc" id="L656" title="All 6 branches missed.">              if (attrs.has(&quot;cell&quot;) || attrs.has(&quot;paragraph&quot;) || attrs.has(&quot;text&quot;)) {</span>
<span class="nc" id="L657">                autoStyle =</span>
<span class="nc" id="L658">                    newElement.getOrCreateUnqiueAutomaticStyle(</span>
                        Boolean.FALSE, OdfStyleFamily.TableCell);
                // APPLY HARD FORMATTING PROPERTIES OF ODF FAMILY
<span class="nc" id="L661">                mapProperties(OdfStyleFamily.TableCell, attrs, autoStyle, doc);</span>
                // default-cell-style-name
<span class="nc" id="L663">                TableDefaultCellStyleNameAttribute attr =</span>
                    new TableDefaultCellStyleNameAttribute(ownerDocument);
<span class="nc" id="L665">                newElement.setOdfAttribute(attr);</span>
<span class="nc" id="L666">                attr.setValue(autoStyle.getStyleNameAttribute());</span>
<span class="nc" id="L667">              }</span>
            } else {
<span class="nc" id="L669">              autoStyle = newElement.getOrCreateUnqiueAutomaticStyle();</span>
              // adding/removing list style reference from style
<span class="nc" id="L671">              modifyListStyleName(attrs, autoStyle);</span>

              // APPLY HARD FORMATTING PROPERTIES OF ODF FAMILY
              try {
<span class="nc" id="L675">                JSONObject paragraphAttr = null;</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">                if (newElement instanceof TextPElement</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">                    &amp;&amp; styleFamily.equals(OdfStyleFamily.Paragraph)</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">                    &amp;&amp; attrs.has(&quot;paragraph&quot;)</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">                    &amp;&amp; ((paragraphAttr = attrs.getJSONObject(&quot;paragraph&quot;)).has(&quot;pageBreakBefore&quot;)</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">                        || paragraphAttr.has(&quot;pageBreakAfter&quot;))) {</span>
                  // search for the top table element, stop at top level and at frames
<span class="nc" id="L682">                  TableTableElement tableElement = null;</span>
<span class="nc" id="L683">                  Node parent = newElement.getParentNode();</span>
<span class="nc bnc" id="L684" title="All 4 branches missed.">                  while (parent != null &amp;&amp; !(parent instanceof DrawFrameElement)) {</span>
<span class="nc bnc" id="L685" title="All 2 branches missed.">                    if (parent instanceof TableTableElement) {</span>
<span class="nc" id="L686">                      tableElement = (TableTableElement) parent;</span>
                    }
<span class="nc" id="L688">                    parent = parent.getParentNode();</span>
                  }
<span class="nc bnc" id="L690" title="All 2 branches missed.">                  if (tableElement != null) {</span>
<span class="nc" id="L691">                    OdfStyle tableStyle = tableElement.getAutomaticStyle();</span>
<span class="nc" id="L692">                    OdfStylePropertiesBase propsElement =</span>
<span class="nc" id="L693">                        tableStyle.getOrCreatePropertiesElement(</span>
                            OdfStylePropertiesSet.TableProperties);
<span class="nc" id="L695">                    JSONObject paraAttrs = attrs.getJSONObject(&quot;paragraph&quot;);</span>
<span class="nc" id="L696">                    boolean isBefore = paragraphAttr.has(&quot;pageBreakBefore&quot;);</span>
<span class="nc bnc" id="L697" title="All 2 branches missed.">                    String attrName = isBefore ? &quot;pageBreakBefore&quot; : &quot;pageBreakAfter&quot;;</span>
<span class="nc" id="L698">                    boolean breakValue =</span>
<span class="nc bnc" id="L699" title="All 4 branches missed.">                        !paraAttrs.isNull(attrName) &amp;&amp; paraAttrs.getBoolean(attrName);</span>
<span class="nc" id="L700">                    paraAttrs.remove(attrName);</span>
<span class="nc bnc" id="L701" title="All 2 branches missed.">                    if (breakValue) {</span>
<span class="nc" id="L702">                      propsElement.setAttributeNS(</span>
<span class="nc" id="L703">                          OdfDocumentNamespace.FO.getUri(),</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">                          isBefore ? &quot;fo:break-before&quot; : &quot;fo:break-after&quot;,</span>
                          &quot;page&quot;);
<span class="nc" id="L706">                      propsElement.removeAttributeNS(</span>
<span class="nc" id="L707">                          OdfDocumentNamespace.FO.getUri(),</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">                          isBefore ? &quot;break-after&quot; : &quot;break-before&quot;);</span>
                    } else {
<span class="nc" id="L710">                      propsElement.removeAttributeNS(</span>
<span class="nc" id="L711">                          OdfDocumentNamespace.FO.getUri(),</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">                          isBefore ? &quot;break-before&quot; : &quot;break-after&quot;);</span>
                    }
                  }
                }
<span class="nc" id="L716">              } catch (JSONException e) {</span>
                // no handling required
<span class="nc" id="L718">              }</span>
<span class="nc" id="L719">              mapProperties(styleFamily, attrs, autoStyle, doc);</span>
              // if the template style is being removed
<span class="nc bnc" id="L721" title="All 2 branches missed.">              if (removeTemplateStyle) {</span>
<span class="nc" id="L722">                autoStyle.removeAttributeNS(</span>
<span class="nc" id="L723">                    OdfDocumentNamespace.STYLE.getUri(), &quot;parent-style-name&quot;);</span>
<span class="nc" id="L724">                addStyleNameAttribute(</span>
<span class="nc" id="L725">                    newElement, styleFamily, ownerDocument, autoStyle.getStyleNameAttribute());</span>
              }
            }
          }
        }
      }
      // apply numberFormat - uses existing 'Number' style or create a new one
<span class="nc" id="L732">      JSONObject cellAttrs = attrs.optJSONObject(&quot;cell&quot;);</span>
<span class="nc bnc" id="L733" title="All 2 branches missed.">      if (cellAttrs != null) {</span>
<span class="nc" id="L734">        String formatCode = cellAttrs.optString(&quot;formatCode&quot;);</span>
<span class="nc bnc" id="L735" title="All 2 branches missed.">        if (!formatCode.isEmpty()) {</span>
<span class="nc" id="L736">          String dataStyleName =</span>
<span class="nc" id="L737">              MapHelper.findOrCreateDataStyle(</span>
<span class="nc" id="L738">                  formatCode, cellAttrs.optLong(&quot;formatId&quot;, -1), ownerDocument);</span>
<span class="nc" id="L739">          autoStyle.setAttributeNS(</span>
<span class="nc" id="L740">              OdfDocumentNamespace.STYLE.getUri(), &quot;style:data-style-name&quot;, dataStyleName);</span>
<span class="nc" id="L741">        } else {</span>
<span class="nc" id="L742">          autoStyle.removeAttributeNS(OdfDocumentNamespace.STYLE.getUri(), &quot;data-style-name&quot;);</span>
        }
      }
    }
<span class="nc" id="L746">    return autoStyle;</span>
  }

  /**
   * Modifying the @style:list-style-name to the style:style of (an automatic) style, when the
   * paragraph properties contain a &quot;listStyleId
   */
  public static void modifyListStyleName(JSONObject attrs, OdfStyleBase autoStyle) {

    // modifying the list style
    String listStyleName;
<span class="nc bnc" id="L757" title="All 2 branches missed.">    if (attrs.has(&quot;paragraph&quot;)) {</span>
<span class="nc" id="L758">      JSONObject paraProps = attrs.optJSONObject(&quot;paragraph&quot;);</span>
<span class="nc" id="L759">      listStyleName = paraProps.optString(&quot;listStyleId&quot;);</span>
<span class="nc bnc" id="L760" title="All 2 branches missed.">      if (listStyleName == null) {</span>
<span class="nc" id="L761">        autoStyle.removeAttributeNS(OdfDocumentNamespace.STYLE.getUri(), &quot;list-style-name&quot;);</span>
<span class="nc bnc" id="L762" title="All 2 branches missed.">      } else if (!listStyleName.isEmpty()) {</span>
<span class="nc" id="L763">        autoStyle.setAttributeNS(</span>
<span class="nc" id="L764">            OdfDocumentNamespace.STYLE.getUri(), &quot;style:list-style-name&quot;, listStyleName);</span>
      }
    }
<span class="nc" id="L767">  }</span>

  /**
   * Modifying the @style:list-style-name to the given text:list element, when the paragraph
   * properties contain a &quot;listStyleId
   */
  public static void modifyListStyleName(JSONObject attrs, TextListElement rootListElement) {
<span class="nc bnc" id="L774" title="All 2 branches missed.">    if (rootListElement != null) {</span>
      // modifying the list style
      String listStyleName;
<span class="nc bnc" id="L777" title="All 2 branches missed.">      if (attrs.has(&quot;paragraph&quot;)) {</span>
<span class="nc" id="L778">        JSONObject paraProps = attrs.optJSONObject(&quot;paragraph&quot;);</span>
<span class="nc" id="L779">        listStyleName = paraProps.optString(&quot;listStyleId&quot;);</span>
<span class="nc bnc" id="L780" title="All 2 branches missed.">        if (listStyleName == null) {</span>
<span class="nc" id="L781">          rootListElement.removeAttributeNS(OdfDocumentNamespace.TEXT.getUri(), &quot;style-name&quot;);</span>
<span class="nc bnc" id="L782" title="All 2 branches missed.">        } else if (!listStyleName.isEmpty()) {</span>
<span class="nc" id="L783">          rootListElement.setAttributeNS(</span>
<span class="nc" id="L784">              OdfDocumentNamespace.TEXT.getUri(), &quot;text:style-name&quot;, listStyleName);</span>
        }
      }
    }
<span class="nc" id="L788">  }</span>

  public static void addStyleNameAttribute(
      OdfElement newElement,
      OdfStyleFamily styleFamily,
      OdfFileDom ownerDocument,
      String styleName) {
    // Add template style, if there was no hard formatting it will be set directly, otherwise the
    // template style has to reference
<span class="nc" id="L797">    String attributeName = null;</span>
<span class="nc bnc" id="L798" title="All 4 branches missed.">    if (styleFamily.getName().equals(&quot;paragraph&quot;) || styleFamily.getName().equals(&quot;text&quot;)) {</span>
<span class="nc" id="L799">      TextStyleNameAttribute attr = new TextStyleNameAttribute(ownerDocument);</span>
<span class="nc" id="L800">      newElement.setOdfAttribute(attr);</span>
<span class="nc" id="L801">      attr.setValue(styleName);</span>
<span class="nc" id="L802">      attributeName = &quot;text:style-name&quot;;</span>
<span class="nc bnc" id="L803" title="All 2 branches missed.">    } else if (styleFamily.getName().equals(&quot;table&quot;)</span>
<span class="nc bnc" id="L804" title="All 2 branches missed.">        || styleFamily.getName().equals(&quot;table-column&quot;)</span>
<span class="nc bnc" id="L805" title="All 2 branches missed.">        || styleFamily.getName().equals(&quot;table-row&quot;)</span>
<span class="nc bnc" id="L806" title="All 2 branches missed.">        || styleFamily.getName().equals(&quot;table-cell&quot;)) {</span>
<span class="nc" id="L807">      TableStyleNameAttribute attr = new TableStyleNameAttribute(ownerDocument);</span>
<span class="nc" id="L808">      newElement.setOdfAttribute(attr);</span>
<span class="nc" id="L809">      attr.setValue(styleName);</span>
<span class="nc" id="L810">      attributeName = &quot;table:style-name&quot;;</span>
<span class="nc bnc" id="L811" title="All 2 branches missed.">    } else if (styleFamily.getName().equals(&quot;graphic&quot;)) {</span>
<span class="nc" id="L812">      DrawStyleNameAttribute attr = new DrawStyleNameAttribute(ownerDocument);</span>
<span class="nc" id="L813">      newElement.setOdfAttribute(attr);</span>
<span class="nc" id="L814">      attr.setValue(styleName);</span>
<span class="nc" id="L815">      attributeName = &quot;draw:style-name&quot;;</span>
    }
<span class="nc" id="L817">    ErrorHandler errorHandler = ownerDocument.getDocument().getPackage().getErrorHandler();</span>
<span class="nc bnc" id="L818" title="All 4 branches missed.">    if (errorHandler != null &amp;&amp; attributeName != null) {</span>
      // Is String from type NCName? == http://www.w3.org/TR/xmlschema-2/#NCName
<span class="nc bnc" id="L820" title="All 2 branches missed.">      if (!StyleName.isValid(styleName)) {</span>
        try {
<span class="nc" id="L822">          errorHandler.error(</span>
              new OdfValidationException(
                  OdfSchemaConstraint.DOCUMENT_XML_INVALID_ATTRIBUTE_VALUE,
                  styleName,
                  attributeName));
<span class="nc" id="L827">        } catch (SAXException ex) {</span>
<span class="nc" id="L828">          Logger.getLogger(StyleStyleElement.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L829">        }</span>
      }
    }
<span class="nc" id="L832">  }</span>

  /**
   * Move the pointed component to its new destination.
   *
   * @param from the origin of the component to be moved
   * @param the the new destination
   */
  public static void move(Component rootComponent, JSONArray start, JSONArray to) {
    try {
<span class="nc" id="L842">      Component parentSourceComponent = rootComponent.getParentOf(start);</span>
<span class="nc" id="L843">      OdfElement movedNode =</span>
<span class="nc" id="L844">          (OdfElement) parentSourceComponent.remove(start.getInt(start.length() - 1));</span>
<span class="nc" id="L845">      insert(rootComponent, movedNode, to);</span>
<span class="nc" id="L846">    } catch (JSONException ex) {</span>
<span class="nc" id="L847">      Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L848">    }</span>
<span class="nc" id="L849">  }</span>

  /**
   * Copy the pointed component to its new destination.
   *
   * @param from the origin of the component to be moved
   * @param the the new destination
   */
  static OdfElement copy(Component rootComponent, JSONArray start, JSONArray to) {
<span class="nc" id="L858">    Component sourceComponent = rootComponent.get(start);</span>
<span class="nc" id="L859">    OdfElement source = (OdfElement) sourceComponent.getRootElement().cloneNode(true);</span>
<span class="nc" id="L860">    insert(rootComponent, source, to);</span>
<span class="nc" id="L861">    return source;</span>
  }

  private static void insert(Component rootComponent, OdfElement rootElement, JSONArray to) {
<span class="nc bnc" id="L865" title="All 2 branches missed.">    if (rootElement != null) {</span>
      try {
<span class="nc" id="L867">        Component parentTargetComponent = rootComponent.getParentOf(to);</span>
        // Text can simply be inserted without taking any parentComponentElement cache/counting into
        // account
<span class="nc" id="L870">        parentTargetComponent.getRootElement().insert(rootElement, to.getInt(to.length() - 1));</span>
<span class="nc bnc" id="L871" title="All 2 branches missed.">        if (rootElement instanceof OdfElement) {</span>
<span class="nc" id="L872">          parentTargetComponent.addChild(to.getInt(to.length() - 1), rootElement.getComponent());</span>
        }
<span class="nc" id="L874">      } catch (JSONException ex) {</span>
<span class="nc" id="L875">        Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L876">      }</span>
    }
<span class="nc" id="L878">  }</span>

  /**
   * Deletes a component from the document.
   *
   * @param rootComponent the root of the component tree
   * @param start the position of the component to be deleted /* ToDo: Possible to join the two
   *     delete methods, this and OdfElement delete(int start, int end)??
   */
  private static void deleteComponents(Component rootComponent, JSONArray start, JSONArray end)
      throws IndexOutOfBoundsException {
<span class="nc" id="L889">    Component parentComponent = rootComponent.getParentOf(start);</span>
<span class="nc" id="L890">    OdfElement parentComponentElement = parentComponent.getRootElement();</span>

    // DELETING TEXT
<span class="nc bnc" id="L893" title="All 2 branches missed.">    if (parentComponent instanceof TextContainer) {</span>
<span class="nc" id="L894">      int pos = start.optInt(start.length() - 1);</span>
<span class="nc" id="L895">      ((TextContainer) parentComponent).removeText(pos, pos + 1);</span>
<span class="nc" id="L896">    } else {</span>
      // DELETING COMPONENT
      try {
<span class="nc" id="L899">        int startPos = start.getInt(start.length() - 1);</span>
        int endPos;
<span class="nc" id="L901">        OdfElement targetElement = null;</span>
<span class="nc" id="L902">        int deletionCount = 1;</span>
<span class="nc bnc" id="L903" title="All 2 branches missed.">        if (end != null) {</span>
<span class="nc" id="L904">          endPos = end.getInt(start.length() - 1);</span>
<span class="nc" id="L905">          deletionCount += endPos - startPos;</span>
        } else {
<span class="nc" id="L907">          endPos = startPos;</span>
        }
        // delete from the end to the start, otherwise the count would be influenced..
<span class="nc bnc" id="L910" title="All 2 branches missed.">        while (deletionCount &gt; 0) {</span>
<span class="nc" id="L911">          targetElement = (OdfElement) parentComponent.getChildNode(endPos);</span>
<span class="nc bnc" id="L912" title="All 2 branches missed.">          if (targetElement == null) {</span>
<span class="nc" id="L913">            break;</span>
          }
<span class="nc" id="L915">          int repetition = targetElement.getRepetition();</span>
<span class="nc bnc" id="L916" title="All 2 branches missed.">          if (targetElement instanceof TableTableCellElement) {</span>
<span class="nc" id="L917">            Component tableComponent = parentComponent.getParent();</span>
<span class="nc" id="L918">            TableTableElement tableElement = (TableTableElement) tableComponent.mRootElement;</span>

            // WORK AROUND for &quot;UNDO COLUMN WIDTH&quot; problem
<span class="nc bnc" id="L921" title="All 2 branches missed.">            if (tableElement.isWidthChangeRequired()) {</span>
              // INSERT COLUMN
              // Returns all TableTableColumn descendants that exist within the tableElement, even
              // within groups, columns and header elements
<span class="nc" id="L925">              OdfTable table = OdfTable.getInstance(tableElement);</span>
<span class="nc" id="L926">              table.removeColumnsByIndex(endPos, deletionCount - 1 + endPos, Boolean.TRUE);</span>
<span class="nc" id="L927">              tableElement.hasChangedWidth();</span>
            }
          }
<span class="nc bnc" id="L930" title="All 2 branches missed.">          if (repetition &gt; 1) {</span>
<span class="nc bnc" id="L931" title="All 2 branches missed.">            if (targetElement instanceof TableTableRowElement) {</span>
<span class="nc bnc" id="L932" title="All 2 branches missed.">              if (deletionCount - repetition &gt; 1) {</span>
<span class="nc" id="L933">                targetElement.removeAttributeNS(</span>
<span class="nc" id="L934">                    OdfDocumentNamespace.TABLE.getUri(), &quot;number-rows-repeated&quot;);</span>
              } else {
<span class="nc" id="L936">                targetElement.setAttributeNS(</span>
<span class="nc" id="L937">                    OdfDocumentNamespace.TABLE.getUri(),</span>
                    &quot;table:number-rows-repeated&quot;,
<span class="nc" id="L939">                    String.valueOf(repetition - deletionCount));</span>
              }
<span class="nc bnc" id="L941" title="All 2 branches missed.">            } else if (targetElement instanceof TableTableCellElement) {</span>
<span class="nc bnc" id="L942" title="All 2 branches missed.">              if (deletionCount - repetition &gt; 1) {</span>
<span class="nc" id="L943">                targetElement.removeAttributeNS(</span>
<span class="nc" id="L944">                    OdfDocumentNamespace.TABLE.getUri(), &quot;number-columns-repeated&quot;);</span>
              } else {
<span class="nc" id="L946">                targetElement.setAttributeNS(</span>
<span class="nc" id="L947">                    OdfDocumentNamespace.TABLE.getUri(),</span>
                    &quot;table:number-columns-repeated&quot;,
<span class="nc" id="L949">                    String.valueOf(repetition - deletionCount));</span>
              }
            }
          } else {
<span class="nc" id="L953">            OdfElement targetParent = (OdfElement) targetElement.getParentNode();</span>
<span class="nc bnc" id="L954" title="All 2 branches missed.">            if (targetParent.equals(parentComponentElement)) {</span>
<span class="nc" id="L955">              parentComponentElement.removeChild(targetElement);</span>
<span class="nc bnc" id="L956" title="All 2 branches missed.">            } else if (targetParent</span>
                instanceof DrawTextBoxElement) { // text box elements are no 'boilerplate'
<span class="nc" id="L958">              targetParent.removeChild(targetElement);</span>
            } else {
              // if the parentComponentElement component root element is not the
              // parentComponentElement of the child component, there have to be boilerplate
              // elements inbetween that have to take care of
              // the common use case is a paragraph within a list. &lt;text:list&gt; &lt;text:list-item&gt;
              // &lt;text:p/&gt; &lt;/text:list-item&gt;&lt; /text:list&gt;. With the last paragraph the list
              // construct is being removed!
              // -&gt; this seems to be wrong. For lists in the body it is a no op while in cells it
              // sets the cell parent component wrongly
              // parentComponentElement.setComponent(rootComponent);
<span class="nc" id="L969">              removeComponentElementAndInbetweenBoilerplate(parentComponentElement, targetElement);</span>
            }
            // already for those and in the future for all components the component removal includes
            // as well an XML removal
<span class="nc bnc" id="L973" title="All 6 branches missed.">            if (!(parentComponent instanceof Table</span>
                || parentComponent instanceof Row
                || parentComponent instanceof Cell)) {
              try {
<span class="nc" id="L977">                parentComponent.remove(start.getInt(start.length() - 1));</span>
<span class="nc" id="L978">              } catch (JSONException ex) {</span>
<span class="nc" id="L979">                Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L980">              }</span>
            }
<span class="nc" id="L982">            deletionCount--;</span>
<span class="nc" id="L983">            endPos--;</span>
          }
<span class="nc" id="L985">        }</span>
<span class="nc" id="L986">      } catch (JSONException ex) {</span>
<span class="nc" id="L987">        Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L988">      }</span>
    }
<span class="nc" id="L990">  }</span>

  /**
   * If the parent component root element is not the element parent of the child component's root
   * element, there have to be boilerplate elements in-between that might have to be deleted as
   * well, if the last sibling was deleted.
   *
   * @param componentParent The element representing the next higher component
   * @param targetElement the element to be deleted. Bottom-up will be all parents traversed and
   *     deleted in case the original element to be deleted had no other siblings being components.
   */
  private static boolean removeComponentElementAndInbetweenBoilerplate(
      OdfElement parentComponentElement, OdfElement targetElement) {
<span class="nc" id="L1003">    OdfElement targetParent = (OdfElement) targetElement.getParentNode();</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">    if (targetParent instanceof TextListItemElement) {</span>
<span class="nc" id="L1005">      OdfElement previousSibling = OdfElement.getPreviousSiblingElement(targetElement);</span>
<span class="nc bnc" id="L1006" title="All 2 branches missed.">      if (previousSibling == null) {</span>
<span class="nc" id="L1007">        OdfElement nextSibling = OdfElement.getNextSiblingElement(targetElement);</span>
<span class="nc bnc" id="L1008" title="All 2 branches missed.">        if (nextSibling != null) {</span>
          // removing the no longer desired content
<span class="nc" id="L1010">          targetParent.removeChild(targetElement);</span>

          // moving the previous list-item children to the new list-header
<span class="nc" id="L1013">          TextListHeaderElement listHeader =</span>
<span class="nc" id="L1014">              new TextListHeaderElement((OdfFileDom) targetParent.getOwnerDocument());</span>
<span class="nc" id="L1015">          targetParent.moveChildrenTo(listHeader);</span>

<span class="nc" id="L1017">          OdfElement grandParent = (OdfElement) targetParent.getParentNode();</span>
<span class="nc" id="L1018">          grandParent.replaceChild(listHeader, targetParent);</span>
<span class="nc" id="L1019">          targetParent = listHeader;</span>
<span class="nc" id="L1020">        } else {</span>
<span class="nc" id="L1021">          targetParent.removeChild(targetElement);</span>
        }
<span class="nc" id="L1023">      } else {</span>
<span class="nc" id="L1024">        targetParent.removeChild(targetElement);</span>
      }
<span class="nc" id="L1026">    } else {</span>
<span class="nc" id="L1027">      targetParent.removeChild(targetElement);</span>
    }
    // if the parent component root element is not the parent of the child component, there have to
    // be boilerplate elements inbetween that have to take care of
<span class="nc bnc" id="L1031" title="All 2 branches missed.">    return removeComponentElementAndEmptyBoilerplate(</span>
<span class="nc" id="L1032">            parentComponentElement, targetParent, targetParent.countDescendantComponents())</span>
        == 0;
  }

  /**
   * If the componentParent component root element is not the element componentParent of the child
   * component's root element, there have to be boilerplate elements in-between that might have to
   * be deleted as well, if the last sibling was deleted.
   *
   * @param componentParent The element representing the next higher component
   * @param targetElement the element to be deleted. Bottom-up will be all parents traversed and
   *     deleted in case the original element to be deleted had no other siblings being components.
   * @param descendantCount the number of descendants of the targetElement
   * @return the number of descendants of the targetParent
   */
  private static int removeComponentElementAndEmptyBoilerplate(
      OdfElement componentParent, OdfElement targetElement, int descendantCount) {
    // if there is boilerplate elements between the targetElement and the componentParent
<span class="nc" id="L1050">    OdfElement targetParent = (OdfElement) targetElement.getParentNode();</span>
    // if there is only a single element below (not being the original target)
<span class="nc bnc" id="L1052" title="All 2 branches missed.">    if (descendantCount == 0) {</span>
      // if there is still no other component, delete the boilerplate element
<span class="nc" id="L1054">      targetParent.removeChild(targetElement);</span>
    }
<span class="nc bnc" id="L1056" title="All 2 branches missed.">    if (!targetParent.equals(componentParent)) {</span>
<span class="nc" id="L1057">      removeComponentElementAndEmptyBoilerplate(</span>
<span class="nc" id="L1058">          componentParent, targetParent, targetParent.countDescendantComponents());</span>
    }
<span class="nc" id="L1060">    return descendantCount;</span>
  }

  // ** Only adds text to Headings and Paragraphs */
  public static void addText(
      Component rootComponent, JSONArray start, JSONObject attrs, String newText)
      throws IndexOutOfBoundsException {
<span class="nc" id="L1067">    Component parentComponent = rootComponent.getParentOf(start);</span>
<span class="nc bnc" id="L1068" title="All 4 branches missed.">    if (parentComponent != null &amp;&amp; start != null) {</span>
      try {
<span class="nc" id="L1070">        addText(</span>
<span class="nc" id="L1071">            (TextParagraphElementBase) parentComponent.getRootElement(),</span>
<span class="nc" id="L1072">            start.getInt(start.length() - 1),</span>
            attrs,
            newText);
<span class="nc" id="L1075">      } catch (JSONException ex) {</span>
<span class="nc" id="L1076">        Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L1077">      }</span>
    } else {
<span class="nc" id="L1079">      LOG.log(</span>
          Level.SEVERE,
          &quot;Could not add text as no container (e.g. paragraph) was found at position: {0}&quot;,
          start);
    }
<span class="nc" id="L1084">  }</span>

  public static void addText(
      TextParagraphElementBase paragraphElementBase, int startPos, JSONObject attrs, String newText)
      throws IndexOutOfBoundsException {

    // ToDo - parse the text spans positions from the beginning, creating array - could do this from
    // the beginning..
    // better not for very long texts it is unnecessary, does not scale
    //        adding the span depths, the span element reference, for every character?
<span class="nc" id="L1094">    int endPos = startPos + newText.length() - 1;</span>
<span class="nc" id="L1095">    paragraphElementBase.insert(newText, startPos);</span>
    // LO let the value attribute overrule the content, therefore this value have to vanish!
<span class="nc" id="L1097">    OdfElement parentElement = (OdfElement) paragraphElementBase.getParentNode();</span>
<span class="nc bnc" id="L1098" title="All 2 branches missed.">    if (parentElement instanceof TableTableCellElement) {</span>
<span class="nc" id="L1099">      ((TableTableCellElement) parentElement)</span>
<span class="nc" id="L1100">          .removeAttributeNS(OdfDocumentNamespace.OFFICE.getUri(), &quot;value&quot;);</span>
<span class="nc" id="L1101">      ((TableTableCellElement) parentElement)</span>
<span class="nc" id="L1102">          .removeAttributeNS(OdfDocumentNamespace.OFFICE.getUri(), &quot;value-type&quot;);</span>
    }
<span class="nc bnc" id="L1104" title="All 4 branches missed.">    if (attrs != null &amp;&amp; attrs.length() &gt; 0) {</span>
<span class="nc" id="L1105">      applyStyleOnText(paragraphElementBase, startPos, endPos, attrs);</span>
    }
<span class="nc" id="L1107">  }</span>

  /** Reused by insertText and format for Text */
  private static void applyStyleOnText(
      OdfElement parentElement, Integer startPos, Integer endPos, JSONObject attrs) {
<span class="nc bnc" id="L1112" title="All 2 branches missed.">    if (parentElement != null) {</span>

      // ToDo - addChild the paragraph text length to the paragraph? Than I need to intercept all
      // text manipulations!!
      // ToDo - parse the text spans positions from the beginning, creating array - could do this
      // from the beginning..
      // better not for very long texts it is unnecessary, does not scale
      //  adding the span depths, the span element reference, for every character?
      // Insert an hyperlink above the span if an URL was included as property
<span class="nc bnc" id="L1121" title="All 2 branches missed.">      if (attrs.has(&quot;character&quot;)) {</span>
        // Remove JSON String encoding for URLs
<span class="nc" id="L1123">        JSONObject chars = attrs.optJSONObject(&quot;character&quot;);</span>
<span class="nc" id="L1124">        String url = chars.optString(&quot;url&quot;);</span>
<span class="nc bnc" id="L1125" title="All 4 branches missed.">        if (url != null &amp;&amp; !url.isEmpty()) {</span>
<span class="nc" id="L1126">          chars.remove(url);</span>
<span class="nc" id="L1127">          chars.put(&quot;url&quot;, url);</span>
<span class="nc" id="L1128">          attrs.put(&quot;character&quot;, chars);</span>
        }
<span class="nc" id="L1130">        parentElement.markText(startPos, endPos, attrs);</span>
      }
    }
<span class="nc" id="L1133">  }</span>

  /**
   * Analyze the attrs if there is any new style properties given or only existing should be removed
   */
  private static boolean hasHardProperties(JSONObject attrs, OdfStyleFamily styleFamily) {
<span class="nc" id="L1139">    int attrsLength = attrs.length();</span>
<span class="nc bnc" id="L1140" title="All 4 branches missed.">    if (attrs.has(OPK_STYLE_ID) &amp;&amp; !attrs.isNull(OPK_STYLE_ID)) {</span>
<span class="nc" id="L1141">      attrsLength--;</span>
    }
<span class="nc bnc" id="L1143" title="All 2 branches missed.">    if (attrs.has(&quot;changes&quot;)) {</span>
<span class="nc" id="L1144">      attrsLength--;</span>
    }
<span class="nc" id="L1146">    Map&lt;String, OdfStylePropertiesSet&gt; elementProps =</span>
<span class="nc" id="L1147">        Component.getAllStyleGroupingIdProperties(styleFamily);</span>
<span class="nc bnc" id="L1148" title="All 2 branches missed.">    for (String propertyId : elementProps.keySet()) {</span>
<span class="nc bnc" id="L1149" title="All 2 branches missed.">      if (attrs.has(propertyId)) {</span>
<span class="nc" id="L1150">        JSONObject newProps = attrs.optJSONObject(propertyId);</span>
<span class="nc bnc" id="L1151" title="All 2 branches missed.">        if (newProps != null) {</span>
<span class="nc" id="L1152">          int propsLength = newProps.length();</span>
<span class="nc" id="L1153">          Iterator&lt;String&gt; keys = newProps.keys();</span>
          String key;
<span class="nc bnc" id="L1155" title="All 2 branches missed.">          while (keys.hasNext()) {</span>
<span class="nc" id="L1156">            key = keys.next();</span>
            // if there is a deletion of a hard formatting or an URL, which is not being used for
            // &lt;text:span&gt; but an own element (&lt;text:a&gt;)
<span class="nc bnc" id="L1159" title="All 6 branches missed.">            if (newProps.has(key) &amp;&amp; newProps.isNull(key) || key.equals(&quot;url&quot;)) {</span>
<span class="nc" id="L1160">              propsLength--;</span>
            } else {
              break;
            }
          }
<span class="nc bnc" id="L1165" title="All 2 branches missed.">          if (propsLength == 0) {</span>
<span class="nc" id="L1166">            attrsLength--;</span>
          } else {
            break;
          }
<span class="nc" id="L1170">        } else {</span>
          // remove key, when value is null
<span class="nc" id="L1172">          attrs.remove(propertyId);</span>
        }
      }
<span class="nc" id="L1175">    }</span>
<span class="nc bnc" id="L1176" title="All 2 branches missed.">    return attrsLength != 0;</span>
  }

  private static void mergeParagraph(Component rootComponent, JSONArray start)
      throws IndexOutOfBoundsException {
<span class="nc" id="L1181">    Component firstComponent = rootComponent.get(start);</span>
<span class="nc" id="L1182">    TextParagraphElementBase firstParagraph = null;</span>
<span class="nc bnc" id="L1183" title="All 2 branches missed.">    if (firstComponent != null) {</span>
<span class="nc" id="L1184">      firstParagraph = (TextParagraphElementBase) firstComponent.getRootElement();</span>
<span class="nc bnc" id="L1185" title="All 2 branches missed.">      if (firstParagraph == null) {</span>
<span class="nc" id="L1186">        throw new IndexOutOfBoundsException(&quot;There was no component for &quot; + start + &quot; accessible.&quot;);</span>
      }
    } else {
<span class="nc" id="L1189">      throw new IndexOutOfBoundsException(&quot;There was no component for &quot; + start + &quot; accessible.&quot;);</span>
    }

<span class="nc" id="L1192">    Component secondComponent = rootComponent.getNextSiblingOf(start);</span>
<span class="nc bnc" id="L1193" title="All 2 branches missed.">    if (secondComponent != null) {</span>
<span class="nc" id="L1194">      TextParagraphElementBase secondParagraph =</span>
<span class="nc" id="L1195">          (TextParagraphElementBase) secondComponent.getRootElement();</span>
<span class="nc bnc" id="L1196" title="All 2 branches missed.">      if (secondParagraph != null) {</span>
        try {
<span class="nc" id="L1198">          secondParagraph.moveChildrenTo(firstParagraph);</span>
<span class="nc" id="L1199">          secondParagraph.getParentNode().removeChild(secondParagraph);</span>
<span class="nc" id="L1200">          secondComponent.getParent().remove(start.getInt(start.length() - 1) + 1);</span>
<span class="nc" id="L1201">        } catch (JSONException ex) {</span>
<span class="nc" id="L1202">          Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L1203">        }</span>
      } else {
<span class="nc" id="L1205">        throw new IndexOutOfBoundsException(&quot;There was no sibling for &quot; + start + &quot; accessible.&quot;);</span>
      }
<span class="nc" id="L1207">    } else {</span>
<span class="nc" id="L1208">      LOG.log(Level.SEVERE, &quot;Could not fine second Paragraph to merge. Position: {0}&quot;, start);</span>
    }
<span class="nc" id="L1210">  }</span>

  public static void delete(Component rootComponent, JSONArray start, JSONArray end)
      throws IndexOutOfBoundsException {
<span class="nc" id="L1214">    Component parentComponent = rootComponent.getParentOf(start);</span>
<span class="nc bnc" id="L1215" title="All 2 branches missed.">    if (parentComponent != null) {</span>
<span class="nc bnc" id="L1216" title="All 2 branches missed.">      if (parentComponent instanceof TextContainer) { // text container might</span>
<span class="nc" id="L1217">        deleteText(rootComponent, start, end);</span>
      } else {
<span class="nc" id="L1219">        deleteComponents(rootComponent, start, end);</span>
      }
    }
<span class="nc" id="L1222">  }</span>

  /**
   * Deletes the cells of a single column or multiple columns from a tableElement.
   *
   * @param rootComponent high level document structure
   * @param start Integer[] The logical position of the tableElement whose columns will be removed.
   * @param startGrid Integer Zero-based index of the first column to be removed, according to the
   *     tableGrid attribute of the tableElement.
   * @param endGrid Integer (optional) Zero-based index of the last column to be removed (closed
   *     range). If omitted, only one column will be removed. Note: Each cell that is addressed by
   *     the specified column range will be removed completely. As a side effect, this op changes
   *     the tableGrid attribute of the parentComponentElement tableElement.
   */
  public static void deleteColumns(
      Component rootComponent, JSONArray start, Integer startGrid, Integer endGrid) {
    // Parent will not change and have to exist to insert the new component
<span class="nc" id="L1239">    final Component parentComponent = rootComponent.get(start);</span>
<span class="nc bnc" id="L1240" title="All 2 branches missed.">    if (parentComponent == null) {</span>
<span class="nc" id="L1241">      LOG.log(</span>
          Level.SEVERE,
          &quot;The table parent component of the column should exist at position {0}&quot;,
          start);
    } else {
      // CREATING NEW ROOT ELEMENT
<span class="nc" id="L1247">      TableTableElement tableElement = (TableTableElement) parentComponent.getRootElement();</span>
<span class="nc" id="L1248">      OdfTable table = OdfTable.getInstance(tableElement);</span>

      // WORK AROUND for &quot;UNDO COLUMN WIDTH&quot; problem
<span class="nc bnc" id="L1251" title="All 2 branches missed.">      if (!tableElement.isWidthChangeRequired()) {</span>
<span class="nc" id="L1252">        Table.stashColumnWidths(tableElement);</span>
      }
<span class="nc" id="L1254">      table.removeColumnsByIndex(startGrid, endGrid - startGrid + 1);</span>

      // WORK AROUND for &quot;UNDO COLUMN WIDTH&quot; problem (see JsonOperationConsumer for further changes)
<span class="nc bnc" id="L1257" title="All 2 branches missed.">      if (tableElement.isWidthChangeRequired()) {</span>
<span class="nc" id="L1258">        JsonOperationConsumer.setColumnsWidth(</span>
<span class="nc" id="L1259">            tableElement.getComponent(),</span>
<span class="nc" id="L1260">            tableElement.getPosition(),</span>
<span class="nc" id="L1261">            tableElement.popTableGrid(),</span>
<span class="nc" id="L1262">            Boolean.TRUE);</span>
      }
    }
<span class="nc" id="L1265">  }</span>

  /**
   * Removes a template style from the document
   *
   * @param doc temporary font properties taken into adapter
   */
  public static void deleteStyle(OdfDocument doc, String styleId, String type) {
<span class="nc" id="L1273">    final OdfOfficeStyles styles = doc.getDocumentStyles();</span>
<span class="nc" id="L1274">    OdfStyle oldStyle = styles.getStyle(styleId, Component.getFamily(type));</span>
<span class="nc bnc" id="L1275" title="All 2 branches missed.">    if (oldStyle != null) {</span>
<span class="nc" id="L1276">      styles.removeChild(oldStyle);</span>
    } else {
      // check if this is a default style
<span class="nc" id="L1279">      final OdfDefaultStyle oldDefaultStyle = styles.getDefaultStyle(Component.getFamily(type));</span>
<span class="nc bnc" id="L1280" title="All 2 branches missed.">      if (oldDefaultStyle != null) {</span>
<span class="nc" id="L1281">        styles.removeChild(oldDefaultStyle);</span>
      }
    }
<span class="nc" id="L1284">  }</span>

  public static void changeStyle(
      OdfDocument doc, String type, String styleId, String styleName, JSONObject attrs) {
<span class="nc" id="L1288">    OdfOfficeStyles styles = doc.getDocumentStyles();</span>
<span class="nc" id="L1289">    OdfStyleFamily styleFamily = Component.getFamily(type);</span>
    // might be null if not existent
<span class="nc" id="L1291">    OdfStyle style = styles.getStyle(styleId, styleFamily);</span>

<span class="nc bnc" id="L1293" title="All 4 branches missed.">    if (styleName != null &amp;&amp; !styleName.isEmpty()) {</span>
<span class="nc" id="L1294">      style.setStyleDisplayNameAttribute(styleName);</span>
    }

<span class="nc bnc" id="L1297" title="All 2 branches missed.">    if (attrs != null) {</span>
<span class="nc bnc" id="L1298" title="All 2 branches missed.">      if (type.equals(&quot;table&quot;)) {</span>

<span class="nc" id="L1300">        style.removeProperty(</span>
<span class="nc" id="L1301">            OdfStyleProperty.get(</span>
                OdfStylePropertiesSet.TableProperties, StyleTablePropertiesElement.ELEMENT_NAME));

<span class="nc" id="L1304">        mapProperties(styleFamily, attrs.optJSONObject(&quot;wholetable&quot;), style, doc);</span>
      } else {

<span class="nc" id="L1307">        style.removeProperty(</span>
<span class="nc" id="L1308">            OdfStyleProperty.get(</span>
                OdfStylePropertiesSet.ParagraphProperties,
                StyleParagraphPropertiesElement.ELEMENT_NAME));
<span class="nc" id="L1311">        style.removeProperty(</span>
<span class="nc" id="L1312">            OdfStyleProperty.get(</span>
                OdfStylePropertiesSet.TextProperties, StyleTextPropertiesElement.ELEMENT_NAME));

<span class="nc" id="L1315">        mapProperties(styleFamily, attrs, style, doc);</span>
      }

      // APPLY PARAGRAPH ONLY PROPERTIES
<span class="nc bnc" id="L1319" title="All 2 branches missed.">      if (styleFamily.equals(OdfStyleFamily.Paragraph)) {</span>
<span class="nc" id="L1320">        handleParaOutline(style, attrs);</span>
      }
    }
<span class="nc" id="L1323">  }</span>

  //	/**
  //	 * Adds a new none automatic style to the document. If the style is hidden a
  //	 * default style, otherwise a template style will be added.
  //	 * @param doc  temporary font properties taken into adapter
  //	 */
  public static void addStyles(
      OdfDocument doc,
      String type,
      String styleId,
      String styleName,
      JSONObject attrs,
      String parent,
      Boolean hidden,
      Boolean custom) {

<span class="nc" id="L1340">    OdfOfficeStyles styles = null;</span>
    try {
<span class="nc" id="L1342">      styles = doc.getStylesDom().getOrCreateOfficeStyles();</span>
<span class="nc" id="L1343">    } catch (SAXException ex) {</span>
<span class="nc" id="L1344">      Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L1345">    } catch (IOException ex) {</span>
<span class="nc" id="L1346">      Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L1347">    }</span>
<span class="nc bnc" id="L1348" title="All 2 branches missed.">    if (attrs != null) {</span>
<span class="nc" id="L1349">      OdfStyleFamily styleFamily = Component.getFamily(type);</span>
<span class="nc bnc" id="L1350" title="All 2 branches missed.">      if (hidden) { // DEFAULT STYLE</span>
        // Removing any existing default style
<span class="nc" id="L1352">        OdfDefaultStyle oldDefaultStyle = styles.getDefaultStyle(styleFamily);</span>
<span class="nc bnc" id="L1353" title="All 2 branches missed.">        if (oldDefaultStyle != null) {</span>
<span class="nc" id="L1354">          styles.removeChild(oldDefaultStyle);</span>
        }
        // Adding new default style
<span class="nc" id="L1357">        StyleDefaultStyleElement defaultStyleElement =</span>
<span class="nc" id="L1358">            styles.newStyleDefaultStyleElement(styleFamily.getName());</span>
<span class="nc" id="L1359">        mapProperties(styleFamily, attrs, defaultStyleElement, doc);</span>
<span class="nc" id="L1360">      } else { // TEMPLATE STYLE</span>
<span class="nc" id="L1361">        OdfStyle oldStyle = styles.getStyle(styleName, styleFamily);</span>
<span class="nc bnc" id="L1362" title="All 2 branches missed.">        if (oldStyle != null) {</span>
<span class="nc" id="L1363">          styles.removeChild(oldStyle);</span>
        } else {
          /* Workaround for OOo applications
           * Applications from the OpenOffice family are exchanging any space in their names with an '_20_' string.
           * Unfortunately they are using them equivalent in general, therefore the names 'Heading_20_2' and 'Heading 2' would result and into a name clash */
<span class="nc bnc" id="L1368" title="All 4 branches missed.">          if (styleName != null &amp;&amp; styleName.contains(&quot; &quot;)) {</span>
<span class="nc" id="L1369">            String testName = styleName.replace(&quot; &quot;, &quot;_20_&quot;);</span>
<span class="nc" id="L1370">            oldStyle = styles.getStyle(testName, styleFamily);</span>
<span class="nc bnc" id="L1371" title="All 2 branches missed.">            if (oldStyle != null) {</span>
<span class="nc" id="L1372">              styles.removeChild(oldStyle);</span>
            }
          }
        }
<span class="nc" id="L1376">        StyleStyleElement style = styles.newStyle(styleId, styleFamily);</span>
<span class="nc bnc" id="L1377" title="All 4 branches missed.">        if (parent != null &amp;&amp; !parent.isEmpty()) {</span>
<span class="nc" id="L1378">          style.setStyleParentStyleNameAttribute(parent);</span>
        }
<span class="nc bnc" id="L1380" title="All 4 branches missed.">        if (styleName != null &amp;&amp; !styleName.isEmpty()) {</span>
<span class="nc" id="L1381">          style.setStyleDisplayNameAttribute(styleName);</span>
        }

        // APPLY FORMATTING PROPERTIES
<span class="nc bnc" id="L1385" title="All 2 branches missed.">        if (type.equals(&quot;table&quot;)) {</span>
<span class="nc" id="L1386">          mapProperties(styleFamily, attrs.optJSONObject(&quot;wholetable&quot;), style, doc);</span>
        } else {
<span class="nc" id="L1388">          mapProperties(styleFamily, attrs, style, doc);</span>
        }

        // APPLY PARAGRAPH ONLY PROPERTIES
<span class="nc bnc" id="L1392" title="All 2 branches missed.">        if (styleFamily.equals(OdfStyleFamily.Paragraph)) {</span>
<span class="nc" id="L1393">          handleParaOutline(style, attrs);</span>
        }
<span class="nc bnc" id="L1395" title="All 4 branches missed.">        if (null != custom &amp;&amp; custom) {</span>
<span class="nc" id="L1396">          style.setAttribute(&quot;custom&quot;, &quot;true&quot;);</span>
        }
      }
    }
<span class="nc" id="L1400">  }</span>

  public static void handleParaOutline(StyleStyleElement style, JSONObject attrs) {
<span class="nc bnc" id="L1403" title="All 2 branches missed.">    if (attrs != null) {</span>
<span class="nc" id="L1404">      JSONObject props = attrs.optJSONObject(&quot;paragraph&quot;);</span>
<span class="nc bnc" id="L1405" title="All 2 branches missed.">      if (props != null) {</span>
        // Heading Level
<span class="nc bnc" id="L1407" title="All 2 branches missed.">        if (props.has(&quot;outlineLevel&quot;)) {</span>
<span class="nc bnc" id="L1408" title="All 2 branches missed.">          if (!props.get(&quot;outlineLevel&quot;).equals(JSONObject.NULL)) {</span>
<span class="nc" id="L1409">            Integer outlineLevel = props.optInt(&quot;outlineLevel&quot;);</span>
<span class="nc bnc" id="L1410" title="All 2 branches missed.">            if (outlineLevel &gt;= 1) {</span>
<span class="nc" id="L1411">              style.setStyleDefaultOutlineLevelAttribute(outlineLevel);</span>
            } else {
<span class="nc" id="L1413">              style.removeAttributeNS(OdfDocumentNamespace.STYLE.getUri(), &quot;default-outline-level&quot;);</span>
            }
<span class="nc" id="L1415">          } else {</span>
<span class="nc" id="L1416">            style.removeAttributeNS(OdfDocumentNamespace.STYLE.getUri(), &quot;default-outline-level&quot;);</span>
          }
        }

        // Follow-Up Style
<span class="nc" id="L1421">        String nextStyleId = props.optString(&quot;nextStyleId&quot;);</span>
        // ToDo: Test with latest JSON Library and adapt accordingly for all occurences
<span class="nc bnc" id="L1423" title="All 4 branches missed.">        if (nextStyleId != null &amp;&amp; !nextStyleId.isEmpty()) {</span>
<span class="nc" id="L1424">          style.setStyleNextStyleNameAttribute(nextStyleId);</span>
        }
      }
    }
<span class="nc" id="L1428">  }</span>

  /**
   * Setting attributes on text, require the text container, otherwise the character itself (as
   * paragraph is not child of paragraph
   */
  public static void format(
      Component rootComponent, JSONArray start, JSONArray end, JSONObject attrs) {
    // Only process the method if all mandatory values are present
<span class="nc bnc" id="L1437" title="All 8 branches missed.">    if (rootComponent != null &amp;&amp; start != null &amp;&amp; attrs != null &amp;&amp; attrs.length() != 0) {</span>
      // Parent will not change and have to exist to insert the new component
      // ToDo PERFORMANCE: Sometimes we do have the parentComponentElement, e.g. the table row
      // component earlier, why searching it ALWAYS again?
<span class="nc" id="L1441">      final Component parentComponent = rootComponent.getParentOf(start);</span>
<span class="nc bnc" id="L1442" title="All 2 branches missed.">      if (parentComponent != null) {</span>
        // the targetComponent might be either text or an element
<span class="nc" id="L1444">        int targetPos = start.optInt(start.length() - 1);</span>
<span class="nc" id="L1445">        Node targetNode = parentComponent.getChildNode(targetPos);</span>
<span class="nc" id="L1446">        format(parentComponent.mRootElement, targetNode, start, end, attrs, Boolean.FALSE);</span>
<span class="nc" id="L1447">      } else {</span>
<span class="nc" id="L1448">        LOG.log(</span>
            Level.SEVERE,
            &quot;No parent component found to '&quot; + OP_FORMAT + &quot;' from {0} to {1} trying to add {2}&quot;,
            new Object[] {start, end, attrs});
      }
<span class="nc" id="L1453">    } else {</span>
<span class="nc" id="L1454">      LOG.log(</span>
          Level.SEVERE,
          &quot;No parent component found to '&quot; + OP_FORMAT + &quot;' from {0} to {1} trying to add {2}&quot;,
          new Object[] {start, end, attrs});
    }
<span class="nc" id="L1459">  }</span>

  /**
   * Setting attributes on text, require the text container, otherwise the character itself (as
   * paragraph is not child of paragraph
   *
   * @param formatCompleteLine in case a row/column has cell styles via a default-cell-style
   *     attribute
   */
  // PROBLEM: A column becomes a default cell style only if the complete column is selected!
  static void format(
      OdfElement parentElement,
      Node targetNode,
      JSONArray start,
      JSONArray end,
      JSONObject attrs,
      Boolean formatCompleteLine) {
<span class="nc bnc" id="L1476" title="All 4 branches missed.">    if (attrs != null &amp;&amp; attrs.length() != 0) {</span>
<span class="nc bnc" id="L1477" title="All 4 branches missed.">      if (targetNode != null &amp;&amp; targetNode instanceof OdfStylableElement) {</span>
<span class="nc" id="L1478">        OdfFileDom xmlDoc = (OdfFileDom) targetNode.getOwnerDocument();</span>
        // Adds the automatic/template style to the target element
<span class="nc" id="L1480">        StyleStyleElement autoStyle = null;</span>
<span class="nc bnc" id="L1481" title="All 2 branches missed.">        if (targetNode instanceof TextParagraphElementBase) {</span>
<span class="nc" id="L1482">          TextParagraphElementBase paragraphBaseElement = (TextParagraphElementBase) targetNode;</span>
          // Check if the paragraph should become a list
<span class="nc" id="L1484">          JSONObject paraProps = attrs.optJSONObject(&quot;paragraph&quot;);</span>
          // adjust list styles and new outline my be triggered by new styleId (template style)
<span class="nc bnc" id="L1486" title="All 4 branches missed.">          if (paraProps != null || attrs.has(OPK_STYLE_ID)) {</span>
<span class="nc" id="L1487">            boolean isNewList = false;</span>
<span class="nc" id="L1488">            boolean hasListLevel = false;</span>
<span class="nc" id="L1489">            boolean hasNewListId = false;</span>
<span class="nc bnc" id="L1490" title="All 2 branches missed.">            if (paraProps != null) {</span>
<span class="nc" id="L1491">              hasListLevel = paraProps.has(&quot;listLevel&quot;);</span>
<span class="nc" id="L1492">              hasNewListId = paraProps.has(&quot;listStyleId&quot;);</span>
            }
            // The indent of a list is only shown in ODF, if the paragraph do not have an indent
            // itself..
<span class="nc bnc" id="L1496" title="All 4 branches missed.">            if (hasListLevel</span>
                || hasNewListId) { // || paraProps.hasAndNotNull(&quot;listStyleId&quot;) &lt;-- reset of
              // listStyle should not be NULL, but -1 even better 0
<span class="nc" id="L1499">              TextListElement rootListElement =</span>
<span class="nc" id="L1500">                  JsonOperationConsumer.isolateListParagraph(paragraphBaseElement);</span>
<span class="nc bnc" id="L1501" title="All 4 branches missed.">              if (rootListElement != null &amp;&amp; hasNewListId) {</span>
<span class="nc" id="L1502">                modifyListStyleName(attrs, rootListElement);</span>
              } else {
<span class="nc" id="L1504">                isNewList = true;</span>
              }
            }
<span class="nc bnc" id="L1507" title="All 2 branches missed.">            if (paraProps != null) {</span>
<span class="nc bnc" id="L1508" title="All 2 branches missed.">              if (hasListLevel) { // || paraProps.hasAndNotNull(&quot;listStyleId&quot;) &lt;-- reset of</span>
                // listStyle should not be NULL, but -1 even better 0
                try {
<span class="nc" id="L1511">                  paraProps.put(&quot;indentFirstLine&quot;, JSONObject.NULL);</span>
<span class="nc" id="L1512">                  paraProps.put(&quot;marginLeft&quot;, JSONObject.NULL);</span>
<span class="nc" id="L1513">                } catch (JSONException ex) {</span>
<span class="nc" id="L1514">                  Logger.getLogger(JsonOperationConsumer.class.getName())</span>
<span class="nc" id="L1515">                      .log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L1516">                }</span>
<span class="nc" id="L1517">                autoStyle = addStyle(attrs, paragraphBaseElement, xmlDoc);</span>

                // get the current list level
<span class="nc" id="L1520">                int listLevel = getListLevel(paragraphBaseElement);</span>
                int newListLevel;
<span class="nc bnc" id="L1522" title="All 2 branches missed.">                if (paraProps.isNull(&quot;listLevel&quot;)) {</span>
<span class="nc" id="L1523">                  newListLevel = -1;</span>
                  // as there is no list level, remove the list styles
<span class="nc bnc" id="L1525" title="All 2 branches missed.">                  if (autoStyle != null) {</span>
<span class="nc" id="L1526">                    autoStyle.removeAttributeNS(</span>
<span class="nc" id="L1527">                        OdfDocumentNamespace.STYLE.getUri(), &quot;list-style-name&quot;);</span>
                  }
                } else {
<span class="nc" id="L1530">                  newListLevel = paraProps.optInt(&quot;listLevel&quot;, -2);</span>
                  // if the list level should be unchanged
<span class="nc bnc" id="L1532" title="All 2 branches missed.">                  if (newListLevel == -2) {</span>
                    // use the current listlevel..
<span class="nc" id="L1534">                    newListLevel = listLevel;</span>
                  }
                }

                // if the paragraph in the list should be shown..
<span class="nc" id="L1539">                boolean listLabelHidden = false;</span>
<span class="nc bnc" id="L1540" title="All 2 branches missed.">                if (paraProps.has(&quot;listLabelHidden&quot;)</span>
<span class="nc bnc" id="L1541" title="All 2 branches missed.">                    &amp;&amp; !paraProps.get(&quot;listLabelHidden&quot;).equals(JSONObject.NULL)) {</span>
                  // get the current list level
<span class="nc" id="L1543">                  listLabelHidden = paraProps.optBoolean(&quot;listLabelHidden&quot;);</span>
                }

                // we need to keep the existing top level list attributes, at least the list style
<span class="nc" id="L1547">                String currentListStyleName = null;</span>
<span class="nc" id="L1548">                TextListElement rootListElement = getListRootElement(paragraphBaseElement);</span>
<span class="nc bnc" id="L1549" title="All 2 branches missed.">                if (rootListElement != null) {</span>
<span class="nc" id="L1550">                  currentListStyleName = rootListElement.getTextStyleNameAttribute();</span>
                }

                // we need to split the paragraph first to root level, to be certain that it is
                // first in a list-item
<span class="nc bnc" id="L1555" title="All 2 branches missed.">                if (paraProps.has(&quot;listStyleId&quot;)</span>
<span class="nc bnc" id="L1556" title="All 4 branches missed.">                    &amp;&amp; !paraProps.get(&quot;listStyleId&quot;).equals(JSONObject.NULL)</span>
                    &amp;&amp; !listLabelHidden) {
<span class="nc" id="L1558">                  String listStyleId = paraProps.optString(&quot;listStyleId&quot;);</span>
                  // if (7 == (start.optInt(start.length() - 1)) || listStyleId == &quot;L4&quot;) {
                  //	System.out.println(&quot;x&quot;);
                  // }

<span class="nc bnc" id="L1563" title="All 6 branches missed.">                  if (autoStyle != null &amp;&amp; listStyleId != null &amp;&amp; !listStyleId.isEmpty()) {</span>
<span class="nc" id="L1564">                    autoStyle.setStyleListStyleNameAttribute(listStyleId);</span>
                  }
                  // ToDo Optimization: remove the following for list level 0 and those without
                  // preceding/following content!
                  // temporary move the paragraph out of the list to separate both list styles
<span class="nc" id="L1569">                  setParagraphListProperties(</span>
                      paragraphBaseElement, paraProps, xmlDoc, listLevel, -1, null);
<span class="nc" id="L1571">                  listLevel = -1;</span>
                }
<span class="nc" id="L1573">                setParagraphListProperties(</span>
                    paragraphBaseElement,
                    paraProps,
                    xmlDoc,
                    listLevel,
                    newListLevel,
                    currentListStyleName);
              }
              // The indent of a list is only shown in ODF, if the paragraph do not have an indent
              // itself..
<span class="nc bnc" id="L1583" title="All 4 branches missed.">              if (isNewList &amp;&amp; hasListLevel) {</span>
<span class="nc" id="L1584">                TextListElement rootListElement =</span>
<span class="nc" id="L1585">                    JsonOperationConsumer.isolateListParagraph(paragraphBaseElement);</span>
<span class="nc" id="L1586">                modifyListStyleName(attrs, rootListElement);</span>
              }
            }
            // switch element if outlineLevel is on a paragraph (or vise versa)
<span class="nc bnc" id="L1590" title="All 4 branches missed.">            if (attrs.has(OPK_STYLE_ID) || paraProps.has(&quot;outlineLevel&quot;)) {</span>
<span class="nc" id="L1591">              int outlineLevel = -2;</span>
              // take the explicit outline level from the
<span class="nc bnc" id="L1593" title="All 2 branches missed.">              if (paraProps != null</span>
<span class="nc bnc" id="L1594" title="All 2 branches missed.">                  &amp;&amp; paraProps.has(&quot;outlineLevel&quot;)</span>
<span class="nc bnc" id="L1595" title="All 2 branches missed.">                  &amp;&amp; !paraProps.get(&quot;outlineLevel&quot;).equals(JSONObject.NULL)) {</span>
<span class="nc" id="L1596">                outlineLevel = paraProps.optInt(&quot;outlineLevel&quot;);</span>
                // if not the automatic/hard style is overwriting the template/referenced style
<span class="nc bnc" id="L1598" title="All 2 branches missed.">              } else if (attrs.has(OPK_STYLE_ID)) { // get the outline level from the styleId</span>
<span class="nc bnc" id="L1599" title="All 2 branches missed.">                if (!attrs.isNull(OPK_STYLE_ID)) {</span>
<span class="nc" id="L1600">                  String styleId = attrs.optString(OPK_STYLE_ID);</span>
<span class="nc bnc" id="L1601" title="All 4 branches missed.">                  if (styleId != null &amp;&amp; !styleId.isEmpty()) {</span>
                    // Update the styleId before getting the outline, as the outline level might be
                    // come from the template style (e.g. &quot;heading1&quot; style)
<span class="nc bnc" id="L1604" title="All 2 branches missed.">                    if (autoStyle == null) {</span>
<span class="nc" id="L1605">                      addStyle(attrs, (OdfStylableElement) targetNode, xmlDoc);</span>
                    }
<span class="nc" id="L1607">                    outlineLevel = getDefaultOutlineLevelFromStyleHierarchy(paragraphBaseElement);</span>
                  }
                }
              }
              // if the &lt;text:p&gt; will e changed to a &lt;text:h&gt; or vice versa, the targetNode will be
              // updated
<span class="nc" id="L1613">              targetNode =</span>
<span class="nc" id="L1614">                  ensureCorrectParagraphElement(</span>
                      outlineLevel,
                      (TextParagraphElementBase) targetNode,
<span class="nc" id="L1617">                      paragraphBaseElement.getComponent());</span>
            }
          }
<span class="nc bnc" id="L1620" title="All 2 branches missed.">        } else if (targetNode instanceof TableTableElement) {</span>
<span class="nc" id="L1621">          TableTableElement tableElement = (TableTableElement) targetNode;</span>
<span class="nc" id="L1622">          autoStyle = addStyle(attrs, (OdfStylableElement) targetNode, xmlDoc);</span>
<span class="nc" id="L1623">          JSONObject tableProps = attrs.optJSONObject(&quot;table&quot;);</span>
<span class="nc bnc" id="L1624" title="All 2 branches missed.">          if (tableProps != null) {</span>
<span class="nc" id="L1625">            JSONArray tableGrid = tableProps.optJSONArray(&quot;tableGrid&quot;);</span>
<span class="nc bnc" id="L1626" title="All 2 branches missed.">            if (tableGrid != null) {</span>
<span class="nc" id="L1627">              setColumnsWidth(tableElement.getComponent(), start, tableGrid, true);</span>
            }
          }
<span class="nc bnc" id="L1630" title="All 2 branches missed.">        } else if (targetNode instanceof TableTableColumnElement) {</span>
<span class="nc" id="L1631">          TableTableColumnElement columnElement = (TableTableColumnElement) targetNode;</span>
<span class="nc bnc" id="L1632" title="All 2 branches missed.">          if (attrs.has(&quot;column&quot;)) {</span>
<span class="nc" id="L1633">            autoStyle = addStyle(attrs, (OdfStylableElement) targetNode, xmlDoc);</span>
          }
<span class="nc bnc" id="L1635" title="All 2 branches missed.">          if (attrs.has(&quot;cell&quot;)) {</span>
            // columnElement.
<span class="nc" id="L1637">            autoStyle = addStyle(attrs, (OdfStylableElement) targetNode, xmlDoc);</span>
          }

<span class="nc" id="L1640">          JSONObject columnProps = attrs.optJSONObject(&quot;column&quot;);</span>
<span class="nc bnc" id="L1641" title="All 2 branches missed.">          if (columnProps != null) {</span>
<span class="nc" id="L1642">            Boolean changeToVisible = columnProps.optBoolean(&quot;visible&quot;, Boolean.TRUE);</span>
<span class="nc" id="L1643">            boolean isVisible = Boolean.TRUE;</span>
<span class="nc bnc" id="L1644" title="All 2 branches missed.">            if (columnElement.hasAttributeNS(OdfDocumentNamespace.TABLE.getUri(), &quot;visibility&quot;)) {</span>
<span class="nc" id="L1645">              isVisible =</span>
<span class="nc" id="L1646">                  Constants.VISIBLE.equals(</span>
<span class="nc" id="L1647">                      columnElement.getAttributeNS(</span>
<span class="nc" id="L1648">                          OdfDocumentNamespace.TABLE.getUri(), &quot;visibility&quot;));</span>
            }
<span class="nc bnc" id="L1650" title="All 8 branches missed.">            if (isVisible &amp;&amp; !changeToVisible || !isVisible &amp;&amp; changeToVisible) {</span>
<span class="nc bnc" id="L1651" title="All 2 branches missed.">              if (changeToVisible) {</span>
<span class="nc" id="L1652">                columnElement.removeAttributeNS(OdfDocumentNamespace.TABLE.getUri(), &quot;visibility&quot;);</span>
              } else {
<span class="nc" id="L1654">                columnElement.setAttributeNS(</span>
<span class="nc" id="L1655">                    OdfDocumentNamespace.TABLE.getUri(), &quot;table:visibility&quot;, Constants.COLLAPSE);</span>
              }
            }
          }
<span class="nc bnc" id="L1659" title="All 2 branches missed.">          if (formatCompleteLine) {</span>
<span class="nc" id="L1660">            setDefaultAttribute(columnElement, attrs);</span>
          }
<span class="nc bnc" id="L1662" title="All 2 branches missed.">        } else if (targetNode instanceof TableTableRowElement) {</span>
<span class="nc" id="L1663">          TableTableRowElement rowElement = (TableTableRowElement) targetNode;</span>
<span class="nc" id="L1664">          autoStyle = addStyle(attrs, (OdfStylableElement) targetNode, xmlDoc);</span>
<span class="nc" id="L1665">          JSONObject rowProps = attrs.optJSONObject(&quot;row&quot;);</span>
<span class="nc bnc" id="L1666" title="All 2 branches missed.">          if (rowProps != null) {</span>
<span class="nc" id="L1667">            Boolean changeToVisible = rowProps.optBoolean(&quot;visible&quot;, Boolean.TRUE);</span>
<span class="nc" id="L1668">            boolean isVisible = Boolean.TRUE;</span>
<span class="nc bnc" id="L1669" title="All 2 branches missed.">            if (rowElement.hasAttributeNS(OdfDocumentNamespace.TABLE.getUri(), &quot;visibility&quot;)) {</span>
<span class="nc" id="L1670">              isVisible =</span>
<span class="nc" id="L1671">                  Constants.VISIBLE.equals(</span>
<span class="nc" id="L1672">                      rowElement.getAttributeNS(OdfDocumentNamespace.TABLE.getUri(), &quot;visibility&quot;));</span>
            }
<span class="nc bnc" id="L1674" title="All 8 branches missed.">            if (isVisible &amp;&amp; !changeToVisible || !isVisible &amp;&amp; changeToVisible) {</span>
<span class="nc bnc" id="L1675" title="All 2 branches missed.">              if (changeToVisible) {</span>
<span class="nc" id="L1676">                rowElement.removeAttributeNS(OdfDocumentNamespace.TABLE.getUri(), &quot;visibility&quot;);</span>
              } else {
<span class="nc" id="L1678">                rowElement.setAttributeNS(</span>
<span class="nc" id="L1679">                    OdfDocumentNamespace.TABLE.getUri(), &quot;table:visibility&quot;, Constants.COLLAPSE);</span>
              }
            }
          }
          // The below would lead into a format of all existing rows due to an OpenOffice issue..
          //                    if (formatCompleteLine) {
          //                        setDefaultAttribute(rowElement, attrs);
          //                    }
<span class="nc bnc" id="L1687" title="All 2 branches missed.">        } else if (targetNode instanceof TableTableCellElementBase) {</span>
<span class="nc" id="L1688">          TableTableCellElementBase cellElement = (TableTableCellElementBase) targetNode;</span>
<span class="nc" id="L1689">          autoStyle = addStyle(attrs, (OdfStylableElement) targetNode, xmlDoc);</span>
<span class="nc" id="L1690">          JSONObject cellProps = attrs.optJSONObject(&quot;cell&quot;);</span>
<span class="nc bnc" id="L1691" title="All 2 branches missed.">          if (cellProps != null) {</span>
<span class="nc" id="L1692">            int span = cellProps.optInt(&quot;gridSpan&quot;, 1);</span>
<span class="nc bnc" id="L1693" title="All 2 branches missed.">            if (span &gt; 1) {</span>
<span class="nc" id="L1694">              cellElement.setAttributeNS(</span>
<span class="nc" id="L1695">                  OdfDocumentNamespace.TABLE.getUri(),</span>
                  &quot;table:number-columns-spanned&quot;,
<span class="nc" id="L1697">                  Integer.toString(span));</span>
            }
          }
<span class="nc bnc" id="L1700" title="All 2 branches missed.">        } else if (targetNode instanceof DrawFrameElement) {</span>
<span class="nc" id="L1701">          DrawFrameElement frameElement = (DrawFrameElement) targetNode;</span>
<span class="nc" id="L1702">          setFrameProperties(frameElement, attrs);</span>
<span class="nc" id="L1703">          NodeList images = frameElement.getElementsByTagName(&quot;draw:image&quot;);</span>
<span class="nc bnc" id="L1704" title="All 2 branches missed.">          if (images.getLength() &gt; 0) {</span>
<span class="nc" id="L1705">            DrawImageElement imageElement = (DrawImageElement) images.item(0);</span>
<span class="nc" id="L1706">            final JSONObject imageAttrs = attrs.optJSONObject(&quot;image&quot;);</span>
<span class="nc bnc" id="L1707" title="All 2 branches missed.">            if (imageAttrs != null) {</span>
<span class="nc" id="L1708">              setImageProperties(imageElement, imageAttrs);</span>
            }
          }
<span class="nc bnc" id="L1711" title="All 2 branches missed.">        } else if (targetNode instanceof DrawGElement) {</span>
<span class="nc" id="L1712">          Integer gWidth = (Integer) targetNode.getUserData(&quot;groupWidth&quot;);</span>
<span class="nc" id="L1713">          Integer gHeight = (Integer) targetNode.getUserData(&quot;groupHeight&quot;);</span>
<span class="nc bnc" id="L1714" title="All 4 branches missed.">          if (gWidth != null &amp;&amp; gHeight != null) {</span>
<span class="nc" id="L1715">            int newWidth = -1;</span>
<span class="nc" id="L1716">            int newHeight = -1;</span>
            try {
<span class="nc" id="L1718">              JSONObject drawAttr = attrs.getJSONObject(&quot;drawing&quot;);</span>
<span class="nc bnc" id="L1719" title="All 2 branches missed.">              if (drawAttr.has(&quot;width&quot;)) {</span>
<span class="nc" id="L1720">                newWidth = attrs.getJSONObject(&quot;drawing&quot;).getInt(&quot;width&quot;);</span>
              }
<span class="nc bnc" id="L1722" title="All 2 branches missed.">              if (drawAttr.has(&quot;height&quot;)) {</span>
<span class="nc" id="L1723">                newHeight = attrs.getJSONObject(&quot;drawing&quot;).getInt(&quot;height&quot;);</span>
              }
<span class="nc" id="L1725">            } catch (JSONException e) {</span>
              // no handling required
<span class="nc" id="L1727">            }</span>
<span class="nc" id="L1728">            double heightFactor = 1;</span>
<span class="nc" id="L1729">            double widthFactor = 1;</span>
<span class="nc bnc" id="L1730" title="All 4 branches missed.">            if (newHeight &gt; 0 &amp;&amp; newHeight != gHeight.intValue()) {</span>
<span class="nc" id="L1731">              heightFactor = (double) newHeight / (double) gHeight.intValue();</span>
<span class="nc" id="L1732">              targetNode.setUserData(&quot;groupHeight&quot;, new Integer(newHeight), null);</span>
            }
<span class="nc bnc" id="L1734" title="All 4 branches missed.">            if (newWidth &gt; 0 &amp;&amp; newWidth != gWidth.intValue()) {</span>
<span class="nc" id="L1735">              widthFactor = (double) newWidth / (double) gWidth.intValue();</span>
<span class="nc" id="L1736">              targetNode.setUserData(&quot;groupWidth&quot;, new Integer(newHeight), null);</span>
            }
<span class="nc" id="L1738">            Node child = targetNode.getFirstChild();</span>
<span class="nc" id="L1739">            changeDrawingSizeAndPos(child, heightFactor, widthFactor);</span>
          }
        }
<span class="nc bnc" id="L1742" title="All 2 branches missed.">        if (autoStyle == null) {</span>
<span class="nc" id="L1743">          addStyle(attrs, (OdfStylableElement) targetNode, xmlDoc);</span>
        }
<span class="nc bnc" id="L1745" title="All 2 branches missed.">      } else if (parentElement != null) {</span>
        // If the parentComponentElement is a paragraph/heading, the target can not be a
        // paragraph/heading as they are not allowed nested.
        // Therefore we addChild a span around the text (or target element as draw:frame for image,
        // which is done by MSO15 by default)
<span class="nc bnc" id="L1750" title="All 2 branches missed.">        if (attrs.has(&quot;character&quot;)) {</span>
<span class="nc" id="L1751">          int startPos = start.optInt(start.length() - 1);</span>
          int endPos;
<span class="nc bnc" id="L1753" title="All 2 branches missed.">          if (end == null) {</span>
<span class="nc" id="L1754">            endPos = startPos;</span>
          } else {
<span class="nc" id="L1756">            endPos = end.optInt(end.length() - 1);</span>
          }
          // ToDo: if the paragraph's automatic textstyle contains character attributes as well they
          // need to be spanned over the paragraph first
          // while applying a new autoStyle without character properties
<span class="nc" id="L1761">          OdfStylableElement paraStylable = (OdfStylableElement) parentElement;</span>
<span class="nc" id="L1762">          StyleStyleElement paraAutoStyle = paraStylable.getAutomaticStyle();</span>
<span class="nc bnc" id="L1763" title="All 2 branches missed.">          if (paraAutoStyle != null) {</span>
<span class="nc" id="L1764">            OdfStylePropertiesBase base =</span>
<span class="nc" id="L1765">                paraAutoStyle.getOrCreatePropertiesElement(OdfStylePropertiesSet.TextProperties);</span>
<span class="nc bnc" id="L1766" title="All 2 branches missed.">            if (base.getAttributes().getLength() &gt; 0) {</span>

<span class="nc" id="L1768">              Map&lt;String, Map&lt;String, String&gt;&gt; allOdfProps =</span>
                  new HashMap&lt;String, Map&lt;String, String&gt;&gt;();
<span class="nc" id="L1770">              Map&lt;String, OdfStylePropertiesSet&gt; familyPropertyGroups =</span>
<span class="nc" id="L1771">                  Component.getAllStyleGroupingIdProperties(OdfStyleFamily.Text);</span>
<span class="nc" id="L1772">              MapHelper.getStyleProperties(paraAutoStyle, familyPropertyGroups, allOdfProps);</span>
<span class="nc" id="L1773">              Map&lt;String, Object&gt; mappedFormatting =</span>
<span class="nc" id="L1774">                  MapHelper.mapStyleProperties(familyPropertyGroups, allOdfProps);</span>
<span class="nc bnc" id="L1775" title="All 2 branches missed.">              if (mappedFormatting.containsKey(&quot;character&quot;)) {</span>
<span class="nc" id="L1776">                JSONObject charProps = (JSONObject) mappedFormatting.get(&quot;character&quot;);</span>
<span class="nc" id="L1777">                JSONObject newAttrs = new JSONObject();</span>
                try {
<span class="nc" id="L1779">                  newAttrs.put(&quot;character&quot;, charProps);</span>
<span class="nc" id="L1780">                } catch (JSONException e) {</span>
<span class="nc" id="L1781">                }</span>
<span class="nc" id="L1782">                applyStyleOnText(parentElement, 0, parentElement.getLength(), newAttrs);</span>
              }
<span class="nc" id="L1784">              StyleStyleElement newAutoStyle = paraStylable.getOrCreateUnqiueAutomaticStyle();</span>
<span class="nc" id="L1785">              newAutoStyle.removeChild(</span>
<span class="nc" id="L1786">                  newAutoStyle.getOrCreatePropertiesElement(OdfStylePropertiesSet.TextProperties));</span>
            }
          }
<span class="nc" id="L1789">          applyStyleOnText(parentElement, startPos, endPos, attrs);</span>
        }
      }
    }
<span class="nc" id="L1793">  }</span>

  private static void changeDrawingSizeAndPos(Node child, double heightFactor, double widthFactor) {
<span class="nc bnc" id="L1796" title="All 2 branches missed.">    while (child != null) {</span>
<span class="nc bnc" id="L1797" title="All 2 branches missed.">      if (child instanceof DrawGElement) {</span>
<span class="nc" id="L1798">        changeDrawingSizeAndPos(child.getFirstChild(), heightFactor, widthFactor);</span>
      } else {
<span class="nc" id="L1800">        DrawShapeElementBase drawElementBase = (DrawShapeElementBase) child;</span>
<span class="nc bnc" id="L1801" title="All 2 branches missed.">        if (heightFactor != 1.) {</span>
<span class="nc" id="L1802">          String heightAttr = drawElementBase.getSvgHeightAttribute();</span>
<span class="nc bnc" id="L1803" title="All 2 branches missed.">          if (heightAttr != null) {</span>
<span class="nc" id="L1804">            int height = MapHelper.normalizeLength(heightAttr);</span>
<span class="nc" id="L1805">            height *= heightFactor;</span>
<span class="nc" id="L1806">            drawElementBase.setSvgHeightAttribute(height / 100.0 + &quot;mm&quot;);</span>
          }
<span class="nc" id="L1808">          String yAttr = drawElementBase.getSvgYAttribute();</span>
<span class="nc bnc" id="L1809" title="All 2 branches missed.">          if (yAttr != null) {</span>
<span class="nc" id="L1810">            int y = MapHelper.normalizeLength(yAttr);</span>
<span class="nc" id="L1811">            y *= heightFactor;</span>
<span class="nc" id="L1812">            drawElementBase.setSvgYAttribute(y / 100.0 + &quot;mm&quot;);</span>
          }
        }
<span class="nc bnc" id="L1815" title="All 2 branches missed.">        if (widthFactor != 1.) {</span>
<span class="nc" id="L1816">          String widthAttr = drawElementBase.getSvgWidthAttribute();</span>
<span class="nc bnc" id="L1817" title="All 2 branches missed.">          if (widthAttr != null) {</span>
<span class="nc" id="L1818">            int width = MapHelper.normalizeLength(widthAttr);</span>
<span class="nc" id="L1819">            width *= widthFactor;</span>
<span class="nc" id="L1820">            drawElementBase.setSvgWidthAttribute(width / 100.0 + &quot;mm&quot;);</span>
          }
<span class="nc" id="L1822">          String xAttr = drawElementBase.getSvgXAttribute();</span>
<span class="nc bnc" id="L1823" title="All 2 branches missed.">          if (xAttr != null) {</span>
<span class="nc" id="L1824">            int x = MapHelper.normalizeLength(xAttr);</span>
<span class="nc" id="L1825">            x *= widthFactor;</span>
<span class="nc" id="L1826">            drawElementBase.setSvgXAttribute(x / 100.0 + &quot;mm&quot;);</span>
          }
        }
      }
<span class="nc" id="L1830">      child = child.getNextSibling();</span>
    }
<span class="nc" id="L1832">  }</span>

  /**
   * Adds a reference of a cell style to the column element (bad ODF design column style should
   * better have cell style families)
   *
   * @param lineElement either the row or the column
   */
  private static void setDefaultAttribute(OdfStylableElement lineElement, JSONObject attrs) {
<span class="nc" id="L1841">    JSONObject cellProps = attrs.optJSONObject(&quot;cell&quot;);</span>
<span class="nc" id="L1842">    JSONObject characterProps = attrs.optJSONObject(&quot;character&quot;);</span>
<span class="nc bnc" id="L1843" title="All 4 branches missed.">    if (cellProps != null || characterProps != null) {</span>
      // NOT YET SPECIFIED AS OPERATION:
      // JSONObject characterProps = attrs.optJSONObject(&quot;paragraph&quot;);
<span class="nc bnc" id="L1846" title="All 2 branches missed.">      if (cellProps != null</span>
<span class="nc bnc" id="L1847" title="All 4 branches missed.">          &amp;&amp; cellProps.equals(JSONObject.NULL)</span>
          &amp;&amp; characterProps != null
<span class="nc bnc" id="L1849" title="All 2 branches missed.">          &amp;&amp; characterProps.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L1850">        lineElement.removeAttributeNS(</span>
<span class="nc" id="L1851">            OdfDocumentNamespace.TABLE.getUri(), &quot;default-cell-style-name&quot;);</span>
      } else {
<span class="nc" id="L1853">        String defaultCellTemplateStyleName = null;</span>
<span class="nc" id="L1854">        StyleStyleElement autoStyle = null;</span>
<span class="nc" id="L1855">        OdfStyle existingDefaultCellStyle = null;</span>

<span class="nc" id="L1857">        String defaultCellStyleName =</span>
<span class="nc" id="L1858">            lineElement.getAttributeNS(</span>
<span class="nc" id="L1859">                OdfDocumentNamespace.TABLE.getUri(), &quot;default-cell-style-name&quot;);</span>
        // if there is already a default cell style
<span class="nc bnc" id="L1861" title="All 2 branches missed.">        if (defaultCellStyleName != null) {</span>
<span class="nc" id="L1862">          OdfOfficeAutomaticStyles autoStyles = lineElement.getOrCreateAutomaticStyles();</span>
          // check if this style exists in the automatic styles
<span class="nc" id="L1864">          existingDefaultCellStyle =</span>
<span class="nc" id="L1865">              autoStyles.getStyle(defaultCellStyleName, OdfStyleFamily.TableCell);</span>
<span class="nc bnc" id="L1866" title="All 2 branches missed.">          if (existingDefaultCellStyle</span>
              == null) { // if not within automatic style, its a template style
<span class="nc" id="L1868">            autoStyle =</span>
<span class="nc" id="L1869">                lineElement.getOrCreateUnqiueAutomaticStyle(</span>
                    Boolean.FALSE, OdfStyleFamily.TableCell);
<span class="nc" id="L1871">            defaultCellTemplateStyleName = defaultCellStyleName;</span>
          } else {
<span class="nc" id="L1873">            autoStyle = existingDefaultCellStyle;</span>
<span class="nc" id="L1874">            defaultCellTemplateStyleName =</span>
<span class="nc" id="L1875">                existingDefaultCellStyle.getStyleParentStyleNameAttribute();</span>
          }
<span class="nc" id="L1877">        } else {</span>
<span class="nc" id="L1878">          autoStyle =</span>
<span class="nc" id="L1879">              lineElement.getOrCreateUnqiueAutomaticStyle(Boolean.FALSE, OdfStyleFamily.TableCell);</span>
        }

<span class="nc bnc" id="L1882" title="All 4 branches missed.">        if (defaultCellTemplateStyleName != null &amp;&amp; !defaultCellTemplateStyleName.isEmpty()) {</span>
<span class="nc" id="L1883">          autoStyle.setAttributeNS(</span>
<span class="nc" id="L1884">              OdfDocumentNamespace.STYLE.getUri(),</span>
              &quot;style:parent-style-name&quot;,
              defaultCellTemplateStyleName);
        }
<span class="nc" id="L1888">        mapProperties(</span>
            OdfStyleFamily.TableCell,
            attrs,
            autoStyle,
<span class="nc" id="L1892">            (OdfDocument) ((OdfFileDom) lineElement.getOwnerDocument()).getDocument());</span>
<span class="nc" id="L1893">        lineElement.setAttributeNS(</span>
<span class="nc" id="L1894">            OdfDocumentNamespace.TABLE.getUri(),</span>
            &quot;table:default-cell-style-name&quot;,
<span class="nc" id="L1896">            autoStyle.getStyleNameAttribute());</span>
      }
    }
<span class="nc" id="L1899">  }</span>

  private static int getDefaultOutlineLevelFromStyleHierarchy(
      TextParagraphElementBase paragraphBaseElement) {
<span class="nc" id="L1903">    OdfStyle style = paragraphBaseElement.getDocumentStyle();</span>
<span class="nc" id="L1904">    int outlineLevel = getStyleOutlineLevel(style);</span>

<span class="nc bnc" id="L1906" title="All 2 branches missed.">    if (style != null) {</span>
      // if no outline Level was set, but there is a parentComponentElement
<span class="nc bnc" id="L1908" title="All 2 branches missed.">      if (outlineLevel == NO_OUTLINE_LEVEL) {</span>
<span class="nc" id="L1909">        OdfStyleBase parentStyle = null;</span>
<span class="nc" id="L1910">        style.getParentStyle();</span>
<span class="nc bnc" id="L1911" title="All 2 branches missed.">        while (outlineLevel == NO_OUTLINE_LEVEL) {</span>
<span class="nc" id="L1912">          outlineLevel = getStyleOutlineLevel(parentStyle);</span>
<span class="nc bnc" id="L1913" title="All 2 branches missed.">          if (outlineLevel != NO_OUTLINE_LEVEL) {</span>
<span class="nc" id="L1914">            break;</span>
          }
<span class="nc bnc" id="L1916" title="All 2 branches missed.">          if (parentStyle instanceof OdfStyle) {</span>
<span class="nc" id="L1917">            parentStyle = ((OdfStyle) parentStyle).getParentStyle();</span>
          } else {
            break;
          }
<span class="nc bnc" id="L1921" title="All 2 branches missed.">          if (parentStyle == null) {</span>
<span class="nc" id="L1922">            break;</span>
          }
        }
      }
    }
<span class="nc" id="L1927">    return outlineLevel;</span>
  }

  private static final int NO_OUTLINE_LEVEL = -2;

  private static int getStyleOutlineLevel(OdfStyleBase style) {
<span class="nc" id="L1933">    int outlineLevel = NO_OUTLINE_LEVEL;</span>
<span class="nc bnc" id="L1934" title="All 2 branches missed.">    if (style != null) {</span>
      String outlineLevelValue;
<span class="nc bnc" id="L1936" title="All 2 branches missed.">      if (style.hasAttributeNS(OdfDocumentNamespace.STYLE.getUri(), &quot;default-outline-level&quot;)) {</span>
<span class="nc" id="L1937">        outlineLevelValue =</span>
<span class="nc" id="L1938">            style.getAttributeNS(OdfDocumentNamespace.STYLE.getUri(), &quot;default-outline-level&quot;);</span>
<span class="nc bnc" id="L1939" title="All 4 branches missed.">        if (outlineLevelValue != null &amp;&amp; !outlineLevelValue.isEmpty()) {</span>
<span class="nc" id="L1940">          outlineLevel = Integer.parseInt(outlineLevelValue);</span>
        }
      }
    }
<span class="nc" id="L1944">    return outlineLevel;</span>
  }

  /**
   * Exchanges a &lt;text:p&gt; element to a &lt;text:h&gt; when the paragraph receives an outline level. In
   * addition the c is always updated with the latest element reference.
   */
  private static TextParagraphElementBase ensureCorrectParagraphElement(
      int outlineLevel, TextParagraphElementBase rootElement, Component c) {
<span class="nc" id="L1953">    TextParagraphElementBase newElement = null;</span>
<span class="nc bnc" id="L1954" title="All 2 branches missed.">    if (outlineLevel &gt; -1) {</span>
      // switch to a heading
<span class="nc bnc" id="L1956" title="All 2 branches missed.">      if (!(rootElement instanceof TextHElement)) {</span>
<span class="nc" id="L1957">        newElement = new TextHElement((OdfFileDom) rootElement.getOwnerDocument());</span>
        // addChild the outline level to the element
<span class="nc" id="L1959">        ((TextHElement) newElement).setTextOutlineLevelAttribute(outlineLevel);</span>
      } else {
<span class="nc" id="L1961">        ((TextHElement) rootElement).setTextOutlineLevelAttribute(outlineLevel);</span>
      }

      // } else if (outlineLevel == -1) {
      // The above should work, but is not supported by Frontend, issue?
    } else {
      // switch to a paragraph
<span class="nc bnc" id="L1968" title="All 2 branches missed.">      if (!(rootElement instanceof TextPElement)) {</span>
<span class="nc" id="L1969">        newElement = new TextPElement((OdfFileDom) rootElement.getOwnerDocument());</span>
        // remove the outline level to the element
      }
<span class="nc" id="L1972">      rootElement.removeAttributeNS(OdfDocumentNamespace.TEXT.getUri(), &quot;outline-level&quot;);</span>
    }
    // if the type have to be changed, clone everything from the old to the new element
<span class="nc bnc" id="L1975" title="All 2 branches missed.">    if (newElement != null) {</span>
<span class="nc" id="L1976">      OdfElement parent = (OdfElement) rootElement.getParentNode();</span>
<span class="nc" id="L1977">      parent.replaceChild(newElement, rootElement);</span>
      // copy/attributes and content
<span class="nc" id="L1979">      OdfElement.cloneNode(rootElement, newElement, true);</span>
<span class="nc" id="L1980">      c.setRootElement(newElement);</span>
      // adding back reference from element to c
<span class="nc" id="L1982">      ((OdfElement) newElement).setComponent(c);</span>
<span class="nc" id="L1983">    } else {</span>
      // adding back reference from element to c
<span class="nc" id="L1985">      ((OdfElement) rootElement).setComponent(c);</span>
<span class="nc" id="L1986">      newElement = rootElement;</span>
    }
<span class="nc" id="L1988">    return newElement;</span>
  }

  /**
   * Deletes all hyperlink and template styles from any span/anchor in this area * Extends the
   * recursive delete function, whenever a component was found within a span/anchor it will be moved
   * in front of it. Empty spans/anchor will be deleted!
   *
   * &lt;p&gt;ToDo: On demand cloning? Man traversiert den Baum durch und fuegt alles in ein temporaes
   * Element ein? Oder gleich an den Anfang des Paragraphen? splitParagraph muesste die gleiche
   * Funktionalitaet bekommen. Anchor wird nicht uebernommen!
   */
  private static void setParagraphListProperties(
      TextParagraphElementBase paragraphBaseElement,
      JSONObject paraProps,
      OdfFileDom xmlDoc,
      int listLevel,
      int newListLevel,
      String currentListStyleName) {
    // Taking the component, to update the root XML element at the end
<span class="nc" id="L2008">    Component c = paragraphBaseElement.getComponent();</span>
    // Will the listlevel change)
<span class="nc bnc" id="L2010" title="All 2 branches missed.">    if (listLevel != newListLevel) {</span>
      // if there has been already a list
<span class="nc bnc" id="L2012" title="All 2 branches missed.">      if (listLevel &gt; -1) {</span>
<span class="nc bnc" id="L2013" title="All 2 branches missed.">        if (newListLevel &gt; listLevel) {</span>
          // raise the level of lists
<span class="nc" id="L2015">          addListLevel(</span>
              paragraphBaseElement,
              newListLevel - listLevel,
              paraProps,
              xmlDoc,
              currentListStyleName);
        } else {
          // lower the level of lists
<span class="nc" id="L2023">          removeListLevel(</span>
              paragraphBaseElement, listLevel - newListLevel, paraProps, currentListStyleName);
        }
      } else { // there is no list yet (level plus one as it start counting with 0)
<span class="nc" id="L2027">        addListLevel(</span>
            paragraphBaseElement, newListLevel + 1, paraProps, xmlDoc, currentListStyleName);
      }
    }
    // Add list style and xml id to the top most list element
<span class="nc" id="L2032">    addTopListElementAttributes(</span>
<span class="nc" id="L2033">        getListRootElement(paragraphBaseElement), paraProps, null, currentListStyleName);</span>
    // Updating the XML root element, after (possibly) exchanging it due to addition/less list-item
    // levels
<span class="nc" id="L2036">    c.setRootElement(paragraphBaseElement);</span>
<span class="nc" id="L2037">  }</span>

  /** ToDo after release: Move this to the paragraph of ODFDOM */
  public static int getListLevel(TextParagraphElementBase paragraphBaseElement) {
<span class="nc" id="L2041">    return getListLevel(paragraphBaseElement, -1);</span>
  }

  /** Count the ancestor &lt;text:list&gt; elements to receive the list level */
  private static int getListLevel(OdfElement element, int listLevel) {
<span class="nc" id="L2046">    OdfElement parent = (OdfElement) element.getParentNode();</span>
<span class="nc bnc" id="L2047" title="All 2 branches missed.">    if (parent instanceof TextListElement) {</span>
<span class="nc" id="L2048">      listLevel = getListLevel(parent, listLevel) + 1;</span>
<span class="nc bnc" id="L2049" title="All 4 branches missed.">    } else if (parent instanceof TextListItemElement || parent instanceof TextListHeaderElement) {</span>
<span class="nc" id="L2050">      listLevel = getListLevel(parent, listLevel);</span>
    }
<span class="nc" id="L2052">    return listLevel;</span>
  }

  /**
   * Isolates the paragraph as only paragraph of the list. For instance, required to be able to
   * addChild a component before/behind that paragraph in the DOM.
   *
   * @param paragraphBaseElement the paragraph within a list
   * @return the root text:list element of the list
   */
  public static TextListElement isolateListParagraph(
      TextParagraphElementBase paragraphBaseElement) {
<span class="nc" id="L2064">    TextListElement rootListElement = null;</span>
<span class="nc" id="L2065">    Element parentElement = (Element) paragraphBaseElement.getParentNode();</span>
<span class="nc bnc" id="L2066" title="All 4 branches missed.">    if (parentElement instanceof TextListItemElement</span>
        || parentElement instanceof TextListHeaderElement) {
      // ToDo: To be moved to paragraph of ODFDOM
<span class="nc" id="L2069">      int listLevel = JsonOperationConsumer.getListLevel(paragraphBaseElement);</span>

      String listStyleName;
<span class="nc" id="L2072">      rootListElement = getListRootElement(paragraphBaseElement);</span>
<span class="nc bnc" id="L2073" title="All 2 branches missed.">      if (rootListElement != null) {</span>
<span class="nc" id="L2074">        listStyleName = rootListElement.getTextStyleNameAttribute();</span>
<span class="nc" id="L2075">        removeListLevel(paragraphBaseElement, listLevel + 1, null, null);</span>
<span class="nc" id="L2076">        TextListElement newRootListElement =</span>
<span class="nc" id="L2077">            addListLevel(</span>
                paragraphBaseElement,
                listLevel + 1,
                null,
<span class="nc" id="L2081">                (OdfFileDom) paragraphBaseElement.getOwnerDocument(),</span>
                listStyleName);
<span class="nc bnc" id="L2083" title="All 2 branches missed.">        if (newRootListElement != null) {</span>
<span class="nc" id="L2084">          rootListElement = newRootListElement;</span>
        }
      }
    }
<span class="nc" id="L2088">    return rootListElement;</span>
  }

  /**
   * Removal of list level starts bottom-up from the lowest list level. The reason is that by
   * component position only the selected paragraph can be found. The paragraph element is nested
   * within all list &amp; list-items and has the deepest element position.
   *
   * &lt;p&gt;If there the paragraphs has preceding and following list content the list has to be split.
   * For this reason it the list will be cloned.
   *
   * &lt;p&gt;As xml:id attributes have to be kept and are not being cloned, the clone will become the
   * latter part and the original list the prior part.
   *
   * &lt;p&gt;From the cloned part all content from the beginning including the marked paragraph are
   * deleted.
   *
   * &lt;p&gt;From the original part all content after the paragraph is being deleted.
   *
   * &lt;p&gt;In addition if the paragraph is not the last, there has to be another clone. In the first
   * clone all following paragraphs are being deleted, in the other last all preceding paragraphs
   * are removed. The same procedure for paragraphs has to be undertaken for text:list-item &amp;
   * text:list-head elements!
   */
  private static void removeListLevel(
      TextParagraphElementBase paragraphBaseElement,
      int levelsToDelete,
      JSONObject paraProps,
      String currentListStyleName) {
    // ToDo: Differentiate between list-header and list-item!!
<span class="nc bnc" id="L2118" title="All 2 branches missed.">    if (levelsToDelete &gt; 0) {</span>
      // Checks for preceding paragraphs, lists or list-items before the current list-item
<span class="nc" id="L2120">      boolean hasPrecedingListContent =</span>
<span class="nc bnc" id="L2121" title="All 2 branches missed.">          OdfElement.getPreviousSiblingElement(paragraphBaseElement) != null</span>
<span class="nc bnc" id="L2122" title="All 2 branches missed.">              || OdfElement.getPreviousSiblingElement(paragraphBaseElement.getParentNode()) != null;</span>
      // Checks for following paragraphs, lists or list-items after the current list-item
<span class="nc" id="L2124">      boolean hasFollowingListContent =</span>
<span class="nc bnc" id="L2125" title="All 2 branches missed.">          OdfElement.getNextSiblingElement(paragraphBaseElement) != null</span>
<span class="nc bnc" id="L2126" title="All 2 branches missed.">              || OdfElement.getNextSiblingElement(paragraphBaseElement.getParentNode()) != null;</span>

      // if the paragraph is not the first and nor the last component, get the root of the list to
      // clone the element
      // The parentComponentElement of the paragraph is either a &lt;text:list-item&gt; or
      // &lt;text:list-header&gt;, its parentComponentElement is the desired &lt;text:list&gt; element
<span class="nc" id="L2132">      paragraphBaseElement.setAttribute(&quot;selectedParagraph&quot;, &quot;true&quot;);</span>
<span class="nc" id="L2133">      OdfElement pContainer = (OdfElement) paragraphBaseElement.getParentNode();</span>
<span class="nc bnc" id="L2134" title="All 2 branches missed.">      if (pContainer instanceof TextListHeaderElement) {</span>
<span class="nc" id="L2135">        paragraphBaseElement.setAttribute(&quot;hiddenParagraph&quot;, &quot;true&quot;);</span>
      }
<span class="nc" id="L2137">      OdfElement lowestListElement = (OdfElement) pContainer.getParentNode();</span>

<span class="nc" id="L2139">      TextListElement clonedListWithFollowingContent = null;</span>
      // if there has been content before the paragraph, clone this content
<span class="nc bnc" id="L2141" title="All 2 branches missed.">      if (hasPrecedingListContent) {</span>
<span class="nc bnc" id="L2142" title="All 2 branches missed.">        if (hasFollowingListContent) {</span>
          // *** CASE 3 ***: Dealing with following list content
          // clone current list for following content
<span class="nc" id="L2145">          clonedListWithFollowingContent = (TextListElement) lowestListElement.cloneNode(true);</span>
<span class="nc" id="L2146">          Component selectedParagraphComponent = paragraphBaseElement.getComponent();</span>
<span class="nc" id="L2147">          int positionOfSelectedParagraph =</span>
<span class="nc" id="L2148">              selectedParagraphComponent.getParent().indexOf(selectedParagraphComponent);</span>
<span class="nc" id="L2149">          adjustComponentReferences(</span>
              -1,
              positionOfSelectedParagraph,
              selectedParagraphComponent,
              clonedListWithFollowingContent);

          // only the FOLLOWING content is of interest, therefore delete everything BEFORE the
          // selected paragraph
<span class="nc" id="L2157">          deleteBeforeAndSelectedParagraph(clonedListWithFollowingContent);</span>
        }
        // *** CASE 1 &amp; 3 ***: handling preceding list content
        // only the PRECEDING content is of interest, therefore delete everything AFTER the selected
        // paragraph (including the paragraph)
<span class="nc" id="L2162">        deleteFromSelectedParagraph(lowestListElement);</span>

<span class="nc" id="L2164">        boolean listLabelHidden = false;</span>
        // if there is no previous sibling and hidden, we need a list-header
<span class="nc bnc" id="L2166" title="All 4 branches missed.">        if (paraProps != null &amp;&amp; paraProps.has(&quot;listLabelHidden&quot;)) {</span>
<span class="nc" id="L2167">          listLabelHidden = paraProps.optBoolean(&quot;listLabelHidden&quot;, Boolean.FALSE);</span>
        }
<span class="nc bnc" id="L2169" title="All 2 branches missed.">        if (listLabelHidden) {</span>
          OdfElement elementForInsertion;
          OdfElement newParentElement;

          // if there is no preceding content, we need to move the paragraph into a list-header
          // element
<span class="nc bnc" id="L2175" title="All 2 branches missed.">          if (hasPrecedingListContent) {</span>
            // if the list item is shown the paragraph has to be in a list-item
<span class="nc" id="L2177">            newParentElement = (OdfElement) lowestListElement.getParentNode().getParentNode();</span>
            // Create new List Item
<span class="nc" id="L2179">            TextListHeaderElement newListHeaderElement =</span>
<span class="nc" id="L2180">                new TextListHeaderElement((OdfFileDom) paragraphBaseElement.getOwnerDocument());</span>
<span class="nc" id="L2181">            newListHeaderElement.appendChild(paragraphBaseElement);</span>
<span class="nc" id="L2182">            elementForInsertion = newListHeaderElement;</span>

<span class="nc" id="L2184">          } else {</span>
            // if the list item is hidden it will be placed stand alone (or in a list-header at list
            // beginning)
<span class="nc" id="L2187">            newParentElement = (OdfElement) lowestListElement.getParentNode();</span>
            // Create new List Item
<span class="nc" id="L2189">            elementForInsertion = paragraphBaseElement;</span>
          }
<span class="nc" id="L2191">          OdfElement nextListSiblingElement = OdfElement.getNextSiblingElement(lowestListElement);</span>
          // if we are at the end of the list
<span class="nc bnc" id="L2193" title="All 2 branches missed.">          if (nextListSiblingElement == null) {</span>
<span class="nc" id="L2194">            newParentElement.appendChild(elementForInsertion);</span>
<span class="nc bnc" id="L2195" title="All 2 branches missed.">            if (clonedListWithFollowingContent != null) {</span>
<span class="nc" id="L2196">              newParentElement.appendChild(clonedListWithFollowingContent);</span>
            }
          } else { // if we are in the middle of the list
<span class="nc" id="L2199">            newParentElement.insertBefore(elementForInsertion, nextListSiblingElement);</span>
<span class="nc bnc" id="L2200" title="All 2 branches missed.">            if (clonedListWithFollowingContent != null) {</span>
<span class="nc" id="L2201">              newParentElement.insertBefore(clonedListWithFollowingContent, nextListSiblingElement);</span>
            }
          }
<span class="nc" id="L2204">        } else {</span>
<span class="nc" id="L2205">          boolean isTopLevelList = false;</span>
          OdfElement elementForInsertion;
          OdfElement newParentElement;

          // parentComponentElement is a list element
          // as if the list item is shown the paragraph has to be in a list-item
<span class="nc" id="L2211">          OdfElement listItemPrecedingSibling = (OdfElement) lowestListElement.getParentNode();</span>
          OdfElement listItemFollowingSibling;
<span class="nc bnc" id="L2213" title="All 4 branches missed.">          if (listItemPrecedingSibling instanceof TextListItemElement</span>
              || listItemPrecedingSibling instanceof TextListHeaderElement) {
<span class="nc" id="L2215">            newParentElement = (OdfElement) listItemPrecedingSibling.getParentNode();</span>
<span class="nc" id="L2216">            listItemFollowingSibling = OdfElement.getNextSiblingElement(listItemPrecedingSibling);</span>
            // Create new List Item
<span class="nc" id="L2218">            TextListItemElement newListItemElement =</span>
<span class="nc" id="L2219">                new TextListItemElement((OdfFileDom) paragraphBaseElement.getOwnerDocument());</span>
<span class="nc" id="L2220">            newListItemElement.appendChild(paragraphBaseElement);</span>
<span class="nc" id="L2221">            elementForInsertion = newListItemElement;</span>
<span class="nc" id="L2222">          } else {</span>
<span class="nc" id="L2223">            isTopLevelList = true;</span>
<span class="nc" id="L2224">            elementForInsertion = paragraphBaseElement;</span>
<span class="nc" id="L2225">            newParentElement = listItemPrecedingSibling;</span>
<span class="nc" id="L2226">            listItemFollowingSibling = OdfElement.getNextSiblingElement(lowestListElement);</span>
          }

          //					OdfElement nextListSiblingElement =
          // OdfElement.getNextSiblingElement(lowestListElement);
          // if we are at the end of the list
<span class="nc bnc" id="L2232" title="All 2 branches missed.">          if (listItemFollowingSibling == null) {</span>
<span class="nc" id="L2233">            newParentElement.appendChild(elementForInsertion);</span>
<span class="nc bnc" id="L2234" title="All 2 branches missed.">            if (clonedListWithFollowingContent != null) {</span>
<span class="nc" id="L2235">              newParentElement.appendChild(clonedListWithFollowingContent);</span>
            }

<span class="nc bnc" id="L2238" title="All 2 branches missed.">            if (clonedListWithFollowingContent != null) {</span>
<span class="nc bnc" id="L2239" title="All 2 branches missed.">              if (isTopLevelList) {</span>
                // Create new List Item
<span class="nc" id="L2241">                newParentElement.appendChild(clonedListWithFollowingContent);</span>

              } else {
                // Create new List Item
<span class="nc" id="L2245">                TextListItemElement newListItemElement =</span>
<span class="nc" id="L2246">                    new TextListItemElement((OdfFileDom) paragraphBaseElement.getOwnerDocument());</span>
<span class="nc" id="L2247">                newListItemElement.appendChild(clonedListWithFollowingContent);</span>
<span class="nc" id="L2248">                newParentElement.appendChild(newListItemElement);</span>
<span class="nc" id="L2249">              }</span>
            }
          } else { // if we are in the middle of the list
<span class="nc" id="L2252">            newParentElement.insertBefore(elementForInsertion, listItemFollowingSibling);</span>
<span class="nc bnc" id="L2253" title="All 2 branches missed.">            if (clonedListWithFollowingContent != null) {</span>
<span class="nc bnc" id="L2254" title="All 2 branches missed.">              if (isTopLevelList) {</span>
                // Create new List Item
<span class="nc" id="L2256">                newParentElement.insertBefore(</span>
                    clonedListWithFollowingContent, listItemFollowingSibling);
              } else {
                // Create new List Item
<span class="nc" id="L2260">                TextListItemElement newListItemElement =</span>
<span class="nc" id="L2261">                    new TextListItemElement((OdfFileDom) paragraphBaseElement.getOwnerDocument());</span>
<span class="nc" id="L2262">                newListItemElement.appendChild(clonedListWithFollowingContent);</span>
<span class="nc" id="L2263">                newParentElement.insertBefore(newListItemElement, listItemFollowingSibling);</span>
              }
            }
          }
        }
<span class="nc" id="L2268">      } else {</span>
<span class="nc bnc" id="L2269" title="All 2 branches missed.">        if (hasFollowingListContent) {</span>
          // *** CASE 2 ***: Ony following list content
          // the list is moved after the paragraph, remove the paragraph out of the list
<span class="nc" id="L2272">          deleteBeforeAndSelectedParagraph(lowestListElement);</span>
<span class="nc" id="L2273">          Node listParent = lowestListElement.getParentNode();</span>
<span class="nc" id="L2274">          listParent.insertBefore(paragraphBaseElement, lowestListElement);</span>
<span class="nc" id="L2275">        } else {</span>
          // *** CASE 0 ***: ALONE - the paragraph was alone in the list parentComponentElement,
          // just replace the paragraph with list
<span class="nc" id="L2278">          Node listParent = lowestListElement.getParentNode();</span>
<span class="nc" id="L2279">          listParent.replaceChild(paragraphBaseElement, lowestListElement);</span>
<span class="nc" id="L2280">          lowestListElement = null;</span>
        }
      }

      // **** FIXING STYLES
      // if list element is a top list element (this happens if the list element has not list
      // header/item as parentComponentElement)
<span class="nc bnc" id="L2287" title="All 2 branches missed.">      if (lowestListElement != null</span>
<span class="nc bnc" id="L2288" title="All 2 branches missed.">          &amp;&amp; !(lowestListElement.getParentNode() instanceof TextListItemElement)</span>
<span class="nc bnc" id="L2289" title="All 2 branches missed.">          &amp;&amp; !(lowestListElement.getParentNode() instanceof TextListHeaderElement)) {</span>
<span class="nc" id="L2290">        OdfElement previousSiblingElement = OdfElement.getPreviousSiblingElement(lowestListElement);</span>
<span class="nc" id="L2291">        String previousListStyleId = null;</span>
<span class="nc bnc" id="L2292" title="All 2 branches missed.">        if (previousSiblingElement instanceof TextListElement) {</span>
<span class="nc" id="L2293">          previousListStyleId =</span>
<span class="nc" id="L2294">              ((TextListElement) previousSiblingElement).getTextStyleNameAttribute();</span>
        }
<span class="nc bnc" id="L2296" title="All 2 branches missed.">        if (currentListStyleName == null) {</span>
<span class="nc" id="L2297">          currentListStyleName = ((TextListElement) lowestListElement).getTextStyleNameAttribute();</span>
        }

        // Add list style and xml id to the top most list element
<span class="nc" id="L2301">        addTopListElementAttributes(</span>
<span class="nc" id="L2302">            getListRootElement(paragraphBaseElement),</span>
            paraProps,
            previousListStyleId,
            currentListStyleName);

<span class="nc bnc" id="L2307" title="All 2 branches missed.">        if (clonedListWithFollowingContent != null) {</span>
          // parameter properties have to be zero, as the existing styles should take precedence
<span class="nc" id="L2309">          addTopListElementAttributes(</span>
              clonedListWithFollowingContent, null, previousListStyleId, currentListStyleName);
        }
      }
      // removing another pairs of &lt;text:list&gt; and &lt;text:list-item&gt; or &lt;text:list-header&gt;
<span class="nc" id="L2314">      removeListLevel(paragraphBaseElement, --levelsToDelete, paraProps, currentListStyleName);</span>
<span class="nc" id="L2315">    } else {</span>
<span class="nc bnc" id="L2316" title="All 2 branches missed.">      if (paragraphBaseElement.hasAttribute(&quot;selectedParagraph&quot;)) {</span>
<span class="nc" id="L2317">        paragraphBaseElement.removeAttribute(&quot;selectedParagraph&quot;);</span>
      }
    }
<span class="nc" id="L2320">  }</span>

  private static void deleteBeforeAndSelectedParagraph(Element listElement) {
<span class="nc" id="L2323">    listContentRemoval(listElement, true);</span>
<span class="nc" id="L2324">  }</span>

  private static void deleteFromSelectedParagraph(Element listElement) {
<span class="nc" id="L2327">    listContentRemoval(listElement, false);</span>
<span class="nc" id="L2328">  }</span>

  /**
   * Loops through elements of a list. There can only be list-item/header children and within those
   * paragraphs. Within one paragraph an attribute was set. According to the given parameters the
   * content before and/or after this paragraph is being deleted
   */
  private static void listContentRemoval(Element listElement, boolean deleteBeforeSelection) {
    // deleteAfterSelection: All content after the selected paragraph in document order is being
    // deleted
    // deleteBeforeSelection: The opposite, only one of both modes exists, the selected paragraph is
    // always deleted
<span class="nc bnc" id="L2340" title="All 2 branches missed.">    boolean deleteAfterSelection = !deleteBeforeSelection;</span>
    // searching backwards the list for the correct list item (to not corrupt the node list by
    // removing its content while iterating)
<span class="nc" id="L2343">    boolean isAfterSelectedParagraph = false;</span>
<span class="nc" id="L2344">    boolean isSelectedParagraph = false;</span>
<span class="nc" id="L2345">    NodeList listChildren = ((TextListElement) listElement).getChildNodes();</span>
<span class="nc bnc" id="L2346" title="All 2 branches missed.">    for (int i = listChildren.getLength() - 1; i &gt;= 0; i--) {</span>
<span class="nc" id="L2347">      Node listItem = listChildren.item(i);</span>
      // check if it is really a list item/header and not for instance a text line break
<span class="nc bnc" id="L2349" title="All 2 branches missed.">      if (listItem instanceof Element) {</span>
<span class="nc" id="L2350">        NodeList listItemParagraphs = listItem.getChildNodes();</span>
        // as the remove items from the node list we need to count back..
<span class="nc bnc" id="L2352" title="All 2 branches missed.">        for (int j = listItemParagraphs.getLength() - 1; j &gt;= 0; j--) {</span>
<span class="nc" id="L2353">          Node listItemParagraph = listItemParagraphs.item(j);</span>
          // check if it is really a list item/header and not for instance a text line break
<span class="nc bnc" id="L2355" title="All 2 branches missed.">          if (listItemParagraph instanceof OdfElement) {</span>
            // If selected paragraph not found yet
<span class="nc bnc" id="L2357" title="All 2 branches missed.">            if (!isAfterSelectedParagraph) {</span>
              // check if the content element is the selected paragraph
<span class="nc bnc" id="L2359" title="All 2 branches missed.">              if (((OdfElement) listItemParagraph).hasAttribute(&quot;selectedParagraph&quot;)) {</span>
<span class="nc" id="L2360">                isAfterSelectedParagraph = true;</span>
<span class="nc" id="L2361">                isSelectedParagraph = true;</span>
                // the selected character will always be removed
<span class="nc" id="L2363">                listItem.removeChild(listItemParagraph);</span>
                // if no deletion before the selection is required..
<span class="nc bnc" id="L2365" title="All 2 branches missed.">                if (!deleteBeforeSelection) {</span>
                  // stop here..
<span class="nc" id="L2367">                  break;</span>
                }
<span class="nc bnc" id="L2369" title="All 2 branches missed.">              } else if (deleteAfterSelection) {</span>
                // IF DESIRED.. delete earlier content
<span class="nc" id="L2371">                listItem.removeChild(listItemParagraph);</span>
              }
<span class="nc bnc" id="L2373" title="All 2 branches missed.">            } else if (deleteBeforeSelection) {</span>
              // IF DESIRED.. delete LATER content
<span class="nc" id="L2375">              listItem.removeChild(listItemParagraph);</span>
            }
<span class="nc bnc" id="L2377" title="All 2 branches missed.">          } else if (listItemParagraph instanceof Text) {</span>
            // removing indentation
<span class="nc" id="L2379">            listItem.removeChild(listItemParagraph);</span>
          }
        }

<span class="nc bnc" id="L2383" title="All 4 branches missed.">        if (isAfterSelectedParagraph &amp;&amp; !deleteBeforeSelection) {</span>

          //					// if the last content was removed..
          //					if (listItemParagraphs.getLength() == 0) {
          //						// remove the list itself
          //						Element parentComponentElement = (Element) listItem.getParentNode();
          //						parentComponentElement.removeChild(listItem);
          //					}
<span class="nc bnc" id="L2391" title="All 2 branches missed.">          if (!listItem.hasChildNodes()) {</span>
            // remove the list itself
<span class="nc" id="L2393">            Element parent = (Element) listItem.getParentNode();</span>
<span class="nc" id="L2394">            parent.removeChild(listItem);</span>
<span class="nc" id="L2395">          }</span>
          break;
        } else {
          // only do anything if it is not the selected paragraph
<span class="nc bnc" id="L2399" title="All 2 branches missed.">          if (!isSelectedParagraph) {</span>
            // ..if we are still after
<span class="nc bnc" id="L2401" title="All 2 branches missed.">            if (!isAfterSelectedParagraph) {</span>
              // ..and if the deletion mode is correct..
<span class="nc bnc" id="L2403" title="All 2 branches missed.">              if (deleteAfterSelection) {</span>
                // ..delete list item
<span class="nc" id="L2405">                listElement.removeChild(listItem);</span>
              } else {
<span class="nc bnc" id="L2407" title="All 2 branches missed.">                if (!listItem.hasChildNodes()) {</span>
                  // remove the list itself
<span class="nc" id="L2409">                  Element parent = (Element) listItem.getParentNode();</span>
<span class="nc" id="L2410">                  parent.removeChild(listItem);</span>
<span class="nc" id="L2411">                }</span>
              }
              // else we are before and if the mode is correct..
<span class="nc bnc" id="L2414" title="All 2 branches missed.">            } else if (deleteBeforeSelection) {</span>
              // delete list item
<span class="nc" id="L2416">              listElement.removeChild(listItem);</span>
            }
          } else {
<span class="nc" id="L2419">            isSelectedParagraph = false;</span>
<span class="nc bnc" id="L2420" title="All 2 branches missed.">            if (!listItem.hasChildNodes()) {</span>
              // remove the list itself
<span class="nc" id="L2422">              Element parent = (Element) listItem.getParentNode();</span>
<span class="nc" id="L2423">              parent.removeChild(listItem);</span>
            }
          }
        }
<span class="nc bnc" id="L2427" title="All 2 branches missed.">      } else if (listItem instanceof Text) {</span>
        // removing indentation
<span class="nc" id="L2429">        listElement.removeChild(listItem);</span>
      }
    }
<span class="nc" id="L2432">  }</span>

  /**
   * All paragraph references from the original list to components that occur paragraphs AFTER the
   * selected paragraph have to be moved to the clonedList paragraphs.
   *
   * @param originalListElement Within this list, every paragraph holds a reference to its component
   *     and vice versa
   * @param clonedListElement Within this list, NO paragraph holds a reference to its component and
   *     vice versa *
   */
  private static int adjustComponentReferences(
      int currentParagraphPosition,
      int selectedParagraphPosition,
      Component selectedParagraphComponent,
      Element clonedListElement) {
<span class="nc" id="L2448">    NodeList listChildren = ((TextListElement) clonedListElement).getChildNodes();</span>
<span class="nc bnc" id="L2449" title="All 2 branches missed.">    for (int i = 0; i &lt; listChildren.getLength(); i++) {</span>
<span class="nc" id="L2450">      Node listItem = listChildren.item(i);</span>
      // check if it is really a list item/header and not for instance a text line break
<span class="nc bnc" id="L2452" title="All 2 branches missed.">      if (listItem instanceof Element) {</span>
<span class="nc" id="L2453">        NodeList listItemParagraphs = listItem.getChildNodes();</span>
        // as the remove items from the node list we need to count back..
<span class="nc bnc" id="L2455" title="All 2 branches missed.">        for (int j = 0; j &lt; listItemParagraphs.getLength(); j++) {</span>
<span class="nc" id="L2456">          Node listItemParagraph = listItemParagraphs.item(j);</span>
          // check if it is really a list item/header and not for instance a text line break
<span class="nc bnc" id="L2458" title="All 2 branches missed.">          if (listItemParagraph instanceof OdfElement) {</span>
            // If selected paragraph not found yet
<span class="nc bnc" id="L2460" title="All 2 branches missed.">            if (listItemParagraph instanceof TextParagraphElementBase) {</span>
<span class="nc bnc" id="L2461" title="All 2 branches missed.">              if (currentParagraphPosition == -1) {</span>
<span class="nc bnc" id="L2462" title="All 2 branches missed.">                if (((OdfElement) listItemParagraph).hasAttribute(&quot;selectedParagraph&quot;)) {</span>
<span class="nc" id="L2463">                  currentParagraphPosition = selectedParagraphPosition + 1;</span>
                }
<span class="nc bnc" id="L2465" title="All 2 branches missed.">              } else if (currentParagraphPosition &gt; selectedParagraphPosition) {</span>

                //
                //								if(selectedParagraphComponent.mParent == null){
                //									System.out.println(&quot;x&quot;);
                //								}
                //
                //	if(selectedParagraphComponent.mParent.getChildNode(currentParagraphPosition) ==
                // null){
                //									System.out.println(&quot;yy&quot;);
                //								}
                // Add components to the paragraphs of the second part of the cloned list
<span class="nc" id="L2477">                Component nextComponent =</span>
                    ((OdfElement)
                            selectedParagraphComponent
<span class="nc" id="L2480">                                .getParent()</span>
<span class="nc" id="L2481">                                .getChildNode(currentParagraphPosition))</span>
<span class="nc" id="L2482">                        .getComponent();</span>
<span class="nc" id="L2483">                nextComponent.setRootElement((TextParagraphElementBase) listItemParagraph);</span>
                // adding back reference from element to component
<span class="nc" id="L2485">                ((TextParagraphElementBase) listItemParagraph).setComponent(nextComponent);</span>
<span class="nc" id="L2486">                currentParagraphPosition++;</span>
<span class="nc" id="L2487">              }</span>
<span class="nc bnc" id="L2488" title="All 2 branches missed.">            } else if (listItemParagraph instanceof TextListElement) {</span>
<span class="nc" id="L2489">              currentParagraphPosition =</span>
<span class="nc" id="L2490">                  adjustComponentReferences(</span>
                      currentParagraphPosition,
                      selectedParagraphPosition,
                      selectedParagraphComponent,
                      (TextListElement) listItemParagraph);
            }
          }
        }
      }
    }
<span class="nc" id="L2500">    return currentParagraphPosition;</span>
  }

  /**
   * In theory the list style might be set on any text:list within the nested list-items/headers,
   * but all known offices (AO/LO/MSO) are consistently using the first style
   */
  private static TextListElement getListRootElement(TextParagraphElementBase paragraphBaseElement) {
<span class="nc" id="L2508">    OdfElement root = null;</span>
<span class="nc" id="L2509">    OdfElement parent = (OdfElement) paragraphBaseElement.getParentNode();</span>
<span class="nc bnc" id="L2510" title="All 6 branches missed.">    while (parent instanceof TextListElement</span>
        || parent instanceof TextListItemElement
        || parent instanceof TextListHeaderElement) {
<span class="nc" id="L2513">      root = parent;</span>
<span class="nc" id="L2514">      parent = (OdfElement) parent.getParentNode();</span>
    }
<span class="nc" id="L2516">    return (TextListElement) root;</span>
  }

  /**
   * If a list already exists, new list level will be added inside of the existing list. In the
   * first step of the recursion only the paragraphBase will be replaced by a list, further list
   * will be added in the other addListLevel method recursive.
   */
  private static TextListElement addListLevel(
      TextParagraphElementBase paragraphBaseElement,
      int levelsToCreate,
      JSONObject paraProps,
      OdfFileDom xmlDoc,
      String currentListStyleName) {
<span class="nc" id="L2530">    TextListElement newListElement = null;</span>
    // ToDo: Differentiate between list-header and list-item!!
<span class="nc bnc" id="L2532" title="All 2 branches missed.">    if (levelsToCreate &gt; 0) {</span>
<span class="nc" id="L2533">      OdfElement parent = (OdfElement) paragraphBaseElement.getParentNode();</span>
      // Create new List
<span class="nc" id="L2535">      newListElement = new TextListElement(xmlDoc);</span>

      // if list element is a top list element (this happens if the list element has not list
      // header/item as parentComponentElement)
<span class="nc bnc" id="L2539" title="All 4 branches missed.">      if (!(parent instanceof TextListItemElement) &amp;&amp; !(parent instanceof TextListHeaderElement)) {</span>
<span class="nc" id="L2540">        OdfElement previousSiblingElement =</span>
<span class="nc" id="L2541">            OdfElement.getPreviousSiblingElement(paragraphBaseElement);</span>
<span class="nc" id="L2542">        String previousListStyleId = null;</span>
<span class="nc bnc" id="L2543" title="All 2 branches missed.">        if (previousSiblingElement instanceof TextListElement) {</span>
<span class="nc" id="L2544">          previousListStyleId =</span>
<span class="nc" id="L2545">              ((TextListElement) previousSiblingElement).getTextStyleNameAttribute();</span>
        }
        // Add list style and xml id to the top most list element
<span class="nc" id="L2548">        addTopListElementAttributes(</span>
            newListElement, paraProps, previousListStyleId, currentListStyleName);
      }
<span class="nc" id="L2551">      parent.replaceChild(newListElement, paragraphBaseElement);</span>

<span class="nc" id="L2553">      levelsToCreate--;</span>
<span class="nc bnc" id="L2554" title="All 2 branches missed.">      if (levelsToCreate &gt; 0) {</span>
        // Create new List Item
<span class="nc" id="L2556">        TextListItemElement newListItemElement = new TextListItemElement(xmlDoc);</span>
<span class="nc" id="L2557">        newListElement.appendChild(newListItemElement);</span>
<span class="nc" id="L2558">        newListItemElement.appendChild(paragraphBaseElement);</span>
<span class="nc" id="L2559">        addListLevel(paragraphBaseElement, levelsToCreate, paraProps, xmlDoc, currentListStyleName);</span>
<span class="nc" id="L2560">      } else {</span>
<span class="nc" id="L2561">        boolean listLabelHidden = false;</span>
        // if either the selected paragraph should show no label, or nothing was mentioned and the
        // paragraph had previously no label, was a child of &lt;text:list-heading&gt;
<span class="nc bnc" id="L2564" title="All 4 branches missed.">        if (paraProps != null &amp;&amp; paraProps.has(&quot;listLabelHidden&quot;)</span>
<span class="nc bnc" id="L2565" title="All 2 branches missed.">            || paragraphBaseElement.hasAttribute(&quot;hiddenParagraph&quot;)) {</span>
<span class="nc bnc" id="L2566" title="All 2 branches missed.">          if (paraProps != null) {</span>
<span class="nc" id="L2567">            listLabelHidden = paraProps.optBoolean(&quot;listLabelHidden&quot;, Boolean.FALSE);</span>
          } else {
<span class="nc" id="L2569">            listLabelHidden = true;</span>
          }
<span class="nc" id="L2571">          paragraphBaseElement.removeAttribute(&quot;hiddenParagraph&quot;);</span>
        }
<span class="nc bnc" id="L2573" title="All 2 branches missed.">        if (listLabelHidden) {</span>
          // Create new List Header
<span class="nc" id="L2575">          TextListHeaderElement newListHeaderElement = new TextListHeaderElement(xmlDoc);</span>
<span class="nc" id="L2576">          newListElement.appendChild(newListHeaderElement);</span>
<span class="nc" id="L2577">          newListHeaderElement.appendChild(paragraphBaseElement);</span>
<span class="nc" id="L2578">        } else {</span>
          // Create new List Item
<span class="nc" id="L2580">          TextListItemElement newListItemElement = new TextListItemElement(xmlDoc);</span>
<span class="nc" id="L2581">          newListElement.appendChild(newListItemElement);</span>
<span class="nc" id="L2582">          newListItemElement.appendChild(paragraphBaseElement);</span>
        }
      }
    }
<span class="nc" id="L2586">    return newListElement;</span>
  }

  /** List styles should currently only changed for the paragraph being selected. */
  private static void addTopListElementAttributes(
      TextListElement rootListElement,
      JSONObject paraProps,
      String previousSiblingListId,
      String currentListId) {
    // Make certain the paragraph is in an list of its own, as only
<span class="nc bnc" id="L2596" title="All 2 branches missed.">    if (rootListElement != null) {</span>
      String newListXmlId;
      String newListStyleId;
<span class="nc bnc" id="L2599" title="All 6 branches missed.">      if (paraProps != null &amp;&amp; paraProps.length() != 0 &amp;&amp; paraProps.has(&quot;listXmlId&quot;)) {</span>
<span class="nc" id="L2600">        newListXmlId = paraProps.optString(&quot;listXmlId&quot;, null);</span>
<span class="nc bnc" id="L2601" title="All 2 branches missed.">        if (newListXmlId != null) {</span>
<span class="nc bnc" id="L2602" title="All 2 branches missed.">          if (!newListXmlId.isEmpty()) {</span>
            // do not create an empty ID
<span class="nc" id="L2604">            rootListElement.setXmlIdAttribute(newListXmlId);</span>
          }
        } else {
<span class="nc" id="L2607">          rootListElement.removeAttributeNS(OdfDocumentNamespace.XML.getUri(), &quot;id&quot;);</span>
        }
      }
      // If style or styleID provided are different to the existent
<span class="nc bnc" id="L2611" title="All 6 branches missed.">      if (paraProps != null &amp;&amp; paraProps.length() != 0 &amp;&amp; paraProps.has(&quot;listStyleId&quot;)) {</span>
<span class="nc" id="L2612">        newListStyleId = paraProps.optString(&quot;listStyleId&quot;, null);</span>
<span class="nc bnc" id="L2613" title="All 2 branches missed.">        if (newListStyleId != null) {</span>
<span class="nc bnc" id="L2614" title="All 2 branches missed.">          if (!newListStyleId.isEmpty()) {</span>
<span class="nc" id="L2615">            rootListElement.setTextStyleNameAttribute(newListStyleId);</span>
          } else {
            // reuse the previous list style ID
<span class="nc bnc" id="L2618" title="All 4 branches missed.">            if (currentListId == null</span>
                &amp;&amp; previousSiblingListId != null
<span class="nc bnc" id="L2620" title="All 2 branches missed.">                &amp;&amp; !previousSiblingListId.isEmpty()) {</span>
<span class="nc" id="L2621">              rootListElement.setTextStyleNameAttribute(newListStyleId);</span>
            }
          }
        } else {
<span class="nc" id="L2625">          rootListElement.removeAttributeNS(OdfDocumentNamespace.TEXT.getUri(), &quot;style-name&quot;);</span>
        }
      } else {
<span class="nc bnc" id="L2628" title="All 4 branches missed.">        if (currentListId == null</span>
            &amp;&amp; previousSiblingListId != null
<span class="nc bnc" id="L2630" title="All 2 branches missed.">            &amp;&amp; !previousSiblingListId.isEmpty()) {</span>
<span class="nc" id="L2631">          rootListElement.setTextStyleNameAttribute(previousSiblingListId);</span>
<span class="nc bnc" id="L2632" title="All 4 branches missed.">        } else if (currentListId != null &amp;&amp; !currentListId.isEmpty()) {</span>
<span class="nc" id="L2633">          rootListElement.setTextStyleNameAttribute(currentListId);</span>
        }
      }
      // Similar to MSO 15 ODF output &amp; behavior, set by default the continue numbering to true
<span class="nc" id="L2637">      rootListElement.setTextContinueNumberingAttribute(Boolean.TRUE);</span>
    }
<span class="nc" id="L2639">  }</span>

  public static void addListStyle(String listStyleId, JSONObject listDefinition, OdfDocument doc) {
    try {
      // ToDo: Later in case a list was added to a header and footer a styles DOM have to be
      // accessed
<span class="nc" id="L2645">      OdfOfficeAutomaticStyles autoStyles = doc.getContentDom().getOrCreateAutomaticStyles();</span>
<span class="nc" id="L2646">      OdfTextListStyle listStyle = autoStyles.newListStyle(listStyleId);</span>
<span class="nc" id="L2647">      JSONObject listLevelDefinition = null;</span>
<span class="nc bnc" id="L2648" title="All 2 branches missed.">      for (int i = 0; i &lt; 9; i++) {</span>
<span class="nc" id="L2649">        listLevelDefinition = listDefinition.optJSONObject(&quot;listLevel&quot; + i);</span>
<span class="nc" id="L2650">        addListDefinition(listStyle, listLevelDefinition, i);</span>
      }
<span class="nc" id="L2652">    } catch (Exception ex) {</span>
<span class="nc" id="L2653">      Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L2654">    }</span>
<span class="nc" id="L2655">  }</span>

  /**
   * &lt; text:list-level-style-bullet text:level=&quot;1&quot; text:style-name=&quot;Bullet_20_Symbols&quot;
   * text:bullet-char=&quot;\u2022&quot;&gt; &lt;style:list-level-properties
   * text:list-level-position-and-space-mode=&quot;label-alignment&quot;&gt; &lt;style:list-level-label-alignment
   * text:label-followed-by=&quot;listtab&quot; text:list-tab-stop-position=&quot;1.27cm&quot; fo:text-indent=&quot;-0.635cm&quot;
   * fo:margin-left=&quot;1.27cm&quot;/&gt; &lt;/style:list-level-properties&gt; &lt;/text:list-level-style-bullet&gt;
   */
  private static void addListDefinition(
      OdfTextListStyle listStyle, JSONObject listLevelDefinition, int listLevel) {
<span class="nc bnc" id="L2666" title="All 2 branches missed.">    if (listLevelDefinition != null) {</span>
<span class="nc" id="L2667">      TextListLevelStyleElementBase listLevelStyle = null;</span>

      // numberFormat: One of 'none', 'bullet', 'decimal', 'lowerRoman', 'upperRoman',
      // 'lowerLetter', or 'upperLetter'.
<span class="nc" id="L2671">      String numberFormat = listLevelDefinition.optString(&quot;numberFormat&quot;);</span>
<span class="nc" id="L2672">      String levelText = listLevelDefinition.optString(&quot;levelText&quot;);</span>
<span class="nc" id="L2673">      String numPrefix = null;</span>
<span class="nc" id="L2674">      String numSuffix = null;</span>
<span class="nc bnc" id="L2675" title="All 2 branches missed.">      if (numberFormat.equals(&quot;bullet&quot;)) {</span>
        // if there is also a suffix appended
<span class="nc bnc" id="L2677" title="All 2 branches missed.">        if (levelText.length() &gt; 1) {</span>
          // num-suffix
<span class="nc" id="L2679">          numSuffix = levelText.substring(1);</span>
          // bullet-char
<span class="nc" id="L2681">          levelText = levelText.substring(0, 1);</span>
          // ToDo: API FIX to split prefix &amp; suffix from bullet char, a single levelText will not be
          // able to round-trip
        }
<span class="nc" id="L2685">        String levelPicBulletUri = listLevelDefinition.optString(&quot;levelPicBulletUri&quot;);</span>
<span class="nc bnc" id="L2686" title="All 2 branches missed.">        if (levelText != null) { // if there is no text label, we have to create an image list</span>
<span class="nc bnc" id="L2687" title="All 4 branches missed.">          if (levelPicBulletUri != null &amp;&amp; !levelPicBulletUri.isEmpty()) {</span>
<span class="nc" id="L2688">            listLevelStyle = createListLevelStyleImage(listStyle, listLevel, levelPicBulletUri);</span>
          } else {
<span class="nc" id="L2690">            listLevelStyle = listStyle.newTextListLevelStyleBulletElement(levelText, listLevel + 1);</span>
          }
        } else {
<span class="nc" id="L2693">          listLevelStyle = createListLevelStyleImage(listStyle, listLevel, levelPicBulletUri);</span>
        }
<span class="nc" id="L2695">      } else { // *** NUMBERED LIST ***</span>
<span class="nc" id="L2696">        listLevelStyle =</span>
<span class="nc" id="L2697">            listStyle.newTextListLevelStyleNumberElement(getNumFormat(numberFormat), listLevel + 1);</span>
<span class="nc" id="L2698">        listLevelStyle.setAttributeNS(</span>
<span class="nc" id="L2699">            OdfDocumentNamespace.TEXT.getUri(),</span>
            &quot;text:display-levels&quot;,
<span class="nc" id="L2701">            Integer.toString(countOccurrences(levelText, '%')));</span>

        // if there is prefix
<span class="nc bnc" id="L2704" title="All 2 branches missed.">        if (!levelText.startsWith(&quot;%&quot;)) {</span>
          // num-prefix
<span class="nc" id="L2706">          int prefixEnd = levelText.indexOf('%');</span>
<span class="nc" id="L2707">          numPrefix = levelText.substring(0, prefixEnd);</span>
<span class="nc" id="L2708">          levelText = levelText.substring(prefixEnd);</span>
        }
        // num-suffix
<span class="nc" id="L2711">        int suffixStart = levelText.lastIndexOf('%') + 2;</span>
<span class="nc bnc" id="L2712" title="All 2 branches missed.">        if (levelText.length() &gt;= suffixStart) {</span>
<span class="nc" id="L2713">          numSuffix = levelText.substring(suffixStart);</span>
        }
<span class="nc" id="L2715">        int listStartValue = listLevelDefinition.optInt(&quot;listStartValue&quot;, -1);</span>
<span class="nc bnc" id="L2716" title="All 2 branches missed.">        if (listStartValue != -1) {</span>
<span class="nc" id="L2717">          listLevelStyle.setAttributeNS(</span>
<span class="nc" id="L2718">              OdfDocumentNamespace.TEXT.getUri(),</span>
              &quot;text:start-value&quot;,
<span class="nc" id="L2720">              Integer.toString(listStartValue));</span>
        }
      }
<span class="nc bnc" id="L2723" title="All 4 branches missed.">      if (numPrefix != null &amp;&amp; !numPrefix.isEmpty()) {</span>
<span class="nc" id="L2724">        listLevelStyle.setAttributeNS(</span>
<span class="nc" id="L2725">            OdfDocumentNamespace.STYLE.getUri(), &quot;style:num-prefix&quot;, numPrefix);</span>
      }
<span class="nc bnc" id="L2727" title="All 4 branches missed.">      if (numSuffix != null &amp;&amp; !numSuffix.isEmpty()) {</span>
<span class="nc" id="L2728">        listLevelStyle.setAttributeNS(</span>
<span class="nc" id="L2729">            OdfDocumentNamespace.STYLE.getUri(), &quot;style:num-suffix&quot;, numSuffix);</span>
      }
      // Add common list style properties
<span class="nc" id="L2732">      addCommonListStyles(listLevelStyle, listLevelDefinition);</span>
    }
<span class="nc" id="L2734">  }</span>

  private static TextListLevelStyleElementBase createListLevelStyleImage(
      OdfTextListStyle listStyle, int listLevel, String levelPicBulletUri) {
<span class="nc" id="L2738">    TextListLevelStyleElementBase listLevelStyle =</span>
<span class="nc" id="L2739">        listStyle.newTextListLevelStyleImageElement(listLevel + 1);</span>

<span class="nc bnc" id="L2741" title="All 4 branches missed.">    if (levelPicBulletUri != null &amp;&amp; !levelPicBulletUri.isEmpty()) {</span>
<span class="nc" id="L2742">      listLevelStyle.setAttributeNS(</span>
<span class="nc" id="L2743">          OdfDocumentNamespace.XLINK.getUri(), &quot;xlink:href&quot;, levelPicBulletUri);</span>
<span class="nc" id="L2744">      TextListLevelStyleImageElement listLevelStyleImage =</span>
          (TextListLevelStyleImageElement) listLevelStyle;
<span class="nc" id="L2746">      listLevelStyleImage.setXlinkActuateAttribute(&quot;onLoad&quot;);</span>
<span class="nc" id="L2747">      listLevelStyleImage.setXlinkShowAttribute(&quot;embed&quot;);</span>
<span class="nc" id="L2748">      listLevelStyleImage.setXlinkTypeAttribute(&quot;simple&quot;);</span>
    }
<span class="nc" id="L2750">    return listLevelStyle;</span>
  }

  private static int countOccurrences(String haystack, char needle) {
<span class="nc" id="L2754">    int count = 0;</span>
<span class="nc bnc" id="L2755" title="All 2 branches missed.">    for (int i = 0; i &lt; haystack.length(); i++) {</span>
<span class="nc bnc" id="L2756" title="All 2 branches missed.">      if (haystack.charAt(i) == needle) {</span>
<span class="nc" id="L2757">        count++;</span>
      }
    }
<span class="nc" id="L2760">    return count;</span>
  }

  /**
   * The &lt;style:list-level-properties&gt; element has the following attributes:
   *
   * &lt;ul&gt;
   *   &lt;li&gt;fo:height
   *   &lt;li&gt;fo:text-align
   *   &lt;li&gt;fo:width
   *   &lt;li&gt;style:font-name
   *   &lt;li&gt;style:vertical-pos
   *   &lt;li&gt;style:vertical-rel
   *   &lt;li&gt;svg:y
   *   &lt;li&gt;text:list-level-position-and-space-mode
   *   &lt;li&gt;text:min-label-distance
   *   &lt;li&gt;text:min-label-width
   *   &lt;li&gt;text:space-before
   * &lt;/ul&gt;
   */
  private static void addCommonListStyles(
      TextListLevelStyleElementBase listLevelStyle, JSONObject listLevelDefinition) {
<span class="nc" id="L2782">    StyleListLevelPropertiesElement styleListLevelProperties =</span>
<span class="nc" id="L2783">        listLevelStyle.newStyleListLevelPropertiesElement();</span>
<span class="nc" id="L2784">    addListLabelAlignment(styleListLevelProperties, listLevelDefinition);</span>

<span class="nc bnc" id="L2786" title="All 2 branches missed.">    if (listLevelDefinition.has(&quot;height&quot;)) {</span>
<span class="nc" id="L2787">      styleListLevelProperties.setAttributeNS(</span>
<span class="nc" id="L2788">          OdfDocumentNamespace.FO.getUri(),</span>
          &quot;fo:height&quot;,
<span class="nc" id="L2790">          listLevelDefinition.optInt(&quot;height&quot;) / 100 + &quot;mm&quot;);</span>
    }
<span class="nc bnc" id="L2792" title="All 2 branches missed.">    if (listLevelDefinition.has(&quot;textAlign&quot;)) {</span>
<span class="nc" id="L2793">      styleListLevelProperties.setAttributeNS(</span>
<span class="nc" id="L2794">          OdfDocumentNamespace.FO.getUri(),</span>
          &quot;fo:text-align&quot;,
<span class="nc" id="L2796">          listLevelDefinition.optString(&quot;textAlign&quot;));</span>
    }
<span class="nc bnc" id="L2798" title="All 2 branches missed.">    if (listLevelDefinition.has(&quot;width&quot;)) {</span>
<span class="nc" id="L2799">      styleListLevelProperties.setAttributeNS(</span>
<span class="nc" id="L2800">          OdfDocumentNamespace.FO.getUri(),</span>
          &quot;fo:width&quot;,
<span class="nc" id="L2802">          listLevelDefinition.optInt(&quot;width&quot;) / 100 + &quot;mm&quot;);</span>
    }
<span class="nc bnc" id="L2804" title="All 2 branches missed.">    if (listLevelDefinition.has(&quot;font-name&quot;)) {</span>
<span class="nc" id="L2805">      styleListLevelProperties.setAttributeNS(</span>
<span class="nc" id="L2806">          OdfDocumentNamespace.STYLE.getUri(),</span>
          &quot;style:font-name&quot;,
<span class="nc" id="L2808">          listLevelDefinition.optString(&quot;fontName&quot;));</span>
    }
<span class="nc bnc" id="L2810" title="All 2 branches missed.">    if (listLevelDefinition.has(&quot;vertical-pos&quot;)) {</span>
<span class="nc" id="L2811">      styleListLevelProperties.setAttributeNS(</span>
<span class="nc" id="L2812">          OdfDocumentNamespace.STYLE.getUri(),</span>
          &quot;style:vertical-pos&quot;,
<span class="nc" id="L2814">          listLevelDefinition.optString(&quot;verticalPos&quot;));</span>
    }
<span class="nc bnc" id="L2816" title="All 2 branches missed.">    if (listLevelDefinition.has(&quot;vertical-rel&quot;)) {</span>
<span class="nc" id="L2817">      styleListLevelProperties.setAttributeNS(</span>
<span class="nc" id="L2818">          OdfDocumentNamespace.STYLE.getUri(),</span>
          &quot;style:vertical-rel&quot;,
<span class="nc" id="L2820">          listLevelDefinition.optString(&quot;verticalRel&quot;));</span>
    }
<span class="nc bnc" id="L2822" title="All 2 branches missed.">    if (listLevelDefinition.has(&quot;y&quot;)) {</span>
<span class="nc" id="L2823">      styleListLevelProperties.setAttributeNS(</span>
<span class="nc" id="L2824">          OdfDocumentNamespace.SVG.getUri(), &quot;svg:y&quot;, listLevelDefinition.optString(&quot;y&quot;));</span>
    }
<span class="nc bnc" id="L2826" title="All 2 branches missed.">    if (listLevelDefinition.has(&quot;listLevelPositionAndSpaceMode&quot;)) {</span>
<span class="nc" id="L2827">      styleListLevelProperties.setAttributeNS(</span>
<span class="nc" id="L2828">          OdfDocumentNamespace.TEXT.getUri(),</span>
          &quot;text:list-level-position-and-space-mode&quot;,
<span class="nc" id="L2830">          listLevelDefinition.optString(&quot;listLevelPositionAndSpaceMode&quot;));</span>
    }
<span class="nc bnc" id="L2832" title="All 2 branches missed.">    if (listLevelDefinition.has(&quot;minLabelDistance&quot;)) {</span>
<span class="nc" id="L2833">      styleListLevelProperties.setAttributeNS(</span>
<span class="nc" id="L2834">          OdfDocumentNamespace.TEXT.getUri(),</span>
          &quot;text:min-label-distance&quot;,
<span class="nc" id="L2836">          listLevelDefinition.optInt(&quot;minLabelDistance&quot;) / 100 + &quot;mm&quot;);</span>
    }
<span class="nc bnc" id="L2838" title="All 2 branches missed.">    if (listLevelDefinition.has(&quot;minLabelWidth&quot;)) {</span>
<span class="nc" id="L2839">      styleListLevelProperties.setAttributeNS(</span>
<span class="nc" id="L2840">          OdfDocumentNamespace.TEXT.getUri(),</span>
          &quot;text:min-label-width&quot;,
<span class="nc" id="L2842">          listLevelDefinition.optInt(&quot;minLabelWidth&quot;) / 100 + &quot;mm&quot;);</span>
    }
<span class="nc bnc" id="L2844" title="All 2 branches missed.">    if (listLevelDefinition.has(&quot;spaceBefore&quot;)) {</span>
<span class="nc" id="L2845">      styleListLevelProperties.setAttributeNS(</span>
<span class="nc" id="L2846">          OdfDocumentNamespace.TEXT.getUri(),</span>
          &quot;text:space-before&quot;,
<span class="nc" id="L2848">          listLevelDefinition.optInt(&quot;spaceBefore&quot;) / 100 + &quot;mm&quot;);</span>
    }
<span class="nc" id="L2850">  }</span>

  private static void addListLabelAlignment(
      StyleListLevelPropertiesElement styleListLevelProperties, JSONObject listLevelDefinition) {
<span class="nc bnc" id="L2854" title="All 4 branches missed.">    if (listLevelDefinition.has(&quot;indentLeft&quot;) || listLevelDefinition.has(&quot;indentFirstLine&quot;)) {</span>
<span class="nc" id="L2855">      styleListLevelProperties.setAttributeNS(</span>
<span class="nc" id="L2856">          OdfDocumentNamespace.TEXT.getUri(),</span>
          &quot;text:list-level-position-and-space-mode&quot;,
          &quot;label-alignment&quot;);
<span class="nc" id="L2859">      String labelFollowedBy = listLevelDefinition.optString(&quot;labelFollowedBy&quot;, &quot;listtab&quot;);</span>
<span class="nc" id="L2860">      StyleListLevelLabelAlignmentElement listLevelLabelAlignmentElement =</span>
<span class="nc" id="L2861">          styleListLevelProperties.newStyleListLevelLabelAlignmentElement(labelFollowedBy);</span>

<span class="nc bnc" id="L2863" title="All 2 branches missed.">      if (listLevelDefinition.has(&quot;indentLeft&quot;)) {</span>
<span class="nc" id="L2864">        int indentLeft = listLevelDefinition.optInt(&quot;indentLeft&quot;);</span>
<span class="nc" id="L2865">        listLevelLabelAlignmentElement.setFoMarginLeftAttribute(indentLeft / 100.0 + &quot;mm&quot;);</span>
      }
<span class="nc bnc" id="L2867" title="All 2 branches missed.">      if (listLevelDefinition.has(&quot;indentFirstLine&quot;)) {</span>
<span class="nc" id="L2868">        int indentFirstLine = listLevelDefinition.optInt(&quot;indentFirstLine&quot;);</span>
<span class="nc" id="L2869">        listLevelLabelAlignmentElement.setFoTextIndentAttribute(indentFirstLine / 100.0 + &quot;mm&quot;);</span>
      }
<span class="nc bnc" id="L2871" title="All 2 branches missed.">      if (listLevelDefinition.has(&quot;tabStopPosition&quot;)) {</span>
<span class="nc" id="L2872">        int tabStopPosition = listLevelDefinition.optInt(&quot;tabStopPosition&quot;);</span>
<span class="nc" id="L2873">        listLevelLabelAlignmentElement.setTextListTabStopPositionAttribute(</span>
            tabStopPosition / 100.0 + &quot;mm&quot;);
<span class="nc" id="L2875">        listLevelLabelAlignmentElement.setTextLabelFollowedByAttribute(&quot;listtab&quot;);</span>
      }
    }
<span class="nc" id="L2878">  }</span>

  /**
   * The style:num-format attribute specifies a numbering sequence. The defined values for the
   * style:num-format attribute are: 1: Hindu-Arabic number sequence starts with 1. a: number
   * sequence of lowercase Modern Latin basic alphabet characters starts with &quot;a&quot;. A: number
   * sequence of uppercase Modern Latin basic alphabet characters starts with &quot;A&quot;. i: number
   * sequence of lowercase Roman numerals starts with &quot;i&quot;. I: number sequence of uppercase Roman
   * numerals start with &quot;I&quot;. a value of type string. an empty string: no number sequence displayed.
   * If no value is given, no number sequence is displayed.
   */
  private static String getNumFormat(String numberFormat) {

<span class="nc" id="L2891">    String numFormat = &quot;&quot;; // &quot;none&quot; is nothing set</span>
<span class="nc bnc" id="L2892" title="All 2 branches missed.">    if (numberFormat.equals(&quot;decimal&quot;)) {</span>
<span class="nc" id="L2893">      numFormat = &quot;1&quot;;</span>
<span class="nc bnc" id="L2894" title="All 2 branches missed.">    } else if (numberFormat.equals(&quot;lowerRoman&quot;)) {</span>
<span class="nc" id="L2895">      numFormat = &quot;i&quot;;</span>
<span class="nc bnc" id="L2896" title="All 2 branches missed.">    } else if (numberFormat.equals(&quot;upperRoman&quot;)) {</span>
<span class="nc" id="L2897">      numFormat = &quot;I&quot;;</span>
<span class="nc bnc" id="L2898" title="All 2 branches missed.">    } else if (numberFormat.equals(&quot;lowerLetter&quot;)) {</span>
<span class="nc" id="L2899">      numFormat = &quot;a&quot;;</span>
<span class="nc bnc" id="L2900" title="All 2 branches missed.">    } else if (numberFormat.equals(&quot;upperLetter&quot;)) {</span>
<span class="nc" id="L2901">      numFormat = &quot;A&quot;;</span>
    }
<span class="nc" id="L2903">    return numFormat;</span>
  }

  /**
   * Splits a paragraph into two splitting the text among the two. Special handling for paragraph
   * within lists: In this case the list item will be split!
   */
  public static void splitParagraph(Component rootComponent, JSONArray start)
      throws IndexOutOfBoundsException {
<span class="nc" id="L2912">    Component component = rootComponent.getParentOf(start);</span>
<span class="nc bnc" id="L2913" title="All 2 branches missed.">    if (component != null) {</span>
<span class="nc" id="L2914">      TextParagraphElementBase para = (TextParagraphElementBase) component.getRootElement();</span>
      try {
<span class="nc" id="L2916">        TextParagraphElementBase newSecondPara =</span>
<span class="nc" id="L2917">            (TextParagraphElementBase) para.split(start.getInt(start.length() - 1));</span>
<span class="nc" id="L2918">        Component parentComponent = component.getParent();</span>
<span class="nc" id="L2919">        Node paraParent = component.getRootElement().getParentNode();</span>

        // if paragraph within a list (checked on parentComponentElement of list-item or
        // list-header) the split will not only split the paragraph, but as well this item/header
        // BECAUSE: In contrary to ODF in OOXML the list is only a property of a paragraph, there
        // can only be one paragraph within a list (emulating this behavior).
<span class="nc bnc" id="L2925" title="All 4 branches missed.">        if (paraParent instanceof TextListItemElement</span>
            || paraParent instanceof TextListHeaderElement) {
<span class="nc" id="L2927">          OdfElement listItem = (OdfElement) paraParent;</span>
          // split the list inbetween the old (splitted) and new paragraph, plus one as a new
          // paragraph was added above
<span class="nc" id="L2930">          int precedingSiblingsNo = para.countPrecedingSiblingElements() + 1;</span>
<span class="nc" id="L2931">          OdfElement secondListPart = listItem.split(precedingSiblingsNo);</span>
<span class="nc" id="L2932">          Component.createChildComponent(</span>
<span class="nc" id="L2933">              start.getInt(start.length() - 2) + 1,</span>
              parentComponent,
<span class="nc" id="L2935">              secondListPart.getFirstChildElement());</span>
<span class="nc" id="L2936">        } else {</span>
<span class="nc" id="L2937">          Component.createChildComponent(</span>
<span class="nc" id="L2938">              start.getInt(start.length() - 2) + 1, parentComponent, newSecondPara);</span>
        }
<span class="nc" id="L2940">      } catch (JSONException ex) {</span>
<span class="nc" id="L2941">        Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L2942">      }</span>
<span class="nc" id="L2943">    } else {</span>
<span class="nc" id="L2944">      LOG.log(Level.SEVERE, &quot;Could not find paragraph at position: {0}&quot;, start);</span>
    }
<span class="nc" id="L2946">  }</span>

  private static void deleteText(Component rootComponent, JSONArray start, JSONArray end)
      throws IndexOutOfBoundsException {
<span class="nc" id="L2950">    Component parentComponent = rootComponent.getParentOf(start);</span>
<span class="nc bnc" id="L2951" title="All 2 branches missed.">    if (parentComponent != null) {</span>
      // TextParagraphElementBase startParagraph = (TextParagraphElementBase)
      // parentComponent.getRootElement();
      try {
        // ToDo - addChild the paragraph text length to the paragraph? Than I need to intercept all
        // text manipulations!! *ARGH just do-it! :D
        // ToDo - parse the text spans positions from the beginning, creating array - could do this
        // from the beginning..
        // better not for very long texts it is unnecessary, does not scale
        //        adding the span depths, the span element reference, for every character?
<span class="nc bnc" id="L2961" title="All 2 branches missed.">        if (parentComponent instanceof TextContainer) {</span>
<span class="nc" id="L2962">          int startPos = start.getInt(start.length() - 1);</span>
          int endPos;
<span class="nc bnc" id="L2964" title="All 2 branches missed.">          if (end != null) {</span>
<span class="nc" id="L2965">            endPos = end.getInt(end.length() - 1);</span>
          } else {
<span class="nc" id="L2967">            endPos = startPos;</span>
          }
<span class="nc" id="L2969">          ((TextContainer) parentComponent).removeText(startPos, endPos);</span>
          // LO let the value attribute overrule the content, therefore this value have to vanish!
<span class="nc" id="L2971">          OdfElement grandParentElement = (OdfElement) parentComponent.mRootElement.getParentNode();</span>
<span class="nc bnc" id="L2972" title="All 2 branches missed.">          if (grandParentElement instanceof TableTableCellElement) {</span>
<span class="nc" id="L2973">            ((TableTableCellElement) grandParentElement)</span>
<span class="nc" id="L2974">                .removeAttributeNS(OdfDocumentNamespace.OFFICE.getUri(), &quot;value&quot;);</span>
<span class="nc" id="L2975">            ((TableTableCellElement) grandParentElement)</span>
<span class="nc" id="L2976">                .removeAttributeNS(OdfDocumentNamespace.OFFICE.getUri(), &quot;value-type&quot;);</span>
          }
<span class="nc" id="L2978">        } else {</span>
<span class="nc" id="L2979">          LOG.log(</span>
              Level.SEVERE, &quot;The parent of the text is not a text component: {0}&quot;, parentComponent);
        }
<span class="nc" id="L2982">      } catch (JSONException ex) {</span>
<span class="nc" id="L2983">        Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L2984">      }</span>
    } else {
<span class="nc" id="L2986">      LOG.log(Level.SEVERE, &quot;Could not find paragraph as parent for position: {0}&quot;, start);</span>
    }
<span class="nc" id="L2988">  }</span>

  private static void addFontData(
      OdfDocument doc,
      String fontName,
      String[] altNames,
      String family,
      String familyGeneric,
      String pitch,
      String panose1) {
    // CREATING CONTENT FONT DECLARATION
    try {
<span class="nc" id="L3000">      OdfContentDom contentDom = doc.getContentDom();</span>
<span class="nc" id="L3001">      StyleFontFaceElement newElement = new StyleFontFaceElement(contentDom);</span>
<span class="nc" id="L3002">      newElement.setStyleNameAttribute(fontName);</span>
<span class="nc bnc" id="L3003" title="All 4 branches missed.">      if (family != null &amp;&amp; !family.isEmpty()) {</span>
<span class="nc" id="L3004">        newElement.setSvgFontFamilyAttribute(family);</span>
      }
<span class="nc bnc" id="L3006" title="All 4 branches missed.">      if (familyGeneric != null &amp;&amp; !familyGeneric.isEmpty()) {</span>
<span class="nc" id="L3007">        newElement.setStyleFontFamilyGenericAttribute(familyGeneric);</span>
      }
<span class="nc bnc" id="L3009" title="All 4 branches missed.">      if (pitch != null &amp;&amp; !pitch.isEmpty()) {</span>
<span class="nc" id="L3010">        newElement.setStyleFontPitchAttribute(pitch);</span>
      }
<span class="nc bnc" id="L3012" title="All 4 branches missed.">      if (panose1 != null &amp;&amp; !panose1.isEmpty()) {</span>
<span class="nc bnc" id="L3013" title="All 2 branches missed.">        if (panose1.contains(&quot;[&quot;)) {</span>
<span class="nc" id="L3014">          panose1 = panose1.substring(1, panose1.length() - 1);</span>
        }
<span class="nc bnc" id="L3016" title="All 2 branches missed.">        if (panose1.contains(&quot;,&quot;)) {</span>
<span class="nc" id="L3017">          panose1 = panose1.replace(',', ' ');</span>
        }
<span class="nc" id="L3019">        newElement.setSvgPanose1Attribute(panose1);</span>
      }
<span class="nc" id="L3021">      addtFontFace(contentDom, newElement);</span>

<span class="nc" id="L3023">      OdfStylesDom stylesDom = doc.getStylesDom();</span>
<span class="nc" id="L3024">      StyleFontFaceElement newElement2 = (StyleFontFaceElement) newElement.cloneNode(true);</span>
<span class="nc" id="L3025">      newElement2 = (StyleFontFaceElement) stylesDom.adoptNode(newElement2);</span>
<span class="nc" id="L3026">      addtFontFace(stylesDom, newElement2);</span>

<span class="nc" id="L3028">    } catch (Exception ex) {</span>
<span class="nc" id="L3029">      Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L3030">    }</span>
<span class="nc" id="L3031">  }</span>

  private static void addtFontFace(OdfFileDom fileDom, StyleFontFaceElement fontFaceElement) {
<span class="nc" id="L3034">    NodeList fontDecls = fileDom.getElementsByTagName(&quot;office:font-face-decls&quot;);</span>
<span class="nc bnc" id="L3035" title="All 2 branches missed.">    if (fontDecls.getLength() == 0) {</span>
<span class="nc" id="L3036">      Element rootElement = fileDom.getRootElement();</span>
<span class="nc" id="L3037">      NodeList rootChildren = rootElement.getChildNodes();</span>
<span class="nc" id="L3038">      boolean hasInserted = false;</span>
<span class="nc" id="L3039">      OfficeFontFaceDeclsElement fontFaceDeclsElement =</span>
          fontFaceDeclsElement = new OfficeFontFaceDeclsElement(fileDom);
<span class="nc" id="L3041">      fontFaceDeclsElement.appendChild(fontFaceElement);</span>
<span class="nc bnc" id="L3042" title="All 2 branches missed.">      for (int i = 0; i &lt; rootChildren.getLength(); i++) {</span>
<span class="nc" id="L3043">        Node currentNode = rootChildren.item(i);</span>
<span class="nc bnc" id="L3044" title="All 2 branches missed.">        if (currentNode instanceof Element) {</span>
<span class="nc" id="L3045">          String elementName = ((Element) currentNode).getNodeName();</span>
<span class="nc bnc" id="L3046" title="All 2 branches missed.">          if (elementName.equals(&quot;office:automatic-styles&quot;)</span>
<span class="nc bnc" id="L3047" title="All 2 branches missed.">              || elementName.equals(&quot;office:styles&quot;)</span>
<span class="nc bnc" id="L3048" title="All 2 branches missed.">              || elementName.equals(&quot;office:body&quot;)</span>
<span class="nc bnc" id="L3049" title="All 2 branches missed.">              || elementName.equals(&quot;office:master-styles&quot;)) {</span>
<span class="nc" id="L3050">            rootElement.insertBefore(fontFaceDeclsElement, currentNode);</span>
<span class="nc" id="L3051">            hasInserted = true;</span>
<span class="nc" id="L3052">            break;</span>
          }
        } else {
          continue;
        }
      }
<span class="nc bnc" id="L3058" title="All 2 branches missed.">      if (!hasInserted) {</span>
<span class="nc" id="L3059">        rootElement.appendChild(fontFaceDeclsElement);</span>
      }
<span class="nc" id="L3061">    } else {</span>
<span class="nc" id="L3062">      OfficeFontFaceDeclsElement fontFaceDeclsElement =</span>
<span class="nc" id="L3063">          (OfficeFontFaceDeclsElement) fontDecls.item(0);</span>
<span class="nc" id="L3064">      fontFaceDeclsElement.appendChild(fontFaceElement);</span>
    }
<span class="nc" id="L3066">  }</span>

  /** Currently all fields are being mapped to a common text field, i.e. &lt;text:text-input&gt; */
  public static void setFieldAttributes(
      OdfElement newFieldElement,
      JSONObject attrs,
      final FieldMap currentMap,
      final OdfContentDom contentDom) {
<span class="nc bnc" id="L3074" title="All 8 branches missed.">    if (newFieldElement != null &amp;&amp; currentMap != null &amp;&amp; attrs != null &amp;&amp; attrs.has(&quot;field&quot;)) {</span>
      try {
<span class="nc" id="L3076">        JSONObject fieldAttrs = attrs.getJSONObject(&quot;field&quot;);</span>
<span class="nc" id="L3077">        String styleName = null;</span>
<span class="nc bnc" id="L3078" title="All 4 branches missed.">        if (currentMap.hasDateFormat() &amp;&amp; fieldAttrs.has(&quot;dateFormat&quot;)) {</span>
<span class="nc" id="L3079">          boolean isTime = currentMap.hasTimeStyle();</span>
<span class="nc" id="L3080">          String dateFormat = fieldAttrs.getString(&quot;dateFormat&quot;);</span>
<span class="nc" id="L3081">          OdfOfficeAutomaticStyles autoStyles = contentDom.getOrCreateAutomaticStyles();</span>
<span class="nc" id="L3082">          Iterator styleIter = null;</span>
<span class="nc bnc" id="L3083" title="All 2 branches missed.">          if (isTime) {</span>
<span class="nc" id="L3084">            styleIter = autoStyles.getTimeStyles().iterator();</span>
          } else {
<span class="nc" id="L3086">            styleIter = autoStyles.getDateStyles().iterator();</span>
          }

<span class="nc" id="L3089">          int newStyleIdx = 0;</span>
<span class="nc bnc" id="L3090" title="All 2 branches missed.">          while (styleIter.hasNext()) {</span>
<span class="nc" id="L3091">            OdfElement style = (OdfElement) styleIter.next();</span>
            String currentName =
<span class="nc bnc" id="L3093" title="All 2 branches missed.">                isTime</span>
<span class="nc" id="L3094">                    ? ((OdfNumberTimeStyle) style).getStyleNameAttribute()</span>
<span class="nc" id="L3095">                    : ((OdfNumberDateStyle) style).getStyleNameAttribute();</span>
<span class="nc bnc" id="L3096" title="All 4 branches missed.">            if (styleName == null</span>
                &amp;&amp; (isTime
<span class="nc bnc" id="L3098" title="All 2 branches missed.">                    ? ((OdfNumberTimeStyle) style).getFormat(true).equals(dateFormat)</span>
<span class="nc bnc" id="L3099" title="All 2 branches missed.">                    : ((OdfNumberDateStyle) style).getFormat(true).equals(dateFormat))) {</span>
<span class="nc" id="L3100">              styleName = currentName;</span>
<span class="nc" id="L3101">              break;</span>
            }
<span class="nc bnc" id="L3103" title="All 2 branches missed.">            if (currentName.substring(0, 1).equals(&quot;N&quot;)) {</span>
<span class="nc" id="L3104">              String numString = currentName.substring(1, currentName.length());</span>
              try {
<span class="nc" id="L3106">                int oldIdx = Integer.parseInt(numString);</span>
<span class="nc" id="L3107">                newStyleIdx = Math.max(newStyleIdx, oldIdx);</span>
<span class="nc" id="L3108">              } catch (NumberFormatException e) {</span>
<span class="nc" id="L3109">                Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.INFO, null, e);</span>
<span class="nc" id="L3110">              }</span>
            }
<span class="nc" id="L3112">          }</span>
<span class="nc" id="L3113">          OdfFileDom fileDom = contentDom;</span>
<span class="nc bnc" id="L3114" title="All 2 branches missed.">          if (styleName == null) {</span>

            // create new style
<span class="nc" id="L3117">            autoStyles.getParentNode();</span>
<span class="nc" id="L3118">            styleName = &quot;N&quot; + (newStyleIdx + 1);</span>
<span class="nc" id="L3119">            OdfElement newStyle = null;</span>
<span class="nc bnc" id="L3120" title="All 2 branches missed.">            if (isTime) {</span>
<span class="nc" id="L3121">              newStyle = new OdfNumberTimeStyle(fileDom, dateFormat, styleName);</span>

            } else {
<span class="nc" id="L3124">              newStyle = new OdfNumberDateStyle(fileDom, dateFormat, styleName);</span>
            }

            // TODO: what makes an ODF date style not having automatic order?
<span class="nc" id="L3128">            newStyle.setAttributeNS(</span>
<span class="nc" id="L3129">                OdfDocumentNamespace.NUMBER.getUri(), &quot;number:automatic-order&quot;, &quot;true&quot;);</span>
<span class="nc" id="L3130">            autoStyles.appendChild(newStyle);</span>
          }
<span class="nc" id="L3132">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3133">              OdfDocumentNamespace.STYLE.getUri(), &quot;style:data-style-name&quot;, styleName);</span>
        }
<span class="nc" id="L3135">        newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3136">            OdfDocumentNamespace.STYLE.getUri(), &quot;style:data-style-name&quot;, styleName);</span>
<span class="nc" id="L3137">        String textUri = OdfDocumentNamespace.TEXT.getUri();</span>
<span class="nc" id="L3138">        String officeUri = OdfDocumentNamespace.OFFICE.getUri();</span>
<span class="nc" id="L3139">        String styleUri = OdfDocumentNamespace.STYLE.getUri();</span>
<span class="nc bnc" id="L3140" title="All 4 branches missed.">        if (currentMap.hasDateValue() &amp;&amp; fieldAttrs.has(&quot;dateValue&quot;)) {</span>
<span class="nc" id="L3141">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3142">              textUri, &quot;text:date-value&quot;, fieldAttrs.getString(&quot;dateValue&quot;));</span>
        }
<span class="nc bnc" id="L3144" title="All 4 branches missed.">        if (currentMap.hasFixed() &amp;&amp; fieldAttrs.has(&quot;fixed&quot;)) {</span>
<span class="nc" id="L3145">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3146">              textUri, &quot;text:fixed&quot;, Boolean.valueOf(fieldAttrs.getBoolean(&quot;fixed&quot;)).toString());</span>
        }
<span class="nc bnc" id="L3148" title="All 4 branches missed.">        if (currentMap.hasdbName() &amp;&amp; fieldAttrs.has(&quot;dbName&quot;)) {</span>
<span class="nc" id="L3149">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3150">              textUri, &quot;text:database-name&quot;, fieldAttrs.getString(&quot;dbName&quot;));</span>
        }
<span class="nc bnc" id="L3152" title="All 4 branches missed.">        if (currentMap.hasTableType() &amp;&amp; fieldAttrs.has(&quot;typeType&quot;)) {</span>
<span class="nc" id="L3153">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3154">              textUri, &quot;text:table-type&quot;, fieldAttrs.getString(&quot;tableType&quot;));</span>
        }
<span class="nc bnc" id="L3156" title="All 4 branches missed.">        if (currentMap.hasdbTable() &amp;&amp; fieldAttrs.has(&quot;dbTable&quot;)) {</span>
<span class="nc" id="L3157">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3158">              textUri, &quot;text:table-name&quot;, fieldAttrs.getString(&quot;dbTable&quot;));</span>
        }
<span class="nc bnc" id="L3160" title="All 4 branches missed.">        if (currentMap.hasdbColumn() &amp;&amp; fieldAttrs.has(&quot;dbColumn&quot;)) {</span>
<span class="nc" id="L3161">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3162">              textUri, &quot;text:column-name&quot;, fieldAttrs.getString(&quot;dbColumn&quot;));</span>
        }
<span class="nc bnc" id="L3164" title="All 4 branches missed.">        if (currentMap.hasDisplay() &amp;&amp; fieldAttrs.has(&quot;display&quot;)) {</span>
<span class="nc" id="L3165">          newFieldElement.setAttributeNS(textUri, &quot;text:display&quot;, fieldAttrs.getString(&quot;display&quot;));</span>
        }
<span class="nc bnc" id="L3167" title="All 4 branches missed.">        if (currentMap.hasRefFormat() &amp;&amp; fieldAttrs.has(&quot;refFormat&quot;)) {</span>
<span class="nc" id="L3168">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3169">              textUri, &quot;text:reference-format&quot;, fieldAttrs.getString(&quot;refFormat&quot;));</span>
        }
<span class="nc bnc" id="L3171" title="All 4 branches missed.">        if (currentMap.hasRefName() &amp;&amp; fieldAttrs.has(&quot;refName&quot;)) {</span>
<span class="nc" id="L3172">          newFieldElement.setAttributeNS(textUri, &quot;text:ref-name&quot;, fieldAttrs.getString(&quot;refName&quot;));</span>
        }
<span class="nc bnc" id="L3174" title="All 4 branches missed.">        if (currentMap.hasOutlinelevel() &amp;&amp; fieldAttrs.has(&quot;outlineLevel&quot;)) {</span>
<span class="nc" id="L3175">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3176">              textUri, &quot;text:outline-level&quot;, fieldAttrs.getString(&quot;outlineLevel&quot;));</span>
        }
<span class="nc bnc" id="L3178" title="All 4 branches missed.">        if (currentMap.hasPageNumFormat() &amp;&amp; fieldAttrs.has(&quot;pageNumFormat&quot;)) {</span>
<span class="nc" id="L3179">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3180">              styleUri, &quot;style:num-format&quot;, fieldAttrs.getString(&quot;pageNumFormat&quot;));</span>
        }
<span class="nc bnc" id="L3182" title="All 4 branches missed.">        if (currentMap.hasNumLetterSync() &amp;&amp; fieldAttrs.has(&quot;numLetterSync&quot;)) {</span>
<span class="nc" id="L3183">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3184">              styleUri, &quot;style:num-letter-sync&quot;, fieldAttrs.getString(&quot;numLetterSync&quot;));</span>
        }
<span class="nc bnc" id="L3186" title="All 4 branches missed.">        if (currentMap.hasCondition() &amp;&amp; fieldAttrs.has(&quot;condition&quot;)) {</span>
<span class="nc" id="L3187">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3188">              textUri, &quot;text:condition&quot;, fieldAttrs.getString(&quot;condition&quot;));</span>
        }
<span class="nc bnc" id="L3190" title="All 4 branches missed.">        if (currentMap.hasCurrentValue() &amp;&amp; fieldAttrs.has(&quot;currentValue&quot;)) {</span>
<span class="nc" id="L3191">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3192">              textUri, &quot;text:current-value&quot;, fieldAttrs.getString(&quot;currentValue&quot;));</span>
        }
<span class="nc bnc" id="L3194" title="All 4 branches missed.">        if (currentMap.hasFalseValue() &amp;&amp; fieldAttrs.has(&quot;falseValue&quot;)) {</span>
<span class="nc" id="L3195">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3196">              textUri, &quot;text:string-value-if-false&quot;, fieldAttrs.getString(&quot;falseValue&quot;));</span>
        }
<span class="nc bnc" id="L3198" title="All 4 branches missed.">        if (currentMap.hasTrueValue() &amp;&amp; fieldAttrs.has(&quot;trueValue&quot;)) {</span>
<span class="nc" id="L3199">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3200">              textUri, &quot;text:string-value-if-true&quot;, fieldAttrs.getString(&quot;trueValue&quot;));</span>
        }
<span class="nc bnc" id="L3202" title="All 4 branches missed.">        if (currentMap.hasConnectionName() &amp;&amp; fieldAttrs.has(&quot;connectionName&quot;)) {</span>
<span class="nc" id="L3203">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3204">              textUri, &quot;text:connection-name&quot;, fieldAttrs.getString(&quot;connectionName&quot;));</span>
        }
<span class="nc bnc" id="L3206" title="All 4 branches missed.">        if (currentMap.hasDuration() &amp;&amp; fieldAttrs.has(&quot;duration&quot;)) {</span>
<span class="nc" id="L3207">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3208">              textUri, &quot;text-duration&quot;, fieldAttrs.getString(&quot;duration&quot;));</span>
        }
<span class="nc bnc" id="L3210" title="All 4 branches missed.">        if (currentMap.hasName() &amp;&amp; fieldAttrs.has(OPK_NAME)) {</span>
<span class="nc" id="L3211">          newFieldElement.setAttributeNS(textUri, &quot;text:name&quot;, fieldAttrs.getString(OPK_NAME));</span>
        }
<span class="nc bnc" id="L3213" title="All 4 branches missed.">        if (currentMap.hasBoolValue() &amp;&amp; fieldAttrs.has(&quot;boolValue&quot;)) {</span>
<span class="nc" id="L3214">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3215">              officeUri, &quot;office:boolean-value&quot;, fieldAttrs.getString(&quot;boolValue&quot;));</span>
        }
<span class="nc bnc" id="L3217" title="All 4 branches missed.">        if (currentMap.hasCurrency() &amp;&amp; fieldAttrs.has(&quot;currency&quot;)) {</span>
<span class="nc" id="L3218">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3219">              officeUri, &quot;office:currency&quot;, fieldAttrs.getString(&quot;currency&quot;));</span>
        }
<span class="nc bnc" id="L3221" title="All 4 branches missed.">        if (currentMap.hasStringValue() &amp;&amp; fieldAttrs.has(&quot;stringValue&quot;)) {</span>
<span class="nc" id="L3222">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3223">              officeUri, &quot;office:value&quot;, fieldAttrs.getString(&quot;stringValue&quot;));</span>
        }
<span class="nc bnc" id="L3225" title="All 4 branches missed.">        if (currentMap.hasTimeValue() &amp;&amp; fieldAttrs.has(&quot;timeValue&quot;)) {</span>
<span class="nc" id="L3226">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3227">              textUri, &quot;text:time-value&quot;, fieldAttrs.getString(&quot;timeValue&quot;));</span>
        }
<span class="nc bnc" id="L3229" title="All 4 branches missed.">        if (currentMap.hasTValue() &amp;&amp; fieldAttrs.has(&quot;value&quot;)) {</span>
<span class="nc" id="L3230">          newFieldElement.setAttributeNS(officeUri, &quot;text:value&quot;, fieldAttrs.getString(&quot;value&quot;));</span>
        }
<span class="nc bnc" id="L3232" title="All 4 branches missed.">        if (currentMap.hasOValue() &amp;&amp; fieldAttrs.has(&quot;value&quot;)) {</span>
<span class="nc" id="L3233">          newFieldElement.setAttributeNS(officeUri, &quot;office:value&quot;, fieldAttrs.getString(&quot;value&quot;));</span>
        }
<span class="nc bnc" id="L3235" title="All 4 branches missed.">        if (currentMap.hasValueType() &amp;&amp; fieldAttrs.has(&quot;valueType&quot;)) {</span>
<span class="nc" id="L3236">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3237">              officeUri, &quot;office:value-type&quot;, fieldAttrs.getString(&quot;valueType&quot;));</span>
        }
<span class="nc bnc" id="L3239" title="All 4 branches missed.">        if (currentMap.hasFormula() &amp;&amp; fieldAttrs.has(&quot;formula&quot;)) {</span>
<span class="nc" id="L3240">          newFieldElement.setAttributeNS(textUri, &quot;text:formula&quot;, fieldAttrs.getString(&quot;formula&quot;));</span>
        }
<span class="nc bnc" id="L3242" title="All 4 branches missed.">        if (currentMap.hasIsHidden() &amp;&amp; fieldAttrs.has(&quot;isHidden&quot;)) {</span>
<span class="nc" id="L3243">          newFieldElement.setAttributeNS(textUri, &quot;text:hidden&quot;, fieldAttrs.getString(&quot;isHidden&quot;));</span>
        }
<span class="nc bnc" id="L3245" title="All 4 branches missed.">        if (currentMap.hasId() &amp;&amp; fieldAttrs.has(OPK_ID)) {</span>
<span class="nc" id="L3246">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3247">              OdfDocumentNamespace.XML.getUri(), &quot;xml:id&quot;, fieldAttrs.getString(OPK_ID));</span>
        }
<span class="nc bnc" id="L3249" title="All 4 branches missed.">        if (currentMap.hasDescription() &amp;&amp; fieldAttrs.has(&quot;description&quot;)) {</span>
<span class="nc" id="L3250">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3251">              textUri, &quot;text:description&quot;, fieldAttrs.getString(&quot;description&quot;));</span>
        }
<span class="nc bnc" id="L3253" title="All 4 branches missed.">        if (currentMap.hasActive() &amp;&amp; fieldAttrs.has(&quot;active&quot;)) {</span>
<span class="nc" id="L3254">          newFieldElement.setAttributeNS(textUri, &quot;text:active&quot;, fieldAttrs.getString(&quot;active&quot;));</span>
        }
<span class="nc bnc" id="L3256" title="All 4 branches missed.">        if (currentMap.hasHref() &amp;&amp; fieldAttrs.has(&quot;href&quot;)) {</span>
<span class="nc" id="L3257">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3258">              OdfDocumentNamespace.XLINK.getUri(), &quot;xlink:href&quot;, fieldAttrs.getString(&quot;href&quot;));</span>
        }
<span class="nc bnc" id="L3260" title="All 4 branches missed.">        if (currentMap.hasPlaceHolderType() &amp;&amp; fieldAttrs.has(&quot;placeHolderType&quot;)) {</span>
<span class="nc" id="L3261">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3262">              textUri, &quot;text:placeholder-type&quot;, fieldAttrs.getString(&quot;placeHolderType&quot;));</span>
        }
<span class="nc bnc" id="L3264" title="All 4 branches missed.">        if (currentMap.hasKind() &amp;&amp; fieldAttrs.has(&quot;kind&quot;)) {</span>
<span class="nc" id="L3265">          newFieldElement.setAttributeNS(textUri, &quot;text:kind&quot;, fieldAttrs.getString(&quot;kind&quot;));</span>
        }
<span class="nc bnc" id="L3267" title="All 4 branches missed.">        if (currentMap.hasLanguage() &amp;&amp; fieldAttrs.has(&quot;language&quot;)) {</span>
<span class="nc" id="L3268">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3269">              OdfDocumentNamespace.SCRIPT.getUri(),</span>
              &quot;script:language&quot;,
<span class="nc" id="L3271">              fieldAttrs.getString(&quot;language&quot;));</span>
        }
<span class="nc bnc" id="L3273" title="All 4 branches missed.">        if (currentMap.hasLinkType() &amp;&amp; fieldAttrs.has(&quot;linkType&quot;)) {</span>
<span class="nc" id="L3274">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3275">              OdfDocumentNamespace.XLINK.getUri(), &quot;xlink:type&quot;, fieldAttrs.getString(&quot;linkType&quot;));</span>
        }
<span class="nc bnc" id="L3277" title="All 4 branches missed.">        if (currentMap.hasNumFormat() &amp;&amp; fieldAttrs.has(&quot;numFormat&quot;)) {</span>
<span class="nc" id="L3278">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3279">              styleUri, &quot;style:num-format&quot;, fieldAttrs.getString(&quot;numFormat&quot;));</span>
        }
<span class="nc bnc" id="L3281" title="All 4 branches missed.">        if (currentMap.hasPageAdjust() &amp;&amp; fieldAttrs.has(&quot;pageAdjust&quot;)) {</span>
<span class="nc" id="L3282">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3283">              textUri, &quot;text:page-adjust&quot;, fieldAttrs.getString(&quot;pageAdjust&quot;));</span>
        }
<span class="nc bnc" id="L3285" title="All 4 branches missed.">        if (currentMap.hasRowNumber() &amp;&amp; fieldAttrs.has(&quot;rowNumber&quot;)) {</span>
<span class="nc" id="L3286">          newFieldElement.setAttributeNS(</span>
<span class="nc" id="L3287">              textUri, &quot;text:row-number&quot;, fieldAttrs.getString(&quot;rowNumber&quot;));</span>
        }
<span class="nc" id="L3289">      } catch (JSONException e) {</span>
<span class="nc" id="L3290">        Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, e);</span>
<span class="nc" id="L3291">      }</span>
    }
<span class="nc" id="L3293">  }</span>

  /** Currently all fields are being mapped to a common text field, i.e. &lt;text:text-input&gt; */
  public static void addField(
      Component rootComponent,
      OdfContentDom contentDom,
      JSONArray start,
      String type,
      String representation,
      JSONObject attrs) {
    // Parent will not change and have to exist to insert the new component
<span class="nc" id="L3304">    final Component parentComponent = rootComponent.getParentOf(start);</span>
<span class="nc bnc" id="L3305" title="All 2 branches missed.">    if (parentComponent == null) {</span>
<span class="nc" id="L3306">      LOG.log(</span>
          Level.SEVERE, &quot;The parent component of the table should exist at position {0}&quot;, start);
    } else {
      // CREATING NEW ROOT ELEMENT
<span class="nc" id="L3310">      OdfFileDom xmlDoc = (OdfFileDom) parentComponent.getOwnerDocument();</span>
<span class="nc" id="L3311">      OdfElement newFieldElement = null;</span>
<span class="nc" id="L3312">      FieldMap currentMap = FieldMap.fieldMap.get(type);</span>
<span class="nc bnc" id="L3313" title="All 2 branches missed.">      if (currentMap != null) {</span>
        Class&lt;OdfElement&gt; fieldClass;
        try {
<span class="nc" id="L3316">          fieldClass = (Class&lt;OdfElement&gt;) Class.forName(currentMap.getClassName());</span>
<span class="nc bnc" id="L3317" title="All 2 branches missed.">          if (fieldClass != null) {</span>
<span class="nc" id="L3318">            Class[] types = {OdfFileDom.class};</span>
<span class="nc" id="L3319">            Constructor&lt;OdfElement&gt; constructor = fieldClass.getConstructor(types);</span>
<span class="nc" id="L3320">            newFieldElement = constructor.newInstance(xmlDoc);</span>
          }
<span class="nc" id="L3322">        } catch (InstantiationException e) {</span>
<span class="nc" id="L3323">          Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, e);</span>
<span class="nc" id="L3324">        } catch (IllegalAccessException e) {</span>
<span class="nc" id="L3325">          Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, e);</span>
<span class="nc" id="L3326">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L3327">          Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, e);</span>
<span class="nc" id="L3328">        } catch (InvocationTargetException e) {</span>
<span class="nc" id="L3329">          Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, e);</span>
<span class="nc" id="L3330">        } catch (NoSuchMethodException e) {</span>
<span class="nc" id="L3331">          Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, e);</span>
<span class="nc" id="L3332">        } catch (SecurityException e) {</span>
<span class="nc" id="L3333">          Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, e);</span>
<span class="nc" id="L3334">        } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L3335">          Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, e);</span>
<span class="nc" id="L3336">        }</span>
<span class="nc" id="L3337">        setFieldAttributes(newFieldElement, attrs, currentMap, contentDom);</span>
<span class="nc bnc" id="L3338" title="All 2 branches missed.">        if (representation != null) {</span>
<span class="nc" id="L3339">          Text text = xmlDoc.createTextNode(representation);</span>
<span class="nc" id="L3340">          newFieldElement.appendChild(text);</span>
        }
        try {
          // ADDING COMPONENT
<span class="nc" id="L3344">          addElementAsComponent(parentComponent, newFieldElement, start.getInt(start.length() - 1));</span>
<span class="nc" id="L3345">        } catch (JSONException ex) {</span>
<span class="nc" id="L3346">          Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L3347">        }</span>
      }
    }
<span class="nc" id="L3350">  }</span>

  /** Modify field at the given position &lt;text:text-input&gt; */
  public static void changeField(
      Component rootComponent,
      OdfContentDom contentDom,
      JSONArray start,
      String type,
      String representation,
      JSONObject attrs) {
    // Parent will not change and have to exist to insert the new component
<span class="nc" id="L3361">    final Component parentComponent = rootComponent.getParentOf(start);</span>
<span class="nc bnc" id="L3362" title="All 2 branches missed.">    if (parentComponent == null) {</span>
<span class="nc" id="L3363">      LOG.log(</span>
          Level.SEVERE, &quot;The parent component of the table should exist at position {0}&quot;, start);
    } else {
<span class="nc" id="L3366">      int targetPos = start.optInt(start.length() - 1);</span>
<span class="nc" id="L3367">      Node targetNode = parentComponent.getChildNode(targetPos);</span>
<span class="nc bnc" id="L3368" title="All 2 branches missed.">      if (targetNode != null) {</span>
<span class="nc" id="L3369">        LOG.log(Level.SEVERE, &quot;node found&quot;);</span>
<span class="nc bnc" id="L3370" title="All 2 branches missed.">        if (representation != null) {</span>
<span class="nc" id="L3371">          targetNode.setTextContent(representation);</span>
        }
<span class="nc bnc" id="L3373" title="All 2 branches missed.">        if (type != null) {</span>
<span class="nc" id="L3374">          OdfElement element = (OdfElement) targetNode;</span>
<span class="nc" id="L3375">          FieldMap currentMap = FieldMap.fieldMap.get(type);</span>
<span class="nc" id="L3376">          setFieldAttributes(element, attrs, currentMap, contentDom);</span>
<span class="nc bnc" id="L3377" title="All 2 branches missed.">          if (Component.isField(targetNode.getNamespaceURI(), targetNode.getLocalName())) {</span>
<span class="nc" id="L3378">            LOG.log(Level.SEVERE, &quot;field found&quot;);</span>
          }
<span class="nc bnc" id="L3380" title="All 2 branches missed.">        } else if (attrs != null) {</span>
<span class="nc" id="L3381">          JsonOperationConsumer.format(rootComponent, start, start, attrs);</span>
        }
      }
    }
<span class="nc" id="L3385">  }</span>

  public static void addDrawing(
      Component rootComponent,
      JSONArray start,
      JSONObject attrs,
      String type,
      CollabTextDocument opsDoc)
      throws IndexOutOfBoundsException, JSONException {
    // Parent will not change and have to exist to insert the new component
<span class="nc" id="L3395">    final Component parentComponent = rootComponent.getParentOf(start);</span>
<span class="nc bnc" id="L3396" title="All 2 branches missed.">    if (parentComponent == null) {</span>
<span class="nc" id="L3397">      LOG.log(</span>
          Level.SEVERE, &quot;The parent component of the table should exist at position {0}&quot;, start);
    } else {
<span class="nc bnc" id="L3400" title="All 4 branches missed.">      boolean isImageFrame = (type != null &amp;&amp; type.equals(&quot;image&quot;));</span>
      // CREATING NEW ROOT ELEMENT
<span class="nc" id="L3402">      OdfFileDom xmlDoc = (OdfFileDom) parentComponent.getOwnerDocument();</span>
<span class="nc" id="L3403">      DrawShapeElementBase frameElement = null;</span>
<span class="nc" id="L3404">      DrawImageElement imageElement = null;</span>
<span class="nc" id="L3405">      JSONObject drawingProps = null;</span>
<span class="nc" id="L3406">      int alternativeNo = -1;</span>
<span class="nc bnc" id="L3407" title="All 2 branches missed.">      if (attrs != null) {</span>
<span class="nc" id="L3408">        drawingProps = attrs.optJSONObject(&quot;drawing&quot;);</span>
<span class="nc bnc" id="L3409" title="All 2 branches missed.">        if (drawingProps == null) {</span>
<span class="nc" id="L3410">          drawingProps = new JSONObject();</span>
<span class="nc" id="L3411">          attrs.put(&quot;drawing&quot;, drawingProps);</span>
        }
<span class="nc bnc" id="L3413" title="All 2 branches missed.">        if (!drawingProps.has(&quot;inline&quot;)) {</span>
<span class="nc" id="L3414">          drawingProps.put(&quot;inline&quot;, true);</span>
        }
<span class="nc bnc" id="L3416" title="All 4 branches missed.">        if (drawingProps != null &amp;&amp; drawingProps.has(&quot;viewAlternative&quot;)) {</span>
          try {
<span class="nc" id="L3418">            alternativeNo = drawingProps.optInt(&quot;viewAlternative&quot;);</span>
<span class="nc" id="L3419">            frameElement =</span>
<span class="nc" id="L3420">                (DrawFrameElement) parentComponent.getChildNode(start.getInt(start.length() - 1));</span>
<span class="nc" id="L3421">          } catch (JSONException ex) {</span>
<span class="nc" id="L3422">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L3423">          }</span>
<span class="nc bnc" id="L3424" title="All 2 branches missed.">        } else if (type.equals(&quot;group&quot;)) {</span>
<span class="nc" id="L3425">          frameElement = new DrawGElement(xmlDoc);</span>
        } else {
<span class="nc" id="L3427">          frameElement = new DrawFrameElement(xmlDoc);</span>
<span class="nc bnc" id="L3428" title="All 2 branches missed.">          if (isImageFrame) {</span>
<span class="nc" id="L3429">            final JSONObject imageProps = attrs.optJSONObject(&quot;image&quot;);</span>
<span class="nc" id="L3430">            imageElement = ((DrawFrameElement) frameElement).newDrawImageElement();</span>
<span class="nc" id="L3431">            imageElement.setXlinkTypeAttribute(&quot;simple&quot;);</span>
<span class="nc" id="L3432">            imageElement.setXlinkShowAttribute(&quot;embed&quot;);</span>
<span class="nc" id="L3433">            imageElement.setXlinkActuateAttribute(&quot;onLoad&quot;);</span>
<span class="nc bnc" id="L3434" title="All 2 branches missed.">            if (imageProps != null) {</span>
<span class="nc" id="L3435">              setImageProperties(imageElement, imageProps);</span>
            }
          }
        }
<span class="nc bnc" id="L3439" title="All 2 branches missed.">        if (frameElement != null) {</span>
<span class="nc" id="L3440">          setFrameProperties(frameElement, attrs);</span>
        }
        // ADDING STYLES TO THE NEW ELEMENT
        try { // TODO: at the moment only one type of shapes can be inserted - a text frame, later a
          // detection of non-textframes is required here
<span class="nc" id="L3445">          if (</span>
<span class="nc bnc" id="L3446" title="All 2 branches missed.">          /*type.equals(&quot;shape&quot;) &amp;&amp; */ !attrs.has(OPK_STYLE_ID)) {</span>
<span class="nc" id="L3447">            attrs.put(OPK_STYLE_ID, &quot;default&quot;);</span>
          }
<span class="nc" id="L3449">        } catch (JSONException e) {</span>
<span class="nc" id="L3450">        }</span>
<span class="nc" id="L3451">        addStyle(attrs, frameElement, xmlDoc);</span>
      }

      // INSERTING THE IMAGE or text frame
      try {
<span class="nc bnc" id="L3456" title="All 2 branches missed.">        if (frameElement != null) {</span>
<span class="nc bnc" id="L3457" title="All 2 branches missed.">          if (alternativeNo == -1) {</span>
            // ADDING COMPONENT
<span class="nc" id="L3459">            addElementAsComponent(parentComponent, frameElement, start.getInt(start.length() - 1));</span>
<span class="nc" id="L3460">            DrawTextBoxElement textBoxElement = new DrawTextBoxElement(xmlDoc);</span>
<span class="nc" id="L3461">            frameElement.insertBefore(textBoxElement, null);</span>
<span class="nc bnc" id="L3462" title="All 2 branches missed.">          } else if (imageElement != null) {</span>
<span class="nc" id="L3463">            NodeList frameChildren = frameElement.getChildNodes();</span>
<span class="nc" id="L3464">            int imagesFound = 0;</span>
<span class="nc" id="L3465">            Node followingImage = null;</span>
<span class="nc bnc" id="L3466" title="All 2 branches missed.">            for (int i = 0; i &lt; frameChildren.getLength(); i++) {</span>
<span class="nc" id="L3467">              Node node = frameChildren.item(i);</span>
<span class="nc bnc" id="L3468" title="All 2 branches missed.">              if (node instanceof DrawImageElement) {</span>
<span class="nc" id="L3469">                imagesFound++;</span>
              }
<span class="nc bnc" id="L3471" title="All 2 branches missed.">              if (imagesFound &gt; alternativeNo) {</span>
<span class="nc" id="L3472">                followingImage = node;</span>
<span class="nc" id="L3473">                break;</span>
              }
            }
            // if followingImage is null, the imageElement will be appended (see API)
<span class="nc" id="L3477">            frameElement.insertBefore(imageElement, followingImage);</span>
          }
        }
<span class="nc" id="L3480">      } catch (JSONException ex) {</span>
<span class="nc" id="L3481">        Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L3482">      }</span>

      // INSERTING THE IMAGE TO THE ZIP
<span class="nc" id="L3485">      String packagePath = null;</span>
<span class="nc" id="L3486">      final JSONObject imageProps = attrs.optJSONObject(&quot;image&quot;);</span>
<span class="nc bnc" id="L3487" title="All 2 branches missed.">      if (imageProps != null) {</span>
<span class="nc" id="L3488">        Object imageUrl = imageProps.opt(&quot;imageUrl&quot;);</span>
<span class="nc bnc" id="L3489" title="All 4 branches missed.">        if (imageUrl != null &amp;&amp; imageUrl instanceof String) {</span>
<span class="nc" id="L3490">          packagePath = (String) imageUrl;</span>
        }
      }
<span class="nc bnc" id="L3493" title="All 6 branches missed.">      if (packagePath != null &amp;&amp; imageElement != null &amp;&amp; imageElement instanceof OdfDrawImage) {</span>
<span class="nc bnc" id="L3494" title="All 2 branches missed.">        if (packagePath.contains(&quot;uid&quot;)) {</span>
<span class="nc" id="L3495">          int uidStart = packagePath.indexOf(&quot;uid&quot;) + 3;</span>
<span class="nc bnc" id="L3496" title="All 2 branches missed.">          if (uidStart != 3</span>
<span class="nc bnc" id="L3497" title="All 2 branches missed.">              &amp;&amp; uidStart &lt; packagePath.length()</span>
<span class="nc bnc" id="L3498" title="All 2 branches missed.">              &amp;&amp; uidStart &lt; packagePath.indexOf('.')) {</span>
<span class="nc" id="L3499">            String uidString = null;</span>
<span class="nc bnc" id="L3500" title="All 2 branches missed.">            if (packagePath.contains(&quot;.&quot;)) {</span>
<span class="nc" id="L3501">              uidString = packagePath.substring(uidStart, packagePath.indexOf('.'));</span>
            } else {
<span class="nc" id="L3503">              uidString = packagePath.substring(uidStart);</span>
            }
<span class="nc bnc" id="L3505" title="All 2 branches missed.">            if (uidString != null) {</span>
<span class="nc" id="L3506">              long uid = Long.parseLong(uidString, 16);</span>
<span class="nc" id="L3507">              Map&lt;Long, byte[]&gt; resourceMap = opsDoc.getResourceMap();</span>
<span class="nc bnc" id="L3508" title="All 2 branches missed.">              if (resourceMap != null) {</span>
<span class="nc" id="L3509">                byte[] fileBytes = resourceMap.get(uid);</span>
<span class="nc bnc" id="L3510" title="All 2 branches missed.">                if (fileBytes != null) {</span>
<span class="nc" id="L3511">                  OdfDrawImage image = (OdfDrawImage) imageElement;</span>
                  try {
<span class="nc" id="L3513">                    image.newImage(</span>
<span class="nc" id="L3514">                        fileBytes, packagePath, OdfFileEntry.getMediaTypeString(packagePath));</span>
<span class="nc" id="L3515">                  } catch (Exception ex) {</span>
<span class="nc" id="L3516">                    Logger.getLogger(JsonOperationConsumer.class.getName())</span>
<span class="nc" id="L3517">                        .log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L3518">                  }</span>
                }
              }
            }
<span class="nc" id="L3522">          } else {</span>
<span class="nc" id="L3523">            LOG.severe(&quot;No appropriate resource URL found for picture: &quot; + packagePath);</span>
          }
        }
      }
    }
<span class="nc" id="L3528">  }</span>

  private static void setImageProperties(DrawImageElement imageElement, JSONObject imageProps) {
<span class="nc bnc" id="L3531" title="All 2 branches missed.">    if (imageProps.has(&quot;imageUrl&quot;)) {</span>
<span class="nc" id="L3532">      String href = imageProps.optString(&quot;imageUrl&quot;);</span>
<span class="nc bnc" id="L3533" title="All 4 branches missed.">      if (href != null &amp;&amp; !href.isEmpty()) {</span>
<span class="nc" id="L3534">        imageElement.setXlinkHrefAttribute(href);</span>
      }
<span class="nc bnc" id="L3536" title="All 2 branches missed.">    } else if (imageProps.has(&quot;imageData&quot;)) {</span>
<span class="nc" id="L3537">      String imageData = imageProps.optString(&quot;imageData&quot;);</span>
<span class="nc bnc" id="L3538" title="All 4 branches missed.">      if (imageData != null &amp;&amp; !imageData.isEmpty()) {</span>
        // expected header is
        //		&quot;data:image/png;base64,
<span class="nc" id="L3541">        String[] header = imageData.split(&quot;base64,&quot;);</span>
<span class="nc" id="L3542">        String suffix = &quot;png&quot;;</span>
<span class="nc" id="L3543">        String mediaTypeString = &quot;image/png&quot;;</span>
        try {
<span class="nc" id="L3545">          mediaTypeString = header[0].substring(header[0].indexOf(&quot;:&quot;) + 1, header[0].indexOf(&quot;;&quot;));</span>
<span class="nc" id="L3546">          suffix = header[0].substring(header[0].indexOf(&quot;/&quot;) + 1, header[0].indexOf(&quot;;&quot;));</span>
<span class="nc" id="L3547">        } catch (Throwable t) {</span>
          // don't worry if the header is not as expected
<span class="nc" id="L3549">          LOG.finer(&quot;BASE64 is not as expected '&quot; + header[0] + &quot;', the exception:&quot; + t);</span>
<span class="nc" id="L3550">        }</span>
<span class="nc" id="L3551">        String fileName = &quot;img_&quot; + new Random().nextInt() + &quot;.&quot; + suffix;</span>
<span class="nc" id="L3552">        Base64Binary base64Binary = Base64Binary.valueOf(header[1]);</span>
<span class="nc" id="L3553">        OdfPackage pkg = ((OdfFileDom) imageElement.getOwnerDocument()).getDocument().getPackage();</span>
        // args: fileBytes, internalPath, mediaTypeString) {
<span class="nc" id="L3555">        pkg.insert(base64Binary.getBytes(), &quot;Pictures/&quot; + fileName, mediaTypeString);</span>
<span class="nc" id="L3556">        imageElement.setXlinkHrefAttribute(&quot;Pictures/&quot; + fileName);</span>
      }
    }
<span class="nc bnc" id="L3559" title="All 2 branches missed.">    if (imageProps.has(&quot;imageXmlId&quot;)) {</span>
<span class="nc" id="L3560">      String xmlId = imageProps.optString(&quot;imageXmlId&quot;);</span>
<span class="nc bnc" id="L3561" title="All 4 branches missed.">      if (xmlId != null &amp;&amp; !xmlId.isEmpty()) {</span>
<span class="nc" id="L3562">        imageElement.setXmlIdAttribute(xmlId);</span>
      }
    }
<span class="nc" id="L3565">  }</span>

  private static void setFrameProperties(DrawShapeElementBase frameElement, JSONObject attrs) {
<span class="nc" id="L3568">    JSONObject drawingProps = attrs.optJSONObject(&quot;drawing&quot;);</span>
<span class="nc bnc" id="L3569" title="All 2 branches missed.">    if (drawingProps != null) {</span>
<span class="nc bnc" id="L3570" title="All 2 branches missed.">      if (drawingProps.has(&quot;width&quot;)) {</span>
<span class="nc" id="L3571">        int width = drawingProps.optInt(&quot;width&quot;);</span>
<span class="nc" id="L3572">        frameElement.setSvgWidthAttribute(width / 100.0 + &quot;mm&quot;);</span>
      }
<span class="nc bnc" id="L3574" title="All 2 branches missed.">      if (drawingProps.has(&quot;height&quot;)) {</span>
<span class="nc" id="L3575">        int height = drawingProps.optInt(&quot;height&quot;);</span>
<span class="nc" id="L3576">        frameElement.setSvgHeightAttribute(height / 100.0 + &quot;mm&quot;);</span>
      }
<span class="nc bnc" id="L3578" title="All 2 branches missed.">      if (drawingProps.has(OPK_NAME)) {</span>
<span class="nc" id="L3579">        String name = drawingProps.optString(OPK_NAME);</span>
<span class="nc bnc" id="L3580" title="All 4 branches missed.">        if (name != null &amp;&amp; !name.isEmpty()) {</span>
<span class="nc" id="L3581">          frameElement.setDrawNameAttribute(name);</span>
        }
      }
<span class="nc bnc" id="L3584" title="All 2 branches missed.">      if (drawingProps.has(&quot;anchorHorOffset&quot;)) {</span>
<span class="nc" id="L3585">        int x = drawingProps.optInt(&quot;anchorHorOffset&quot;);</span>
<span class="nc" id="L3586">        frameElement.setSvgXAttribute(x / 100.0 + &quot;mm&quot;);</span>
      }
<span class="nc bnc" id="L3588" title="All 2 branches missed.">      if (drawingProps.has(&quot;anchorVertOffset&quot;)) {</span>
<span class="nc" id="L3589">        int y = drawingProps.optInt(&quot;anchorVertOffset&quot;);</span>
<span class="nc" id="L3590">        frameElement.setSvgYAttribute(y / 100.0 + &quot;mm&quot;);</span>
      }
<span class="nc bnc" id="L3592" title="All 2 branches missed.">      if (drawingProps.has(&quot;inline&quot;)</span>
<span class="nc bnc" id="L3593" title="All 2 branches missed.">          &amp;&amp; !drawingProps.get(&quot;inline&quot;).equals(JSONObject.NULL)</span>
<span class="nc bnc" id="L3594" title="All 2 branches missed.">          &amp;&amp; drawingProps.optBoolean(&quot;inline&quot;)) {</span>
<span class="nc" id="L3595">        frameElement.setTextAnchorTypeAttribute(&quot;as-char&quot;);</span>
<span class="nc bnc" id="L3596" title="All 4 branches missed.">      } else if (drawingProps.has(&quot;anchorHorBase&quot;) &amp;&amp; drawingProps.has(&quot;anchorVertBase&quot;)) {</span>
<span class="nc" id="L3597">        String anchorHorBase = drawingProps.optString(&quot;anchorHorBase&quot;);</span>
<span class="nc" id="L3598">        String anchorVertBase = drawingProps.optString(&quot;anchorVertBase&quot;);</span>
<span class="nc bnc" id="L3599" title="All 4 branches missed.">        if (anchorHorBase != null &amp;&amp; anchorVertBase != null) {</span>
<span class="nc bnc" id="L3600" title="All 4 branches missed.">          if (anchorHorBase.equals(&quot;page&quot;) &amp;&amp; anchorVertBase.equals(&quot;page&quot;)) {</span>
<span class="nc" id="L3601">            frameElement.setTextAnchorTypeAttribute(&quot;paragraph&quot;);</span>

<span class="nc bnc" id="L3603" title="All 4 branches missed.">          } else if (anchorHorBase.equals(&quot;column&quot;) &amp;&amp; anchorVertBase.equals(&quot;margin&quot;)) {</span>
<span class="nc" id="L3604">            frameElement.setTextAnchorTypeAttribute(&quot;frame&quot;);</span>

<span class="nc bnc" id="L3606" title="All 4 branches missed.">          } else if (anchorHorBase.equals(&quot;column&quot;) &amp;&amp; anchorVertBase.equals(&quot;paragraph&quot;)) {</span>
<span class="nc" id="L3607">            frameElement.setTextAnchorTypeAttribute(&quot;paragraph&quot;);</span>
            // apply related default wrapping, if not part of the attributes:
<span class="nc bnc" id="L3609" title="All 4 branches missed.">            if (!drawingProps.has(&quot;textWrapMode&quot;) &amp;&amp; !drawingProps.has(&quot;textWrapSide&quot;)) {</span>
              try {
<span class="nc" id="L3611">                drawingProps.put(&quot;textWrapMode&quot;, &quot;topAndBottom&quot;);</span>
<span class="nc" id="L3612">              } catch (JSONException e) {</span>
                // no handline required
<span class="nc" id="L3614">              }</span>
            }
<span class="nc bnc" id="L3616" title="All 4 branches missed.">          } else if (anchorHorBase.equals(&quot;character&quot;) &amp;&amp; anchorVertBase.equals(&quot;paragraph&quot;)) {</span>
<span class="nc" id="L3617">            frameElement.setTextAnchorTypeAttribute(&quot;char&quot;);</span>
          } else { // the default is &quot;inline&quot; a
<span class="nc" id="L3619">            frameElement.setTextAnchorTypeAttribute(&quot;as-char&quot;);</span>
          }
        }
<span class="nc" id="L3622">      } else {</span>
<span class="nc bnc" id="L3623" title="All 2 branches missed.">        if (drawingProps.has(&quot;anchorHorBase&quot;)) {</span>
<span class="nc" id="L3624">          String anchorHorBase = drawingProps.optString(&quot;anchorHorBase&quot;);</span>
<span class="nc bnc" id="L3625" title="All 2 branches missed.">          if (anchorHorBase != null) {</span>
<span class="nc bnc" id="L3626" title="All 2 branches missed.">            if (anchorHorBase.equals(&quot;page&quot;)) {</span>
<span class="nc" id="L3627">              frameElement.setTextAnchorTypeAttribute(&quot;page&quot;);</span>

<span class="nc bnc" id="L3629" title="All 2 branches missed.">            } else if (anchorHorBase.equals(&quot;column&quot;)) {</span>
<span class="nc" id="L3630">              frameElement.setTextAnchorTypeAttribute(&quot;paragraph&quot;);</span>

<span class="nc bnc" id="L3632" title="All 2 branches missed.">            } else if (anchorHorBase.equals(&quot;character&quot;)) {</span>
<span class="nc" id="L3633">              frameElement.setTextAnchorTypeAttribute(&quot;char&quot;);</span>
            }
          }
        }
      }
<span class="nc bnc" id="L3638" title="All 2 branches missed.">      if (drawingProps.has(&quot;anchorLayerOrder&quot;)) {</span>
<span class="nc" id="L3639">        int anchorLayerOrder = drawingProps.optInt(&quot;anchorLayerOrder&quot;, 0);</span>
<span class="nc" id="L3640">        frameElement.setDrawZIndexAttribute(anchorLayerOrder);</span>
      }
    }
<span class="nc" id="L3643">    JSONObject shapeProps = attrs.optJSONObject(&quot;shape&quot;);</span>
<span class="nc bnc" id="L3644" title="All 2 branches missed.">    if (shapeProps != null) {</span>
<span class="nc bnc" id="L3645" title="All 4 branches missed.">      if (shapeProps.has(&quot;autoResizeHeight&quot;) &amp;&amp; shapeProps.optBoolean(&quot;autoResizeHeight&quot;) == true) {</span>
<span class="nc" id="L3646">        frameElement.removeAttribute(&quot;height&quot;);</span>
      }
    }
<span class="nc" id="L3649">  }</span>

  /**
   * @param rootComponent high level document structure
   * @param pos position of the tableElement starting with 0 and one over the existing is allowed
   * @throws IndexOutOfBoundsException - if index is out of range (index &lt; 0 || index &gt; size()). One
   *     over size is allowed to append a tableElement.
   */
  public static void addTable(
      Component rootComponent,
      JSONArray start,
      JSONObject attrs,
      JSONObject sizeExceeded,
      String tableName)
      throws IndexOutOfBoundsException {
    // Parent will not change and have to exist to insert the new component
<span class="nc" id="L3665">    final Component parentComponent = rootComponent.getParentOf(start);</span>

<span class="nc bnc" id="L3667" title="All 2 branches missed.">    if (parentComponent == null) {</span>
<span class="nc" id="L3668">      LOG.log(</span>
          Level.SEVERE, &quot;The parent component of the table should exist at position {0}&quot;, start);
    } else {
<span class="nc" id="L3671">      OdfFileDom xmlDoc = (OdfFileDom) parentComponent.getOwnerDocument();</span>
      OdfStylableElement newTableElement;
<span class="nc bnc" id="L3673" title="All 2 branches missed.">      if (sizeExceeded == null) {</span>
        // CREATING NEW ROOT ELEMENT
<span class="nc" id="L3675">        newTableElement = new TableTableElement(xmlDoc);</span>
<span class="nc bnc" id="L3676" title="All 4 branches missed.">        if (tableName != null &amp;&amp; !tableName.isEmpty()) {</span>
<span class="nc" id="L3677">          ((TableTableElement) newTableElement).setTableNameAttribute(tableName);</span>
        }
<span class="nc bnc" id="L3679" title="All 2 branches missed.">        if (attrs == null) {</span>
<span class="nc" id="L3680">          attrs = new JSONObject();</span>
          try {
<span class="nc" id="L3682">            attrs.put(&quot;visible&quot;, true);</span>
<span class="nc" id="L3683">          } catch (JSONException e) {</span>
<span class="nc" id="L3684">          }</span>
        }
<span class="nc bnc" id="L3686" title="All 2 branches missed.">        if (attrs != null) {</span>
          // ADDING STYLES TO THE NEW ELEMENT
<span class="nc" id="L3688">          addStyle(attrs, newTableElement, xmlDoc);</span>
<span class="nc" id="L3689">          JSONObject tableProps = attrs.optJSONObject(&quot;table&quot;);</span>
<span class="nc bnc" id="L3690" title="All 2 branches missed.">          if (tableProps != null) {</span>
<span class="nc" id="L3691">            JSONArray tableGrid = tableProps.optJSONArray(&quot;tableGrid&quot;);</span>
<span class="nc bnc" id="L3692" title="All 2 branches missed.">            if (tableGrid != null) {</span>
<span class="nc" id="L3693">              addNewColumns((TableTableElement) newTableElement, tableGrid);</span>
            }
          }
        }
        try {
          // ADDING TABLE COMPONENT
<span class="nc" id="L3699">          addElementAsComponent(parentComponent, newTableElement, start.getInt(start.length() - 1));</span>
<span class="nc" id="L3700">        } catch (JSONException ex) {</span>
<span class="nc" id="L3701">          Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L3702">        }</span>
      } else {
        // No tableElement, just writing a paragraph with an error
<span class="nc" id="L3705">        newTableElement = new TextPElement(xmlDoc);</span>
<span class="nc" id="L3706">        newTableElement.appendChild(xmlDoc.createTextNode(&quot;This table was too large!&quot;));</span>
        try {
          // ADDING COMPONENT
<span class="nc" id="L3709">          addElementAsComponent(parentComponent, newTableElement, start.getInt(start.length() - 1));</span>
<span class="nc" id="L3710">        } catch (JSONException ex) {</span>
<span class="nc" id="L3711">          Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L3712">        }</span>
      }
    }
<span class="nc" id="L3715">  }</span>

  /*
      Current implementation only supports the annotation of paragraphs (perhaps other components), by adding the annotation as component into the document beyond the paragraph.
      But the annotation will never allow the annotation of text, as text is a leave and can not have an annotation beyond!
      Or shall style info be beyond a character?

      See content.xml of text-extract.odt

      &lt;text:p text:style-name=&quot;P6&quot;&gt;ODFDOM &lt;text:span text:style-name=&quot;T3&quot;&gt;in a &lt;/text:span&gt;
          &lt;text:span text:style-name=&quot;T3&quot;&gt;
              &lt;office:annotation office:name=&quot;__Annotation__271_116812866&quot;&gt;
                  &lt;dc:creator&gt;Unbekannter Autor&lt;/dc:creator&gt;
                  &lt;dc:date&gt;2019-06-17T20:51:24.996000000&lt;/dc:date&gt;
                  &lt;text:p text:style-name=&quot;P7&quot;&gt;
                      &lt;text:span text:style-name=&quot;T7&quot;&gt;A Note about section!!!&lt;/text:span&gt;
                  &lt;/text:p&gt;
              &lt;/office:annotation&gt;
          &lt;/text:span&gt;
          &lt;text:span text:style-name=&quot;T3&quot;&gt;section&lt;/text:span&gt;
          &lt;office:annotation-end office:name=&quot;__Annotation__271_116812866&quot;/&gt;

      See content.xml and styles.xml of HeaderFooter.odt for overlapping notes &amp; notes in footer!

  SOLUTION: Create a &quot;target&quot; and annotation refers to target!
   */
  public static void addAnnotation(
      Component rootComponent,
      JSONArray start,
      JSONObject attrs,
      String id,
      String author,
      String date) {
    // TODO: attrs need to be supported
<span class="nc" id="L3749">    final Component parentComponent = rootComponent.getParentOf(start);</span>
<span class="nc bnc" id="L3750" title="All 2 branches missed.">    if (parentComponent == null) {</span>
<span class="nc" id="L3751">      LOG.log(</span>
          Level.SEVERE, &quot;The parent component of the comment should exist at position {0}&quot;, start);
<span class="nc bnc" id="L3753" title="All 2 branches missed.">    } else if (!id.startsWith(COMMENT_PREFIX)) {</span>
<span class="nc" id="L3754">      LOG.log(Level.SEVERE, &quot;The comment id should start with &quot; + COMMENT_PREFIX, start);</span>
    } else {
<span class="nc" id="L3756">      OdfFileDom xmlDoc = (OdfFileDom) parentComponent.getOwnerDocument();</span>
<span class="nc" id="L3757">      OfficeAnnotationElement newCommentElement = new OfficeAnnotationElement(xmlDoc);</span>
<span class="nc" id="L3758">      id = id.substring(COMMENT_PREFIX.length());</span>
<span class="nc" id="L3759">      newCommentElement.setOfficeNameAttribute(id);</span>
      try {
        // ADDING ANNOTATION COMPONENT
<span class="nc" id="L3762">        addElementAsComponent(parentComponent, newCommentElement, start.getInt(start.length() - 1));</span>
<span class="nc" id="L3763">      } catch (JSONException ex) {</span>
<span class="nc" id="L3764">        Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L3765">      }</span>
<span class="nc bnc" id="L3766" title="All 2 branches missed.">      if (!author.isEmpty()) {</span>
<span class="nc" id="L3767">        DcCreatorElement creatorElement = new DcCreatorElement(xmlDoc);</span>
<span class="nc" id="L3768">        creatorElement.setTextContent(author);</span>
<span class="nc" id="L3769">        newCommentElement.appendChild(creatorElement);</span>
      }
<span class="nc bnc" id="L3771" title="All 2 branches missed.">      if (!date.isEmpty()) {</span>
<span class="nc" id="L3772">        DcDateElement dateElement = new DcDateElement(xmlDoc);</span>
<span class="nc" id="L3773">        dateElement.setTextContent(date);</span>
<span class="nc" id="L3774">        newCommentElement.appendChild(dateElement);</span>
      }
<span class="nc" id="L3776">      OdfFileDom fileDom = (OdfFileDom) rootComponent.getOwnerDocument();</span>
<span class="nc" id="L3777">      ((OdfDocument) fileDom.getDocument()).addAnnotation(id, (newCommentElement));</span>
    }
<span class="nc" id="L3779">  }</span>

  public static void addNoteSelection(
      Component rootComponent,
      JSONArray start,
      String type,
      String position,
      JSONObject attrs,
      String id) {
<span class="nc" id="L3788">    final Component parentComponent = rootComponent.getParentOf(start);</span>
<span class="nc bnc" id="L3789" title="All 2 branches missed.">    if (parentComponent == null) {</span>
<span class="nc" id="L3790">      LOG.log(</span>
          Level.SEVERE, &quot;The parent component of the comment should exist at position {0}&quot;, start);
<span class="nc bnc" id="L3792" title="All 2 branches missed.">    } else if (!id.startsWith(COMMENT_PREFIX)) {</span>
<span class="nc" id="L3793">      LOG.log(Level.SEVERE, &quot;The comment id should start with &quot; + COMMENT_PREFIX, start);</span>
<span class="nc bnc" id="L3794" title="All 2 branches missed.">    } else if (!type.equals(&quot;comment&quot;)) {</span>
<span class="nc" id="L3795">      LOG.log(Level.SEVERE, &quot;Only ranges of type 'comment' can be inserted&quot;, start);</span>
<span class="nc bnc" id="L3796" title="All 2 branches missed.">    } else if (position.equals(OPK_END)) {</span>
<span class="nc" id="L3797">      OdfFileDom xmlDoc = (OdfFileDom) parentComponent.getOwnerDocument();</span>
<span class="nc" id="L3798">      OfficeAnnotationEndElement newCommentEndElement = new OfficeAnnotationEndElement(xmlDoc);</span>
<span class="nc" id="L3799">      id = id.substring(COMMENT_PREFIX.length());</span>
<span class="nc" id="L3800">      newCommentEndElement.setOfficeNameAttribute(id);</span>
      try {
        // ADDING ANNOTATION END COMPONENT
<span class="nc" id="L3803">        addElementAsComponent(</span>
<span class="nc" id="L3804">            parentComponent, newCommentEndElement, start.getInt(start.length() - 1));</span>
<span class="nc" id="L3805">      } catch (JSONException ex) {</span>
<span class="nc" id="L3806">        Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L3807">      }</span>
<span class="nc" id="L3808">    } else {</span>
<span class="nc" id="L3809">      LOG.log(Level.SEVERE, &quot;ODF does not define a comment start range &quot;, start);</span>
    }
<span class="nc" id="L3811">  }</span>

  /** Modifys the page layout (ie. 4 margins, width, height) for all master styles */
  public static void modifyPages(OdfDocument doc, JSONObject attrs) {
    try {
<span class="nc" id="L3816">      OdfStylesDom stylesDom = doc.getStylesDom();</span>
<span class="nc bnc" id="L3817" title="All 4 branches missed.">      if (stylesDom != null &amp;&amp; attrs.has(&quot;page&quot;)) {</span>
<span class="nc" id="L3818">        JSONObject pageAttrs = attrs.getJSONObject(&quot;page&quot;);</span>

<span class="nc" id="L3820">        OdfOfficeMasterStyles masterStyles = stylesDom.getOrCreateMasterStyles();</span>
<span class="nc" id="L3821">        OdfOfficeAutomaticStyles autoStyles = stylesDom.getOrCreateAutomaticStyles();</span>
<span class="nc" id="L3822">        Iterator&lt;StyleMasterPageElement&gt; masterIt = masterStyles.iterator();</span>
<span class="nc bnc" id="L3823" title="All 2 branches missed.">        while (masterIt.hasNext()) {</span>
<span class="nc" id="L3824">          StyleMasterPageElement masterPage = masterIt.next();</span>
<span class="nc" id="L3825">          String pageLayoutName = masterPage.getStylePageLayoutNameAttribute();</span>
<span class="nc" id="L3826">          OdfStylePageLayout pageLayout = autoStyles.getPageLayout(pageLayoutName);</span>
<span class="nc bnc" id="L3827" title="All 2 branches missed.">          if (pageAttrs.has(&quot;marginLeft&quot;)) {</span>
<span class="nc" id="L3828">            double value = pageAttrs.getDouble(&quot;marginLeft&quot;);</span>
<span class="nc" id="L3829">            pageLayout.setProperty(</span>
<span class="nc" id="L3830">                StylePageLayoutPropertiesElement.MarginLeft, Double.toString(value / 100) + &quot;mm&quot;);</span>
          }
<span class="nc bnc" id="L3832" title="All 2 branches missed.">          if (pageAttrs.has(&quot;marginRight&quot;)) {</span>
<span class="nc" id="L3833">            double value = pageAttrs.getDouble(&quot;marginRight&quot;);</span>
<span class="nc" id="L3834">            pageLayout.setProperty(</span>
<span class="nc" id="L3835">                StylePageLayoutPropertiesElement.MarginRight, Double.toString(value / 100) + &quot;mm&quot;);</span>
          }
<span class="nc bnc" id="L3837" title="All 2 branches missed.">          if (pageAttrs.has(&quot;marginTop&quot;)) {</span>
<span class="nc" id="L3838">            double value = pageAttrs.getDouble(&quot;marginTop&quot;);</span>
<span class="nc" id="L3839">            pageLayout.setProperty(</span>
<span class="nc" id="L3840">                StylePageLayoutPropertiesElement.MarginTop, Double.toString(value / 100) + &quot;mm&quot;);</span>
          }
<span class="nc bnc" id="L3842" title="All 2 branches missed.">          if (pageAttrs.has(&quot;marginBottom&quot;)) {</span>
<span class="nc" id="L3843">            double value = pageAttrs.getDouble(&quot;marginBottom&quot;);</span>
<span class="nc" id="L3844">            pageLayout.setProperty(</span>
<span class="nc" id="L3845">                StylePageLayoutPropertiesElement.MarginBottom, Double.toString(value / 100) + &quot;mm&quot;);</span>
          }
<span class="nc bnc" id="L3847" title="All 2 branches missed.">          if (pageAttrs.has(&quot;width&quot;)) {</span>
<span class="nc" id="L3848">            double value = pageAttrs.getInt(&quot;width&quot;);</span>
<span class="nc" id="L3849">            pageLayout.setProperty(</span>
<span class="nc" id="L3850">                StylePageLayoutPropertiesElement.PageWidth, Double.toString(value / 100) + &quot;mm&quot;);</span>
          }
<span class="nc bnc" id="L3852" title="All 2 branches missed.">          if (pageAttrs.has(&quot;height&quot;)) {</span>
<span class="nc" id="L3853">            double value = pageAttrs.getInt(&quot;height&quot;);</span>
<span class="nc" id="L3854">            pageLayout.setProperty(</span>
<span class="nc" id="L3855">                StylePageLayoutPropertiesElement.PageHeight, Double.toString(value / 100) + &quot;mm&quot;);</span>
          }
<span class="nc" id="L3857">        }</span>
      }
<span class="nc" id="L3859">    } catch (Exception ex) {</span>
<span class="nc" id="L3860">      Logger.getLogger(OdfSchemaDocument.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L3861">    }</span>
<span class="nc" id="L3862">  }</span>

  public static void addDeleteHeaderFooter(OdfDocument doc, boolean insert, String id) {
<span class="nc" id="L3865">    String masterPageName = &quot;&quot;;</span>
<span class="nc" id="L3866">    PageArea pageArea = null;</span>
<span class="nc bnc" id="L3867" title="All 2 branches missed.">    if (id.startsWith(&quot;header&quot;)) {</span>
<span class="nc bnc" id="L3868" title="All 2 branches missed.">      if (id.startsWith(HEADER_DEFAULT.getPageAreaName())) {</span>
<span class="nc" id="L3869">        masterPageName = id.substring(HEADER_DEFAULT.getPageAreaName().length() + 1, id.length());</span>
<span class="nc" id="L3870">        pageArea = HEADER_DEFAULT;</span>
<span class="nc bnc" id="L3871" title="All 2 branches missed.">      } else if (id.startsWith(HEADER_FIRST.getPageAreaName())) {</span>
<span class="nc" id="L3872">        masterPageName = id.substring(HEADER_FIRST.getPageAreaName().length() + 1, id.length());</span>
<span class="nc" id="L3873">        pageArea = HEADER_FIRST;</span>
<span class="nc bnc" id="L3874" title="All 2 branches missed.">      } else if (id.startsWith(HEADER_EVEN.getPageAreaName())) {</span>
<span class="nc" id="L3875">        masterPageName = id.substring(HEADER_EVEN.getPageAreaName().length() + 1, id.length());</span>
<span class="nc" id="L3876">        pageArea = HEADER_EVEN;</span>
      }
<span class="nc bnc" id="L3878" title="All 2 branches missed.">    } else if (id.startsWith(&quot;footer&quot;)) {</span>
<span class="nc bnc" id="L3879" title="All 2 branches missed.">      if (id.startsWith(FOOTER_DEFAULT.getPageAreaName())) {</span>
<span class="nc" id="L3880">        masterPageName = id.substring(FOOTER_DEFAULT.getPageAreaName().length() + 1, id.length());</span>
<span class="nc" id="L3881">        pageArea = FOOTER_DEFAULT;</span>
<span class="nc bnc" id="L3882" title="All 2 branches missed.">      } else if (id.startsWith(FOOTER_FIRST.getPageAreaName())) {</span>
<span class="nc" id="L3883">        masterPageName = id.substring(FOOTER_FIRST.getPageAreaName().length() + 1, id.length());</span>
<span class="nc" id="L3884">        pageArea = FOOTER_FIRST;</span>
<span class="nc bnc" id="L3885" title="All 2 branches missed.">      } else if (id.startsWith(FOOTER_EVEN.getPageAreaName())) {</span>
<span class="nc" id="L3886">        masterPageName = id.substring(FOOTER_EVEN.getPageAreaName().length() + 1, id.length());</span>
<span class="nc" id="L3887">        pageArea = FOOTER_EVEN;</span>
      }
    }
<span class="nc bnc" id="L3890" title="All 2 branches missed.">    if (pageArea != null) {</span>
<span class="nc bnc" id="L3891" title="All 2 branches missed.">      if (insert) {</span>
<span class="nc" id="L3892">        OdfElement component = doc.getRootComponentElement(masterPageName, pageArea, true);</span>
<span class="nc bnc" id="L3893" title="All 4 branches missed.">        if (pageArea == HEADER_EVEN || pageArea == FOOTER_EVEN) {</span>
<span class="nc" id="L3894">          String pageLayoutName =</span>
<span class="nc" id="L3895">              ((StyleMasterPageElement) component.getParentNode())</span>
<span class="nc" id="L3896">                  .getAttributeNS(OdfDocumentNamespace.STYLE.getUri(), &quot;page-layout-name&quot;);</span>
<span class="nc bnc" id="L3897" title="All 2 branches missed.">          if (pageLayoutName != null) {</span>
<span class="nc" id="L3898">            OdfStylePageLayout pageLayout =</span>
<span class="nc" id="L3899">                ((StyleMasterPageElement) component.getParentNode())</span>
<span class="nc" id="L3900">                    .getOrCreateAutomaticStyles()</span>
<span class="nc" id="L3901">                    .getOrCreatePageLayout(pageLayoutName);</span>
<span class="nc" id="L3902">            String pageUsageAttribute = pageLayout.getStylePageUsageAttribute();</span>
<span class="nc bnc" id="L3903" title="All 2 branches missed.">            if (!pageUsageAttribute.isEmpty()</span>
<span class="nc bnc" id="L3904" title="All 4 branches missed.">                &amp;&amp; (pageUsageAttribute.equals(&quot;right&quot;) || pageUsageAttribute.equals(&quot;left&quot;))) {</span>
<span class="nc" id="L3905">              pageLayout.setStylePageUsageAttribute(null);</span>
            }
          }
        }
<span class="nc" id="L3909">      } else {</span>
<span class="nc" id="L3910">        OdfElement component = doc.getRootComponentElement(masterPageName, pageArea, false);</span>
<span class="nc bnc" id="L3911" title="All 2 branches missed.">        if (component != null) {</span>
<span class="nc" id="L3912">          Node parent = component.getParentNode();</span>
<span class="nc" id="L3913">          parent.removeChild(component);</span>
        }
<span class="nc" id="L3915">      }</span>
    } else {
<span class="nc" id="L3917">      LOG.log(Level.SEVERE, &quot;Unable to add/delete header/footer for &quot; + id);</span>
    }
<span class="nc" id="L3919">  }</span>

  // reusing addColumnAndCellElements, only with a reference that is outside the scope..
  public static void setColumnsWidth(
      Component tableComponent, JSONArray start, JSONArray tableGrid, boolean isTextTable) {
<span class="nc bnc" id="L3924" title="All 2 branches missed.">    if (tableGrid != null) {</span>
      // Returns all TableTableColumn descendants that exist within the tableElement, even within
      // groups, columns and header elements
<span class="nc" id="L3927">      TableTableElement tableElement = (TableTableElement) tableComponent.getRootElement();</span>
      // WORK AROUND for &quot;UNDO COLUMN WIDTH&quot; problem (see TableTableElement for further changes)
<span class="nc" id="L3929">      List&lt;TableTableColumnElement&gt; existingColumnList =</span>
<span class="nc" id="L3930">          Table.getTableColumnElements(tableElement, new LinkedList&lt;TableTableColumnElement&gt;());</span>
<span class="nc" id="L3931">      int columnCount = 0;</span>
<span class="nc bnc" id="L3932" title="All 2 branches missed.">      for (TableTableColumnElement column : existingColumnList) {</span>
<span class="nc" id="L3933">        columnCount += column.getRepetition();</span>
<span class="nc" id="L3934">      }</span>
<span class="nc bnc" id="L3935" title="All 2 branches missed.">      if (tableGrid.length() != columnCount) {</span>
        // reuse the width from later caching
<span class="nc" id="L3937">        tableElement.pushTableGrid(tableGrid);</span>
<span class="nc" id="L3938">        tableElement.requireLaterWidthChange(start);</span>
      } else {
<span class="nc" id="L3940">        addColumnAndCellElements(</span>
            tableComponent,
            start,
            tableGrid,
<span class="nc" id="L3944">            Integer.MAX_VALUE,</span>
            INSERT_BEFORE,
            -1,
            isTextTable,
            existingColumnList,
<span class="nc" id="L3949">            Boolean.TRUE);</span>
      }
<span class="nc" id="L3951">    } else {</span>
<span class="nc" id="L3952">      LOG.log(</span>
          Level.SEVERE,
          &quot;Missing table grid defining the relative column widths for table component at position {0}&quot;);
    }
<span class="nc" id="L3956">  }</span>

  /**
   * If the tableElement has an absolute width, the absolute column width is derived from the given
   * tableGrid
   *
   * @return a list of all absolute column widths, derived from the overall tableElement width
   */
  private static List&lt;String&gt; calcAbsoluteColumnWidths(
      TableTableElement tableElement, JSONArray tableGrid) {
<span class="nc" id="L3966">    List&lt;String&gt; absColumnWidths = null;</span>
<span class="nc" id="L3967">    String tableWidth = tableElement.getProperty(StyleTablePropertiesElement.Width);</span>
<span class="nc bnc" id="L3968" title="All 4 branches missed.">    if (tableWidth != null &amp;&amp; !tableWidth.isEmpty()) {</span>
<span class="nc" id="L3969">      int absTableWidth = MapHelper.normalizeLength(tableWidth);</span>
<span class="nc" id="L3970">      double relTableWidth = 0.0;</span>
<span class="nc" id="L3971">      int columnCount = tableGrid.length();</span>
<span class="nc" id="L3972">      absColumnWidths = new ArrayList(columnCount);</span>
<span class="nc bnc" id="L3973" title="All 2 branches missed.">      for (int i = 0; columnCount &gt; i; i++) {</span>
<span class="nc" id="L3974">        relTableWidth += tableGrid.optLong(i);</span>
      }
<span class="nc bnc" id="L3976" title="All 2 branches missed.">      if (relTableWidth == 0) {</span>
        // should never occur, but being defensive here, before dividing through zero
<span class="nc" id="L3978">        relTableWidth = 1;</span>
      }
<span class="nc" id="L3980">      double widthProRel = absTableWidth / relTableWidth;</span>
<span class="nc bnc" id="L3981" title="All 2 branches missed.">      for (int i = 0; tableGrid.length() &gt; i; i++) {</span>
<span class="nc" id="L3982">        double absWidth = Math.round(tableGrid.optInt(i) * widthProRel);</span>
<span class="nc" id="L3983">        absColumnWidths.add(absWidth / 100.0 + &quot;mm&quot;);</span>
      }
    }
<span class="nc" id="L3986">    return absColumnWidths;</span>
  }

  /**
   * Inserts cells for a new column into a tableElement. Copies styles from the existing referenced
   * grid cell and might adjust the width of all new cells.
   *
   * @param rootComponent high level document structure
   * @param start Integer[] The logical position of the tableElement the new column will be inserted
   *     into.
   * @param referenceColumnGridPosition Integer Zero-based column index, according to the tableGrid
   *     attribute of the tableElement.
   * @param tableGrid Integer[] The complete array of relative widths for the entire tableElement,
   *     containing the new entry for the new column. Will be set to the tableGrid attribute of the
   *     tableElement.
   * @param insertMode String (optional) If set to 'before', the new cells will be inserted before
   *     the existing cells, otherwise after the cells. Default is 'before'. Note: As a side effect,
   *     this op changes the tableGrid attribute of the parentComponentElement tableElement.
   */
  public static void addColumns(
      Component rootComponent,
      JSONArray start,
      JSONArray tableGrid,
      Integer referenceColumnGridPosition,
      String insertMode) {
    // Parent will not change and have to exist to insert the new component
<span class="nc" id="L4012">    final Component parentComponent = rootComponent.get(start);</span>
<span class="nc bnc" id="L4013" title="All 2 branches missed.">    if (parentComponent == null) {</span>
<span class="nc" id="L4014">      LOG.log(</span>
          Level.SEVERE,
          &quot;The table parent component of the column should exist at position {0}&quot;,
          start);
    } else {
<span class="nc bnc" id="L4019" title="All 2 branches missed.">      if (tableGrid != null) {</span>
        // WORK AROUND for &quot;UNDO COLUMN WIDTH&quot; problem
<span class="nc" id="L4021">        TableTableElement tableElement = (TableTableElement) parentComponent.mRootElement;</span>

        // WORK AROUND for &quot;UNDO COLUMN WIDTH&quot; problem
<span class="nc bnc" id="L4024" title="All 2 branches missed.">        if (!tableElement.isWidthChangeRequired()) {</span>
<span class="nc" id="L4025">          Table.stashColumnWidths(tableElement);</span>
        }
        // INSERT COLUMN
        // Returns all TableTableColumn descendants that exist within the tableElement, even within
        // groups, columns and header elements
<span class="nc" id="L4030">        List&lt;TableTableColumnElement&gt; existingColumnList =</span>
<span class="nc" id="L4031">            Table.getTableColumnElements(</span>
<span class="nc" id="L4032">                parentComponent.getRootElement(), new LinkedList&lt;TableTableColumnElement&gt;());</span>
<span class="nc" id="L4033">        addColumnAndCellElements(</span>
            parentComponent,
            start,
            tableGrid,
            referenceColumnGridPosition,
            insertMode,
            -1,
            true,
            existingColumnList,
<span class="nc" id="L4042">            Boolean.FALSE);</span>
        // WORK AROUND for &quot;UNDO COLUMN WIDTH&quot; problem (see JsonOperationConsumer for further
        // changes)
<span class="nc bnc" id="L4045" title="All 2 branches missed.">        if (tableElement.isWidthChangeRequired()) {</span>
<span class="nc" id="L4046">          JsonOperationConsumer.setColumnsWidth(</span>
<span class="nc" id="L4047">              tableElement.getComponent(),</span>
<span class="nc" id="L4048">              tableElement.getPosition(),</span>
<span class="nc" id="L4049">              tableElement.popTableGrid(),</span>
<span class="nc" id="L4050">              Boolean.TRUE);</span>
        }
<span class="nc" id="L4052">      } else {</span>
<span class="nc" id="L4053">        LOG.log(</span>
            Level.SEVERE,
            &quot;Missing table grid defining the relative column widths for table component at position {0}&quot;,
            start);
      }
    }
<span class="nc" id="L4059">  }</span>

  // The following we should consider for symmetry reasons..
  // private static void addColumns(Component rootComponent, JSONArray start, JSONObject attrs, int
  // count, int referenceColumn, boolean isTextTable) {	}
  private static void addColumnAndCellElements(
      Component tableComponent,
      JSONArray start,
      JSONArray tableGrid,
      Integer referenceColumnGridPosition,
      String insertMode,
      int newLastColumnNo,
      boolean isTextTable,
      List&lt;TableTableColumnElement&gt; existingColumnList,
      boolean columnCreationOnly) {
<span class="nc" id="L4074">    TableTableElement tableElement = (TableTableElement) tableComponent.getRootElement();</span>

    // We need to exchange all absolute widths
    // If the tableElement has an absolute width, the absolute column width is derived from the
    // given tableGrid
<span class="nc" id="L4079">    List&lt;String&gt; newAbsColumnWidthsGrid = null;</span>
<span class="nc bnc" id="L4080" title="All 2 branches missed.">    if (tableGrid != null) {</span>
<span class="nc" id="L4081">      newAbsColumnWidthsGrid = calcAbsoluteColumnWidths(tableElement, tableGrid);</span>
    }
<span class="nc" id="L4083">    TableTableColumnElement newColumnElement = null;</span>
<span class="nc" id="L4084">    int appendColumnCount = newLastColumnNo + 1 - getColumnCount(existingColumnList);</span>
<span class="nc bnc" id="L4085" title="All 2 branches missed.">    if (tableGrid != null) {</span>
<span class="nc" id="L4086">      Long previousColumnWidth = null;</span>
<span class="nc" id="L4087">      Long currentColumnWidth = null;</span>
<span class="nc" id="L4088">      int equalColumnsPassed = 0;</span>
<span class="nc" id="L4089">      TableTableColumnElement columnElement = null;</span>
<span class="nc" id="L4090">      int columnGridNo = 0;</span>
      // COLUMN ITERATION: Find place to insert new column!
      // We are iterating the columns elements from the existingColumnList, receiving the width from
      // the grid
<span class="nc" id="L4094">      for (int columnElementNo = 0;</span>
<span class="nc bnc" id="L4095" title="All 2 branches missed.">          columnElementNo &lt; existingColumnList.size();</span>
<span class="nc" id="L4096">          columnElementNo++, columnGridNo++) {</span>
        // Receive column element
<span class="nc" id="L4098">        columnElement = existingColumnList.get(columnElementNo);</span>

        // applies absolute &amp; relative width to column due to LO/AO issue with relative width
<span class="nc" id="L4101">        applyWidth(</span>
            columnElement,
<span class="nc" id="L4103">            getAbsoluteColumnWidth(newAbsColumnWidthsGrid, columnGridNo),</span>
<span class="nc" id="L4104">            tableGrid.optLong(columnGridNo) + &quot;*&quot;);</span>
        //	Iterating through columns (there might be repeated)
        //	Breaking repeated columns if
        //		a) new column is within the repeated
        //		b) column given by grid has different follow-up width
        //	We can not join yet as there is no hasSameStyle function for columns
        // if COLUMN element repeated (covers multiple column grid positions)
        // check for every repeated cell if the grid has changed, increment columnGridNo after each
        // repeat..
<span class="nc" id="L4113">        int repetition = columnElement.getRepetition();</span>
<span class="nc bnc" id="L4114" title="All 2 branches missed.">        for (int repeated = 1; repeated &lt;= repetition; repeated++) {</span>
<span class="nc bnc" id="L4115" title="All 2 branches missed.">          if (repeated &gt; 1) {</span>
<span class="nc" id="L4116">            columnGridNo++;</span>
          }
<span class="nc" id="L4118">          currentColumnWidth = tableGrid.optLong(columnGridNo);</span>
          // split repeated column element if two follow-up column have a different width
<span class="nc bnc" id="L4120" title="All 4 branches missed.">          if (previousColumnWidth != null</span>
              &amp;&amp; equalColumnsPassed &gt; 0
<span class="nc bnc" id="L4122" title="All 2 branches missed.">              &amp;&amp; (!currentColumnWidth.equals(previousColumnWidth))) {</span>
            // Remove existing repeated attribute from current column
<span class="nc bnc" id="L4124" title="All 2 branches missed.">            if (columnElement.hasAttributeNS(</span>
<span class="nc" id="L4125">                OdfDocumentNamespace.TABLE.getUri(), &quot;number-columns-repeated&quot;)) {</span>
<span class="nc" id="L4126">              columnElement.removeAttributeNS(</span>
<span class="nc" id="L4127">                  OdfDocumentNamespace.TABLE.getUri(), &quot;number-columns-repeated&quot;);</span>
            }
            // Create the first part of passed column
<span class="nc" id="L4130">            newColumnElement = cloneColumnElement(columnElement);</span>
<span class="nc" id="L4131">            OdfElement parent = (OdfElement) columnElement.getParentNode();</span>
            // the new one will be behind, therefore the existing before
<span class="nc" id="L4133">            parent.insertBefore(newColumnElement, columnElement);</span>
            // when repeated are left, they can be added as repeated attributed
<span class="nc bnc" id="L4135" title="All 2 branches missed.">            if (equalColumnsPassed &gt; 1) {</span>
<span class="nc" id="L4136">              newColumnElement.setAttributeNS(</span>
<span class="nc" id="L4137">                  OdfDocumentNamespace.TABLE.getUri(),</span>
                  &quot;table:number-columns-repeated&quot;,
<span class="nc" id="L4139">                  String.valueOf(equalColumnsPassed));</span>
            }
<span class="nc" id="L4141">            applyWidth(</span>
                columnElement,
<span class="nc" id="L4143">                getAbsoluteColumnWidth(newAbsColumnWidthsGrid, columnGridNo),</span>
<span class="nc" id="L4144">                tableGrid.optLong(columnGridNo) + &quot;*&quot;);</span>
<span class="nc" id="L4145">            equalColumnsPassed = 1;</span>
<span class="nc" id="L4146">          } else {</span>
            // columns have the same size
<span class="nc" id="L4148">            equalColumnsPassed++;</span>
            // insertion of new column
<span class="nc bnc" id="L4150" title="All 2 branches missed.">            if (columnGridNo == referenceColumnGridPosition) {</span>
<span class="nc" id="L4151">              equalColumnsPassed++;</span>
<span class="nc" id="L4152">              columnGridNo++;</span>
            }
          }
          // the current becomes the previous width
<span class="nc" id="L4156">          previousColumnWidth = currentColumnWidth;</span>
        }

        // when repeated are left, they can be added as repeated attributed
<span class="nc bnc" id="L4160" title="All 2 branches missed.">        if (equalColumnsPassed &gt; 1) {</span>
<span class="nc" id="L4161">          columnElement.setAttributeNS(</span>
<span class="nc" id="L4162">              OdfDocumentNamespace.TABLE.getUri(),</span>
              &quot;table:number-columns-repeated&quot;,
<span class="nc" id="L4164">              String.valueOf(equalColumnsPassed));</span>
        } else {
<span class="nc bnc" id="L4166" title="All 2 branches missed.">          if (columnElement.hasAttributeNS(</span>
<span class="nc" id="L4167">              OdfDocumentNamespace.TABLE.getUri(), &quot;number-columns-repeated&quot;)) {</span>
<span class="nc" id="L4168">            columnElement.removeAttributeNS(</span>
<span class="nc" id="L4169">                OdfDocumentNamespace.TABLE.getUri(), &quot;number-columns-repeated&quot;);</span>
          }
        }
<span class="nc" id="L4172">        equalColumnsPassed = 0;</span>
<span class="nc" id="L4173">        previousColumnWidth = null;</span>
      }

<span class="nc bnc" id="L4176" title="All 2 branches missed.">      if (columnGridNo == referenceColumnGridPosition) {</span>
<span class="nc" id="L4177">        addColumnElement(</span>
            columnElement, insertMode, columnGridNo, newAbsColumnWidthsGrid, tableGrid);
<span class="nc" id="L4179">        columnGridNo++;</span>
      }
    }
<span class="nc bnc" id="L4182" title="All 4 branches missed.">    if ((appendColumnCount &gt; 0 || newLastColumnNo &gt; 0)</span>
<span class="nc bnc" id="L4183" title="All 2 branches missed.">        &amp;&amp; !referenceColumnGridPosition.equals(</span>
<span class="nc" id="L4184">            Integer</span>
                .MAX_VALUE)) { // else if no existing columns have to be changed, but only further
      // have to be appended
<span class="nc" id="L4187">      appendColumnElement(tableElement, existingColumnList, appendColumnCount);</span>
    }
<span class="nc bnc" id="L4189" title="All 2 branches missed.">    if (!columnCreationOnly) {</span>
      // A new cell is being inserted at the given position for each row
<span class="nc bnc" id="L4191" title="All 2 branches missed.">      if (referenceColumnGridPosition == null) {</span>
<span class="nc" id="L4192">        addCellsInRows(</span>
<span class="nc" id="L4193">            tableComponent, start, appendColumnCount, insertMode, appendColumnCount, isTextTable);</span>
<span class="nc bnc" id="L4194" title="All 2 branches missed.">      } else if (referenceColumnGridPosition</span>
          != Integer.MAX_VALUE) { // MAX VALUE used for setAttribute reusage
<span class="nc" id="L4196">        addCellsInRows(</span>
            tableComponent,
            start,
            referenceColumnGridPosition,
            insertMode,
            appendColumnCount,
            isTextTable);
      }
    }
<span class="nc" id="L4205">  }</span>

  private static void addColumnElement(
      TableTableColumnElement columnElement,
      String insertMode,
      int columnGridNo,
      List&lt;String&gt; newAbsColumnWidthsGrid,
      JSONArray tableGrid) {
    // Clone the current column (where the cursor stands) as all styles are copied from it
<span class="nc" id="L4214">    TableTableColumnElement newColumnElement = cloneColumnElement(columnElement);</span>
<span class="nc" id="L4215">    OdfElement parent = (OdfElement) columnElement.getParentNode();</span>
<span class="nc bnc" id="L4216" title="All 2 branches missed.">    if (insertMode.equals(INSERT_BEFORE)) {</span>
<span class="nc" id="L4217">      parent.insertBefore(newColumnElement, columnElement);</span>
      // increment grid due to the new cell and format the existing cell (pushed back) correctly
<span class="nc" id="L4219">      applyWidth(</span>
          columnElement,
<span class="nc" id="L4221">          getAbsoluteColumnWidth(newAbsColumnWidthsGrid, columnGridNo),</span>
<span class="nc" id="L4222">          tableGrid.optLong(columnGridNo) + &quot;*&quot;);</span>
    } else { // new column is after existing columns
<span class="nc" id="L4224">      Element nextSibling = OdfElement.getNextSiblingElement(columnElement);</span>
<span class="nc bnc" id="L4225" title="All 2 branches missed.">      if (nextSibling != null) {</span>
<span class="nc" id="L4226">        parent.insertBefore(newColumnElement, nextSibling);</span>
      } else {
<span class="nc" id="L4228">        parent.appendChild(newColumnElement);</span>
      }
      // increment grid due to the new cell and format the new cell correctly
<span class="nc" id="L4231">      applyWidth(</span>
          newColumnElement,
<span class="nc" id="L4233">          getAbsoluteColumnWidth(newAbsColumnWidthsGrid, columnGridNo),</span>
<span class="nc" id="L4234">          tableGrid.optLong(columnGridNo) + &quot;*&quot;);</span>
    }
<span class="nc" id="L4236">  }</span>

  private static void appendColumnElement(
      TableTableElement tableElement,
      List&lt;TableTableColumnElement&gt; existingColumnList,
      int appendColumnCount) {
<span class="nc" id="L4242">    TableTableColumnElement columnElement = existingColumnList.get(existingColumnList.size() - 1);</span>
<span class="nc" id="L4243">    TableTableColumnElement newColumnElement =</span>
<span class="nc" id="L4244">        new TableTableColumnElement((OdfFileDom) tableElement.getOwnerDocument());</span>
<span class="nc bnc" id="L4245" title="All 2 branches missed.">    if (appendColumnCount &gt; 1) {</span>
<span class="nc" id="L4246">      newColumnElement.setTableNumberColumnsRepeatedAttribute(appendColumnCount);</span>
    }
    // @tableElement:default-cell-style-name
<span class="nc bnc" id="L4249" title="All 2 branches missed.">    if (columnElement.hasAttributeNS(</span>
<span class="nc" id="L4250">        OdfDocumentNamespace.TABLE.getUri(), &quot;default-cell-style-name&quot;)) {</span>
<span class="nc" id="L4251">      newColumnElement.setTableDefaultCellStyleNameAttribute(</span>
<span class="nc" id="L4252">          columnElement.getAttributeNS(</span>
<span class="nc" id="L4253">              OdfDocumentNamespace.TABLE.getUri(), &quot;default-cell-style-name&quot;));</span>
    }
<span class="nc" id="L4255">    OdfElement parent = (OdfElement) columnElement.getParentNode();</span>
<span class="nc" id="L4256">    Element nextSibling = OdfElement.getNextSiblingElement(columnElement);</span>
<span class="nc bnc" id="L4257" title="All 2 branches missed.">    if (nextSibling != null) {</span>
<span class="nc" id="L4258">      parent.insertBefore(newColumnElement, nextSibling);</span>
    } else {
<span class="nc" id="L4260">      parent.appendChild(newColumnElement);</span>
    }
<span class="nc" id="L4262">  }</span>

  private static int getColumnCount(List&lt;TableTableColumnElement&gt; columnList) {
<span class="nc" id="L4265">    int columnCount = 0;</span>
<span class="nc" id="L4266">    int columnRepeated = 1;</span>
<span class="nc bnc" id="L4267" title="All 2 branches missed.">    for (TableTableColumnElement columnElement : columnList) {</span>
<span class="nc" id="L4268">      columnRepeated = 1;</span>
<span class="nc bnc" id="L4269" title="All 2 branches missed.">      if (columnElement.hasAttributeNS(</span>
<span class="nc" id="L4270">          OdfDocumentNamespace.TABLE.getUri(), &quot;number-columns-repeated&quot;)) {</span>
<span class="nc" id="L4271">        columnRepeated =</span>
<span class="nc" id="L4272">            Integer.parseInt(</span>
<span class="nc" id="L4273">                columnElement.getAttributeNS(</span>
<span class="nc" id="L4274">                    OdfDocumentNamespace.TABLE.getUri(), &quot;number-columns-repeated&quot;));</span>
      }
<span class="nc" id="L4276">      columnCount += columnRepeated;</span>
<span class="nc" id="L4277">    }</span>
<span class="nc" id="L4278">    return columnCount;</span>
  }

  private static void addCellsInRows(
      Component tableComponent,
      JSONArray start,
      Integer referenceColumnGridPosition,
      String insertMode,
      int cellRepetition,
      boolean isTextTable) {
    // A new cell is being inserted at the given position for each row
<span class="nc bnc" id="L4289" title="All 2 branches missed.">    if (referenceColumnGridPosition</span>
        != Integer.MAX_VALUE) { // MAX VALUE used for setAttribute reusage
      // GET TARGET POSITION
      // Figure out target grid position for cell/column
<span class="nc" id="L4293">      int newColumnTargetGridPosition = -1;</span>
<span class="nc bnc" id="L4294" title="All 2 branches missed.">      if (insertMode.equals(INSERT_BEFORE)) {</span>
<span class="nc" id="L4295">        newColumnTargetGridPosition = referenceColumnGridPosition;</span>
      } else {
<span class="nc" id="L4297">        newColumnTargetGridPosition = referenceColumnGridPosition + 1;</span>
      }
<span class="nc" id="L4299">      addNewRowsCells(</span>
          tableComponent,
          start,
          referenceColumnGridPosition,
<span class="nc" id="L4303">          newColumnTargetGridPosition,</span>
          cellRepetition,
          isTextTable);
    }
<span class="nc" id="L4307">  }</span>

  private static String getAbsoluteColumnWidth(
      List&lt;String&gt; newAbsColumnWidthsGrid, int columnGridNo) {
<span class="nc" id="L4311">    String absoluteWidth = null;</span>
<span class="nc bnc" id="L4312" title="All 2 branches missed.">    if (newAbsColumnWidthsGrid != null) {</span>
<span class="nc" id="L4313">      absoluteWidth = newAbsColumnWidthsGrid.get(columnGridNo);</span>
    }
<span class="nc" id="L4315">    return absoluteWidth;</span>
  }

  /** Applies to the given column element the given absolute and relative width */
  private static void applyWidth(
      TableTableColumnElement columnElement, String absoluteWidth, String relativeWidth) {
<span class="nc" id="L4321">    StyleStyleElement columnStyleElement = columnElement.getOrCreateUnqiueAutomaticStyle();</span>
<span class="nc" id="L4322">    StyleTableColumnPropertiesElement columnPropsElement =</span>
        (StyleTableColumnPropertiesElement)
<span class="nc" id="L4324">            columnStyleElement.getOrCreatePropertiesElement(</span>
                OdfStylePropertiesSet.TableColumnProperties);
<span class="nc bnc" id="L4326" title="All 2 branches missed.">    if (columnPropsElement == null) {</span>
<span class="nc" id="L4327">      columnPropsElement = columnStyleElement.newStyleTableColumnPropertiesElement();</span>
    }
    // There is a problem with relative width in some ODF applications, therefore we need to set the
    // absolute width as well
<span class="nc bnc" id="L4331" title="All 2 branches missed.">    if (absoluteWidth != null) {</span>
<span class="nc" id="L4332">      columnPropsElement.setAttributeNS(</span>
<span class="nc" id="L4333">          OdfDocumentNamespace.STYLE.getUri(), &quot;style:column-width&quot;, absoluteWidth);</span>
      // remove the relative with, otherwise LO/AO will ignore the absolute, but unfortunately is
      // buggy with the relative
<span class="nc" id="L4336">      columnPropsElement.removeAttributeNS(OdfDocumentNamespace.STYLE.getUri(), &quot;rel-column-width&quot;);</span>
<span class="nc bnc" id="L4337" title="All 2 branches missed.">    } else if (relativeWidth != null) {</span>
      // if there is no absolute tableElement width, the relative widths have to be used (or &quot;auto&quot;
      // being resolved)
<span class="nc" id="L4340">      columnPropsElement.setAttributeNS(</span>
<span class="nc" id="L4341">          OdfDocumentNamespace.STYLE.getUri(), &quot;style:rel-column-width&quot;, relativeWidth);</span>
    }
<span class="nc" id="L4343">  }</span>

  // The function clones the given column element removing xml:id and repeated attributes
  private static TableTableColumnElement cloneColumnElement(
      TableTableColumnElement origColumnElement) {
    // CLONING EXISTING COLUMN
<span class="nc" id="L4349">    TableTableColumnElement newColumnElement =</span>
<span class="nc" id="L4350">        (TableTableColumnElement) origColumnElement.cloneNode(true);</span>
    // do not clone an ID, as there can only be one of it in an XML file
<span class="nc bnc" id="L4352" title="All 2 branches missed.">    if (newColumnElement.hasAttribute(&quot;xml:id&quot;)) {</span>
<span class="nc" id="L4353">      newColumnElement.removeAttribute(&quot;xml:id&quot;);</span>
    }

    // skip the iteration over the same column
<span class="nc bnc" id="L4357" title="All 2 branches missed.">    if (newColumnElement.hasAttributeNS(</span>
<span class="nc" id="L4358">        OdfDocumentNamespace.TABLE.getUri(), &quot;number-columns-repeated&quot;)) {</span>
<span class="nc" id="L4359">      newColumnElement.removeAttributeNS(</span>
<span class="nc" id="L4360">          OdfDocumentNamespace.TABLE.getUri(), &quot;number-columns-repeated&quot;);</span>
    }
<span class="nc" id="L4362">    return newColumnElement;</span>
  }

  /** A new cell is being inserted at the given position for each row *** ToBeRemoved*** */
  private static void addNewRowsCells(
      Component tableComponent,
      JSONArray start,
      Integer cellReferencePosition,
      Integer cellTargetPosition,
      int cellRepetition,
      boolean isTextTable) {
    // MULTIPLYING THE CELLS - adding XML &amp; Component
<span class="nc" id="L4374">    int currentRowPosition = 0;</span>
<span class="nc" id="L4375">    int rowComponentLevel = start.length();</span>
    // Add initial row and cell position
<span class="nc" id="L4377">    JSONArray destinationCellPosition = start.put(currentRowPosition).put(cellTargetPosition);</span>
<span class="nc" id="L4378">    TableTableCellElement clonedCellElement = null;</span>
<span class="nc" id="L4379">    TableTableElement tableElement = (TableTableElement) tableComponent.mRootElement;</span>
<span class="nc" id="L4380">    OdfTable table = OdfTable.getInstance(tableElement);</span>
<span class="nc bnc" id="L4381" title="All 2 branches missed.">    for (TableTableRowElement rowElement : table.getRowElementList()) {</span>
<span class="nc" id="L4382">      Row rowComponent = (Row) rowElement.getComponent();</span>
      // if there is no cell at this position, skip this row
<span class="nc bnc" id="L4384" title="All 4 branches missed.">      if (cellReferencePosition == null || cellReferencePosition == -1) {</span>
<span class="nc" id="L4385">        clonedCellElement =</span>
<span class="nc" id="L4386">            new TableTableCellElement((OdfFileDom) tableComponent.getOwnerDocument());</span>
<span class="nc" id="L4387">        cellReferencePosition = -1;</span>
<span class="nc bnc" id="L4388" title="All 2 branches missed.">      } else if (rowComponent.getChildNode(cellReferencePosition) != null) {</span>
        // otherwise clone the styles from the referenced cell
<span class="nc" id="L4390">        clonedCellElement =</span>
            (TableTableCellElement)
<span class="nc" id="L4392">                ((TableTableCellElement) rowComponent.getChildNode(cellReferencePosition))</span>
<span class="nc" id="L4393">                    .cloneNode(0);</span>
        // remove any of the following attributes
<span class="nc" id="L4395">        clonedCellElement.removeAttributeNS(</span>
<span class="nc" id="L4396">            OdfDocumentNamespace.TABLE.getUri(), &quot;number-columns-repeated&quot;);</span>
<span class="nc" id="L4397">        clonedCellElement.removeAttributeNS(</span>
<span class="nc" id="L4398">            OdfDocumentNamespace.TABLE.getUri(), &quot;number-columns-spanned&quot;);</span>
<span class="nc" id="L4399">        clonedCellElement.removeAttribute(&quot;xml:id&quot;);</span>
      }

      //			// if there is a target position
      //			if ((rowComponent.getChildNode(cellTargetPosition) == null || cellTargetPosition == 1 +
      // cellReferencePosition) &amp;&amp; clonedCellElement != null) {
<span class="nc bnc" id="L4405" title="All 2 branches missed.">      if (cellRepetition == -1) {</span>
<span class="nc" id="L4406">        cellRepetition = cellTargetPosition - cellReferencePosition;</span>
      }
<span class="nc" id="L4408">      addCells(</span>
<span class="nc" id="L4409">          tableComponent.getRootComponent(),</span>
          destinationCellPosition,
          null,
          cellRepetition,
          rowComponent,
          clonedCellElement,
          isTextTable);
      //			}

      try {
<span class="nc" id="L4419">        currentRowPosition += rowComponent.repetition();</span>
<span class="nc" id="L4420">        destinationCellPosition.put(rowComponentLevel, currentRowPosition);</span>
<span class="nc" id="L4421">      } catch (JSONException ex) {</span>
<span class="nc" id="L4422">        Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L4423">      }</span>
<span class="nc" id="L4424">    }</span>
<span class="nc" id="L4425">  }</span>

  /**
   * Adding a sequence of columns with repeated attribute to the tableElement and automatic styles
   * with relative column width for the columns
   */
  private static void addNewColumns(TableTableElement table, JSONArray tableGrid) {
<span class="nc bnc" id="L4432" title="All 2 branches missed.">    if (tableGrid != null) {</span>
<span class="nc" id="L4433">      int columnLength = Integer.MIN_VALUE;</span>
<span class="nc" id="L4434">      int previousColumnLength = Integer.MIN_VALUE;</span>
<span class="nc" id="L4435">      int repeated = 1;</span>
<span class="nc" id="L4436">      int columnCount = tableGrid.length();</span>
<span class="nc bnc" id="L4437" title="All 2 branches missed.">      for (int i = 0; i &lt; columnCount; i++) {</span>
        try {
<span class="nc" id="L4439">          columnLength = (Integer) tableGrid.get(i);</span>
<span class="nc" id="L4440">        } catch (JSONException ex) {</span>
<span class="nc" id="L4441">          Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L4442">        }</span>
<span class="nc bnc" id="L4443" title="All 2 branches missed.">        if (previousColumnLength == columnLength) {</span>
<span class="nc" id="L4444">          repeated++;</span>
        } else {
<span class="nc bnc" id="L4446" title="All 2 branches missed.">          if (i != 0) {</span>
            // write out column with repeat
<span class="nc" id="L4448">            TableTableColumnElement column = table.newTableTableColumnElement();</span>
<span class="nc bnc" id="L4449" title="All 2 branches missed.">            if (repeated != 1) {</span>
<span class="nc" id="L4450">              column.setTableNumberColumnsRepeatedAttribute(repeated);</span>
            }
<span class="nc" id="L4452">            column</span>
<span class="nc" id="L4453">                .getOrCreateUnqiueAutomaticStyle()</span>
<span class="nc" id="L4454">                .newStyleTableColumnPropertiesElement()</span>
<span class="nc" id="L4455">                .setStyleRelColumnWidthAttribute(previousColumnLength + &quot;*&quot;);</span>
          }
<span class="nc" id="L4457">          previousColumnLength = columnLength;</span>
<span class="nc" id="L4458">          repeated = 1;</span>
        }
      }
<span class="nc" id="L4461">      TableTableColumnElement column = table.newTableTableColumnElement();</span>
<span class="nc bnc" id="L4462" title="All 2 branches missed.">      if (repeated != 1) {</span>
<span class="nc" id="L4463">        column.setTableNumberColumnsRepeatedAttribute(repeated);</span>
      }
<span class="nc" id="L4465">      column</span>
<span class="nc" id="L4466">          .getOrCreateUnqiueAutomaticStyle()</span>
<span class="nc" id="L4467">          .newStyleTableColumnPropertiesElement()</span>
<span class="nc" id="L4468">          .setStyleRelColumnWidthAttribute(previousColumnLength + &quot;*&quot;);</span>
    }
<span class="nc" id="L4470">  }</span>

  /**
   * addRows Inserts one or more new rows into a tableElement.
   *
   * @param name 'addRows'
   * @param start The logical position of the new row. The row will be inserted before a row that is
   *     currently located at this position.
   * @param count (optional) The number of rows that will be inserted, default is 1.
   * @param addDefaultCells (optional) If true, empty cells will be inserted into the new row. The
   *     number of inserted cells will be equal to the number of columns in the tableElement, as
   *     specified by the tableGrid attribute of the tableElement. The default is false.
   * @param referenceRow (optional) If specified, the zero-based index of the existing row whose
   *     cells and their attributes will be cloned (but without the cell contents).
   * @param attrs (optional) Initial row attributes. See Table Row Formatting Attributes. Note: The
   *     attributes addDefaultCells and referenceRow are mutually exclusive.
   */
  public static void addRows(
      Component rootComponent,
      JSONArray start,
      JSONObject attrs,
      int count,
      boolean addDefaultCells,
      int referenceRow,
      boolean isTextTable)
      throws IndexOutOfBoundsException, JSONException {
<span class="nc bnc" id="L4496" title="All 4 branches missed.">    assert count &gt;= 1 : &quot;Row count is expected to be at least 1&quot;;</span>
    // Parent will not change and have to exist to insert the new component
<span class="nc" id="L4498">    final Component parentComponent = rootComponent.getParentOf(start);</span>
<span class="nc" id="L4499">    Object o = parentComponent.getRootElement();</span>
    // only occurs, when a paragraph was inserted to state that the max. table size was exceeded
    // this is a feature not activated in the default build, but table limitation might assist
    // performance on weak clients
<span class="nc bnc" id="L4503" title="All 2 branches missed.">    if (!(o instanceof TableTableElement)) {</span>
<span class="nc" id="L4504">      LOG.severe(&quot;Table exceeded the maximum Size: &quot; + o.toString());</span>
    }
<span class="nc" id="L4506">    TableTableElement tableElement = (TableTableElement) parentComponent.getRootElement();</span>
<span class="nc" id="L4507">    OdfTable table = OdfTable.getInstance(tableElement);</span>

<span class="nc bnc" id="L4509" title="All 2 branches missed.">    if (parentComponent == null) {</span>
<span class="nc" id="L4510">      LOG.log(</span>
          Level.SEVERE, &quot;The parent component of the table should exist at position {0}&quot;, start);
    } else {
      TableTableRowElement rowElement;
<span class="nc" id="L4514">      OdfFileDom xmlDoc = (OdfFileDom) parentComponent.getOwnerDocument();</span>
<span class="nc bnc" id="L4515" title="All 2 branches missed.">      if (referenceRow &gt; -1) {</span>
        // Get the referenceRow and copy it WITH cells, but without the cell content
<span class="nc" id="L4517">        OdfTableRow row = table.getRowByIndex(referenceRow);</span>
<span class="nc" id="L4518">        TableTableRowElement originalRow = row.getOdfElement();</span>
        // Once cloned to apply all the hard styles only on the new row
<span class="nc" id="L4520">        rowElement = (TableTableRowElement) originalRow.cloneNode(1);</span>
        // do not clone an ID, as there can only be one of it in an XML file
<span class="nc bnc" id="L4522" title="All 2 branches missed.">        if (rowElement.hasAttribute(&quot;xml:id&quot;)) {</span>
<span class="nc" id="L4523">          rowElement.removeAttribute(&quot;xml:id&quot;);</span>
        }
<span class="nc" id="L4525">        Integer rowsRepeated = rowElement.getTableNumberRowsRepeatedAttribute();</span>
<span class="nc bnc" id="L4526" title="All 4 branches missed.">        if (rowsRepeated != null &amp;&amp; rowsRepeated &gt; 1) {</span>
<span class="nc" id="L4527">          rowElement.removeAttributeNS(OdfDocumentNamespace.TABLE.getUri(), &quot;number-rows-repeated&quot;);</span>
        }
<span class="nc" id="L4529">      } else {</span>
        // CREATING NEW ROOT ELEMENT
<span class="nc" id="L4531">        rowElement = new TableTableRowElement(xmlDoc);</span>
      }

      // ADDING STYLES TO THE NEW ELEMENT
<span class="nc bnc" id="L4535" title="All 2 branches missed.">      if (attrs != null) {</span>
<span class="nc" id="L4536">        addStyle(attrs, rowElement, xmlDoc);</span>
      }

      // Only addChild cells to a new row, when explicitly requested or reference row had been
      // addressed
<span class="nc" id="L4541">      Component newRowComponent =</span>
<span class="nc" id="L4542">          addElementAsComponent(parentComponent, rowElement, start.optInt(start.length() - 1));</span>
<span class="nc bnc" id="L4543" title="All 2 branches missed.">      if (addDefaultCells) {</span>
<span class="nc bnc" id="L4544" title="All 2 branches missed.">        if (isTextTable) {</span>
<span class="nc" id="L4545">          addCells(</span>
              rootComponent,
              start,
              CELL_WITH_BORDER_ATTRS,
<span class="nc" id="L4549">              table.getColumnCount(),</span>
              newRowComponent,
              null,
              isTextTable);
        } else {
          // if there is no reference row, no cells has been cloned from an existing row and basic
          // cells have to be added
<span class="nc bnc" id="L4556" title="All 2 branches missed.">          if (referenceRow &lt;= -1) {</span>
<span class="nc" id="L4557">            addCells(</span>
                rootComponent,
                start,
                null,
<span class="nc" id="L4561">                table.getColumnCount(),</span>
                newRowComponent,
                null,
                isTextTable);
          }
        }
      }
<span class="nc bnc" id="L4568" title="All 2 branches missed.">      if (count &gt; 1) {</span>
<span class="nc bnc" id="L4569" title="All 2 branches missed.">        if (isTextTable) {</span>
          // Insert row as often as requested by &quot;count&quot;
<span class="nc" id="L4571">          duplicateComponent(newRowComponent, count - 1);</span>
        } else {
<span class="nc" id="L4573">          rowElement.setTableNumberRowsRepeatedAttribute(count);</span>
        }
      }
    }
<span class="nc" id="L4577">  }</span>

  // ToDo: addCells/Rows/Table are very very SIMILAR and can be condensed!!
  public static void addCells(
      Component rootComponent,
      JSONArray start,
      JSONObject attrs,
      int count,
      Component parentComponent,
      OdfElement newCellElement,
      boolean isTextTable)
      throws IndexOutOfBoundsException {
    // Parent will not change and have to exist to insert the new component
<span class="nc bnc" id="L4590" title="All 2 branches missed.">    if (parentComponent == null) {</span>
<span class="nc" id="L4591">      parentComponent = rootComponent.getParentOf(start);</span>
    }
<span class="nc" id="L4593">    int cellPosition = start.optInt(start.length() - 1);</span>

<span class="nc bnc" id="L4595" title="All 2 branches missed.">    if (isTextTable) {</span>
      //
      //		if(parentComponent == null){
      //			// OOStyledTable.odt
      //			// tableOps.odt
      //		}
      //		if (parentComponent == null) {
      //			parentComponent = rootComponent.getParentOf(start);
      //		}

<span class="nc" id="L4605">      OdfFileDom xmlDoc = (OdfFileDom) parentComponent.getOwnerDocument();</span>
<span class="nc bnc" id="L4606" title="All 2 branches missed.">      if (newCellElement == null) {</span>
        // Creating a new cell (with border for text documents)
<span class="nc" id="L4608">        newCellElement = new TableTableCellElement(xmlDoc);</span>
      }

      // Adding any hard formatting to cell
<span class="nc bnc" id="L4612" title="All 2 branches missed.">      if (attrs != null) {</span>
<span class="nc" id="L4613">        JsonOperationConsumer.addStyle(attrs, (OdfStylableElement) newCellElement, xmlDoc);</span>
<span class="nc" id="L4614">        addCellAttributes(attrs, (TableTableCellElement) newCellElement);</span>
      }

      // ADDING COMPONENT
<span class="nc" id="L4618">      Component cellComponent =</span>
<span class="nc" id="L4619">          JsonOperationConsumer.addElementAsComponent(</span>
              parentComponent, newCellElement, cellPosition);
      // Insert cell as often as requested by &quot;count&quot;	(minus one as already once created)
<span class="nc" id="L4622">      JsonOperationConsumer.duplicateComponent(cellComponent, count - 1);</span>

<span class="nc" id="L4624">      Component tableComponent = cellComponent.getParent().getParent();</span>
<span class="nc" id="L4625">      TableTableElement tableElement = (TableTableElement) tableComponent.mRootElement;</span>

      // WORK AROUND for &quot;UNDO COLUMN WIDTH&quot; problem
<span class="nc bnc" id="L4628" title="All 2 branches missed.">      if (tableElement.isWidthChangeRequired()) {</span>
        // INSERT COLUMN
        // Returns all TableTableColumn descendants that exist within the tableElement, even within
        // groups, columns and header elements
<span class="nc" id="L4632">        List&lt;TableTableColumnElement&gt; existingColumnList =</span>
<span class="nc" id="L4633">            Table.getTableColumnElements(tableElement, new LinkedList&lt;TableTableColumnElement&gt;());</span>
        // Column creation only required
<span class="nc" id="L4635">        addColumnAndCellElements(</span>
<span class="nc" id="L4636">            tableElement.getComponent(),</span>
            start,
<span class="nc" id="L4638">            tableElement.popTableGrid(),</span>
<span class="nc" id="L4639">            cellPosition,</span>
            INSERT_AFTER,
            -1,
            true,
            existingColumnList,
<span class="nc" id="L4644">            Boolean.TRUE);</span>
<span class="nc" id="L4645">        tableElement.hasChangedWidth();</span>
      }

<span class="nc" id="L4648">    } else {</span>
<span class="nc bnc" id="L4649" title="All 2 branches missed.">      if (newCellElement == null) {</span>
<span class="nc" id="L4650">        OdfFileDom xmlDoc = (OdfFileDom) parentComponent.getOwnerDocument();</span>

        // Creating a new cell (with border for text documents)
<span class="nc" id="L4653">        newCellElement = new TableTableCellElement(xmlDoc);</span>
      }
<span class="nc bnc" id="L4655" title="All 2 branches missed.">      if (count &gt; 1) {</span>
<span class="nc" id="L4656">        newCellElement.setAttributeNS(</span>
<span class="nc" id="L4657">            OdfDocumentNamespace.TABLE.getUri(),</span>
            &quot;table:number-columns-repeated&quot;,
<span class="nc" id="L4659">            String.valueOf(count));</span>
      }

      //			newCellElement.setAttributeNS(OdfDocumentNamespace.TABLE.getUri(),
      // &quot;tableElement:number-columns-repeated&quot;, String.valueOf(count));
      //			parentComponent.getRootElement().appendChild(newCellElement);
      // ADDING COMPONENT
<span class="nc" id="L4666">      JsonOperationConsumer.addElementAsComponent(parentComponent, newCellElement, cellPosition);</span>
    }
<span class="nc" id="L4668">  }</span>

  private static void addCellAttributes(
      JSONObject attrs, TableTableCellElement newCellElement) { // , OdfFileDom ownerDocument
<span class="nc" id="L4672">    JSONObject props = (JSONObject) attrs.opt(&quot;cell&quot;);</span>
<span class="nc bnc" id="L4673" title="All 4 branches missed.">    if (props != null &amp;&amp; props.length() &gt; 0) {</span>
<span class="nc bnc" id="L4674" title="All 2 branches missed.">      if (props.has(&quot;gridSpan&quot;)) {</span>
<span class="nc" id="L4675">        Integer columnSpan = props.optInt(&quot;gridSpan&quot;);</span>
<span class="nc" id="L4676">        newCellElement.setTableNumberColumnsSpannedAttribute(columnSpan);</span>
      }
    }
<span class="nc" id="L4679">  }</span>

  /** Clones all elements of the component and created new components for them */
  // ToDo-Clean-Up: Move this to styleable Element
  private static void duplicateComponent(Component c, int count) {
    // if multiple components have to be added, clone them (different handling components with
    // repeated element, e.g. for cells )
<span class="nc" id="L4686">    OdfElement newElement = c.mRootElement;</span>
<span class="nc" id="L4687">    OdfElement parent = (OdfElement) c.mRootElement.getParentNode();</span>
<span class="nc bnc" id="L4688" title="All 2 branches missed.">    for (int i = 0; i &lt; count; i++) {</span>
<span class="nc" id="L4689">      newElement = (OdfElement) newElement.cloneNode(true);</span>
<span class="nc" id="L4690">      parent.insertBefore(newElement, c.mRootElement);</span>
<span class="nc" id="L4691">      addElementAsComponent(c.getParent(), newElement, -1);</span>

      //			NodeList rowChildren = cellElement.getChildNodes();
      //			Node child;
      //			for (int m = 0; m &lt; rowChildren.getLength(); m++) { // ADD CELL ELEMENTS
      //				child = rowChildren.item(m);
      //				if (child instanceof TableTableCellElement) {
      //					// remove all the content from the cell (or covered tableElement cell)
      //					TableTableCellElement cell = (TableTableCellElement) child;
      //					newRowComponent.createChildComponent((OdfElement) cell);
      //				}
      //			}
    }
<span class="nc" id="L4704">  }</span>

  /**
   * Adds the newElement to the parentComponent. Creating a component for
   * newElement Repeating the above in the number of the given count Adding
   * components for all children of newElement * Unfortunately sometimes there
   * is trailing boilerplate elements, that HAVE to be at the end. No new
   * components are allowed to be appended, e.g.
   * &lt;table:named-expressions/&gt;
   * &lt;/office:spreadsheet&gt;
   *
   */
  // ToDo Move this function to Component/Element or make it obsolete by no longer using component
  // structure
  public static Component addElementAsComponent(
      Component parentComponent, OdfElement newElement, int newPosition) {
<span class="nc" id="L4720">    Component newComponent = null;</span>
<span class="nc bnc" id="L4721" title="All 2 branches missed.">    if (parentComponent != null) {</span>
<span class="nc" id="L4722">      Node existingNode = parentComponent.getChildNode(newPosition);</span>
<span class="nc" id="L4723">      Element existingElement = null;</span>
      // CHECK IF AN EXISTING COMPONENT HAVE TO BE MOVED
      // When existing element found and no explicit appending (by providing -1)
<span class="nc bnc" id="L4726" title="All 6 branches missed.">      if (existingNode != null &amp;&amp; newPosition != -1 &amp;&amp; existingNode instanceof OdfElement) {</span>
        // if there is already a component on this position, insert the new component before
<span class="nc" id="L4728">        OdfElement existingParentElement = (OdfElement) existingNode.getParentNode();</span>
        // if there is are wrapping list elements around the node
<span class="nc bnc" id="L4730" title="All 4 branches missed.">        if (existingParentElement instanceof TextListItemElement</span>
            || existingParentElement instanceof TextListHeaderElement) {
<span class="nc" id="L4732">          existingElement =</span>
<span class="nc" id="L4733">              Component.getCorrectStartElementOfChild(</span>
<span class="nc" id="L4734">                  parentComponent.getRootElement(), (OdfElement) existingNode);</span>
<span class="nc" id="L4735">          existingParentElement = parentComponent.getRootElement();</span>
        } else {
<span class="nc" id="L4737">          existingElement = (OdfElement) existingNode;</span>
        }
        // PLACING THE NEW COMPONENT ELEMENT INTO THE EXISTING TREE
<span class="nc" id="L4740">        existingParentElement.insertBefore(newElement, existingElement);</span>
<span class="nc" id="L4741">        newComponent = Component.createChildComponent(newPosition, parentComponent, newElement);</span>
<span class="nc" id="L4742">      } else {</span>
        // IF IT IS A TEXT COMPONENT
<span class="nc bnc" id="L4744" title="All 2 branches missed.">        if (parentComponent instanceof TextContainer</span>
<span class="nc bnc" id="L4745" title="All 2 branches missed.">            &amp;&amp; ((TextContainer) parentComponent).getChildNode(newPosition) != null) {</span>
<span class="nc" id="L4746">          Element parentElement = parentComponent.getRootElement();</span>
<span class="nc bnc" id="L4747" title="All 2 branches missed.">          if (parentElement instanceof OdfElement) {</span>
<span class="nc" id="L4748">            ((OdfElement) parentElement).insert(newElement, newPosition);</span>
<span class="nc" id="L4749">            newComponent = Component.createChildComponent(newPosition, parentComponent, newElement);</span>
          } else {
<span class="nc" id="L4751">            LOG.log(</span>
                Level.WARNING,
                &quot;The parent element {0} is not of type OdfElement. The new element {1} could not be inserted!&quot;,
<span class="nc" id="L4754">                new Object[] {parentElement.getTagName(), newElement.getTagName()});</span>
          }
<span class="nc" id="L4756">        } else { // only possibility left is that it have to be appended with parameter -1</span>
<span class="nc" id="L4757">          Element parentElement = parentComponent.getRootElement();</span>
<span class="nc" id="L4758">          boolean inserted = false;</span>
<span class="nc bnc" id="L4759" title="All 2 branches missed.">          if (parentElement instanceof DrawFrameElement) {</span>
<span class="nc" id="L4760">            Node child = parentElement.getFirstChild();</span>
<span class="nc bnc" id="L4761" title="All 4 branches missed.">            if (child != null &amp;&amp; child instanceof DrawTextBoxElement) {</span>
<span class="nc" id="L4762">              child.appendChild(newElement);</span>
<span class="nc" id="L4763">              inserted = true;</span>
            }
          }
<span class="nc bnc" id="L4766" title="All 2 branches missed.">          if (!inserted) {</span>
<span class="nc" id="L4767">            parentElement.appendChild(newElement);</span>
          }
<span class="nc" id="L4769">          newComponent = parentComponent.createChildComponent(newElement);</span>
<span class="nc bnc" id="L4770" title="All 4 branches missed.">          if (newComponent instanceof Row || newComponent instanceof Cell) {</span>
<span class="nc" id="L4771">            OdfElement parent = (OdfElement) newComponent.mRootElement.getParentNode();</span>
<span class="nc bnc" id="L4772" title="All 2 branches missed.">            if (newComponent instanceof Row) {</span>

              //							while(!(parentComponentElement instanceof TableTableRowElement)){
              //								parentComponentElement.getParentNode();
              //							}
              // int existingNumber =  parentComponentElement.countDescendantComponents();
              // newElement.setAttributeNS(OdfDocumentNamespace.TABLE.getUri(),
              // &quot;tableElement:tableElement:number-columns-repeated&quot;, String.valueOf(newPosition -
              // existingNumber));
              //							newElement.setAttributeNS(OdfDocumentNamespace.TABLE.getUri(),
              // &quot;tableElement:tableElement:number-columns-repeated&quot;, String.valueOf(newPosition));
              //						}else{
<span class="nc bnc" id="L4784" title="All 2 branches missed.">              while (!(parent instanceof TableTableElement)) {</span>
<span class="nc" id="L4785">                parent.getParentNode();</span>
              }
              // minus one as the new row was already added
<span class="nc" id="L4788">              int existingNumber = parent.countDescendantComponents() - 1;</span>
              // plus one as the position starts counting with zero
<span class="nc" id="L4790">              int newCount = newPosition + 1;</span>
<span class="nc" id="L4791">              int rowRepeated = newCount - existingNumber;</span>
<span class="nc bnc" id="L4792" title="All 2 branches missed.">              if (rowRepeated &gt; 1) {</span>
<span class="nc" id="L4793">                newElement.setAttributeNS(</span>
<span class="nc" id="L4794">                    OdfDocumentNamespace.TABLE.getUri(),</span>
                    &quot;table:number-rows-repeated&quot;,
<span class="nc" id="L4796">                    String.valueOf(rowRepeated));</span>
              }
            }
          }
        }
      }
<span class="nc" id="L4802">    } else {</span>
<span class="nc" id="L4803">      LOG.severe(&quot;The parentComponent should never be null!&quot;);</span>
    }
<span class="nc" id="L4805">    return newComponent;</span>
  }

  public static void mapProperties(
      OdfStyleFamily styleFamily, JSONObject attrs, OdfStyleBase style, OdfDocument doc) {

<span class="nc bnc" id="L4811" title="All 6 branches missed.">    if (attrs != null &amp;&amp; styleFamily != null &amp;&amp; style != null) {</span>
<span class="nc bnc" id="L4812" title="All 2 branches missed.">      if (styleFamily.getName().equals(&quot;table-cell&quot;)</span>
<span class="nc bnc" id="L4813" title="All 2 branches missed.">          &amp;&amp; attrs.has(&quot;cell&quot;)</span>
<span class="nc bnc" id="L4814" title="All 2 branches missed.">          &amp;&amp; !attrs.get(&quot;cell&quot;).equals(JSONObject.NULL)) {</span>
        try {
<span class="nc" id="L4816">          JSONObject cellObject = attrs.getJSONObject(&quot;cell&quot;);</span>
<span class="nc bnc" id="L4817" title="All 2 branches missed.">          if (cellObject.has(&quot;alignHor&quot;)) {</span>
<span class="nc bnc" id="L4818" title="All 2 branches missed.">            if (!attrs.has(&quot;paragraph&quot;)) {</span>
<span class="nc" id="L4819">              attrs.put(&quot;paragraph&quot;, new JSONObject());</span>
            }
<span class="nc" id="L4821">            JSONObject paraObject = attrs.getJSONObject(&quot;paragraph&quot;);</span>
<span class="nc" id="L4822">            paraObject.put(&quot;alignment&quot;, cellObject.get(&quot;alignHor&quot;));</span>
          }
<span class="nc" id="L4824">        } catch (JSONException e) {</span>
<span class="nc" id="L4825">        }</span>
      }
<span class="nc" id="L4827">      Map&lt;String, OdfStylePropertiesSet&gt; familyProperties =</span>
<span class="nc" id="L4828">          Component.getAllStyleGroupingIdProperties(styleFamily);</span>
<span class="nc" id="L4829">      Set&lt;String&gt; propTypes = familyProperties.keySet();</span>
<span class="nc bnc" id="L4830" title="All 2 branches missed.">      for (String type : propTypes) {</span>

<span class="nc bnc" id="L4832" title="All 2 branches missed.">        if (type.equals(&quot;character&quot;)</span>
<span class="nc bnc" id="L4833" title="All 2 branches missed.">            &amp;&amp; attrs.has(&quot;character&quot;)</span>
<span class="nc bnc" id="L4834" title="All 2 branches missed.">            &amp;&amp; !attrs.get(&quot;character&quot;).equals(JSONObject.NULL)) {</span>
<span class="nc" id="L4835">          JSONObject textProps = (JSONObject) attrs.opt(&quot;character&quot;);</span>
<span class="nc bnc" id="L4836" title="All 4 branches missed.">          if (textProps != null &amp;&amp; textProps.length() &gt; 0) {</span>
<span class="nc" id="L4837">            OdfStylePropertiesBase propsElement =</span>
<span class="nc" id="L4838">                style.getOrCreatePropertiesElement(OdfStylePropertiesSet.TextProperties);</span>
<span class="nc" id="L4839">            mapCharacterProperties(textProps, (StyleTextPropertiesElement) propsElement, doc);</span>
          }
<span class="nc bnc" id="L4841" title="All 2 branches missed.">        } else if (type.equals(&quot;paragraph&quot;)</span>
<span class="nc bnc" id="L4842" title="All 2 branches missed.">            &amp;&amp; attrs.has(&quot;paragraph&quot;)</span>
<span class="nc bnc" id="L4843" title="All 2 branches missed.">            &amp;&amp; !attrs.get(&quot;paragraph&quot;).equals(JSONObject.NULL)) {</span>
<span class="nc" id="L4844">          JSONObject paraProps = (JSONObject) attrs.opt(&quot;paragraph&quot;);</span>
<span class="nc bnc" id="L4845" title="All 4 branches missed.">          if (paraProps != null &amp;&amp; paraProps.length() &gt; 0) {</span>
<span class="nc" id="L4846">            OdfStylePropertiesBase propsElement =</span>
<span class="nc" id="L4847">                style.getOrCreatePropertiesElement(OdfStylePropertiesSet.ParagraphProperties);</span>
<span class="nc" id="L4848">            mapParagraphProperties(paraProps, (StyleParagraphPropertiesElement) propsElement);</span>
          }
<span class="nc bnc" id="L4850" title="All 2 branches missed.">        } else if (type.equals(&quot;table&quot;)) {</span>
<span class="nc bnc" id="L4851" title="All 4 branches missed.">          if (attrs.has(&quot;table&quot;) &amp;&amp; !attrs.get(&quot;table&quot;).equals(JSONObject.NULL)) {</span>
<span class="nc" id="L4852">            JSONObject tableProps = (JSONObject) attrs.opt(&quot;table&quot;);</span>
<span class="nc bnc" id="L4853" title="All 4 branches missed.">            if (tableProps != null &amp;&amp; tableProps.length() &gt; 0) {</span>
<span class="nc" id="L4854">              OdfStylePropertiesBase propsElement =</span>
<span class="nc" id="L4855">                  style.getOrCreatePropertiesElement(OdfStylePropertiesSet.TableProperties);</span>
<span class="nc" id="L4856">              mapTableProperties(tableProps, (StyleTablePropertiesElement) propsElement);</span>
            }
<span class="nc bnc" id="L4858" title="All 4 branches missed.">          } else if (attrs.has(OPK_SHEET) &amp;&amp; !attrs.get(OPK_SHEET).equals(JSONObject.NULL)) {</span>
            // currently the sheet are handled different than the tableElement
<span class="nc" id="L4860">            JSONObject sheetProps = (JSONObject) attrs.opt(OPK_SHEET);</span>
<span class="nc bnc" id="L4861" title="All 4 branches missed.">            if (sheetProps != null &amp;&amp; sheetProps.length() &gt; 0) {</span>
<span class="nc" id="L4862">              OdfStylePropertiesBase propsElement =</span>
<span class="nc" id="L4863">                  style.getOrCreatePropertiesElement(OdfStylePropertiesSet.TableProperties);</span>
<span class="nc" id="L4864">              mapTableProperties(sheetProps, (StyleTablePropertiesElement) propsElement);</span>
            }
<span class="nc" id="L4866">          } else {</span>
            // some default values have to be set (width 100% for MSO15)
<span class="nc" id="L4868">            OdfStylePropertiesBase propsElement =</span>
<span class="nc" id="L4869">                style.getOrCreatePropertiesElement(OdfStylePropertiesSet.TableProperties);</span>
<span class="nc" id="L4870">            mapTableProperties(null, (StyleTablePropertiesElement) propsElement);</span>
<span class="nc" id="L4871">          }</span>
<span class="nc bnc" id="L4872" title="All 2 branches missed.">        } else if (type.equals(&quot;row&quot;)</span>
<span class="nc bnc" id="L4873" title="All 2 branches missed.">            &amp;&amp; attrs.has(&quot;row&quot;)</span>
<span class="nc bnc" id="L4874" title="All 2 branches missed.">            &amp;&amp; !attrs.get(&quot;row&quot;).equals(JSONObject.NULL)) {</span>
<span class="nc" id="L4875">          JSONObject props = (JSONObject) attrs.opt(&quot;row&quot;);</span>
<span class="nc bnc" id="L4876" title="All 4 branches missed.">          if (props != null &amp;&amp; props.length() &gt; 0) {</span>
<span class="nc" id="L4877">            OdfStylePropertiesBase propsElement =</span>
<span class="nc" id="L4878">                style.getOrCreatePropertiesElement(OdfStylePropertiesSet.TableRowProperties);</span>
<span class="nc" id="L4879">            mapRowProperties(props, (StyleTableRowPropertiesElement) propsElement);</span>
          }
<span class="nc bnc" id="L4881" title="All 2 branches missed.">        } else if (type.equals(&quot;cell&quot;)</span>
<span class="nc bnc" id="L4882" title="All 2 branches missed.">            &amp;&amp; attrs.has(&quot;cell&quot;)</span>
<span class="nc bnc" id="L4883" title="All 2 branches missed.">            &amp;&amp; !attrs.get(&quot;cell&quot;).equals(JSONObject.NULL)) {</span>
<span class="nc" id="L4884">          JSONObject props = (JSONObject) attrs.opt(&quot;cell&quot;);</span>
<span class="nc bnc" id="L4885" title="All 4 branches missed.">          if (props != null &amp;&amp; props.length() &gt; 0) {</span>
<span class="nc" id="L4886">            OdfStylePropertiesBase propsElement =</span>
<span class="nc" id="L4887">                style.getOrCreatePropertiesElement(OdfStylePropertiesSet.TableCellProperties);</span>
<span class="nc" id="L4888">            mapCellProperties(props, (StyleTableCellPropertiesElement) propsElement);</span>
          }
<span class="nc bnc" id="L4890" title="All 2 branches missed.">        } else if (type.equals(&quot;column&quot;)</span>
<span class="nc bnc" id="L4891" title="All 2 branches missed.">            &amp;&amp; attrs.has(&quot;column&quot;)</span>
<span class="nc bnc" id="L4892" title="All 2 branches missed.">            &amp;&amp; !attrs.get(&quot;column&quot;).equals(JSONObject.NULL)) {</span>
<span class="nc" id="L4893">          JSONObject props = (JSONObject) attrs.opt(&quot;column&quot;);</span>
<span class="nc bnc" id="L4894" title="All 4 branches missed.">          if (props != null &amp;&amp; props.length() &gt; 0) {</span>
<span class="nc" id="L4895">            OdfStylePropertiesBase propsElement =</span>
<span class="nc" id="L4896">                style.getOrCreatePropertiesElement(OdfStylePropertiesSet.TableColumnProperties);</span>
<span class="nc" id="L4897">            mapColumnProperties(props, (StyleTableColumnPropertiesElement) propsElement);</span>
          }
<span class="nc bnc" id="L4899" title="All 2 branches missed.">        } else if (type.equals(&quot;list&quot;)</span>
<span class="nc bnc" id="L4900" title="All 2 branches missed.">            &amp;&amp; attrs.has(&quot;list&quot;)</span>
<span class="nc bnc" id="L4901" title="All 2 branches missed.">            &amp;&amp; !attrs.get(&quot;list&quot;).equals(JSONObject.NULL)) {</span>
<span class="nc" id="L4902">          JSONObject props = (JSONObject) attrs.opt(&quot;list&quot;);</span>
<span class="nc bnc" id="L4903" title="All 4 branches missed.">          if (props != null &amp;&amp; props.length() &gt; 0) {</span>
<span class="nc" id="L4904">            OdfStylePropertiesBase propsElement =</span>
<span class="nc" id="L4905">                style.getOrCreatePropertiesElement(OdfStylePropertiesSet.ListLevelProperties);</span>
<span class="nc" id="L4906">            mapListProperties(props, (StyleListLevelPropertiesElement) propsElement);</span>
          }
<span class="nc bnc" id="L4908" title="All 2 branches missed.">        } else if (type.equals(&quot;section&quot;)</span>
<span class="nc bnc" id="L4909" title="All 2 branches missed.">            &amp;&amp; attrs.has(&quot;section&quot;)</span>
<span class="nc bnc" id="L4910" title="All 2 branches missed.">            &amp;&amp; !attrs.get(&quot;section&quot;).equals(JSONObject.NULL)) {</span>
<span class="nc" id="L4911">          JSONObject props = (JSONObject) attrs.opt(&quot;section&quot;);</span>
<span class="nc bnc" id="L4912" title="All 4 branches missed.">          if (props != null &amp;&amp; props.length() &gt; 0) {</span>
<span class="nc" id="L4913">            OdfStylePropertiesBase propsElement =</span>
<span class="nc" id="L4914">                style.getOrCreatePropertiesElement(OdfStylePropertiesSet.SectionProperties);</span>
<span class="nc" id="L4915">            mapSectionProperties(props, (StyleSectionPropertiesElement) propsElement);</span>
          }

<span class="nc bnc" id="L4918" title="All 4 branches missed.">        } else if (type.equals(&quot;drawing&quot;) || type.equals(&quot;presentation&quot;)) {</span>
<span class="nc bnc" id="L4919" title="All 2 branches missed.">          if (attrs.has(&quot;drawing&quot;)</span>
<span class="nc bnc" id="L4920" title="All 2 branches missed.">              || attrs.has(&quot;shape&quot;)</span>
<span class="nc bnc" id="L4921" title="All 2 branches missed.">              || attrs.has(&quot;line&quot;)</span>
<span class="nc bnc" id="L4922" title="All 2 branches missed.">              || attrs.has(&quot;fill&quot;)) {</span>
<span class="nc" id="L4923">            JSONObject allDrawingProperties = new JSONObject();</span>
            try {
<span class="nc" id="L4925">              String subs[] = {&quot;shape&quot;, &quot;drawing&quot;};</span>
<span class="nc bnc" id="L4926" title="All 2 branches missed.">              for (String sub : subs) {</span>
<span class="nc bnc" id="L4927" title="All 2 branches missed.">                if (attrs.has(sub)) {</span>
<span class="nc" id="L4928">                  JSONObject subAttrs = attrs.getJSONObject(sub);</span>
<span class="nc" id="L4929">                  Iterator&lt;String&gt; keyIt = subAttrs.keys();</span>
<span class="nc bnc" id="L4930" title="All 2 branches missed.">                  while (keyIt.hasNext()) {</span>
<span class="nc" id="L4931">                    String key = keyIt.next();</span>
<span class="nc" id="L4932">                    allDrawingProperties.put(key, subAttrs.get(key));</span>
<span class="nc" id="L4933">                  }</span>
                }
              }
<span class="nc bnc" id="L4936" title="All 2 branches missed.">              if (attrs.has(&quot;fill&quot;)) {</span>
<span class="nc" id="L4937">                allDrawingProperties.put(&quot;fill&quot;, attrs.getJSONObject(&quot;fill&quot;));</span>
              }
<span class="nc bnc" id="L4939" title="All 2 branches missed.">              if (attrs.has(&quot;line&quot;)) {</span>
<span class="nc" id="L4940">                allDrawingProperties.put(&quot;line&quot;, attrs.getJSONObject(&quot;line&quot;));</span>
              }
<span class="nc" id="L4942">            } catch (JSONException e) {</span>
              // no handling required
<span class="nc" id="L4944">            }</span>
<span class="nc bnc" id="L4945" title="All 2 branches missed.">            if (allDrawingProperties.length() &gt; 0) {</span>
<span class="nc" id="L4946">              OdfStyleBase parentStyle = style.getParentStyle();</span>
<span class="nc" id="L4947">              OdfStylePropertiesBase propsElement =</span>
<span class="nc" id="L4948">                  style.getOrCreatePropertiesElement(OdfStylePropertiesSet.GraphicProperties);</span>
<span class="nc" id="L4949">              mapGraphicProperties(</span>
                  allDrawingProperties, (StyleGraphicPropertiesElement) propsElement, parentStyle);
            }
<span class="nc" id="L4952">          }</span>

          // ToDo: How to differentiate Graphics from Drawings? ( see condition before - images have
          // only GraphicProperties!)
          //				} else if (type.equals(&quot;drawing&quot;)) {
          //					JSONObject props = (JSONObject) attrs.opt(&quot;drawing&quot;);
          //					if (props != null &amp;&amp; props.length() &gt; 0) {
          //						OdfStylePropertiesBase propsElement =
          // style.getOrCreatePropertiesElement(OdfStylePropertiesSet.DrawingPageProperties);
          //						mapDrawingProperties(props, (StyleDrawingPagePropertiesElement) propsElement);
          //					}
<span class="nc bnc" id="L4963" title="All 4 branches missed.">        } else if (type.equals(&quot;chart&quot;) || type.equals(&quot;chart&quot;)) {</span>
<span class="nc" id="L4964">          JSONObject props = (JSONObject) attrs.opt(&quot;chart&quot;);</span>
<span class="nc bnc" id="L4965" title="All 4 branches missed.">          if (props != null &amp;&amp; props.length() &gt; 0) {</span>
<span class="nc" id="L4966">            OdfStylePropertiesBase propsElement =</span>
<span class="nc" id="L4967">                style.getOrCreatePropertiesElement(OdfStylePropertiesSet.ChartProperties);</span>
<span class="nc" id="L4968">            mapChartProperties(props, (StyleChartPropertiesElement) propsElement);</span>
          }
<span class="nc bnc" id="L4970" title="All 4 branches missed.">        } else if (type.equals(&quot;page&quot;) || type.equals(&quot;page&quot;)) {</span>
<span class="nc" id="L4971">          JSONObject props = (JSONObject) attrs.opt(&quot;page&quot;);</span>
<span class="nc bnc" id="L4972" title="All 4 branches missed.">          if (props != null &amp;&amp; props.length() &gt; 0) {</span>
<span class="nc" id="L4973">            OdfStylePropertiesBase propsElement =</span>
<span class="nc" id="L4974">                style.getOrCreatePropertiesElement(OdfStylePropertiesSet.PageLayoutProperties);</span>
<span class="nc" id="L4975">            mapPageProperties(props, (StylePageLayoutPropertiesElement) propsElement);</span>
          }
<span class="nc bnc" id="L4977" title="All 4 branches missed.">        } else if (type.equals(&quot;ruby&quot;) || type.equals(&quot;ruby&quot;)) {</span>
<span class="nc" id="L4978">          JSONObject props = (JSONObject) attrs.opt(&quot;ruby&quot;);</span>
<span class="nc bnc" id="L4979" title="All 4 branches missed.">          if (props != null &amp;&amp; props.length() &gt; 0) {</span>
<span class="nc" id="L4980">            OdfStylePropertiesBase propsElement =</span>
<span class="nc" id="L4981">                style.getOrCreatePropertiesElement(OdfStylePropertiesSet.RubyProperties);</span>
<span class="nc" id="L4982">            mapRubyProperties(props, (StyleRubyPropertiesElement) propsElement);</span>
          }
<span class="nc bnc" id="L4984" title="All 4 branches missed.">        } else if (type.equals(&quot;headerFooter&quot;) || type.equals(&quot;headerFooter&quot;)) {</span>
<span class="nc" id="L4985">          JSONObject props = (JSONObject) attrs.opt(&quot;headerFooter&quot;);</span>
<span class="nc bnc" id="L4986" title="All 4 branches missed.">          if (props != null &amp;&amp; props.length() &gt; 0) {</span>
<span class="nc" id="L4987">            OdfStylePropertiesBase propsElement =</span>
<span class="nc" id="L4988">                style.getOrCreatePropertiesElement(OdfStylePropertiesSet.HeaderFooterProperties);</span>
<span class="nc" id="L4989">            mapHeaderFooterProperties(props, (StyleHeaderFooterPropertiesElement) propsElement);</span>
          }
        }
<span class="nc" id="L4992">      }</span>
    }
<span class="nc" id="L4994">  }</span>

  // The latter fontNames Set is a hack for the OX release as the 16 fonts supported do not write
  // out their descriptions
  public static void mapCharacterProperties(
      JSONObject attrs, StyleTextPropertiesElement propertiesElement, OdfDocument doc) {
<span class="nc bnc" id="L5000" title="All 2 branches missed.">    if (attrs != null) {</span>

<span class="nc" id="L5002">      Object language = null;</span>
<span class="nc" id="L5003">      Object noProof = null;</span>

<span class="nc" id="L5005">      final Iterator keySetIter = attrs.keySet().iterator();</span>
<span class="nc bnc" id="L5006" title="All 2 branches missed.">      while (keySetIter.hasNext()) {</span>
<span class="nc" id="L5007">        final String key = (String) keySetIter.next();</span>
<span class="nc" id="L5008">        final Object value = attrs.get(key);</span>
        // TODO -- !!!!!!!!!!!!!!!!ROUNDTRIP WITH THESE VALUES!!!!!!!!!!!
        //	&lt;define name=&quot;fontWeight&quot;&gt;
        //		&lt;choice&gt;
        //			&lt;value&gt;normal&lt;/value&gt;
        //			&lt;value&gt;bold&lt;/value&gt;
        //			&lt;value&gt;100&lt;/value&gt;
        //			&lt;value&gt;200&lt;/value&gt;
        //			&lt;value&gt;300&lt;/value&gt;
        //			&lt;value&gt;400&lt;/value&gt;
        //			&lt;value&gt;500&lt;/value&gt;
        //			&lt;value&gt;600&lt;/value&gt;
        //			&lt;value&gt;700&lt;/value&gt;
        //			&lt;value&gt;800&lt;/value&gt;
        //			&lt;value&gt;900&lt;/value&gt;
        //		&lt;/choice&gt;
        //	&lt;/define&gt;
        // fo:font-weight
<span class="nc bnc" id="L5026" title="All 2 branches missed.">        if (key.equals(&quot;bold&quot;)) {</span>
<span class="nc bnc" id="L5027" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5028">            propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;font-weight&quot;);</span>
          } else {
<span class="nc" id="L5030">            Boolean isBold = (Boolean) value;</span>
<span class="nc bnc" id="L5031" title="All 2 branches missed.">            if (isBold) {</span>
<span class="nc" id="L5032">              propertiesElement.setFoFontWeightAttribute(&quot;bold&quot;);</span>
            } else {
<span class="nc" id="L5034">              propertiesElement.setFoFontWeightAttribute(&quot;normal&quot;);</span>
            }
<span class="nc" id="L5036">          }</span>
<span class="nc bnc" id="L5037" title="All 2 branches missed.">        } else if (key.equals(&quot;boldAsian&quot;)) {</span>
<span class="nc bnc" id="L5038" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5039">            propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5040">                OdfDocumentNamespace.FO.getUri(), &quot;font-weight-asian&quot;);</span>
          } else {
<span class="nc" id="L5042">            Boolean isBold = (Boolean) value;</span>
<span class="nc bnc" id="L5043" title="All 2 branches missed.">            if (isBold) {</span>
<span class="nc" id="L5044">              propertiesElement.setAttributeNS(</span>
<span class="nc" id="L5045">                  OdfDocumentNamespace.STYLE.getUri(), &quot;style:font-weight-asian&quot;, &quot;bold&quot;);</span>
            } else {
<span class="nc" id="L5047">              propertiesElement.setAttributeNS(</span>
<span class="nc" id="L5048">                  OdfDocumentNamespace.STYLE.getUri(), &quot;style:font-weight-asian&quot;, &quot;normal&quot;);</span>
            }
<span class="nc" id="L5050">          }</span>
<span class="nc bnc" id="L5051" title="All 2 branches missed.">        } else if (key.equals(&quot;boldComplex&quot;)) {</span>
<span class="nc bnc" id="L5052" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5053">            propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5054">                OdfDocumentNamespace.FO.getUri(), &quot;font-weight-complex&quot;);</span>
          } else {
<span class="nc" id="L5056">            Boolean isBold = (Boolean) value;</span>
<span class="nc bnc" id="L5057" title="All 2 branches missed.">            if (isBold) {</span>
<span class="nc" id="L5058">              propertiesElement.setAttributeNS(</span>
<span class="nc" id="L5059">                  OdfDocumentNamespace.STYLE.getUri(), &quot;style:font-weight-complex&quot;, &quot;bold&quot;);</span>
            } else {
<span class="nc" id="L5061">              propertiesElement.setAttributeNS(</span>
<span class="nc" id="L5062">                  OdfDocumentNamespace.STYLE.getUri(), &quot;style:font-weight-complex&quot;, &quot;normal&quot;);</span>
            }
<span class="nc" id="L5064">          }</span>
        } //	&lt;define name=&quot;lineStyle&quot;&gt;
        //		&lt;choice&gt;
        //			&lt;value&gt;none&lt;/value&gt;
        //			&lt;value&gt;solid&lt;/value&gt;
        //			&lt;value&gt;dotted&lt;/value&gt;
        //			&lt;value&gt;dash&lt;/value&gt;
        //			&lt;value&gt;long-dash&lt;/value&gt;
        //			&lt;value&gt;dot-dash&lt;/value&gt;
        //			&lt;value&gt;dot-dot-dash&lt;/value&gt;
        //			&lt;value&gt;wave&lt;/value&gt;
        //		&lt;/choice&gt;
        //	&lt;/define&gt;
<span class="nc bnc" id="L5077" title="All 2 branches missed.">        else if (key.equals(&quot;underline&quot;)) {</span>
<span class="nc bnc" id="L5078" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5079">            propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5080">                OdfDocumentNamespace.STYLE.getUri(), &quot;text-underline-style&quot;);</span>
<span class="nc" id="L5081">            propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5082">                OdfDocumentNamespace.STYLE.getUri(), &quot;text-underline-width&quot;);</span>
<span class="nc" id="L5083">            propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5084">                OdfDocumentNamespace.STYLE.getUri(), &quot;text-underline-color&quot;);</span>
<span class="nc" id="L5085">            propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5086">                OdfDocumentNamespace.STYLE.getUri(), &quot;text-underline-type&quot;);</span>
          } else {
<span class="nc" id="L5088">            Boolean isUnderline = (Boolean) value;</span>
<span class="nc bnc" id="L5089" title="All 2 branches missed.">            if (isUnderline) {</span>
<span class="nc" id="L5090">              propertiesElement.setStyleTextUnderlineStyleAttribute(&quot;solid&quot;);</span>
            } else {
<span class="nc" id="L5092">              propertiesElement.setStyleTextUnderlineStyleAttribute(&quot;none&quot;);</span>
            }
<span class="nc" id="L5094">          }</span>

          //	&lt;define name=&quot;fontStyle&quot;&gt;
          //		&lt;choice&gt;
          //			&lt;value&gt;normal&lt;/value&gt;
          //			&lt;value&gt;italic&lt;/value&gt;
          //			&lt;value&gt;oblique&lt;/value&gt;
          //		&lt;/choice&gt;
          //	&lt;/define&gt;
<span class="nc bnc" id="L5103" title="All 2 branches missed.">        } else if (key.equals(&quot;italic&quot;)) {</span>
<span class="nc bnc" id="L5104" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5105">            propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;font-style&quot;);</span>
          } else {
<span class="nc" id="L5107">            Boolean isItalic = (Boolean) value;</span>
<span class="nc bnc" id="L5108" title="All 2 branches missed.">            if (isItalic) {</span>
<span class="nc" id="L5109">              propertiesElement.setFoFontStyleAttribute(&quot;italic&quot;);</span>
            } else {
<span class="nc" id="L5111">              propertiesElement.setFoFontStyleAttribute(&quot;normal&quot;);</span>
            }
<span class="nc" id="L5113">          }</span>
<span class="nc bnc" id="L5114" title="All 2 branches missed.">        } else if (key.equals(&quot;italicAsian&quot;)) {</span>
<span class="nc bnc" id="L5115" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5116">            propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5117">                OdfDocumentNamespace.FO.getUri(), &quot;font-style-asian&quot;);</span>
          } else {
<span class="nc" id="L5119">            Boolean isItalic = (Boolean) value;</span>
<span class="nc bnc" id="L5120" title="All 2 branches missed.">            if (isItalic) {</span>
<span class="nc" id="L5121">              propertiesElement.setAttributeNS(</span>
<span class="nc" id="L5122">                  OdfDocumentNamespace.STYLE.getUri(), &quot;style:font-style-asian&quot;, &quot;italic&quot;);</span>

            } else {
<span class="nc" id="L5125">              propertiesElement.setAttributeNS(</span>
<span class="nc" id="L5126">                  OdfDocumentNamespace.STYLE.getUri(), &quot;style:font-style-asian&quot;, &quot;normal&quot;);</span>
            }
<span class="nc" id="L5128">          }</span>
<span class="nc bnc" id="L5129" title="All 2 branches missed.">        } else if (key.equals(&quot;italicComplex&quot;)) {</span>
<span class="nc bnc" id="L5130" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5131">            propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5132">                OdfDocumentNamespace.FO.getUri(), &quot;font-style-complex&quot;);</span>
          } else {
<span class="nc" id="L5134">            Boolean isItalic = (Boolean) value;</span>
<span class="nc bnc" id="L5135" title="All 2 branches missed.">            if (isItalic) {</span>
<span class="nc" id="L5136">              propertiesElement.setAttributeNS(</span>
<span class="nc" id="L5137">                  OdfDocumentNamespace.STYLE.getUri(), &quot;style:font-style-complex&quot;, &quot;italic&quot;);</span>
            } else {
<span class="nc" id="L5139">              propertiesElement.setAttributeNS(</span>
<span class="nc" id="L5140">                  OdfDocumentNamespace.STYLE.getUri(), &quot;style:font-style-complex&quot;, &quot;normal&quot;);</span>
            }
<span class="nc" id="L5142">          }</span>
<span class="nc bnc" id="L5143" title="All 2 branches missed.">        } else if (key.equals(&quot;color&quot;)) {</span>
<span class="nc bnc" id="L5144" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5145">            propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;color&quot;);</span>
          } else {
<span class="nc" id="L5147">            JSONObject color = (JSONObject) value;</span>
<span class="nc bnc" id="L5148" title="All 4 branches missed.">            if (color.has(OPK_TYPE) &amp;&amp; !color.get(OPK_TYPE).equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5149">              String type = color.optString(OPK_TYPE, &quot;&quot;);</span>
<span class="nc bnc" id="L5150" title="All 2 branches missed.">              if (!type.equals(MapHelper.AUTO)) {</span>
<span class="nc" id="L5151">                propertiesElement.setFoColorAttribute(getColor(color, null));</span>
<span class="nc" id="L5152">                propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5153">                    OdfDocumentNamespace.STYLE.getUri(), &quot;use-window-font-color&quot;);</span>
              } else {
<span class="nc" id="L5155">                propertiesElement.setAttributeNS(</span>
<span class="nc" id="L5156">                    OdfDocumentNamespace.STYLE.getUri(), &quot;style:use-window-font-color&quot;, &quot;true&quot;);</span>
              }
<span class="nc" id="L5158">            } else { // DEFAULT IS AUTO</span>
<span class="nc" id="L5159">              propertiesElement.setAttributeNS(</span>
<span class="nc" id="L5160">                  OdfDocumentNamespace.STYLE.getUri(), &quot;style:use-window-font-color&quot;, &quot;true&quot;);</span>
            }
<span class="nc" id="L5162">          }</span>
<span class="nc bnc" id="L5163" title="All 2 branches missed.">        } else if (key.equals(&quot;fillColor&quot;)) {</span>
<span class="nc bnc" id="L5164" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5165">            propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5166">                OdfDocumentNamespace.FO.getUri(), &quot;background-color&quot;);</span>
          } else {
<span class="nc" id="L5168">            JSONObject color = (JSONObject) value;</span>
<span class="nc" id="L5169">            propertiesElement.setFoBackgroundColorAttribute(getColor(color, MapHelper.TRANSPARENT));</span>
<span class="nc" id="L5170">          }</span>
<span class="nc bnc" id="L5171" title="All 2 branches missed.">        } else if (key.equals(&quot;fontSize&quot;)) {</span>
<span class="nc bnc" id="L5172" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5173">            propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;font-size&quot;);</span>
          } else {
<span class="nc" id="L5175">            propertiesElement.setFoFontSizeAttribute(value.toString() + &quot;pt&quot;);</span>
          }
<span class="nc bnc" id="L5177" title="All 2 branches missed.">        } else if (key.equals(&quot;fontSizeAsian&quot;)) {</span>
<span class="nc bnc" id="L5178" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5179">            propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5180">                OdfDocumentNamespace.STYLE.getUri(), &quot;font-size-asian&quot;);</span>
          } else {
<span class="nc" id="L5182">            propertiesElement.setAttributeNS(</span>
<span class="nc" id="L5183">                OdfDocumentNamespace.STYLE.getUri(),</span>
                &quot;style:font-size-asian&quot;,
<span class="nc" id="L5185">                value.toString() + &quot;pt&quot;);</span>
          }
<span class="nc bnc" id="L5187" title="All 2 branches missed.">        } else if (key.equals(&quot;fontSizeComplex&quot;)) {</span>
<span class="nc bnc" id="L5188" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5189">            propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5190">                OdfDocumentNamespace.STYLE.getUri(), &quot;font-size-complex&quot;);</span>
          } else {
<span class="nc" id="L5192">            propertiesElement.setAttributeNS(</span>
<span class="nc" id="L5193">                OdfDocumentNamespace.STYLE.getUri(),</span>
                &quot;style:font-size-complex&quot;,
<span class="nc" id="L5195">                value.toString() + &quot;pt&quot;);</span>
          }
<span class="nc bnc" id="L5197" title="All 2 branches missed.">        } else if (key.equals(&quot;fontName&quot;)) {</span>
<span class="nc bnc" id="L5198" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5199">            propertiesElement.removeAttributeNS(OdfDocumentNamespace.STYLE.getUri(), &quot;font-name&quot;);</span>
          } else {
<span class="nc" id="L5201">            String fontName = (String) value;</span>
<span class="nc" id="L5202">            propertiesElement.setStyleFontNameAttribute(fontName);</span>
<span class="nc" id="L5203">            addFontToDocument(fontName, doc);</span>
<span class="nc" id="L5204">          }</span>
<span class="nc bnc" id="L5205" title="All 2 branches missed.">        } else if (key.equals(&quot;fontNameAsian&quot;)) {</span>
<span class="nc bnc" id="L5206" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5207">            propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5208">                OdfDocumentNamespace.STYLE.getUri(), &quot;font-name-asian&quot;);</span>
          } else {
<span class="nc" id="L5210">            String fontName = (String) value;</span>
<span class="nc" id="L5211">            propertiesElement.setAttributeNS(</span>
<span class="nc" id="L5212">                OdfDocumentNamespace.STYLE.getUri(), &quot;style:font-name-asian&quot;, fontName);</span>
<span class="nc" id="L5213">          }</span>
<span class="nc bnc" id="L5214" title="All 2 branches missed.">        } else if (key.equals(&quot;fontNameComplex&quot;)) {</span>
<span class="nc bnc" id="L5215" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5216">            propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5217">                OdfDocumentNamespace.STYLE.getUri(), &quot;font-name-complex&quot;);</span>
          } else {
<span class="nc" id="L5219">            String fontName = (String) value;</span>
<span class="nc" id="L5220">            propertiesElement.setAttributeNS(</span>
<span class="nc" id="L5221">                OdfDocumentNamespace.STYLE.getUri(), &quot;style:font-name-complex&quot;, fontName);</span>
<span class="nc" id="L5222">          }</span>
<span class="nc bnc" id="L5223" title="All 2 branches missed.">        } else if (key.equals(&quot;vertAlign&quot;)) {</span>
<span class="nc bnc" id="L5224" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5225">            propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5226">                OdfDocumentNamespace.STYLE.getUri(), &quot;text-position&quot;);</span>
          } else {
<span class="nc" id="L5228">            String alignment = (String) value;</span>
<span class="nc bnc" id="L5229" title="All 2 branches missed.">            if (alignment.equals(&quot;sub&quot;)) {</span>
<span class="nc" id="L5230">              propertiesElement.setStyleTextPositionAttribute(&quot;sub&quot;);</span>
<span class="nc bnc" id="L5231" title="All 2 branches missed.">            } else if (alignment.equals(&quot;super&quot;)) {</span>
<span class="nc" id="L5232">              propertiesElement.setStyleTextPositionAttribute(&quot;super&quot;);</span>
            } else { // baseline
<span class="nc" id="L5234">              propertiesElement.setStyleTextPositionAttribute(&quot;0% 100%&quot;);</span>
            }
<span class="nc" id="L5236">          }</span>
<span class="nc bnc" id="L5237" title="All 2 branches missed.">        } else if (key.equals(&quot;strike&quot;)) {</span>
<span class="nc bnc" id="L5238" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5239">            propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5240">                OdfDocumentNamespace.STYLE.getUri(), &quot;text-position&quot;);</span>
<span class="nc" id="L5241">            propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5242">                OdfDocumentNamespace.STYLE.getUri(), &quot;text-line-through-color&quot;);</span>
<span class="nc" id="L5243">            propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5244">                OdfDocumentNamespace.STYLE.getUri(), &quot;text-line-through-mode&quot;);</span>
<span class="nc" id="L5245">            propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5246">                OdfDocumentNamespace.STYLE.getUri(), &quot;text-line-through-style&quot;);</span>
<span class="nc" id="L5247">            propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5248">                OdfDocumentNamespace.STYLE.getUri(), &quot;text-line-through-text&quot;);</span>
<span class="nc" id="L5249">            propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5250">                OdfDocumentNamespace.STYLE.getUri(), &quot;text-line-through-text-style&quot;);</span>
<span class="nc" id="L5251">            propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5252">                OdfDocumentNamespace.STYLE.getUri(), &quot;text-line-through-type&quot;);</span>
<span class="nc" id="L5253">            propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5254">                OdfDocumentNamespace.STYLE.getUri(), &quot;text-line-through-width&quot;);</span>
          } else {
<span class="nc" id="L5256">            String strikeType = (String) value;</span>
<span class="nc bnc" id="L5257" title="All 2 branches missed.">            if (strikeType.equals(&quot;single&quot;)) {</span>
<span class="nc" id="L5258">              propertiesElement.setStyleTextLineThroughTypeAttribute(&quot;single&quot;);</span>
<span class="nc" id="L5259">              propertiesElement.setStyleTextLineThroughStyleAttribute(&quot;solid&quot;);</span>
<span class="nc" id="L5260">              propertiesElement.setStyleTextLineThroughModeAttribute(&quot;continuous&quot;);</span>
<span class="nc" id="L5261">              propertiesElement.setStyleTextUnderlineModeAttribute(&quot;continuous&quot;);</span>
<span class="nc" id="L5262">              propertiesElement.setStyleTextOverlineModeAttribute(&quot;continuous&quot;);</span>
<span class="nc bnc" id="L5263" title="All 2 branches missed.">            } else if (!strikeType.equals(&quot;none&quot;)) { // double</span>
<span class="nc" id="L5264">              propertiesElement.setStyleTextLineThroughTypeAttribute(&quot;double&quot;);</span>
<span class="nc" id="L5265">              propertiesElement.setStyleTextLineThroughStyleAttribute(&quot;solid&quot;);</span>
<span class="nc" id="L5266">              propertiesElement.setStyleTextLineThroughModeAttribute(&quot;continuous&quot;);</span>
<span class="nc" id="L5267">              propertiesElement.setStyleTextUnderlineModeAttribute(&quot;continuous&quot;);</span>
<span class="nc" id="L5268">              propertiesElement.setStyleTextOverlineModeAttribute(&quot;continuous&quot;);</span>
            }
<span class="nc" id="L5270">          }</span>
<span class="nc bnc" id="L5271" title="All 2 branches missed.">        } else if (key.equals(&quot;language&quot;)) {</span>
<span class="nc" id="L5272">          language = value;</span>
<span class="nc bnc" id="L5273" title="All 2 branches missed.">        } else if (key.equals(&quot;noProof&quot;)) {</span>
<span class="nc" id="L5274">          noProof = value;</span>
        } else /*
               The defined values for the fo:line-height attribute are:
               * a value of type nonNegativeLength
               * normal: disables the effects of style:line-height-at-least and style:line-spacing.
               * a value of type percent  */
        //				&lt;attribute name=&quot;fo:line-height&quot;&gt;
        //					&lt;choice&gt;
        //						&lt;value&gt;normal&lt;/value&gt;
        //						&lt;ref name=&quot;nonNegativeLength&quot;/&gt;
        //						&lt;ref name=&quot;percent&quot;/&gt;
        //					&lt;/choice&gt;
        //				&lt;/attribute&gt;
        // { type: 'percent', value: 100 }
<span class="nc bnc" id="L5288" title="All 2 branches missed.">        if (key.equals(&quot;letterSpacing&quot;)) {</span>
<span class="nc bnc" id="L5289" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5290">            propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;letter-spacing&quot;);</span>
          } else {
<span class="nc bnc" id="L5292" title="All 2 branches missed.">            if (value.equals(&quot;normal&quot;)) {</span>
<span class="nc" id="L5293">              propertiesElement.setFoLetterSpacingAttribute(&quot;normal&quot;);</span>
            } else {
<span class="nc" id="L5295">              propertiesElement.setFoLetterSpacingAttribute(</span>
<span class="nc" id="L5296">                  (getSafelyInteger(value)) / 100.0 + &quot;mm&quot;);</span>
            }
          }
<span class="nc bnc" id="L5299" title="All 2 branches missed.">        } else if (key.equals(&quot;url&quot;)) {</span>
<span class="nc bnc" id="L5300" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5301">            propertiesElement.removeAttributeNS(OdfDocumentNamespace.XLINK.getUri(), &quot;href&quot;);</span>
          } else {
<span class="nc" id="L5303">            propertiesElement.setAttributeNS(</span>
<span class="nc" id="L5304">                OdfDocumentNamespace.XLINK.getUri(), &quot;xlink:href&quot;, (String) value);</span>
          }
        }
<span class="nc" id="L5307">      }</span>
<span class="nc bnc" id="L5308" title="All 4 branches missed.">      if (noProof != null || language != null) {</span>
<span class="nc" id="L5309">        Object newLanguage = language;</span>
<span class="nc bnc" id="L5310" title="All 6 branches missed.">        if ((noProof instanceof Boolean &amp;&amp; ((Boolean) noProof).booleanValue())</span>
<span class="nc bnc" id="L5311" title="All 2 branches missed.">            || ((language instanceof String) &amp;&amp; ((String) language).equals(&quot;none&quot;))) {</span>
<span class="nc" id="L5312">          propertiesElement.setFoLanguageAttribute(&quot;zxx&quot;);</span>
<span class="nc" id="L5313">          propertiesElement.setStyleLanguageAsianAttribute(&quot;zxx&quot;);</span>
<span class="nc" id="L5314">          propertiesElement.setStyleCountryComplexAttribute(&quot;zxx&quot;);</span>
<span class="nc" id="L5315">          propertiesElement.setFoCountryAttribute(&quot;none&quot;);</span>
<span class="nc" id="L5316">          propertiesElement.setStyleCountryAsianAttribute(&quot;none&quot;);</span>
<span class="nc" id="L5317">          propertiesElement.setStyleCountryComplexAttribute(&quot;none&quot;);</span>
<span class="nc bnc" id="L5318" title="All 4 branches missed.">        } else if (newLanguage == null || newLanguage.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5319">          propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;country&quot;);</span>
<span class="nc" id="L5320">          propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;language&quot;);</span>
<span class="nc" id="L5321">          propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;country-asian&quot;);</span>
<span class="nc" id="L5322">          propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;language-asian&quot;);</span>
<span class="nc" id="L5323">          propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;country-complex&quot;);</span>
<span class="nc" id="L5324">          propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;language-complex&quot;);</span>
        } else {
<span class="nc" id="L5326">          String locale = (String) newLanguage;</span>
<span class="nc bnc" id="L5327" title="All 2 branches missed.">          if (!locale.isEmpty()) {</span>
<span class="nc" id="L5328">            int delimiterPos = locale.indexOf('-');</span>
<span class="nc bnc" id="L5329" title="All 2 branches missed.">            if (delimiterPos &gt; -1) {</span>
<span class="nc" id="L5330">              propertiesElement.setFoLanguageAttribute(locale.substring(0, delimiterPos));</span>
<span class="nc" id="L5331">              propertiesElement.setFoCountryAttribute(</span>
<span class="nc" id="L5332">                  locale.substring(delimiterPos + 1, locale.length()));</span>
            } else {
<span class="nc" id="L5334">              propertiesElement.setFoLanguageAttribute(locale);</span>
            }
          }
        }
      }
    }
<span class="nc" id="L5340">  }</span>

  //	DEFAULT FONTS ADDED TO APACHE OPEN OFFICE
  //		&lt;style:font-face style:name=&quot;Andale Mono&quot; svg:font-family=&quot;&amp;apos;Andale Mono&amp;apos;&quot;/&gt;
  //		&lt;style:font-face style:name=&quot;Mangal1&quot; svg:font-family=&quot;Mangal&quot;/&gt;
  //		&lt;style:font-face style:name=&quot;Palatino&quot; svg:font-family=&quot;Palatino&quot;
  // style:font-family-generic=&quot;roman&quot;/&gt;
  //		&lt;style:font-face style:name=&quot;Times&quot; svg:font-family=&quot;Times&quot;
  // style:font-family-generic=&quot;roman&quot;/&gt;
  //		&lt;style:font-face style:name=&quot;Helvetica&quot; svg:font-family=&quot;Helvetica&quot;
  // style:font-family-generic=&quot;swiss&quot;/&gt;
  //		&lt;style:font-face style:name=&quot;Consolas&quot; svg:font-family=&quot;Consolas&quot;
  // style:font-family-generic=&quot;modern&quot; style:font-pitch=&quot;fixed&quot;/&gt;
  //		&lt;style:font-face style:name=&quot;Courier&quot; svg:font-family=&quot;Courier&quot;
  // style:font-family-generic=&quot;modern&quot; style:font-pitch=&quot;fixed&quot;/&gt;
  //		&lt;style:font-face style:name=&quot;Courier New&quot; svg:font-family=&quot;&amp;apos;Courier New&amp;apos;&quot;
  // style:font-family-generic=&quot;modern&quot; style:font-pitch=&quot;fixed&quot;/&gt;
  //		&lt;style:font-face style:name=&quot;Book Antiqua&quot; svg:font-family=&quot;&amp;apos;Book Antiqua&amp;apos;&quot;
  // style:font-family-generic=&quot;roman&quot; style:font-pitch=&quot;variable&quot;/&gt;
  //		&lt;style:font-face style:name=&quot;Cambria&quot; svg:font-family=&quot;Cambria&quot;
  // style:font-family-generic=&quot;roman&quot; style:font-pitch=&quot;variable&quot;/&gt;
  //		&lt;style:font-face style:name=&quot;Georgia&quot; svg:font-family=&quot;Georgia&quot;
  // style:font-family-generic=&quot;roman&quot; style:font-pitch=&quot;variable&quot;/&gt;
  //		&lt;style:font-face style:name=&quot;Times New Roman&quot; svg:font-family=&quot;&amp;apos;Times New Roman&amp;apos;&quot;
  // style:font-family-generic=&quot;roman&quot; style:font-pitch=&quot;variable&quot;/&gt;
  //		&lt;style:font-face style:name=&quot;Arial&quot; svg:font-family=&quot;Arial&quot; style:font-family-generic=&quot;swiss&quot;
  // style:font-pitch=&quot;variable&quot;/&gt;
  //		&lt;style:font-face style:name=&quot;Calibri&quot; svg:font-family=&quot;Calibri&quot;
  // style:font-family-generic=&quot;swiss&quot; style:font-pitch=&quot;variable&quot;/&gt;
  //		&lt;style:font-face style:name=&quot;Impact&quot; svg:font-family=&quot;Impact&quot;
  // style:font-family-generic=&quot;swiss&quot; style:font-pitch=&quot;variable&quot;/&gt;
  //		&lt;style:font-face style:name=&quot;Tahoma&quot; svg:font-family=&quot;Tahoma&quot;
  // style:font-family-generic=&quot;swiss&quot; style:font-pitch=&quot;variable&quot;/&gt;
  //		&lt;style:font-face style:name=&quot;Verdana&quot; svg:font-family=&quot;Verdana&quot;
  // style:font-family-generic=&quot;swiss&quot; style:font-pitch=&quot;variable&quot;/&gt;
  //		&lt;style:font-face style:name=&quot;Mangal&quot; svg:font-family=&quot;Mangal&quot;
  // style:font-family-generic=&quot;system&quot; style:font-pitch=&quot;variable&quot;/&gt;
  //		&lt;style:font-face style:name=&quot;Microsoft YaHei&quot; svg:font-family=&quot;&amp;apos;Microsoft YaHei&amp;apos;&quot;
  // style:font-family-generic=&quot;system&quot; style:font-pitch=&quot;variable&quot;/&gt;
  //		&lt;style:font-face style:name=&quot;SimSun&quot; svg:font-family=&quot;SimSun&quot;
  // style:font-family-generic=&quot;system&quot; style:font-pitch=&quot;variable&quot;/&gt;
  // ADDED FROM MSO 15 export
  /*

  &lt;style:font-face style:name=&quot;Cambria&quot; svg:font-family=&quot;Cambria&quot; style:font-family-generic=&quot;roman&quot; style:font-pitch=&quot;variable&quot; svg:panose-1=&quot;2 4 5 3 5 4 6 3 2 4&quot;/&gt;
  &lt;style:font-face style:name=&quot;MS Mincho&quot; svg:font-family=&quot;MS Mincho&quot; style:font-family-generic=&quot;modern&quot; style:font-pitch=&quot;fixed&quot; svg:panose-1=&quot;2 2 6 9 4 2 5 8 3 4&quot;/&gt;
  &lt;style:font-face style:name=&quot;Times New Roman&quot; svg:font-family=&quot;Times New Roman&quot; style:font-family-generic=&quot;roman&quot; style:font-pitch=&quot;variable&quot; svg:panose-1=&quot;2 2 6 3 5 4 5 2 3 4&quot;/&gt;
  &lt;style:font-face style:name=&quot;Calibri&quot; svg:font-family=&quot;Calibri&quot; style:font-family-generic=&quot;swiss&quot; style:font-pitch=&quot;variable&quot; svg:panose-1=&quot;2 15 5 2 2 2 4 3 2 4&quot;/&gt;
  &lt;style:font-face style:name=&quot;MS Gothic&quot; svg:font-family=&quot;MS Gothic&quot; style:font-family-generic=&quot;modern&quot; style:font-pitch=&quot;fixed&quot; svg:panose-1=&quot;2 11 6 9 7 2 5 8 2 4&quot;/&gt;

  */
  private static void addFontToDocument(String fontName, OdfDocument doc) {
<span class="nc bnc" id="L5392" title="All 2 branches missed.">    if (doc != null) {</span>

<span class="nc" id="L5394">      Set fontNames = doc.getFontNames();</span>
<span class="nc bnc" id="L5395" title="All 4 branches missed.">      if (fontName != null &amp;&amp; !fontName.isEmpty()) {</span>
<span class="nc bnc" id="L5396" title="All 2 branches missed.">        if (!fontNames.contains(fontName)) {</span>
<span class="nc" id="L5397">          fontNames.add(fontName);</span>
<span class="nc bnc" id="L5398" title="All 2 branches missed.">          if (fontName.equals(&quot;Andale Mono&quot;)) {</span>
<span class="nc" id="L5399">            addFontData(doc, &quot;Andale Mono&quot;, null, &quot;Andale Mono&quot;, null, null, null);</span>
<span class="nc bnc" id="L5400" title="All 2 branches missed.">          } else if (fontName.equals(&quot;Arial&quot;)) {</span>
<span class="nc" id="L5401">            addFontData(doc, &quot;Arial&quot;, null, &quot;Arial&quot;, &quot;swiss&quot;, &quot;variable&quot;, null);</span>
<span class="nc bnc" id="L5402" title="All 2 branches missed.">          } else if (fontName.equals(&quot;Book Antiqua&quot;)) {</span>
<span class="nc" id="L5403">            addFontData(doc, &quot;Book Antiqua&quot;, null, &quot;Book Antiqua&quot;, &quot;roman&quot;, &quot;variable&quot;, null);</span>
<span class="nc bnc" id="L5404" title="All 2 branches missed.">          } else if (fontName.equals(&quot;Calibri&quot;)) {</span>
<span class="nc" id="L5405">            addFontData(</span>
                doc, &quot;Calibri&quot;, null, &quot;Calibri&quot;, &quot;swiss&quot;, &quot;variable&quot;, &quot;2 15 5 2 2 2 4 3 2 4&quot;);
<span class="nc bnc" id="L5407" title="All 2 branches missed.">          } else if (fontName.equals(&quot;Cambria&quot;)) {</span>
<span class="nc" id="L5408">            addFontData(</span>
                doc, &quot;Cambria&quot;, null, &quot;Cambria&quot;, &quot;roman&quot;, &quot;variable&quot;, &quot;2 4 5 3 5 4 6 3 2 4&quot;);
<span class="nc bnc" id="L5410" title="All 2 branches missed.">          } else if (fontName.equals(&quot;Consolas&quot;)) {</span>
<span class="nc" id="L5411">            addFontData(doc, &quot;Consolas&quot;, null, &quot;Consolas&quot;, &quot;modern&quot;, &quot;fixed&quot;, null);</span>
<span class="nc bnc" id="L5412" title="All 2 branches missed.">          } else if (fontName.equals(&quot;Courier New&quot;)) {</span>
<span class="nc" id="L5413">            addFontData(doc, &quot;Courier New&quot;, null, &quot;Courier New&quot;, &quot;modern&quot;, &quot;fixed&quot;, null);</span>
<span class="nc bnc" id="L5414" title="All 2 branches missed.">          } else if (fontName.equals(&quot;Courier&quot;)) {</span>
<span class="nc" id="L5415">            addFontData(doc, &quot;Courier&quot;, null, &quot;Courier&quot;, &quot;modern&quot;, &quot;fixed&quot;, null);</span>
<span class="nc bnc" id="L5416" title="All 2 branches missed.">          } else if (fontName.equals(&quot;Georgia&quot;)) {</span>
<span class="nc" id="L5417">            addFontData(doc, &quot;Georgia&quot;, null, &quot;Georgia&quot;, &quot;roman&quot;, &quot;variable&quot;, null);</span>
<span class="nc bnc" id="L5418" title="All 2 branches missed.">          } else if (fontName.equals(&quot;Helvetica&quot;)) {</span>
<span class="nc" id="L5419">            addFontData(doc, &quot;Helvetica&quot;, null, &quot;Helvetica&quot;, &quot;swiss&quot;, null, null);</span>
<span class="nc bnc" id="L5420" title="All 2 branches missed.">          } else if (fontName.equals(&quot;Impact&quot;)) {</span>
<span class="nc" id="L5421">            addFontData(doc, &quot;Impact&quot;, null, &quot;Impact&quot;, &quot;swiss&quot;, &quot;variable&quot;, null);</span>
<span class="nc bnc" id="L5422" title="All 2 branches missed.">          } else if (fontName.equals(&quot;Mangal&quot;)) {</span>
<span class="nc" id="L5423">            addFontData(doc, &quot;Mangal&quot;, null, &quot;Mangal&quot;, &quot;system&quot;, &quot;variable&quot;, null);</span>
<span class="nc bnc" id="L5424" title="All 2 branches missed.">          } else if (fontName.equals(&quot;Mangal1&quot;)) {</span>
<span class="nc" id="L5425">            addFontData(doc, &quot;Mangal1&quot;, null, &quot;Mangal&quot;, null, null, null);</span>
<span class="nc bnc" id="L5426" title="All 2 branches missed.">          } else if (fontName.equals(&quot;Microsoft YaHei&quot;)) {</span>
<span class="nc" id="L5427">            addFontData(</span>
                doc, &quot;Microsoft YaHei&quot;, null, &quot;Microsoft YaHei&quot;, &quot;system&quot;, &quot;variable&quot;, null);
<span class="nc bnc" id="L5429" title="All 2 branches missed.">          } else if (fontName.equals(&quot;MS Gothic&quot;)) {</span>
<span class="nc" id="L5430">            addFontData(</span>
                doc, &quot;MS Gothic&quot;, null, &quot;MS Gothic&quot;, &quot;modern&quot;, &quot;fixed&quot;, &quot;2 11 6 9 7 2 5 8 2 4&quot;);
<span class="nc bnc" id="L5432" title="All 2 branches missed.">          } else if (fontName.equals(&quot;MS Mincho&quot;)) {</span>
<span class="nc" id="L5433">            addFontData(</span>
                doc, &quot;MS Mincho&quot;, null, &quot;MS Mincho&quot;, &quot;modern&quot;, &quot;fixed&quot;, &quot;2 2 6 9 4 2 5 8 3 4&quot;);
<span class="nc bnc" id="L5435" title="All 2 branches missed.">          } else if (fontName.equals(&quot;Palatino&quot;)) {</span>
<span class="nc" id="L5436">            addFontData(doc, &quot;Palatino&quot;, null, &quot;Palatino&quot;, &quot;roman&quot;, null, null);</span>
<span class="nc bnc" id="L5437" title="All 2 branches missed.">          } else if (fontName.equals(&quot;SimSun&quot;)) {</span>
<span class="nc" id="L5438">            addFontData(doc, &quot;SimSun&quot;, null, &quot;SimSun&quot;, &quot;system&quot;, &quot;variable&quot;, null);</span>
<span class="nc bnc" id="L5439" title="All 2 branches missed.">          } else if (fontName.equals(&quot;Tahoma&quot;)) {</span>
<span class="nc" id="L5440">            addFontData(doc, &quot;Tahoma&quot;, null, &quot;Tahoma&quot;, &quot;swiss&quot;, &quot;variable&quot;, null);</span>
<span class="nc bnc" id="L5441" title="All 2 branches missed.">          } else if (fontName.equals(&quot;Times New Roman&quot;)) {</span>
<span class="nc" id="L5442">            addFontData(</span>
                doc,
                &quot;Times New Roman&quot;,
                null,
                &quot;Times New Roman&quot;,
                &quot;roman&quot;,
                &quot;variable&quot;,
                &quot;2 2 6 3 5 4 5 2 3 4&quot;);
<span class="nc bnc" id="L5450" title="All 2 branches missed.">          } else if (fontName.equals(&quot;Times&quot;)) {</span>
<span class="nc" id="L5451">            addFontData(doc, &quot;Times&quot;, null, &quot;Times&quot;, &quot;roman&quot;, null, null);</span>
<span class="nc bnc" id="L5452" title="All 2 branches missed.">          } else if (fontName.equals(&quot;Verdana&quot;)) {</span>
<span class="nc" id="L5453">            addFontData(doc, &quot;Verdana&quot;, null, &quot;Verdana&quot;, &quot;swiss&quot;, &quot;variable&quot;, null);</span>
          }
        }
      }
    }
<span class="nc" id="L5458">  }</span>

  public static void mapParagraphProperties(
      JSONObject attrs, StyleParagraphPropertiesElement propertiesElement) {

<span class="nc bnc" id="L5463" title="All 2 branches missed.">    if (attrs != null) {</span>
<span class="nc" id="L5464">      Set&lt;String&gt; propKeys = attrs.keySet();</span>
<span class="nc bnc" id="L5465" title="All 2 branches missed.">      for (String key : propKeys) {</span>
<span class="nc" id="L5466">        addBorderProperties(key, attrs, propertiesElement, null);</span>
<span class="nc" id="L5467">        addPaddingProperties(key, attrs, propertiesElement);</span>
<span class="nc" id="L5468">        addMarginProperties(key, attrs, propertiesElement);</span>
        // fo:background-color
        /*
        &lt;attribute name=&quot;fo:background-color&quot;&gt;
        &lt;choice&gt;
        &lt;value&gt;transparent&lt;/value&gt;
        &lt;ref name=&quot;color&quot;/&gt;
        &lt;/choice&gt;
        &lt;/attribute&gt;
        &lt;define name=&quot;color&quot;&gt;
        &lt;data type=&quot;string&quot;&gt;
        &lt;param name=&quot;pattern&quot;&gt;#[0-9a-fA-F]{6}&lt;/param&gt;
        &lt;/data&gt;
        &lt;/define&gt;
        */
<span class="nc bnc" id="L5483" title="All 2 branches missed.">        if (key.equals(&quot;fillColor&quot;)) {</span>
          try {
<span class="nc" id="L5485">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L5486" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5487">              propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5488">                  OdfDocumentNamespace.FO.getUri(), &quot;background-color&quot;);</span>
            } else {
<span class="nc" id="L5490">              JSONObject color = (JSONObject) value;</span>
<span class="nc" id="L5491">              propertiesElement.setFoBackgroundColorAttribute(</span>
<span class="nc" id="L5492">                  getColor(color, MapHelper.TRANSPARENT));</span>
            }
<span class="nc" id="L5494">          } catch (JSONException ex) {</span>
<span class="nc" id="L5495">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L5496">          }</span>
        } else /*
               The defined values for the fo:line-height attribute are:
               * a value of type nonNegativeLength
               * normal: disables the effects of style:line-height-at-least and style:line-spacing.
               * a value of type percent  */
        //				&lt;attribute name=&quot;fo:line-height&quot;&gt;
        //					&lt;choice&gt;
        //						&lt;value&gt;normal&lt;/value&gt;
        //						&lt;ref name=&quot;nonNegativeLength&quot;/&gt;
        //						&lt;ref name=&quot;percent&quot;/&gt;
        //					&lt;/choice&gt;
        //				&lt;/attribute&gt;
        // { type: 'percent', value: 100 }
<span class="nc bnc" id="L5510" title="All 2 branches missed.">        if (key.equals(&quot;lineHeight&quot;)) {</span>
          try {
<span class="nc" id="L5512">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L5513" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5514">              propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;line-height&quot;);</span>
<span class="nc" id="L5515">              propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5516">                  OdfDocumentNamespace.STYLE.getUri(), &quot;line-height-at-least&quot;);</span>
<span class="nc" id="L5517">              propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5518">                  OdfDocumentNamespace.STYLE.getUri(), &quot;line-spacing&quot;);</span>
            } else {
<span class="nc" id="L5520">              JSONObject lineHeight = (JSONObject) value;</span>
<span class="nc" id="L5521">              setLineHeight(lineHeight, propertiesElement);</span>
            }
<span class="nc" id="L5523">          } catch (JSONException ex) {</span>
<span class="nc" id="L5524">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L5525">          }</span>
        } // One of 'left', 'center', 'right', or 'justify'.
        // start, end, left, right, center or justify.
<span class="nc bnc" id="L5528" title="All 2 branches missed.">        else if (key.equals(&quot;alignment&quot;)) {</span>
          try {
<span class="nc" id="L5530">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L5531" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5532">              propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;text-align&quot;);</span>
            } else {
<span class="nc" id="L5534">              propertiesElement.setAttributeNS(</span>
<span class="nc" id="L5535">                  OdfDocumentNamespace.FO.getUri(), &quot;fo:text-align&quot;, (String) value);</span>
            }
<span class="nc" id="L5537">          } catch (JSONException ex) {</span>
<span class="nc" id="L5538">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L5539">          }</span>
        } // &lt;attribute name=&quot;fo:text-indent&quot;&gt;
        //	&lt;choice&gt;
        //		&lt;ref name=&quot;length&quot;/&gt;
        //		&lt;ref name=&quot;percent&quot;/&gt;
        //	&lt;/choice&gt;
        // &lt;/attribute&gt;
<span class="nc bnc" id="L5546" title="All 2 branches missed.">        else if (key.equals(&quot;indentFirstLine&quot;)) {</span>
          try {
<span class="nc" id="L5548">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L5549" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5550">              propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;text-indent&quot;);</span>
            } else {
<span class="nc" id="L5552">              Integer indent = getSafelyInteger(value);</span>
<span class="nc" id="L5553">              propertiesElement.setAttributeNS(</span>
<span class="nc" id="L5554">                  OdfDocumentNamespace.FO.getUri(), &quot;fo:text-indent&quot;, ((indent / 100.0) + &quot;mm&quot;));</span>
            }
<span class="nc" id="L5556">          } catch (JSONException ex) {</span>
<span class="nc" id="L5557">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L5558">          }</span>
        } // &lt;attribute name=&quot;fo:break-before&quot;&gt;
        //	&lt;choice&gt;
        //		&lt;value&gt;auto&lt;/value&gt;
        //		&lt;value&gt;column&lt;/value&gt;
        //		&lt;value&gt;page&lt;/value&gt;
        //	&lt;/choice&gt;
        // &lt;/attribute&gt;
<span class="nc bnc" id="L5566" title="All 2 branches missed.">        else if (key.equals(&quot;pageBreakBefore&quot;)) {</span>
          try {
<span class="nc" id="L5568">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L5569" title="All 4 branches missed.">            if (value != JSONObject.NULL &amp;&amp; value.equals(Boolean.TRUE)) {</span>
<span class="nc" id="L5570">              propertiesElement.setAttributeNS(</span>
<span class="nc" id="L5571">                  OdfDocumentNamespace.FO.getUri(), &quot;fo:break-before&quot;, &quot;page&quot;);</span>
            } else {
<span class="nc" id="L5573">              propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;break-before&quot;);</span>
            }
            // there can not be before and after break at the same paragraph
<span class="nc" id="L5576">            propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;break-after&quot;);</span>
<span class="nc" id="L5577">          } catch (JSONException ex) {</span>
<span class="nc" id="L5578">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L5579">          }</span>
        } // &lt;attribute name=&quot;fo:break-after&quot;&gt;
        //	&lt;choice&gt;
        //		&lt;value&gt;auto&lt;/value&gt;
        //		&lt;value&gt;column&lt;/value&gt;
        //		&lt;value&gt;page&lt;/value&gt;
        //	&lt;/choice&gt;
        // &lt;/attribute&gt;
<span class="nc bnc" id="L5587" title="All 2 branches missed.">        else if (key.equals(&quot;pageBreakAfter&quot;)) {</span>
          try {
<span class="nc" id="L5589">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L5590" title="All 4 branches missed.">            if (value != JSONObject.NULL &amp;&amp; value.equals(Boolean.TRUE)) {</span>
<span class="nc" id="L5591">              propertiesElement.setAttributeNS(</span>
<span class="nc" id="L5592">                  OdfDocumentNamespace.FO.getUri(), &quot;fo:break-after&quot;, &quot;page&quot;);</span>
            } else {
<span class="nc" id="L5594">              propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;break-after&quot;);</span>
            }
            // there can not be before and after break at the same paragraph
<span class="nc" id="L5597">            propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;break-before&quot;);</span>
<span class="nc" id="L5598">          } catch (JSONException ex) {</span>
<span class="nc" id="L5599">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L5600">          }</span>
<span class="nc bnc" id="L5601" title="All 2 branches missed.">        } else if (key.equals(&quot;tabStops&quot;)) {</span>
          try {
<span class="nc" id="L5603">            Object value = attrs.get(key);</span>
<span class="nc" id="L5604">            StyleTabStopsElement tabsElement =</span>
<span class="nc" id="L5605">                OdfElement.findFirstChildNode(StyleTabStopsElement.class, propertiesElement);</span>
<span class="nc bnc" id="L5606" title="All 2 branches missed.">            if (tabsElement != null) {</span>
<span class="nc" id="L5607">              propertiesElement.removeChild(tabsElement);</span>
            }
<span class="nc bnc" id="L5609" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
              // node already removed
            } else {
<span class="nc" id="L5612">              JSONArray tabsValue = (JSONArray) value;</span>

<span class="nc" id="L5614">              OdfFileDom fileDom = (OdfFileDom) propertiesElement.getOwnerDocument();</span>
<span class="nc" id="L5615">              tabsElement = new StyleTabStopsElement(fileDom);</span>
<span class="nc bnc" id="L5616" title="All 2 branches missed.">              for (int idx = 0; idx &lt; tabsValue.length(); ++idx) {</span>
<span class="nc" id="L5617">                JSONObject tab = tabsValue.getJSONObject(idx);</span>
<span class="nc" id="L5618">                StyleTabStopElement tabElement = new StyleTabStopElement(fileDom);</span>
<span class="nc bnc" id="L5619" title="All 2 branches missed.">                if (tab.has(&quot;pos&quot;)) {</span>
<span class="nc" id="L5620">                  int tabPos = tab.getInt(&quot;pos&quot;);</span>
<span class="nc" id="L5621">                  tabElement.setStylePositionAttribute((tabPos / 1000F) + &quot;cm&quot;);</span>
                }
<span class="nc bnc" id="L5623" title="All 2 branches missed.">                if (tab.has(&quot;value&quot;)) {</span>
<span class="nc" id="L5624">                  String tabValue = tab.getString(&quot;value&quot;);</span>
<span class="nc bnc" id="L5625" title="All 2 branches missed.">                  if (tabValue.equals(&quot;decimal&quot;)) {</span>
<span class="nc" id="L5626">                    tabValue = &quot;char&quot;;</span>
<span class="nc bnc" id="L5627" title="All 2 branches missed.">                  } else if (tabValue.equals(&quot;bar&quot;)) {</span>
<span class="nc" id="L5628">                    tabValue = &quot;left&quot;;</span>
<span class="nc bnc" id="L5629" title="All 2 branches missed.">                  } else if (tabValue.equals(&quot;clear&quot;)) {</span>
<span class="nc" id="L5630">                    continue; // clear unsupported</span>
                  }
<span class="nc" id="L5632">                  tabElement.setStyleTypeAttribute(tabValue); // center, char, left, right</span>
                }
<span class="nc" id="L5634">                tabsElement.insertBefore(tabElement, null);</span>
              }

<span class="nc" id="L5637">              propertiesElement.insertBefore(tabsElement, null);</span>
            }
<span class="nc" id="L5639">          } catch (JSONException ex) {</span>
<span class="nc" id="L5640">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L5641">          }</span>
        }
<span class="nc" id="L5643">      }</span>
    }
<span class="nc" id="L5645">  }</span>

  public static void mapTableProperties(
      JSONObject attrs, StyleTablePropertiesElement propertiesElement) {
<span class="nc bnc" id="L5649" title="All 2 branches missed.">    if (attrs != null) {</span>
<span class="nc" id="L5650">      Set&lt;String&gt; propKeys = attrs.keySet();</span>
<span class="nc" id="L5651">      boolean isTableWidthGiven = false;</span>
<span class="nc bnc" id="L5652" title="All 2 branches missed.">      for (String key : propKeys) {</span>
        // no padding, no border
<span class="nc" id="L5654">        addMarginProperties(key, attrs, propertiesElement);</span>
<span class="nc bnc" id="L5655" title="All 2 branches missed.">        if (key.equals(&quot;width&quot;)) {</span>
<span class="nc" id="L5656">          Object value = null;</span>
          try {
<span class="nc" id="L5658">            value = attrs.get(key);</span>
<span class="nc" id="L5659">          } catch (JSONException ex) {</span>
<span class="nc" id="L5660">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L5661">          }</span>

<span class="nc bnc" id="L5663" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5664">            propertiesElement.removeAttributeNS(OdfDocumentNamespace.STYLE.getUri(), &quot;width&quot;);</span>
          } else {
<span class="nc" id="L5666">            Object width = value;</span>
<span class="nc bnc" id="L5667" title="All 4 branches missed.">            if (width != null &amp;&amp; !width.equals(MapHelper.AUTO)) {</span>
              // MSO 15 WORKAROUND..
<span class="nc" id="L5669">              isTableWidthGiven = true;</span>
<span class="nc bnc" id="L5670" title="All 2 branches missed.">              if (width instanceof Integer) {</span>
<span class="nc" id="L5671">                propertiesElement.setStyleWidthAttribute(((Integer) width) / 1000.0 + &quot;cm&quot;);</span>
<span class="nc bnc" id="L5672" title="All 2 branches missed.">              } else if (width instanceof String) {</span>
<span class="nc" id="L5673">                propertiesElement.setStyleWidthAttribute(</span>
<span class="nc" id="L5674">                    Integer.parseInt((String) width) / 1000.0 + &quot;cm&quot;);</span>
              }
              // LO/AO0 WORKSROUND: if there is a rel width with 100% and an absolute style the
              // rel-width wins :(
              // WIDTH COMES - REL-WIDTH GOES...
<span class="nc" id="L5679">              propertiesElement.removeAttributeNS(OdfDocumentNamespace.STYLE.getUri(), &quot;rel-width&quot;);</span>
              // LO/AOO WORKAROUND: width is only recognized by LO/AO, when an alignment is
              // provided. If none now left (or margin equal alignment is set to left!
<span class="nc bnc" id="L5682" title="All 2 branches missed.">              if (!propertiesElement.hasAttributeNS(OdfDocumentNamespace.TABLE.getUri(), &quot;align&quot;)</span>
                  || propertiesElement
<span class="nc" id="L5684">                      .getAttributeNS(OdfDocumentNamespace.TABLE.getUri(), &quot;align&quot;)</span>
<span class="nc bnc" id="L5685" title="All 2 branches missed.">                      .equalsIgnoreCase(&quot;margins&quot;)) {</span>
<span class="nc" id="L5686">                propertiesElement.setTableAlignAttribute(&quot;left&quot;);</span>
              }
            }
          }
<span class="nc bnc" id="L5690" title="All 2 branches missed.">        } else if (key.equals(&quot;fillColor&quot;)) {</span>
          try {
<span class="nc" id="L5692">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L5693" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5694">              propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5695">                  OdfDocumentNamespace.FO.getUri(), &quot;background-color&quot;);</span>
            } else {
<span class="nc" id="L5697">              JSONObject color = (JSONObject) value;</span>
<span class="nc" id="L5698">              propertiesElement.setFoBackgroundColorAttribute(</span>
<span class="nc" id="L5699">                  getColor(color, MapHelper.TRANSPARENT));</span>
            }
<span class="nc" id="L5701">          } catch (JSONException ex) {</span>
<span class="nc" id="L5702">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L5703">          }</span>
<span class="nc bnc" id="L5704" title="All 2 branches missed.">        } else if (key.equals(&quot;visible&quot;)) {</span>
          try {
<span class="nc" id="L5706">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L5707" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5708">              propertiesElement.removeAttributeNS(OdfDocumentNamespace.TABLE.getUri(), &quot;display&quot;);</span>
            } else {
<span class="nc" id="L5710">              propertiesElement.setTableDisplayAttribute((Boolean) value);</span>
            }
<span class="nc" id="L5712">          } catch (JSONException ex) {</span>
<span class="nc" id="L5713">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L5714">          }</span>
          // &lt;attribute name=&quot;fo:break-before&quot;&gt;
          //	&lt;choice&gt;
          //		&lt;value&gt;auto&lt;/value&gt;
          //		&lt;value&gt;column&lt;/value&gt;
          //		&lt;value&gt;page&lt;/value&gt;
          //	&lt;/choice&gt;
          // &lt;/attribute&gt;
        }
<span class="nc" id="L5723">      }</span>
      // MSO 15 WORKAROUND:
<span class="nc bnc" id="L5725" title="All 2 branches missed.">      if (!isTableWidthGiven) {</span>
        // by default at least a 100 percent relative width for the table have to be given for MSO15
<span class="nc" id="L5727">        propertiesElement.setStyleRelWidthAttribute(HUNDRED_PERCENT);</span>
      }
<span class="nc" id="L5729">    } else {</span>
<span class="nc bnc" id="L5730" title="All 2 branches missed.">      if (propertiesElement != null) {</span>
        // by default at least a 100 percent relative width for the table have to be given for MSO15
<span class="nc" id="L5732">        propertiesElement.setStyleRelWidthAttribute(HUNDRED_PERCENT);</span>
      }
    }
<span class="nc" id="L5735">  }</span>

  public static void mapPageProperties(
      JSONObject attrs, StylePageLayoutPropertiesElement propertiesElement) {
<span class="nc bnc" id="L5739" title="All 2 branches missed.">    if (attrs != null) {</span>
<span class="nc" id="L5740">      Set&lt;String&gt; propKeys = attrs.keySet();</span>
<span class="nc bnc" id="L5741" title="All 2 branches missed.">      for (String key : propKeys) {</span>
<span class="nc" id="L5742">        addBorderProperties(key, attrs, propertiesElement, null);</span>
<span class="nc" id="L5743">        addPaddingProperties(key, attrs, propertiesElement);</span>
<span class="nc" id="L5744">        addMarginProperties(key, attrs, propertiesElement);</span>
<span class="nc bnc" id="L5745" title="All 2 branches missed.">        if (key.equals(&quot;fillColor&quot;)) {</span>
          try {
<span class="nc" id="L5747">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L5748" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5749">              propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5750">                  OdfDocumentNamespace.FO.getUri(), &quot;background-color&quot;);</span>
            } else {
<span class="nc" id="L5752">              JSONObject color = (JSONObject) value;</span>
<span class="nc" id="L5753">              propertiesElement.setFoBackgroundColorAttribute(</span>
<span class="nc" id="L5754">                  getColor(color, MapHelper.TRANSPARENT));</span>
            }
<span class="nc" id="L5756">          } catch (JSONException ex) {</span>
<span class="nc" id="L5757">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L5758">          }</span>
        }
<span class="nc" id="L5760">      }</span>
    }
<span class="nc" id="L5762">  }</span>

  public static void mapRowProperties(
      JSONObject attrs, StyleTableRowPropertiesElement propertiesElement) {
<span class="nc bnc" id="L5766" title="All 2 branches missed.">    if (attrs != null) {</span>
<span class="nc" id="L5767">      Set&lt;String&gt; propKeys = attrs.keySet();</span>
<span class="nc bnc" id="L5768" title="All 2 branches missed.">      for (String key : propKeys) {</span>
<span class="nc bnc" id="L5769" title="All 2 branches missed.">        if (key.equals(&quot;fillColor&quot;)) {</span>
          try {
<span class="nc" id="L5771">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L5772" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5773">              propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5774">                  OdfDocumentNamespace.FO.getUri(), &quot;background-color&quot;);</span>
            } else {
<span class="nc" id="L5776">              JSONObject color = (JSONObject) value;</span>
<span class="nc" id="L5777">              propertiesElement.setFoBackgroundColorAttribute(</span>
<span class="nc" id="L5778">                  getColor(color, MapHelper.TRANSPARENT));</span>
            }
<span class="nc" id="L5780">          } catch (JSONException ex) {</span>
<span class="nc" id="L5781">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L5782">          }</span>
<span class="nc bnc" id="L5783" title="All 2 branches missed.">        } else if (key.equals(&quot;height&quot;)) {</span>
          try {
<span class="nc" id="L5785">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L5786" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5787">              propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5788">                  OdfDocumentNamespace.STYLE.getUri(), &quot;row-height&quot;);</span>
              // currently we are not differentiating between height and minimum height
<span class="nc" id="L5790">              propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5791">                  OdfDocumentNamespace.STYLE.getUri(), &quot;min-row-height&quot;);</span>
            } else {
<span class="nc" id="L5793">              Integer rowHeight = getSafelyInteger(value);</span>
<span class="nc" id="L5794">              propertiesElement.setStyleRowHeightAttribute(((rowHeight / 100.0) + &quot;mm&quot;));</span>
            }
<span class="nc" id="L5796">          } catch (JSONException ex) {</span>
<span class="nc" id="L5797">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L5798">          }</span>
<span class="nc bnc" id="L5799" title="All 2 branches missed.">        } else if (key.equals(&quot;customHeight&quot;)) {</span>
          try {
<span class="nc" id="L5801">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L5802" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5803">              propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5804">                  OdfDocumentNamespace.STYLE.getUri(), &quot;use-optimal-row-height&quot;);</span>
            } else {
<span class="nc bnc" id="L5806" title="All 2 branches missed.">              propertiesElement.setStyleUseOptimalRowHeightAttribute(!((Boolean) value));</span>
            }
<span class="nc" id="L5808">          } catch (JSONException ex) {</span>
<span class="nc" id="L5809">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L5810">          }</span>
        }
<span class="nc" id="L5812">      }</span>
    }
<span class="nc" id="L5814">  }</span>

  public static void mapCellProperties(
      JSONObject attrs, StyleTableCellPropertiesElement propertiesElement) {
<span class="nc bnc" id="L5818" title="All 2 branches missed.">    if (attrs != null) {</span>
<span class="nc" id="L5819">      Set&lt;String&gt; propKeys = attrs.keySet();</span>
<span class="nc bnc" id="L5820" title="All 2 branches missed.">      for (String key : propKeys) {</span>
        // No margin in ODF
<span class="nc" id="L5822">        addBorderProperties(key, attrs, propertiesElement, null);</span>
<span class="nc" id="L5823">        addPaddingProperties(key, attrs, propertiesElement);</span>
<span class="nc bnc" id="L5824" title="All 2 branches missed.">        if (key.equals(&quot;fillColor&quot;)) {</span>
          try {
<span class="nc" id="L5826">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L5827" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5828">              propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5829">                  OdfDocumentNamespace.FO.getUri(), &quot;background-color&quot;);</span>
            } else {
<span class="nc" id="L5831">              JSONObject color = (JSONObject) value;</span>
<span class="nc" id="L5832">              propertiesElement.setFoBackgroundColorAttribute(</span>
<span class="nc" id="L5833">                  getColor(color, MapHelper.TRANSPARENT));</span>
            }
<span class="nc" id="L5835">          } catch (JSONException ex) {</span>
<span class="nc" id="L5836">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L5837">          }</span>
<span class="nc bnc" id="L5838" title="All 2 branches missed.">        } else if (key.equals(&quot;alignVert&quot;)) {</span>
          try {
<span class="nc" id="L5840">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L5841" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5842">              propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5843">                  OdfDocumentNamespace.STYLE.getUri(), &quot;vertical-align&quot;);</span>
            } else {
<span class="nc" id="L5845">              String align = (String) value;</span>
<span class="nc" id="L5846">              propertiesElement.setStyleVerticalAlignAttribute(align);</span>
            }
<span class="nc" id="L5848">          } catch (JSONException ex) {</span>
<span class="nc" id="L5849">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L5850">          }</span>
        }
<span class="nc" id="L5852">      }</span>
    }
<span class="nc" id="L5854">  }</span>

  public static void mapColumnProperties(
      JSONObject attrs, StyleTableColumnPropertiesElement propertiesElement) {
<span class="nc bnc" id="L5858" title="All 2 branches missed.">    if (attrs != null) {</span>
<span class="nc" id="L5859">      Set&lt;String&gt; propKeys = attrs.keySet();</span>
<span class="nc bnc" id="L5860" title="All 2 branches missed.">      for (String key : propKeys) {</span>
<span class="nc bnc" id="L5861" title="All 2 branches missed.">        if (key.equals(&quot;width&quot;)) {</span>
          try {
<span class="nc" id="L5863">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L5864" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5865">              propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5866">                  OdfDocumentNamespace.STYLE.getUri(), &quot;column-width&quot;);</span>
            } else {
<span class="nc" id="L5868">              propertiesElement.setAttributeNS(</span>
<span class="nc" id="L5869">                  OdfDocumentNamespace.STYLE.getUri(),</span>
                  &quot;style:column-width&quot;,
<span class="nc" id="L5871">                  (getSafelyInteger(value) / 100.0) + &quot;mm&quot;);</span>
            }
<span class="nc" id="L5873">          } catch (JSONException ex) {</span>
<span class="nc" id="L5874">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L5875">          }</span>
<span class="nc bnc" id="L5876" title="All 2 branches missed.">        } else if (key.equals(&quot;customWidth&quot;)) {</span>
          try {
<span class="nc" id="L5878">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L5879" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5880">              propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5881">                  OdfDocumentNamespace.STYLE.getUri(), &quot;use-optimal-column-width&quot;);</span>
            } else {
<span class="nc" id="L5883">              propertiesElement.setAttributeNS(</span>
<span class="nc" id="L5884">                  OdfDocumentNamespace.STYLE.getUri(),</span>
                  &quot;style:use-optimal-column-width&quot;,
<span class="nc" id="L5886">                  value.toString());</span>
            }
<span class="nc" id="L5888">          } catch (JSONException ex) {</span>
<span class="nc" id="L5889">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L5890">          }</span>
        }
<span class="nc" id="L5892">      }</span>
    }
<span class="nc" id="L5894">  }</span>

  public static void mapListProperties(
      JSONObject attrs, StyleListLevelPropertiesElement propertiesElement) {
<span class="nc bnc" id="L5898" title="All 2 branches missed.">    if (attrs != null) {</span>
<span class="nc" id="L5899">      Set&lt;String&gt; propKeys = attrs.keySet();</span>
<span class="nc bnc" id="L5900" title="All 2 branches missed.">      for (String key : propKeys) {</span>
<span class="nc bnc" id="L5901" title="All 2 branches missed.">        if (key.equals(&quot;fontName&quot;)) {</span>
          try {
<span class="nc" id="L5903">            Object value = attrs.get(key);</span>
            // == null does not work here..
<span class="nc bnc" id="L5905" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5906">              propertiesElement.removeAttributeNS(OdfDocumentNamespace.STYLE.getUri(), &quot;font-name&quot;);</span>
            } else {
<span class="nc" id="L5908">              String fontName = (String) value;</span>
<span class="nc" id="L5909">              propertiesElement.setStyleFontNameAttribute(fontName);</span>
            }
<span class="nc" id="L5911">          } catch (JSONException ex) {</span>
<span class="nc" id="L5912">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L5913">          }</span>
<span class="nc bnc" id="L5914" title="All 2 branches missed.">        } else if (key.equals(&quot;fontNameAsian&quot;)) {</span>
          try {
<span class="nc" id="L5916">            Object value = attrs.get(key);</span>
            // == null does not work here..
<span class="nc bnc" id="L5918" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5919">              propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5920">                  OdfDocumentNamespace.STYLE.getUri(), &quot;font-name-asian&quot;);</span>
            } else {
<span class="nc" id="L5922">              String fontName = (String) value;</span>
<span class="nc" id="L5923">              propertiesElement.setAttributeNS(</span>
<span class="nc" id="L5924">                  OdfDocumentNamespace.STYLE.getUri(), &quot;style:font-name-asian&quot;, fontName);</span>
            }
<span class="nc" id="L5926">          } catch (JSONException ex) {</span>
<span class="nc" id="L5927">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L5928">          }</span>
<span class="nc bnc" id="L5929" title="All 2 branches missed.">        } else if (key.equals(&quot;fontNameComplex&quot;)) {</span>
          try {
<span class="nc" id="L5931">            Object value = attrs.get(key);</span>
            // == null does not work here..
<span class="nc bnc" id="L5933" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5934">              propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5935">                  OdfDocumentNamespace.STYLE.getUri(), &quot;font-name-complex&quot;);</span>
            } else {
<span class="nc" id="L5937">              String fontName = (String) value;</span>
<span class="nc" id="L5938">              propertiesElement.setAttributeNS(</span>
<span class="nc" id="L5939">                  OdfDocumentNamespace.STYLE.getUri(), &quot;style:font-name-complex&quot;, fontName);</span>
            }
<span class="nc" id="L5941">          } catch (JSONException ex) {</span>
<span class="nc" id="L5942">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L5943">          }</span>
        }
<span class="nc" id="L5945">      }</span>
    }
<span class="nc" id="L5947">  }</span>

  public static void mapSectionProperties(
      JSONObject attrs, StyleSectionPropertiesElement propertiesElement) {
<span class="nc bnc" id="L5951" title="All 2 branches missed.">    if (attrs != null) {</span>
<span class="nc" id="L5952">      Set&lt;String&gt; propKeys = attrs.keySet();</span>
<span class="nc bnc" id="L5953" title="All 2 branches missed.">      for (String key : propKeys) {</span>
        // No margin in ODF
<span class="nc" id="L5955">        addBorderProperties(key, attrs, propertiesElement, null);</span>
<span class="nc" id="L5956">        addPaddingProperties(key, attrs, propertiesElement);</span>
<span class="nc bnc" id="L5957" title="All 2 branches missed.">        if (key.equals(&quot;fillColor&quot;)) {</span>
          try {
<span class="nc" id="L5959">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L5960" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L5961">              propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L5962">                  OdfDocumentNamespace.FO.getUri(), &quot;background-color&quot;);</span>
            } else {
<span class="nc" id="L5964">              JSONObject color = (JSONObject) value;</span>
<span class="nc" id="L5965">              propertiesElement.setFoBackgroundColorAttribute(</span>
<span class="nc" id="L5966">                  getColor(color, MapHelper.TRANSPARENT));</span>
            }
<span class="nc" id="L5968">          } catch (JSONException ex) {</span>
<span class="nc" id="L5969">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L5970">          }</span>
        }
<span class="nc" id="L5972">      }</span>
    }
<span class="nc" id="L5974">  }</span>

  public static void mapGraphicProperties(
      JSONObject attrs,
      StyleGraphicPropertiesElement propertiesElement,
      OdfStyleBase frameParentStyle) {
<span class="nc bnc" id="L5980" title="All 2 branches missed.">    if (attrs != null) {</span>
<span class="nc" id="L5981">      boolean isMirroredHorizontalRemoved = false;</span>
<span class="nc" id="L5982">      boolean isMirroredHorizontal = false;</span>
<span class="nc" id="L5983">      boolean isMirroredVerticalRemoved = false;</span>
<span class="nc" id="L5984">      boolean isMirroredVertical = false;</span>
<span class="nc" id="L5985">      Set&lt;String&gt; propKeys = attrs.keySet();</span>
<span class="nc bnc" id="L5986" title="All 2 branches missed.">      for (String key : propKeys) {</span>
<span class="nc" id="L5987">        addBorderProperties(key, attrs, propertiesElement, frameParentStyle);</span>
<span class="nc" id="L5988">        addPaddingProperties(key, attrs, propertiesElement);</span>
<span class="nc" id="L5989">        addMarginProperties(key, attrs, propertiesElement);</span>
<span class="nc bnc" id="L5990" title="All 2 branches missed.">        if (key.equals(&quot;fill&quot;)) {</span>
          try {
<span class="nc" id="L5992">            JSONObject value = (JSONObject) attrs.get(key);</span>
<span class="nc bnc" id="L5993" title="All 4 branches missed.">            boolean flyFrame =</span>
                frameParentStyle != null &amp;&amp; !(frameParentStyle instanceof OdfDefaultStyle);
<span class="nc bnc" id="L5995" title="All 2 branches missed.">            if (value == null</span>
<span class="nc bnc" id="L5996" title="All 2 branches missed.">                || value.equals(JSONObject.NULL)</span>
<span class="nc bnc" id="L5997" title="All 2 branches missed.">                || (value.has(OPK_TYPE)</span>
<span class="nc bnc" id="L5998" title="All 4 branches missed.">                    &amp;&amp; (value.isNull(OPK_TYPE) || value.getString(OPK_TYPE).equals(&quot;none&quot;)))) {</span>
<span class="nc bnc" id="L5999" title="All 2 branches missed.">              if (flyFrame) {</span>
<span class="nc" id="L6000">                propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L6001">                    OdfDocumentNamespace.FO.getUri(), &quot;background-color&quot;);</span>
              } else {
<span class="nc" id="L6003">                propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;fill-color&quot;);</span>
<span class="nc" id="L6004">                propertiesElement.setAttributeNS(</span>
<span class="nc" id="L6005">                    OdfDocumentNamespace.DRAW.getUri(), &quot;draw:fill&quot;, &quot;none&quot;);</span>
              }
            } else {
<span class="nc" id="L6008">              String colorAttr = null;</span>
              // sometimes a JSONObject, e.g. color&quot;:{OPK_TYPE:&quot;rgb&quot;,&quot;value&quot;:&quot;ff00ff&quot;} within
              //    attrs&quot;:{&quot;character&quot;:{&quot;color&quot;:{OPK_TYPE:&quot;rgb&quot;,&quot;value&quot;:&quot;0000ff&quot;}
              // sometimes a String &quot;fill&quot;:{&quot;color&quot;:&quot;ffffff&quot;}
<span class="nc" id="L6012">              Object color = value.get(&quot;color&quot;);</span>
<span class="nc bnc" id="L6013" title="All 2 branches missed.">              if (color instanceof JSONObject) {</span>
<span class="nc" id="L6014">                colorAttr = getColor((JSONObject) color, MapHelper.TRANSPARENT);</span>
              } else {
<span class="nc" id="L6016">                colorAttr = (String) color;</span>
              }
<span class="nc bnc" id="L6018" title="All 2 branches missed.">              if (flyFrame) {</span>
<span class="nc" id="L6019">                propertiesElement.setFoBackgroundColorAttribute(colorAttr);</span>
              } else {
<span class="nc" id="L6021">                propertiesElement.setAttributeNS(</span>
<span class="nc" id="L6022">                    OdfDocumentNamespace.DRAW.getUri(), &quot;draw:fill-color&quot;, colorAttr);</span>
<span class="nc" id="L6023">                propertiesElement.setAttributeNS(</span>
<span class="nc" id="L6024">                    OdfDocumentNamespace.DRAW.getUri(), &quot;draw:fill&quot;, &quot;solid&quot;);</span>
              }
            }
<span class="nc" id="L6027">          } catch (JSONException ex) {</span>
<span class="nc" id="L6028">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6029">          }</span>

<span class="nc bnc" id="L6031" title="All 2 branches missed.">        } else if (key.equals(&quot;flipH&quot;)) {</span>
          try {
<span class="nc" id="L6033">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L6034" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6035">              isMirroredHorizontalRemoved = true;</span>
<span class="nc bnc" id="L6036" title="All 2 branches missed.">            } else if ((Boolean) value) {</span>
<span class="nc" id="L6037">              isMirroredHorizontal = true;</span>
            }
<span class="nc" id="L6039">          } catch (JSONException ex) {</span>
<span class="nc" id="L6040">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6041">          }</span>
<span class="nc bnc" id="L6042" title="All 2 branches missed.">        } else if (key.equals(&quot;flipV&quot;)) {</span>
          try {
<span class="nc" id="L6044">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L6045" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6046">              isMirroredVerticalRemoved = true;</span>
<span class="nc bnc" id="L6047" title="All 2 branches missed.">            } else if ((Boolean) value) {</span>
<span class="nc" id="L6048">              isMirroredVertical = true;</span>
            }
<span class="nc" id="L6050">          } catch (JSONException ex) {</span>
<span class="nc" id="L6051">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6052">          }</span>
<span class="nc bnc" id="L6053" title="All 2 branches missed.">        } else if (key.equals(&quot;anchorHorBase&quot;)) {</span>
          try {
<span class="nc" id="L6055">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L6056" title="All 4 branches missed.">            if (value != null &amp;&amp; !value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6057">              String horBase = (String) value;</span>
<span class="nc" id="L6058">              Map&lt;String, String&gt; relMap = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L6059">              relMap.put(&quot;margin&quot;, &quot;page-start-margin&quot;);</span>
<span class="nc" id="L6060">              relMap.put(&quot;page&quot;, &quot;page&quot;);</span>
<span class="nc" id="L6061">              relMap.put(&quot;column&quot;, &quot;paragraph&quot;);</span>
<span class="nc" id="L6062">              relMap.put(&quot;character&quot;, &quot;char&quot;);</span>
<span class="nc" id="L6063">              relMap.put(&quot;leftMargin&quot;, &quot;page-start-margin&quot;);</span>
<span class="nc" id="L6064">              relMap.put(&quot;rightMargin&quot;, &quot;page-end-margin&quot;);</span>
<span class="nc" id="L6065">              relMap.put(</span>
                  &quot;insideMargin&quot;, &quot;page-start-margin&quot;); // TODO: set horizontal-postion:from-inside
<span class="nc" id="L6067">              relMap.put(</span>
                  &quot;outsideMargin&quot;, &quot;page-start-margin&quot;); // TODO: set horizontal-postion:outside
<span class="nc" id="L6069">              String odfValue = relMap.get(horBase);</span>
<span class="nc bnc" id="L6070" title="All 2 branches missed.">              if (odfValue != null) {</span>
<span class="nc" id="L6071">                propertiesElement.setStyleHorizontalRelAttribute(odfValue);</span>
              }
            }
<span class="nc" id="L6074">          } catch (JSONException ex) {</span>
<span class="nc" id="L6075">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6076">          }</span>
<span class="nc bnc" id="L6077" title="All 2 branches missed.">        } else if (key.equals(&quot;anchorVertBase&quot;)) {</span>
          try {
<span class="nc" id="L6079">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L6080" title="All 4 branches missed.">            if (value != null &amp;&amp; !value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6081">              String horBase = (String) value;</span>
<span class="nc" id="L6082">              Map&lt;String, String&gt; relMap = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L6083">              relMap.put(&quot;margin&quot;, &quot;page-content&quot;);</span>
<span class="nc" id="L6084">              relMap.put(&quot;page&quot;, &quot;page&quot;);</span>
<span class="nc" id="L6085">              relMap.put(&quot;paragraph&quot;, &quot;paragraph&quot;);</span>
<span class="nc" id="L6086">              relMap.put(&quot;line&quot;, &quot;line&quot;);</span>
<span class="nc" id="L6087">              relMap.put(&quot;topMargin&quot;, &quot;page-content&quot;);</span>
<span class="nc" id="L6088">              relMap.put(&quot;bottomMargin&quot;, &quot;page-content&quot;);</span>
<span class="nc" id="L6089">              String odfValue = relMap.get(horBase);</span>
<span class="nc bnc" id="L6090" title="All 2 branches missed.">              if (odfValue != null) {</span>
<span class="nc" id="L6091">                propertiesElement.setStyleVerticalRelAttribute(odfValue);</span>
              }
            }
<span class="nc" id="L6094">          } catch (JSONException ex) {</span>
<span class="nc" id="L6095">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6096">          }</span>
        } else /* http://docs.oasis-open.org/office/v1.2/os/OpenDocument-v1.2-os-part1.html#property-style_wrap
               The style:wrap attribute specifies how text is displayed around a frame or graphic object.
               The defined values for the style:wrap attribute are:
               * biggest: text may wrap around the shape where the difference to the left or right page or column border is largest.
               * Mode=square Side=largest
               * dynamic: text may wrap around both sides of the shape. The space for wrapping is set by the style:wrap-dynamic-threshold attribute. 20.393
               * UNSUPPORTED
               * left: text wraps around the left side of the shape.
               * Mode=square	Side=left
               * none: text does not wrap around the shape.
               * Mode=topAndBottom
               * parallel: text wraps around both sides of the shape.
               * Mode=square	Side=both
               * right: text wraps around the right side of the shape.
               * Mode=square	Side=right
               * run-through: text runs through the shape.
               * Mode=through	Side=both   */
        /*
        OX API: textWrapMode	One of 'none', 'square', 'tight', 'through', or 'topAndBottom'. (IMHO 'none' == 'topAndBottom', but the latter is implemented)
<span class="nc" id="L6116">        OX API: textWrapSide	Sides where text wraps around the image (only used if textWrapMode is set to 'square', 'tight', or 'through') (1). One of ['both', 'left', 'right', 'largest'	*/ if (key</span>
<span class="nc bnc" id="L6117" title="All 2 branches missed.">            .equals(&quot;textWrapMode&quot;)) {</span>
          try {
<span class="nc" id="L6119">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L6120" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6121">              propertiesElement.removeAttributeNS(OdfDocumentNamespace.STYLE.getUri(), &quot;wrap&quot;);</span>
<span class="nc" id="L6122">              propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L6123">                  OdfDocumentNamespace.STYLE.getUri(), &quot;wrap-contour&quot;);</span>
            } else {
<span class="nc" id="L6125">              String textWrapMode = (String) value;</span>
<span class="nc bnc" id="L6126" title="All 2 branches missed.">              if (textWrapMode.equals(&quot;topAndBottom&quot;)) {</span>
<span class="nc" id="L6127">                propertiesElement.setStyleWrapAttribute(&quot;none&quot;);</span>
<span class="nc" id="L6128">                propertiesElement.setStyleWrapContourAttribute(Boolean.FALSE);</span>
              } else {
<span class="nc" id="L6130">                String textWrapSide = attrs.optString(&quot;textWrapSide&quot;);</span>
<span class="nc bnc" id="L6131" title="All 2 branches missed.">                if (textWrapSide != null) {</span>
<span class="nc bnc" id="L6132" title="All 2 branches missed.">                  if (textWrapMode.equals(&quot;square&quot;)) {</span>
<span class="nc bnc" id="L6133" title="All 2 branches missed.">                    if (textWrapSide.equals(&quot;largest&quot;)) {</span>
<span class="nc" id="L6134">                      propertiesElement.setStyleWrapAttribute(&quot;biggest&quot;);</span>
<span class="nc bnc" id="L6135" title="All 2 branches missed.">                    } else if (textWrapSide.equals(&quot;left&quot;)) {</span>
<span class="nc" id="L6136">                      propertiesElement.setStyleWrapAttribute(&quot;left&quot;);</span>
<span class="nc bnc" id="L6137" title="All 2 branches missed.">                    } else if (textWrapSide.equals(&quot;both&quot;)) {</span>
<span class="nc" id="L6138">                      propertiesElement.setStyleWrapAttribute(&quot;parallel&quot;);</span>
<span class="nc bnc" id="L6139" title="All 2 branches missed.">                    } else if (textWrapSide.equals(&quot;right&quot;)) {</span>
<span class="nc" id="L6140">                      propertiesElement.setStyleWrapAttribute(&quot;right&quot;);</span>
                    }
<span class="nc" id="L6142">                    propertiesElement.setStyleWrapContourAttribute(Boolean.FALSE);</span>
<span class="nc bnc" id="L6143" title="All 2 branches missed.">                  } else if (textWrapMode.equals(&quot;through&quot;)) {</span>
<span class="nc" id="L6144">                    propertiesElement.setStyleWrapAttribute(&quot;run-through&quot;);</span>
<span class="nc" id="L6145">                    propertiesElement.setStyleWrapContourAttribute(Boolean.FALSE);</span>
                  }
                }
              }
            }
<span class="nc" id="L6150">          } catch (JSONException ex) {</span>
<span class="nc" id="L6151">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6152">          }</span>
        } else /* @style:horizontal-pos:
               The defined values for the style:horizontal-pos attribute are:
               * center: horizontal alignment of a frame should be centered relative to the specified area.
               * anchorHorAlign=center
               * from-inside: on pages with an odd page number the left edge of the specific area is taken as the horizontal alignment of a frame. On pages with an even page number the right edge of the specified area is taken. Attribute svg:x associated with the frame element specifies the horizontal position of the frame from the edge which is taken.
               * UNSUPPORTED
               * from-left: the svg:x attribute associated with the frame element specifies the horizontal position of the frame from the left edge of the specified area.
               * anchorHorAlign=offset
               * inside: on pages with an odd page number the horizontal alignment of a frame is the same as for the attribute value left. On pages with an even page number the horizontal alignment of a frame is the same as for the attribute value right.
               * anchorHorAlign=inside
               * left: horizontal alignment of a frame should be left aligned relative to the specified area.
               * anchorHorAlign=left
               * outside: on pages with an odd page number the horizontal alignment of a frame is the same as for the attribute value right. On pages with an even page number the horizontal alignment of a frame is the same as for the attribute value left.
               * anchorHorAlign=outside
               * right: horizontal alignment of a frame should be right aligned relative to the specified area.
               * anchorHorAlign=right
               If the attribute value is not from-left and not from-inside, the svg:x attribute associated with the frame element is ignored for text documents.						 */
        // OX API:
        // anchorHorAlign: Horizontal anchor position:	One of 'left', 'right', 'center', 'inside',
        // 'outside', or 'offset'.
        // anchorHorOffset: Horizontal position offset (only used if anchorHorAlign is set to
        // 'offset')
<span class="nc bnc" id="L6175" title="All 2 branches missed.">        if (key.equals(&quot;anchorHorAlign&quot;)) {</span>
          try {
<span class="nc" id="L6177">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L6178" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6179">              propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L6180">                  OdfDocumentNamespace.STYLE.getUri(), &quot;horizontal-pos&quot;);</span>
<span class="nc" id="L6181">              propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L6182">                  OdfDocumentNamespace.STYLE.getUri(), &quot;horizontal-rel&quot;);</span>
            } else {
<span class="nc" id="L6184">              String anchorHorAlign = (String) value;</span>
<span class="nc bnc" id="L6185" title="All 2 branches missed.">              if (anchorHorAlign.equals(&quot;center&quot;)) {</span>
<span class="nc" id="L6186">                propertiesElement.setStyleHorizontalPosAttribute(&quot;center&quot;);</span>
<span class="nc bnc" id="L6187" title="All 2 branches missed.">              } else if (anchorHorAlign.equals(&quot;offset&quot;)) {</span>
<span class="nc" id="L6188">                propertiesElement.setStyleHorizontalPosAttribute(&quot;from-left&quot;);</span>
<span class="nc bnc" id="L6189" title="All 2 branches missed.">              } else if (anchorHorAlign.equals(&quot;left&quot;)) {</span>
<span class="nc" id="L6190">                propertiesElement.setStyleHorizontalPosAttribute(&quot;left&quot;);</span>
<span class="nc bnc" id="L6191" title="All 2 branches missed.">              } else if (anchorHorAlign.equals(&quot;right&quot;)) {</span>
<span class="nc" id="L6192">                propertiesElement.setStyleHorizontalPosAttribute(&quot;right&quot;);</span>
<span class="nc bnc" id="L6193" title="All 2 branches missed.">              } else if (anchorHorAlign.equals(&quot;inside&quot;)) {</span>
<span class="nc" id="L6194">                propertiesElement.setStyleHorizontalPosAttribute(&quot;inside&quot;);</span>
<span class="nc bnc" id="L6195" title="All 2 branches missed.">              } else if (anchorHorAlign.equals(&quot;outside&quot;)) {</span>
<span class="nc" id="L6196">                propertiesElement.setStyleHorizontalPosAttribute(&quot;outside&quot;);</span>
              }
            }
<span class="nc" id="L6199">          } catch (JSONException ex) {</span>
<span class="nc" id="L6200">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6201">          }</span>
<span class="nc bnc" id="L6202" title="All 2 branches missed.">        } else if (key.equals(&quot;anchorHorOffset&quot;)) {</span>
          try {
<span class="nc" id="L6204">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L6205" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6206">              propertiesElement.removeAttributeNS(OdfDocumentNamespace.SVG.getUri(), &quot;x&quot;);</span>
            } else {
<span class="nc" id="L6208">              Integer x = getSafelyInteger(value);</span>

              // This is the default in our constellation
<span class="nc" id="L6211">              propertiesElement.setSvgXAttribute(x / 100.0 + &quot;mm&quot;);</span>
            }
<span class="nc" id="L6213">          } catch (JSONException ex) {</span>
<span class="nc" id="L6214">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6215">          }</span>
<span class="nc bnc" id="L6216" title="All 2 branches missed.">        } else if (key.equals(&quot;anchorVertAlign&quot;)) {</span>
          try {
<span class="nc" id="L6218">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L6219" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6220">              propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L6221">                  OdfDocumentNamespace.STYLE.getUri(), &quot;vertical-pos&quot;);</span>
<span class="nc" id="L6222">              propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L6223">                  OdfDocumentNamespace.STYLE.getUri(), &quot;vertical-rel&quot;);</span>
            } else {
<span class="nc" id="L6225">              String anchorVertAlign = (String) value;</span>
<span class="nc bnc" id="L6226" title="All 2 branches missed.">              if (anchorVertAlign.equals(&quot;center&quot;)) {</span>
<span class="nc" id="L6227">                propertiesElement.setStyleVerticalPosAttribute(&quot;center&quot;);</span>
<span class="nc bnc" id="L6228" title="All 2 branches missed.">              } else if (anchorVertAlign.equals(&quot;offset&quot;)) {</span>
<span class="nc" id="L6229">                propertiesElement.setStyleVerticalPosAttribute(&quot;from-top&quot;);</span>
<span class="nc bnc" id="L6230" title="All 2 branches missed.">              } else if (anchorVertAlign.equals(&quot;bottom&quot;)) {</span>
<span class="nc" id="L6231">                propertiesElement.setStyleVerticalPosAttribute(&quot;bottom&quot;);</span>
<span class="nc bnc" id="L6232" title="All 2 branches missed.">              } else if (anchorVertAlign.equals(&quot;top&quot;)) {</span>
<span class="nc" id="L6233">                propertiesElement.setStyleVerticalPosAttribute(&quot;top&quot;);</span>
<span class="nc bnc" id="L6234" title="All 2 branches missed.">              } else if (anchorVertAlign.equals(&quot;inside&quot;)) {</span>
<span class="nc" id="L6235">                propertiesElement.setStyleVerticalPosAttribute(&quot;inside&quot;);</span>
<span class="nc bnc" id="L6236" title="All 2 branches missed.">              } else if (anchorVertAlign.equals(&quot;outside&quot;)) {</span>
<span class="nc" id="L6237">                propertiesElement.setStyleVerticalPosAttribute(&quot;outside&quot;);</span>
              }
            }
<span class="nc" id="L6240">          } catch (JSONException ex) {</span>
<span class="nc" id="L6241">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6242">          }</span>
<span class="nc bnc" id="L6243" title="All 2 branches missed.">        } else if (key.equals(&quot;anchorVertOffset&quot;)) {</span>
          try {
<span class="nc" id="L6245">            Object value = attrs.get(key);</span>
<span class="nc bnc" id="L6246" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6247">              propertiesElement.removeAttributeNS(OdfDocumentNamespace.SVG.getUri(), &quot;y&quot;);</span>
            } else {
<span class="nc" id="L6249">              Integer y = getSafelyInteger(value);</span>
              // This is the default in our constellation
<span class="nc" id="L6251">              propertiesElement.setSvgYAttribute(y / 100.0 + &quot;mm&quot;);</span>
            }
<span class="nc" id="L6253">          } catch (JSONException ex) {</span>
<span class="nc" id="L6254">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6255">          }</span>
<span class="nc bnc" id="L6256" title="All 2 branches missed.">        } else if (key.equals(&quot;anchorBehindDoc&quot;)) {</span>
<span class="nc" id="L6257">          boolean anchorBehindDoc = attrs.optBoolean(key, false);</span>
<span class="nc" id="L6258">          StyleRunThroughAttribute.Value attr = null;</span>
<span class="nc bnc" id="L6259" title="All 2 branches missed.">          if (anchorBehindDoc) {</span>
<span class="nc" id="L6260">            attr = StyleRunThroughAttribute.Value.BACKGROUND;</span>
          } else {
<span class="nc" id="L6262">            attr = StyleRunThroughAttribute.Value.FOREGROUND;</span>
          }
<span class="nc" id="L6264">          propertiesElement.setStyleRunThroughAttribute(attr.toString());</span>
        }
<span class="nc" id="L6266">      }</span>

      //					} else if (propName.contains(&quot;svg:x&quot;)) {
      //						int x = normalizeLength(odfProps.get(&quot;svg:x&quot;));
      //						if(x != 0){
      //							newProps.put(&quot;anchorHorOffset&quot;, x);
      //						}
      // Two attributes are evaluated via boolean flags:
<span class="nc bnc" id="L6274" title="All 4 branches missed.">      if (isMirroredHorizontalRemoved &amp;&amp; isMirroredVerticalRemoved) {</span>
<span class="nc" id="L6275">        propertiesElement.removeAttributeNS(OdfDocumentNamespace.STYLE.getUri(), &quot;mirror&quot;);</span>
<span class="nc bnc" id="L6276" title="All 4 branches missed.">      } else if (isMirroredHorizontal &amp;&amp; isMirroredVertical) {</span>
<span class="nc" id="L6277">        propertiesElement.setStyleMirrorAttribute(&quot;horizontal vertical&quot;);</span>
<span class="nc bnc" id="L6278" title="All 2 branches missed.">      } else if (isMirroredVertical) {</span>
<span class="nc" id="L6279">        propertiesElement.setStyleMirrorAttribute(&quot;vertical&quot;);</span>
<span class="nc bnc" id="L6280" title="All 2 branches missed.">      } else if (isMirroredHorizontal) {</span>
<span class="nc" id="L6281">        propertiesElement.setStyleMirrorAttribute(&quot;horizontal&quot;);</span>
      }
    }
<span class="nc" id="L6284">  }</span>

  public static void mapChartProperties(
<span class="nc" id="L6287">      JSONObject attrs, StyleChartPropertiesElement propertiesElement) {}</span>

  public static void mapDrawingProperties(
<span class="nc" id="L6290">      JSONObject attrs, StyleDrawingPagePropertiesElement propertiesElement) {}</span>

  public static void mapRubyProperties(
<span class="nc" id="L6293">      JSONObject attrs, StyleRubyPropertiesElement propertiesElement) {}</span>

  public static void mapHeaderFooterProperties(
      JSONObject attrs, StyleHeaderFooterPropertiesElement propertiesElement) {
<span class="nc bnc" id="L6297" title="All 2 branches missed.">    if (attrs != null) {</span>
<span class="nc" id="L6298">      Set&lt;String&gt; propKeys = attrs.keySet();</span>
<span class="nc bnc" id="L6299" title="All 2 branches missed.">      for (String key : propKeys) {</span>
        // No border, padding in ODF
<span class="nc" id="L6301">        addMarginProperties(key, attrs, propertiesElement);</span>
<span class="nc bnc" id="L6302" title="All 2 branches missed.">        if (key.equals(&quot;fillColor&quot;)) {</span>
          try {
<span class="nc" id="L6304">            Object value = attrs.get(key);</span>
            // ToDo: Test with latest JSON Library and adapt accordingly for all occurences
<span class="nc bnc" id="L6306" title="All 4 branches missed.">            if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6307">              propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L6308">                  OdfDocumentNamespace.FO.getUri(), &quot;background-color&quot;);</span>
            } else {
<span class="nc" id="L6310">              JSONObject color = (JSONObject) value;</span>
<span class="nc" id="L6311">              propertiesElement.setFoBackgroundColorAttribute(</span>
<span class="nc" id="L6312">                  getColor(color, MapHelper.TRANSPARENT));</span>
            }
<span class="nc" id="L6314">          } catch (JSONException ex) {</span>
<span class="nc" id="L6315">            Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6316">          }</span>
        }
<span class="nc" id="L6318">      }</span>
    }
<span class="nc" id="L6320">  }</span>

  //	fo:border=&quot;0.5pt solid #000000&quot;
  // {\&quot;width\&quot;:2,
  //  \&quot;style\&quot;:\&quot;solid\&quot;
  //  \&quot;color\&quot;:{\&quot;value\&quot;:\&quot;000000\&quot;,\&quot;type\&quot;:\&quot;rgb\&quot;}}
  private static String getBorder(JSONObject border) {
<span class="nc" id="L6327">    String style = null;</span>
<span class="nc" id="L6328">    String borderValue = &quot;&quot;;</span>
<span class="nc bnc" id="L6329" title="All 4 branches missed.">    if (border.has(&quot;style&quot;) &amp;&amp; !border.get(&quot;style&quot;).equals(JSONObject.NULL)) {</span>
      //  'none', 'single', 'double', 'dotted', 'dashed', 'outset', or 'inset'
<span class="nc" id="L6331">      style = border.optString(&quot;style&quot;);</span>
<span class="nc bnc" id="L6332" title="All 2 branches missed.">      if (style.equals(&quot;none&quot;)) {</span>
<span class="nc" id="L6333">        borderValue = &quot;none&quot;;</span>
      } else {
<span class="nc bnc" id="L6335" title="All 4 branches missed.">        if (border.has(&quot;width&quot;) &amp;&amp; !border.get(&quot;width&quot;).equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6336">          double width = border.optInt(&quot;width&quot;) / 100.0;</span>
<span class="nc" id="L6337">          borderValue = width + &quot;mm &quot;;</span>
<span class="nc" id="L6338">        } else {</span>
          // DEFAULT BORDER: 0.002cm solid #000000&quot;
<span class="nc" id="L6340">          borderValue = &quot;0.02mm &quot;;</span>
        }
<span class="nc bnc" id="L6342" title="All 4 branches missed.">        if (border.has(&quot;style&quot;) &amp;&amp; !border.get(&quot;style&quot;).equals(JSONObject.NULL)) {</span>
          //  'none', 'single', 'double', 'dotted', 'dashed', 'outset', or 'inset'
<span class="nc" id="L6344">          style = border.optString(&quot;style&quot;);</span>
<span class="nc bnc" id="L6345" title="All 2 branches missed.">          if (style.equals(&quot;single&quot;)) {</span>
<span class="nc" id="L6346">            borderValue = borderValue.concat(&quot;solid &quot;);</span>
          } else {
<span class="nc" id="L6348">            borderValue = borderValue.concat(style + &quot; &quot;);</span>
          }
        } else {
          // DEFAULT BORDER: 0.002cm solid #000000&quot;
<span class="nc" id="L6352">          borderValue = borderValue.concat(&quot;solid &quot;);</span>
        }
<span class="nc bnc" id="L6354" title="All 4 branches missed.">        if (border.has(&quot;color&quot;) &amp;&amp; !border.get(&quot;color&quot;).equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6355">          JSONObject color = border.optJSONObject(&quot;color&quot;);</span>
<span class="nc" id="L6356">          borderValue = borderValue.concat(getColor(color, BLACK));</span>
<span class="nc" id="L6357">        } else {</span>
          // DEFAULT BORDER: 0.002cm solid #000000&quot;
<span class="nc" id="L6359">          borderValue = borderValue.concat(&quot;#000000&quot;);</span>
        }
      }
    }
<span class="nc" id="L6363">    return borderValue;</span>
  }

  /** Supporting &quot;normal&quot;, &quot;percentage&quot; and a none-negative number */
  private static void setLineHeight(
      JSONObject lineHeight, StyleParagraphPropertiesElement propertiesElement) {
<span class="nc" id="L6369">    String lineHeightValue = null;</span>
    try {
<span class="nc" id="L6371">      String type = lineHeight.getString(OPK_TYPE);</span>
<span class="nc bnc" id="L6372" title="All 2 branches missed.">      if (type.equals(&quot;percent&quot;)) {</span>
<span class="nc" id="L6373">        String value = lineHeight.optString(&quot;value&quot;);</span>
<span class="nc bnc" id="L6374" title="All 4 branches missed.">        if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="nc" id="L6375">          lineHeightValue = value.concat(&quot;%&quot;);</span>
<span class="nc" id="L6376">          propertiesElement.setFoLineHeightAttribute(lineHeightValue);</span>
<span class="nc" id="L6377">          propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L6378">              OdfDocumentNamespace.STYLE.getUri(), &quot;line-height-at-least&quot;);</span>
<span class="nc" id="L6379">          propertiesElement.removeAttributeNS(OdfDocumentNamespace.STYLE.getUri(), &quot;line-spacing&quot;);</span>
        }
<span class="nc bnc" id="L6381" title="All 2 branches missed.">      } else if (type.equals(&quot;fixed&quot;)) {</span>
<span class="nc" id="L6382">        double value = lineHeight.optInt(&quot;value&quot;) / 100.0;</span>
<span class="nc" id="L6383">        lineHeightValue = value + &quot;mm&quot;;</span>
<span class="nc" id="L6384">        propertiesElement.setFoLineHeightAttribute(lineHeightValue);</span>
<span class="nc" id="L6385">        propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L6386">            OdfDocumentNamespace.STYLE.getUri(), &quot;line-height-at-least&quot;);</span>
<span class="nc" id="L6387">        propertiesElement.removeAttributeNS(OdfDocumentNamespace.STYLE.getUri(), &quot;line-spacing&quot;);</span>
<span class="nc bnc" id="L6388" title="All 2 branches missed.">      } else if (type.equals(&quot;atLeast&quot;)) {</span>
<span class="nc" id="L6389">        double value = lineHeight.optInt(&quot;value&quot;) / 100.0;</span>
<span class="nc" id="L6390">        lineHeightValue = value + &quot;mm&quot;;</span>
<span class="nc" id="L6391">        propertiesElement.setStyleLineHeightAtLeastAttribute(lineHeightValue);</span>
<span class="nc" id="L6392">        propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;line-height&quot;);</span>
<span class="nc" id="L6393">        propertiesElement.removeAttributeNS(OdfDocumentNamespace.STYLE.getUri(), &quot;line-spacing&quot;);</span>

<span class="nc bnc" id="L6395" title="All 2 branches missed.">      } else if (type.equals(&quot;leading&quot;)) {</span>
<span class="nc" id="L6396">        double value = lineHeight.optInt(&quot;value&quot;) / 100.0;</span>
<span class="nc" id="L6397">        lineHeightValue = value + &quot;mm&quot;;</span>
<span class="nc" id="L6398">        propertiesElement.setStyleLineSpacingAttribute(lineHeightValue);</span>
<span class="nc" id="L6399">        propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;line-height&quot;);</span>
<span class="nc" id="L6400">        propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L6401">            OdfDocumentNamespace.STYLE.getUri(), &quot;line-height-at-least&quot;);</span>
<span class="nc bnc" id="L6402" title="All 2 branches missed.">      } else if (type.equals(&quot;normal&quot;)) {</span>
<span class="nc" id="L6403">        lineHeightValue = &quot;normal&quot;;</span>
<span class="nc" id="L6404">        propertiesElement.removeAttributeNS(</span>
<span class="nc" id="L6405">            OdfDocumentNamespace.STYLE.getUri(), &quot;line-height-at-least&quot;);</span>
<span class="nc" id="L6406">        propertiesElement.removeAttributeNS(OdfDocumentNamespace.STYLE.getUri(), &quot;line-spacing&quot;);</span>
      }
<span class="nc" id="L6408">    } catch (JSONException ex) {</span>
<span class="nc" id="L6409">      Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6410">    }</span>
<span class="nc" id="L6411">  }</span>

  public static String getColor(JSONObject color, String autoColor) {
<span class="nc" id="L6414">    String colorValue = &quot;&quot;;</span>
    try {
<span class="nc bnc" id="L6416" title="All 2 branches missed.">      if (color != null) {</span>
<span class="nc" id="L6417">        String type = color.getString(OPK_TYPE);</span>
<span class="nc bnc" id="L6418" title="All 2 branches missed.">        if (type.equals(MapHelper.AUTO)) {</span>
<span class="nc" id="L6419">          colorValue = autoColor;</span>
<span class="nc bnc" id="L6420" title="All 2 branches missed.">        } else if (type.equals(&quot;rgb&quot;)) {</span>
<span class="nc" id="L6421">          colorValue = '#' + color.getString(&quot;value&quot;);</span>
<span class="nc bnc" id="L6422" title="All 2 branches missed.">        } else if (color.has(&quot;fallbackValue&quot;)) {</span>
          // {&quot;color&quot;:{OPK_TYPE:&quot;scheme&quot;,&quot;value&quot;:&quot;accent1&quot;,&quot;transformations&quot;:[{OPK_TYPE:&quot;shade&quot;,&quot;value&quot;:74902}],&quot;fallbackValue&quot;:&quot;376092&quot;}
<span class="nc" id="L6424">          colorValue = '#' + color.getString(&quot;fallbackValue&quot;);</span>
        } else {
<span class="nc" id="L6426">          LOG.warning(&quot;Unmappable color: &quot; + color);</span>
        }
      }
<span class="nc" id="L6429">    } catch (JSONException ex) {</span>
      // {&quot;value&quot;:&quot;text2&quot;,OPK_TYPE:&quot;scheme&quot;,&quot;transformations&quot;:[{&quot;value&quot;:60000,OPK_TYPE:&quot;tint&quot;}]}
<span class="nc" id="L6431">      Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6432">    }</span>
<span class="nc" id="L6433">    return colorValue;</span>
  }

  public static void addBorderProperties(
      String key,
      JSONObject attrs,
      OdfStylePropertiesBase propertiesElement,
      OdfStyleBase frameParentStyle) {
<span class="nc" id="L6441">    boolean putBorders = false;</span>
<span class="nc bnc" id="L6442" title="All 2 branches missed.">    if (frameParentStyle != null</span>
<span class="nc bnc" id="L6443" title="All 2 branches missed.">        &amp;&amp; attrs.has(&quot;line&quot;)</span>
<span class="nc bnc" id="L6444" title="All 2 branches missed.">        &amp;&amp; !attrs.get(&quot;line&quot;).equals(JSONObject.NULL)) {</span>
      try {
<span class="nc" id="L6446">        boolean isEmptyBorder = true;</span>
<span class="nc" id="L6447">        String allBorderString = propertiesElement.getAttribute(&quot;fo:border&quot;);</span>
<span class="nc" id="L6448">        String leftBorderString = propertiesElement.getAttribute(&quot;fo:border-left&quot;);</span>
<span class="nc" id="L6449">        String rightBorderString = propertiesElement.getAttribute(&quot;fo:border-right&quot;);</span>
<span class="nc" id="L6450">        String topBorderString = propertiesElement.getAttribute(&quot;fo:border-top&quot;);</span>
<span class="nc" id="L6451">        String bottomBorderString = propertiesElement.getAttribute(&quot;fo:border-bottom&quot;);</span>
<span class="nc bnc" id="L6452" title="All 2 branches missed.">        boolean useOneBorder = allBorderString.length() &gt; 0;</span>
<span class="nc bnc" id="L6453" title="All 2 branches missed.">        if (!useOneBorder) {</span>
<span class="nc" id="L6454">          OdfStylePropertiesBase propsElement =</span>
<span class="nc" id="L6455">              frameParentStyle.getOrCreatePropertiesElement(</span>
                  OdfStylePropertiesSet.GraphicProperties);
<span class="nc" id="L6457">          String styleAllBorderString = propsElement.getAttribute(&quot;fo:border&quot;);</span>
<span class="nc bnc" id="L6458" title="All 2 branches missed.">          if (leftBorderString.length() == 0) {</span>
<span class="nc" id="L6459">            leftBorderString = propsElement.getAttribute(&quot;fo:border-left&quot;);</span>
          }
<span class="nc bnc" id="L6461" title="All 2 branches missed.">          if (rightBorderString.length() == 0) {</span>
<span class="nc" id="L6462">            rightBorderString = propsElement.getAttribute(&quot;fo:border-right&quot;);</span>
          }
<span class="nc bnc" id="L6464" title="All 2 branches missed.">          if (topBorderString.length() == 0) {</span>
<span class="nc" id="L6465">            topBorderString = propsElement.getAttribute(&quot;fo:border-top&quot;);</span>
          }
<span class="nc bnc" id="L6467" title="All 2 branches missed.">          if (bottomBorderString.length() == 0) {</span>
<span class="nc" id="L6468">            bottomBorderString = propsElement.getAttribute(&quot;fo:border-bottom&quot;);</span>
          }
<span class="nc bnc" id="L6470" title="All 2 branches missed.">          if (styleAllBorderString.length() &gt; 0</span>
<span class="nc bnc" id="L6471" title="All 2 branches missed.">              &amp;&amp; leftBorderString.length() == 0</span>
<span class="nc bnc" id="L6472" title="All 2 branches missed.">              &amp;&amp; rightBorderString.length() == 0</span>
<span class="nc bnc" id="L6473" title="All 2 branches missed.">              &amp;&amp; topBorderString.length() == 0</span>
<span class="nc bnc" id="L6474" title="All 2 branches missed.">              &amp;&amp; bottomBorderString.length() == 0) {</span>
<span class="nc" id="L6475">            allBorderString = styleAllBorderString;</span>
<span class="nc" id="L6476">            useOneBorder = true;</span>
          } else {
<span class="nc" id="L6478">            useOneBorder = false;</span>
          }
        }

<span class="nc" id="L6482">        JSONObject allBorder = MapHelper.createBorderMap(allBorderString);</span>
<span class="nc" id="L6483">        JSONObject oldLeftBorder = MapHelper.createBorderMap(leftBorderString);</span>
<span class="nc" id="L6484">        JSONObject oldRightBorder = MapHelper.createBorderMap(rightBorderString);</span>
<span class="nc" id="L6485">        JSONObject oldTopBorder = MapHelper.createBorderMap(topBorderString);</span>
<span class="nc" id="L6486">        JSONObject oldBottomBorder = MapHelper.createBorderMap(bottomBorderString);</span>
        isEmptyBorder =
<span class="nc bnc" id="L6488" title="All 2 branches missed.">            useOneBorder</span>
<span class="nc bnc" id="L6489" title="All 4 branches missed.">                ? (!allBorder.has(&quot;width&quot;) || !allBorder.has(&quot;style&quot;))</span>
<span class="nc bnc" id="L6490" title="All 4 branches missed.">                : (!oldTopBorder.has(&quot;width&quot;) || !oldTopBorder.has(&quot;style&quot;));</span>

<span class="nc" id="L6492">        JSONObject line = attrs.getJSONObject(&quot;line&quot;);</span>
<span class="nc" id="L6493">        JSONObject lineColor = line.optJSONObject(&quot;color&quot;);</span>
<span class="nc bnc" id="L6494" title="All 4 branches missed.">        boolean lineColorIsNull = line.has(&quot;color&quot;) &amp;&amp; line.isNull(&quot;color&quot;);</span>
<span class="nc bnc" id="L6495" title="All 4 branches missed.">        boolean lineTypeIsNull = line.has(OPK_TYPE) &amp;&amp; line.isNull(OPK_TYPE);</span>
<span class="nc bnc" id="L6496" title="All 4 branches missed.">        boolean lineWidthIsNull = line.has(&quot;width&quot;) &amp;&amp; line.isNull(&quot;width&quot;);</span>
<span class="nc bnc" id="L6497" title="All 4 branches missed.">        boolean lineStyleIsNull = line.has(&quot;style&quot;) &amp;&amp; line.isNull(&quot;style&quot;);</span>
<span class="nc bnc" id="L6498" title="All 6 branches missed.">        if (lineStyleIsNull &amp;&amp; lineTypeIsNull &amp;&amp; lineWidthIsNull) {</span>
<span class="nc" id="L6499">          putBorders = true;</span>
<span class="nc" id="L6500">          useOneBorder = true;</span>
<span class="nc bnc" id="L6501" title="All 2 branches missed.">          for (String borderKey : allBorder.keySet()) {</span>
<span class="nc" id="L6502">            allBorder.remove(borderKey);</span>
<span class="nc" id="L6503">          }</span>
        } else {
<span class="nc" id="L6505">          String lineType = line.optString(OPK_TYPE);</span>
<span class="nc" id="L6506">          String lineStyle = line.optString(&quot;style&quot;);</span>
<span class="nc" id="L6507">          int width = line.optInt(&quot;width&quot;);</span>
<span class="nc bnc" id="L6508" title="All 2 branches missed.">          if (lineColor != null) {</span>
<span class="nc bnc" id="L6509" title="All 2 branches missed.">            if (useOneBorder) {</span>
<span class="nc" id="L6510">              allBorder.put(&quot;color&quot;, lineColor);</span>
            } else {
<span class="nc" id="L6512">              oldLeftBorder.put(&quot;color&quot;, lineColor);</span>
<span class="nc" id="L6513">              oldRightBorder.put(&quot;color&quot;, lineColor);</span>
<span class="nc" id="L6514">              oldTopBorder.put(&quot;color&quot;, lineColor);</span>
<span class="nc" id="L6515">              oldBottomBorder.put(&quot;color&quot;, lineColor);</span>
            }
<span class="nc" id="L6517">            putBorders = true;</span>
<span class="nc bnc" id="L6518" title="All 2 branches missed.">            if (isEmptyBorder) {</span>
<span class="nc bnc" id="L6519" title="All 2 branches missed.">              if (lineStyle.isEmpty()) {</span>
<span class="nc" id="L6520">                lineStyle = &quot;solid&quot;;</span>
              }
<span class="nc bnc" id="L6522" title="All 2 branches missed.">              if (width == 0) {</span>
<span class="nc" id="L6523">                width = 1;</span>
              }
            }
<span class="nc bnc" id="L6526" title="All 2 branches missed.">          } else if (lineColorIsNull) {</span>
<span class="nc bnc" id="L6527" title="All 2 branches missed.">            if (useOneBorder) {</span>
<span class="nc" id="L6528">              allBorder.remove(&quot;color&quot;);</span>
            } else {
<span class="nc" id="L6530">              oldLeftBorder.remove(&quot;color&quot;);</span>
<span class="nc" id="L6531">              oldRightBorder.remove(&quot;color&quot;);</span>
<span class="nc" id="L6532">              oldTopBorder.remove(&quot;color&quot;);</span>
<span class="nc" id="L6533">              oldBottomBorder.remove(&quot;color&quot;);</span>
            }
<span class="nc" id="L6535">            putBorders = true;</span>
          }
<span class="nc bnc" id="L6537" title="All 4 branches missed.">          if (lineType != null</span>
              &amp;&amp; lineStyle != null
<span class="nc bnc" id="L6539" title="All 4 branches missed.">              &amp;&amp; (lineStyle.length() &gt; 0 || (lineType.equals(&quot;none&quot;)))) {</span>
            // type: none, auto, solid
            // style:               solid,          dotted, dashed, dashDot, dashDotDot
            // border-style: none,   single, double, dotted, dashed, dashDot, dashDotDot
<span class="nc" id="L6543">            String newStyle = lineStyle;</span>
            ;
<span class="nc bnc" id="L6545" title="All 2 branches missed.">            if (lineType.equals(&quot;none&quot;)) {</span>
<span class="nc" id="L6546">              newStyle = &quot;none&quot;;</span>
<span class="nc bnc" id="L6547" title="All 2 branches missed.">            } else if (lineStyle.equals(&quot;solid&quot;)) {</span>
<span class="nc" id="L6548">              newStyle = &quot;single&quot;;</span>
            }
<span class="nc bnc" id="L6550" title="All 2 branches missed.">            if (useOneBorder) {</span>
<span class="nc" id="L6551">              allBorder.put(&quot;style&quot;, newStyle);</span>
            } else {
<span class="nc" id="L6553">              oldLeftBorder.put(&quot;style&quot;, newStyle);</span>
<span class="nc" id="L6554">              oldRightBorder.put(&quot;style&quot;, newStyle);</span>
<span class="nc" id="L6555">              oldTopBorder.put(&quot;style&quot;, newStyle);</span>
<span class="nc" id="L6556">              oldBottomBorder.put(&quot;style&quot;, newStyle);</span>
            }
<span class="nc bnc" id="L6558" title="All 6 branches missed.">            if (isEmptyBorder &amp;&amp; width == 0 &amp;&amp; !newStyle.equals(&quot;none&quot;)) {</span>
<span class="nc" id="L6559">              width = 1;</span>
            }
<span class="nc" id="L6561">            putBorders = true;</span>
          }
<span class="nc bnc" id="L6563" title="All 2 branches missed.">          if (width &gt; 0) {</span>
<span class="nc bnc" id="L6564" title="All 2 branches missed.">            if (useOneBorder) {</span>
<span class="nc" id="L6565">              allBorder.put(&quot;width&quot;, width);</span>
            } else {
<span class="nc" id="L6567">              oldLeftBorder.put(&quot;width&quot;, width);</span>
<span class="nc" id="L6568">              oldRightBorder.put(&quot;width&quot;, width);</span>
<span class="nc" id="L6569">              oldTopBorder.put(&quot;width&quot;, width);</span>
<span class="nc" id="L6570">              oldBottomBorder.put(&quot;width&quot;, width);</span>
            }
<span class="nc" id="L6572">            putBorders = true;</span>
          }
        }
<span class="nc bnc" id="L6575" title="All 2 branches missed.">        if (putBorders) {</span>
<span class="nc" id="L6576">          JSONObject copyAttrs = new JSONObject(attrs);</span>
<span class="nc bnc" id="L6577" title="All 2 branches missed.">          copyAttrs.put(&quot;borderLeft&quot;, useOneBorder ? allBorder : oldLeftBorder);</span>
<span class="nc bnc" id="L6578" title="All 2 branches missed.">          copyAttrs.put(&quot;borderRight&quot;, useOneBorder ? allBorder : oldRightBorder);</span>
<span class="nc bnc" id="L6579" title="All 2 branches missed.">          copyAttrs.put(&quot;borderTop&quot;, useOneBorder ? allBorder : oldTopBorder);</span>
<span class="nc bnc" id="L6580" title="All 2 branches missed.">          copyAttrs.put(&quot;borderBottom&quot;, useOneBorder ? allBorder : oldBottomBorder);</span>
<span class="nc" id="L6581">          attrs = copyAttrs;</span>
<span class="nc" id="L6582">          propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;border&quot;);</span>
        }
<span class="nc" id="L6584">      } catch (JSONException e) {</span>
        // no handling required
<span class="nc" id="L6586">      }</span>
    }
    //        if (key.contains(&quot;border&quot;)) {

    //			if (key.equals(&quot;border&quot;)) {
    //				try {
    //					Object value = attrs.get(key);
    //					// ToDo: Test with latest JSON Library and adapt accordingly for all occurences
    //					if (value == null || value.equals(JSONObject.NULL)) {
    //						propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;border&quot;);
    //					} else {
    //						// {\&quot;width\&quot;:2,
    //						// \&quot;style\&quot;:\&quot;solid\&quot;
    //						// \&quot;color\&quot;:{\&quot;value\&quot;:\&quot;000000\&quot;,\&quot;type\&quot;:\&quot;rgb\&quot;}}
    //						JSONObject border = (JSONObject) value;
    //						propertiesElement.setAttributeNS(OdfDocumentNamespace.FO.getUri(),&quot;fo:border&quot;,
    // getBorder(border));
    //					}
    //				} catch (JSONException ex) {
    //					Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);
    //				}
    //			} else
<span class="nc bnc" id="L6608" title="All 4 branches missed.">    if (putBorders || key.equals(&quot;borderLeft&quot;)) {</span>
      try {
<span class="nc" id="L6610">        Object value = attrs.get(&quot;borderLeft&quot;);</span>
        // ToDo: Test with latest JSON Library and adapt accordingly for all occurences
<span class="nc bnc" id="L6612" title="All 4 branches missed.">        if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6613">          propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;border-left&quot;);</span>
        } else {
          // {\&quot;width\&quot;:2,
          // \&quot;style\&quot;:\&quot;solid\&quot;
          // \&quot;color\&quot;:{\&quot;value\&quot;:\&quot;000000\&quot;,\&quot;type\&quot;:\&quot;rgb\&quot;}}
<span class="nc" id="L6618">          JSONObject border = (JSONObject) value;</span>
<span class="nc" id="L6619">          propertiesElement.setAttributeNS(</span>
<span class="nc" id="L6620">              OdfDocumentNamespace.FO.getUri(), &quot;fo:border-left&quot;, getBorder(border));</span>
          // oppose to the other border styles, the padding was added to border
<span class="nc bnc" id="L6622" title="All 4 branches missed.">          if (border.has(&quot;space&quot;) &amp;&amp; !border.get(&quot;space&quot;).equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6623">            double padding = border.optInt(&quot;space&quot;) / 100.0;</span>
<span class="nc" id="L6624">            propertiesElement.setAttributeNS(</span>
<span class="nc" id="L6625">                OdfDocumentNamespace.FO.getUri(), &quot;fo:padding-left&quot;, padding + &quot;mm&quot;);</span>
          }
        }
<span class="nc" id="L6628">      } catch (JSONException ex) {</span>
<span class="nc" id="L6629">        Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6630">      }</span>
    }
<span class="nc bnc" id="L6632" title="All 4 branches missed.">    if (putBorders || key.equals(&quot;borderRight&quot;)) {</span>
      try {
<span class="nc" id="L6634">        Object value = attrs.get(&quot;borderRight&quot;);</span>
        // ToDo: Test with latest JSON Library and adapt accordingly for all occurences
<span class="nc bnc" id="L6636" title="All 4 branches missed.">        if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6637">          propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;border-right&quot;);</span>
        } else {
          // {\&quot;width\&quot;:15,
          // \&quot;style\&quot;:\&quot;solid\&quot;
          // \&quot;color\&quot;:{\&quot;value\&quot;:\&quot;000000\&quot;,\&quot;type\&quot;:\&quot;rgb\&quot;}} / // \&quot;color\&quot;:{\&quot;type\&quot;:\&quot;auto\&quot;}}
          // \&quot;space\&quot;:\140
<span class="nc" id="L6643">          JSONObject border = (JSONObject) value;</span>
<span class="nc" id="L6644">          propertiesElement.setAttributeNS(</span>
<span class="nc" id="L6645">              OdfDocumentNamespace.FO.getUri(), &quot;fo:border-right&quot;, getBorder(border));</span>
          // oppose to the other border styles, the padding was added to border
<span class="nc bnc" id="L6647" title="All 4 branches missed.">          if (border.has(&quot;space&quot;) &amp;&amp; !border.get(&quot;space&quot;).equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6648">            double padding = border.optInt(&quot;space&quot;) / 100.0;</span>
<span class="nc" id="L6649">            propertiesElement.setAttributeNS(</span>
<span class="nc" id="L6650">                OdfDocumentNamespace.FO.getUri(), &quot;fo:padding-right&quot;, padding + &quot;mm&quot;);</span>
          }
        }
<span class="nc" id="L6653">      } catch (JSONException ex) {</span>
<span class="nc" id="L6654">        Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6655">      }</span>
    }
<span class="nc bnc" id="L6657" title="All 4 branches missed.">    if (putBorders || key.equals(&quot;borderTop&quot;)) {</span>
      try {
<span class="nc" id="L6659">        Object value = attrs.get(&quot;borderTop&quot;);</span>
        // ToDo: Test with latest JSON Library and adapt accordingly for all occurences
<span class="nc bnc" id="L6661" title="All 4 branches missed.">        if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6662">          propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;border-top&quot;);</span>
        } else {
          // {\&quot;width\&quot;:2,
          // \&quot;style\&quot;:\&quot;solid\&quot;
          // \&quot;color\&quot;:{\&quot;value\&quot;:\&quot;000000\&quot;,\&quot;type\&quot;:\&quot;rgb\&quot;}}
<span class="nc" id="L6667">          JSONObject border = (JSONObject) value;</span>
<span class="nc" id="L6668">          propertiesElement.setAttributeNS(</span>
<span class="nc" id="L6669">              OdfDocumentNamespace.FO.getUri(), &quot;fo:border-top&quot;, getBorder(border));</span>
          // oppose to the other border styles, the padding was added to border
<span class="nc bnc" id="L6671" title="All 4 branches missed.">          if (border.has(&quot;space&quot;) &amp;&amp; !border.get(&quot;space&quot;).equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6672">            double padding = border.optInt(&quot;space&quot;) / 100.0;</span>
<span class="nc" id="L6673">            propertiesElement.setAttributeNS(</span>
<span class="nc" id="L6674">                OdfDocumentNamespace.FO.getUri(), &quot;fo:padding-top&quot;, padding + &quot;mm&quot;);</span>
          }
        }
<span class="nc" id="L6677">      } catch (JSONException ex) {</span>
<span class="nc" id="L6678">        Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6679">      }</span>
    }
<span class="nc bnc" id="L6681" title="All 4 branches missed.">    if (putBorders || key.equals(&quot;borderBottom&quot;)) {</span>
      try {
<span class="nc" id="L6683">        Object value = attrs.get(&quot;borderBottom&quot;);</span>
        // ToDo: Test with latest JSON Library and adapt accordingly for all occurences
<span class="nc bnc" id="L6685" title="All 4 branches missed.">        if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6686">          propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;border-bottom&quot;);</span>
        } else {
          // {\&quot;width\&quot;:2,
          // \&quot;style\&quot;:\&quot;solid\&quot;
          // \&quot;color\&quot;:{\&quot;value\&quot;:\&quot;000000\&quot;,\&quot;type\&quot;:\&quot;rgb\&quot;}}
<span class="nc" id="L6691">          JSONObject border = (JSONObject) value;</span>
<span class="nc" id="L6692">          propertiesElement.setAttributeNS(</span>
<span class="nc" id="L6693">              OdfDocumentNamespace.FO.getUri(), &quot;fo:border-bottom&quot;, getBorder(border));</span>
          // oppose to the other border styles, the padding was added to border
<span class="nc bnc" id="L6695" title="All 4 branches missed.">          if (border.has(&quot;space&quot;) &amp;&amp; !border.get(&quot;space&quot;).equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6696">            double padding = border.optInt(&quot;space&quot;) / 100.0;</span>
<span class="nc" id="L6697">            propertiesElement.setAttributeNS(</span>
<span class="nc" id="L6698">                OdfDocumentNamespace.FO.getUri(), &quot;fo:padding-bottom&quot;, padding + &quot;mm&quot;);</span>
          }
        }
<span class="nc" id="L6701">      } catch (JSONException ex) {</span>
<span class="nc" id="L6702">        Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6703">      }</span>
    }
    //        }
<span class="nc" id="L6706">  }</span>

  private static void addMarginProperties(
      String key, JSONObject attrs, OdfStylePropertiesBase propertiesElement) {
<span class="nc bnc" id="L6710" title="All 4 branches missed.">    if (key.contains(&quot;margin&quot;) || key.contains(&quot;indent&quot;)) {</span>

      //			if (key.equals(&quot;margin&quot;)) {
      //				try {
      //					Object value = attrs.get(key);
      //					// ToDo: Test with latest JSON Library and adapt accordingly for all occurences
      //					if (value == null || value.equals(JSONObject.NULL)) {
      //						propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;margin&quot;);
      //					} else {
      //						Integer width = getSafelyInteger(value);
      //						propertiesElement.setAttributeNS(OdfDocumentNamespace.FO.getUri(),&quot;margin&quot;, ((width /
      // 100.0) + &quot;mm&quot;));
      //					}
      //				} catch (JSONException ex) {
      //					Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);
      //				}
      //			} else
<span class="nc bnc" id="L6727" title="All 2 branches missed.">      if (key.equals(&quot;marginBottom&quot;)) {</span>
        try {
<span class="nc" id="L6729">          Object value = attrs.get(key);</span>
          // ToDo: Test with latest JSON Library and adapt accordingly for all occurences
<span class="nc bnc" id="L6731" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6732">            propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;margin-bottom&quot;);</span>
          } else {
<span class="nc" id="L6734">            Integer width = getSafelyInteger(value);</span>
<span class="nc" id="L6735">            propertiesElement.setAttributeNS(</span>
<span class="nc" id="L6736">                OdfDocumentNamespace.FO.getUri(), &quot;fo:margin-bottom&quot;, ((width / 100.0) + &quot;mm&quot;));</span>
          }
<span class="nc" id="L6738">        } catch (JSONException ex) {</span>
<span class="nc" id="L6739">          Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6740">        }</span>
<span class="nc bnc" id="L6741" title="All 4 branches missed.">      } else if (key.equals(&quot;marginLeft&quot;) || key.equals(&quot;indentLeft&quot;)) {</span>

        // FIX API   			} else if (key.equals(&quot;indentLeft&quot;)) {
        try {
<span class="nc" id="L6745">          Object value = attrs.get(key);</span>
          // ToDo: Test with latest JSON Library and adapt accordingly for all occurences
<span class="nc bnc" id="L6747" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6748">            propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;margin-left&quot;);</span>
          } else {
<span class="nc" id="L6750">            Integer width = getSafelyInteger(value);</span>
<span class="nc" id="L6751">            propertiesElement.setAttributeNS(</span>
<span class="nc" id="L6752">                OdfDocumentNamespace.FO.getUri(), &quot;fo:margin-left&quot;, ((width / 100.0) + &quot;mm&quot;));</span>
          }
<span class="nc" id="L6754">        } catch (JSONException ex) {</span>
<span class="nc" id="L6755">          Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6756">        }</span>
<span class="nc bnc" id="L6757" title="All 4 branches missed.">      } else if (key.equals(&quot;marginRight&quot;) || key.equals(&quot;indentRight&quot;)) {</span>
        // FIX API   			} else if (key.equals(&quot;indentRight&quot;)) {
        try {
<span class="nc" id="L6760">          Object value = attrs.get(key);</span>
          // ToDo: Test with latest JSON Library and adapt accordingly for all occurences
<span class="nc bnc" id="L6762" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6763">            propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;margin-right&quot;);</span>
          } else {
<span class="nc" id="L6765">            Integer width = getSafelyInteger(value);</span>
<span class="nc" id="L6766">            propertiesElement.setAttributeNS(</span>
<span class="nc" id="L6767">                OdfDocumentNamespace.FO.getUri(), &quot;fo:margin-right&quot;, ((width / 100.0) + &quot;mm&quot;));</span>
          }
<span class="nc" id="L6769">        } catch (JSONException ex) {</span>
<span class="nc" id="L6770">          Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6771">        }</span>
<span class="nc bnc" id="L6772" title="All 2 branches missed.">      } else if (key.equals(&quot;marginTop&quot;)) {</span>
        try {
<span class="nc" id="L6774">          Object value = attrs.get(key);</span>
          // ToDo: Test with latest JSON Library and adapt accordingly for all occurences
<span class="nc bnc" id="L6776" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6777">            propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;margin-top&quot;);</span>
          } else {
<span class="nc" id="L6779">            Integer width = getSafelyInteger(value);</span>
<span class="nc" id="L6780">            propertiesElement.setAttributeNS(</span>
<span class="nc" id="L6781">                OdfDocumentNamespace.FO.getUri(), &quot;fo:margin-top&quot;, ((width / 100.0) + &quot;mm&quot;));</span>
          }
<span class="nc" id="L6783">        } catch (JSONException ex) {</span>
<span class="nc" id="L6784">          Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6785">        }</span>
      }
    }
<span class="nc" id="L6788">  }</span>

  public static void addPaddingProperties(
      String key, JSONObject attrs, OdfStylePropertiesBase propertiesElement) {
<span class="nc bnc" id="L6792" title="All 2 branches missed.">    if (key.contains(&quot;padding&quot;)) {</span>
      //				try {
      //					Object value = attrs.get(key);
      //					// ToDo: Test with latest JSON Library and adapt accordingly for all occurences
      //					if (value == null || value.equals(JSONObject.NULL)) {
      //						propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;padding&quot;);
      //					} else {
      //						Integer width = getSafelyInteger(value);
      //						propertiesElement.setAttributeNS(OdfDocumentNamespace.FO.getUri(),&quot;fo:padding&quot;,
      // ((width / 100.0) + &quot;mm&quot;));
      //					}
      //				} catch (JSONException ex) {
      //					Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);
      //				}
      ////			}
      //			else if (key.equals(&quot;padding&quot;)) {
      //				try {
      //					Object value = attrs.get(key);
      //					// ToDo: Test with latest JSON Library and adapt accordingly for all occurences
      //					if (value == null || value.equals(JSONObject.NULL)) {
      //						propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;padding&quot;);
      //					} else {
      //						Integer width = getSafelyInteger(value);
      //						propertiesElement.setAttributeNS(OdfDocumentNamespace.FO.getUri(),&quot;fo:padding&quot;,
      // ((width / 100.0) + &quot;mm&quot;));
      //					}
      //				} catch (JSONException ex) {
      //					Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);
      //				}
      //			} else

<span class="nc bnc" id="L6823" title="All 2 branches missed.">      if (key.equals(&quot;paddingBottom&quot;)) {</span>
        try {
<span class="nc" id="L6825">          Object value = attrs.get(key);</span>
          // ToDo: Test with latest JSON Library and adapt accordingly for all occurences
<span class="nc bnc" id="L6827" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6828">            propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;padding-bottom&quot;);</span>
          } else {
<span class="nc" id="L6830">            Integer width = getSafelyInteger(value);</span>
<span class="nc" id="L6831">            propertiesElement.setAttributeNS(</span>
<span class="nc" id="L6832">                OdfDocumentNamespace.FO.getUri(), &quot;fo:padding-bottom&quot;, ((width / 100.0) + &quot;mm&quot;));</span>
          }
<span class="nc" id="L6834">        } catch (JSONException ex) {</span>
<span class="nc" id="L6835">          Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6836">        }</span>
<span class="nc bnc" id="L6837" title="All 2 branches missed.">      } else if (key.equals(&quot;paddingLeft&quot;)) {</span>
        try {
<span class="nc" id="L6839">          Object value = attrs.get(key);</span>
          // ToDo: Test with latest JSON Library and adapt accordingly for all occurences
<span class="nc bnc" id="L6841" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6842">            propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;padding-left&quot;);</span>
          } else {
<span class="nc" id="L6844">            Integer width = getSafelyInteger(value);</span>
<span class="nc" id="L6845">            propertiesElement.setAttributeNS(</span>
<span class="nc" id="L6846">                OdfDocumentNamespace.FO.getUri(), &quot;fo:padding-left&quot;, ((width / 100.0) + &quot;mm&quot;));</span>
          }
<span class="nc" id="L6848">        } catch (JSONException ex) {</span>
<span class="nc" id="L6849">          Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6850">        }</span>
<span class="nc bnc" id="L6851" title="All 2 branches missed.">      } else if (key.equals(&quot;paddingRight&quot;)) {</span>
        try {
<span class="nc" id="L6853">          Object value = attrs.get(key);</span>
<span class="nc bnc" id="L6854" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6855">            propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;padding-right&quot;);</span>
          } else {
<span class="nc" id="L6857">            Integer width = getSafelyInteger(value);</span>
<span class="nc" id="L6858">            propertiesElement.setAttributeNS(</span>
<span class="nc" id="L6859">                OdfDocumentNamespace.FO.getUri(), &quot;fo:padding-right&quot;, ((width / 100.0) + &quot;mm&quot;));</span>
          }
<span class="nc" id="L6861">        } catch (JSONException ex) {</span>
<span class="nc" id="L6862">          Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6863">        }</span>
<span class="nc bnc" id="L6864" title="All 2 branches missed.">      } else if (key.equals(&quot;paddingTop&quot;)) {</span>
        try {
<span class="nc" id="L6866">          Object value = attrs.get(key);</span>
<span class="nc bnc" id="L6867" title="All 4 branches missed.">          if (value == null || value.equals(JSONObject.NULL)) {</span>
<span class="nc" id="L6868">            propertiesElement.removeAttributeNS(OdfDocumentNamespace.FO.getUri(), &quot;padding-top&quot;);</span>
          } else {
<span class="nc" id="L6870">            Integer width = getSafelyInteger(value);</span>
<span class="nc" id="L6871">            propertiesElement.setAttributeNS(</span>
<span class="nc" id="L6872">                OdfDocumentNamespace.FO.getUri(), &quot;fo:padding-top&quot;, ((width / 100.0) + &quot;mm&quot;));</span>
          }
<span class="nc" id="L6874">        } catch (JSONException ex) {</span>
<span class="nc" id="L6875">          Logger.getLogger(JsonOperationConsumer.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6876">        }</span>
      }
    }
<span class="nc" id="L6879">  }</span>

  private static int getSafelyInteger(Object value) {
    int i;
    // defensive block in case JSON/Javascript/browser returns a Double
<span class="nc bnc" id="L6884" title="All 2 branches missed.">    if (value instanceof Double) {</span>
<span class="nc" id="L6885">      i = (int) Math.round((Double) value);</span>
<span class="nc" id="L6886">      LOG.log(Level.SEVERE, &quot;The value should be an Integer, not a Double: {0}&quot;, value);</span>
<span class="nc bnc" id="L6887" title="All 2 branches missed.">    } else if (value instanceof Float) {</span>
<span class="nc" id="L6888">      i = Math.round((Float) value);</span>
<span class="nc" id="L6889">      LOG.log(Level.SEVERE, &quot;The value should be an Integer, not a Float: {0}&quot;, value);</span>
    } else {
<span class="nc" id="L6891">      i = (Integer) value;</span>
    }
<span class="nc" id="L6893">    return i;</span>
  }

  private static final JSONArray decrementAll(JSONArray position) {
<span class="nc bnc" id="L6897" title="All 2 branches missed.">    if (position != null) {</span>
<span class="nc bnc" id="L6898" title="All 2 branches missed.">      for (int i = 0; i &lt; position.length(); i++) {</span>
<span class="nc" id="L6899">        position.put(i, ((Integer) position.get(i)) - 1);</span>
      }
    }
<span class="nc" id="L6902">    return position;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>