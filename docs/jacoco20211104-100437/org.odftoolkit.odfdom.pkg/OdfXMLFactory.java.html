<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OdfXMLFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ODFDOM</a> &gt; <a href="index.source.html" class="el_package">org.odftoolkit.odfdom.pkg</a> &gt; <span class="el_source">OdfXMLFactory.java</span></div><h1>OdfXMLFactory.java</h1><pre class="source lang-java linenums">/**
 * **********************************************************************
 *
 * &lt;p&gt;DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER
 *
 * &lt;p&gt;Copyright 2008, 2010 Oracle and/or its affiliates. All rights reserved.
 *
 * &lt;p&gt;Use is subject to license terms.
 *
 * &lt;p&gt;Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file
 * except in compliance with the License. You may obtain a copy of the License at
 * http://www.apache.org/licenses/LICENSE-2.0. You can also obtain a copy of the License at
 * http://odftoolkit.org/docs/license.txt
 *
 * &lt;p&gt;Unless required by applicable law or agreed to in writing, software distributed under the
 * License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 * express or implied.
 *
 * &lt;p&gt;See the License for the specific language governing permissions and limitations under the
 * License.
 *
 * &lt;p&gt;**********************************************************************
 */

/*
 * This file is automatically generated.
 * Don't edit manually.
 */
package org.odftoolkit.odfdom.pkg;

import java.lang.reflect.Constructor;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.Set;
import java.util.StringTokenizer;
import java.util.logging.Level;
import java.util.logging.Logger;
import org.w3c.dom.DOMException;

/**
 * This factory determines what elements are being used in the DOC layer (i.e. the convenient
 * layer).
 *
 * &lt;p&gt;The mapping of ODF element to convenient class can be changed from the user during run time.
 *
 * &lt;p&gt;For example, a user might want to create a table always with a certain style or default data
 * and might want to overwrite the mapping for &lt;code&gt;{odf.element table:table}&lt;/code&gt;, that a
 * different class instead of &lt;code&gt;OdfTable&lt;/code&gt; is being used.
 */
<span class="nc" id="L51">public class OdfXMLFactory {</span>

<span class="fc" id="L53">  private static Map&lt;OdfName, Class&gt; mElementTypes = new HashMap&lt;OdfName, Class&gt;();</span>
<span class="fc" id="L54">  private static Map&lt;OdfName, Class&gt; mAttributeTypes = new HashMap&lt;OdfName, Class&gt;();</span>
<span class="fc" id="L55">  private static Map&lt;String, String&gt; mElementRenames = new HashMap&lt;String, String&gt;();</span>
  // a set for the element which need to load a none generated manual written class
<span class="fc" id="L57">  private static Set&lt;String&gt; mHandwrittenElementClasses = new HashSet&lt;String&gt;();</span>
  private static final String LOCAL_NAME_DELIMITER = &quot;-&quot;;
  private static final String ELEMENT_NAME_DELIMITER = &quot;:&quot;;
  private static final String ELEMENT_PACKAGE_NAME = &quot;element&quot;;
  private static final String ATTRIBUTE_PACKAGE_NAME = &quot;attribute&quot;;

  static {
<span class="fc" id="L64">    mElementRenames.put(&quot;text:h&quot;, &quot;text:heading&quot;);</span>
<span class="fc" id="L65">    mElementRenames.put(&quot;text:p&quot;, &quot;text:paragraph&quot;);</span>

<span class="fc" id="L67">    mHandwrittenElementClasses.add(&quot;draw:frame&quot;);</span>
<span class="fc" id="L68">    mHandwrittenElementClasses.add(&quot;draw:image&quot;);</span>
<span class="fc" id="L69">    mHandwrittenElementClasses.add(&quot;number:currency-style&quot;);</span>
<span class="fc" id="L70">    mHandwrittenElementClasses.add(&quot;number:date-style&quot;);</span>
<span class="fc" id="L71">    mHandwrittenElementClasses.add(&quot;number:percentage-style&quot;);</span>
<span class="fc" id="L72">    mHandwrittenElementClasses.add(&quot;number:number-style&quot;);</span>
<span class="fc" id="L73">    mHandwrittenElementClasses.add(&quot;number:time-style&quot;);</span>
    // Starting Refactoring. Goal: using XML DOM classes with sets for styles instead of own layer
    // mHandwrittenElements.add(&quot;office:automatic-styles&quot;);
    // mHandwrittenElements.add(&quot;office:master-styles&quot;);
    // mHandwrittenElements.add(&quot;office:styles&quot;);
<span class="fc" id="L78">    mHandwrittenElementClasses.add(&quot;style:default-style&quot;);</span>
<span class="fc" id="L79">    mHandwrittenElementClasses.add(&quot;style:style&quot;);</span>
<span class="fc" id="L80">    mHandwrittenElementClasses.add(&quot;style:page-layout&quot;);</span>
<span class="fc" id="L81">    mHandwrittenElementClasses.add(&quot;text:h&quot;);</span>
<span class="fc" id="L82">    mHandwrittenElementClasses.add(&quot;text:list&quot;);</span>
<span class="fc" id="L83">    mHandwrittenElementClasses.add(&quot;text:list-level-style-bullet&quot;);</span>
<span class="fc" id="L84">    mHandwrittenElementClasses.add(&quot;text:list-level-style-image&quot;);</span>
<span class="fc" id="L85">    mHandwrittenElementClasses.add(&quot;text:list-level-style-number&quot;);</span>
<span class="fc" id="L86">    mHandwrittenElementClasses.add(&quot;text:list-style&quot;);</span>
<span class="fc" id="L87">    mHandwrittenElementClasses.add(&quot;text:outline-level-style&quot;);</span>
<span class="fc" id="L88">    mHandwrittenElementClasses.add(&quot;text:outline-style&quot;);</span>
<span class="fc" id="L89">    mHandwrittenElementClasses.add(&quot;text:p&quot;);</span>
<span class="fc" id="L90">    mHandwrittenElementClasses.add(&quot;text:span&quot;);</span>
<span class="fc" id="L91">  }</span>

  /**
   * @param odfName the name of the ODF attribute the desired DOM class should represent.
   * @return the Java DOM attribute class to be mapped to a certain ODF attribute.
   */
  private static Class getOdfAttributeClass(OdfName odfName) {
<span class="fc" id="L98">    return getOdfNodeClass(odfName, ATTRIBUTE_PACKAGE_NAME, mAttributeTypes);</span>
  }

  /**
   * @param odfName the name of the ODF element the desired DOM class should represent.
   * @return the Java DOM element class to be mapped to a certain ODF element.
   */
  private static Class getOdfElementClass(OdfName odfName) {
<span class="fc" id="L106">    return getOdfNodeClass(odfName, ELEMENT_PACKAGE_NAME, mElementTypes);</span>
  }

  private static Class getOdfNodeClass(
      OdfName odfName, String nodeType, Map&lt;OdfName, Class&gt; classCache) {
<span class="fc" id="L111">    Class c = null;</span>
<span class="fc" id="L112">    String className = &quot;&quot;;</span>
<span class="fc" id="L113">    c = classCache.get(odfName);</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">    if (c == null) {</span>
<span class="fc" id="L115">      String prefix = odfName.getPrefix();</span>
<span class="fc bfc" id="L116" title="All 6 branches covered.">      if (prefix != null &amp;&amp; !(nodeType.equals(ATTRIBUTE_PACKAGE_NAME) &amp;&amp; prefix.equals(&quot;xmlns&quot;))) {</span>
<span class="fc" id="L117">        String qName = odfName.getQName();</span>
<span class="fc" id="L118">        String localName = odfName.getLocalName();</span>
        // judge whether the element need to load class from incubator package.
<span class="fc bfc" id="L120" title="All 2 branches covered.">        if (mHandwrittenElementClasses.contains(qName)) {</span>
          // judge whether the element need to rename before find class name.
<span class="fc bfc" id="L122" title="All 2 branches covered.">          if (mElementRenames.containsKey(qName)) {</span>
<span class="fc" id="L123">            String renameName = mElementRenames.get(qName);</span>
<span class="fc" id="L124">            StringTokenizer stok = new StringTokenizer(renameName, ELEMENT_NAME_DELIMITER);</span>
<span class="fc" id="L125">            prefix = stok.nextToken();</span>
<span class="fc" id="L126">            localName = stok.nextToken();</span>
          }
<span class="fc" id="L128">          className = getOdfIncubatorNodeClassName(prefix, localName);</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">        } else if (&quot;manifest&quot;.equals(prefix)) {</span>
<span class="fc" id="L130">          className = getOdfPKGNodeClassName(prefix, localName, nodeType);</span>
        } else {
<span class="fc" id="L132">          className = getOdfDOMNodeClassName(prefix, localName, nodeType);</span>
        }
        try {
<span class="fc" id="L135">          c = Class.forName(className);</span>
<span class="fc" id="L136">          classCache.put(odfName, c);</span>
<span class="fc" id="L137">        } catch (ClassNotFoundException ex) {</span>
          // all classes are first tring to load and warning is given later
<span class="fc" id="L139">        } catch (NoClassDefFoundError dex) {</span>
<span class="fc" id="L140">          Logger.getLogger(OdfXMLFactory.class.getName())</span>
<span class="fc" id="L141">              .log(Level.FINER, &quot;NoClassDefFoundError: &quot; + className, dex.getMessage());</span>
<span class="fc" id="L142">        }</span>
      }
    }
<span class="fc" id="L145">    return c;</span>
  }

  private static String getOdfIncubatorNodeClassName(String prefix, String localName) {
<span class="fc" id="L149">    boolean contains = false;</span>
<span class="fc" id="L150">    StringBuilder className = new StringBuilder();</span>

<span class="fc bfc" id="L152" title="All 2 branches covered.">    if (localName.indexOf(LOCAL_NAME_DELIMITER) != -1) {</span>
<span class="fc" id="L153">      StringTokenizer stok = new StringTokenizer(localName, LOCAL_NAME_DELIMITER);</span>
<span class="fc bfc" id="L154" title="All 2 branches covered.">      while (stok.hasMoreElements()) {</span>
<span class="fc" id="L155">        String substr = stok.nextToken();</span>
<span class="fc bfc" id="L156" title="All 2 branches covered.">        if (substr.equals(prefix)) {</span>
<span class="fc" id="L157">          contains = true;</span>
        }
<span class="fc" id="L159">        className = className.append(toUpperCaseFirstCharacter(substr));</span>
<span class="fc" id="L160">      }</span>
<span class="fc" id="L161">    } else {</span>
<span class="fc" id="L162">      className = className.append(toUpperCaseFirstCharacter(localName));</span>
    }
<span class="pc bpc" id="L164" title="1 of 4 branches missed.">    if (!((contains &amp;&amp; !localName.endsWith(&quot;table&quot;))</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">        || (localName.equals(prefix))</span>
<span class="pc bpc" id="L166" title="3 of 4 branches missed.">        || (localName.startsWith(prefix) &amp;&amp; prefix.equals(&quot;anim&quot;)))) {</span>
<span class="fc" id="L167">      className = className.insert(0, toUpperCaseFirstCharacter(prefix));</span>
    }
<span class="fc" id="L169">    className = className.insert(0, &quot;org.odftoolkit.odfdom.incubator.doc.&quot; + prefix + &quot;.&quot; + &quot;Odf&quot;);</span>

<span class="fc" id="L171">    return className.toString();</span>
  }

  private static String getOdfPKGNodeClassName(String prefix, String localName, String nodeType) {
<span class="fc" id="L175">    StringBuilder className = new StringBuilder(&quot;org.odftoolkit.odfdom.pkg.&quot; + prefix + &quot;.&quot;);</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">    if (localName.indexOf(LOCAL_NAME_DELIMITER) != -1) {</span>
<span class="fc" id="L177">      StringTokenizer stok = new StringTokenizer(localName, LOCAL_NAME_DELIMITER);</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">      while (stok.hasMoreElements()) {</span>
<span class="fc" id="L179">        className = className.append(toUpperCaseFirstCharacter(stok.nextToken()));</span>
      }
<span class="fc" id="L181">    } else {</span>
<span class="fc" id="L182">      className = className.append(toUpperCaseFirstCharacter(localName));</span>
    }
<span class="fc" id="L184">    className.append(toUpperCaseFirstCharacter(nodeType));</span>
<span class="fc" id="L185">    return className.toString();</span>
  }

  private static String getOdfDOMNodeClassName(String prefix, String localName, String nodeType) {
<span class="fc" id="L189">    StringBuilder className =</span>
        new StringBuilder(&quot;org.odftoolkit.odfdom.dom.&quot; + nodeType + &quot;.&quot; + prefix + &quot;.&quot;);
<span class="fc" id="L191">    className = className.append(toUpperCaseFirstCharacter(prefix));</span>
<span class="fc bfc" id="L192" title="All 2 branches covered.">    if (localName.indexOf(LOCAL_NAME_DELIMITER) != -1) {</span>
<span class="fc" id="L193">      StringTokenizer stok = new StringTokenizer(localName, LOCAL_NAME_DELIMITER);</span>
<span class="fc bfc" id="L194" title="All 2 branches covered.">      while (stok.hasMoreElements()) {</span>
<span class="fc" id="L195">        className = className.append(toUpperCaseFirstCharacter(stok.nextToken()));</span>
      }
<span class="fc" id="L197">    } else {</span>
<span class="fc" id="L198">      className = className.append(toUpperCaseFirstCharacter(localName));</span>
    }
<span class="fc" id="L200">    className.append(toUpperCaseFirstCharacter(nodeType));</span>
<span class="fc" id="L201">    return className.toString();</span>
  }

  private static String toUpperCaseFirstCharacter(String token) {
<span class="fc" id="L205">    return token.substring(0, 1).toUpperCase() + token.substring(1);</span>
  }

  public static OdfElement newOdfElement(OdfFileDom dom, OdfName name) throws DOMException {
<span class="fc" id="L209">    OdfElement element = null;</span>

    // lookup registered element class for qname
<span class="fc" id="L212">    Class elementClass = getOdfElementClass(name);</span>

    // if a class was registered create an instance of that class
<span class="fc bfc" id="L215" title="All 2 branches covered.">    if (elementClass != null) {</span>
<span class="fc" id="L216">      element = (OdfElement) getNodeFromClass(dom, elementClass);</span>
    } else {
<span class="fc" id="L218">      String oldPrefix = name.getPrefix();</span>
<span class="fc bfc" id="L219" title="All 2 branches covered.">      if (oldPrefix != null) {</span>
        // check if the namespace prefix is correct or add potential namespace to DOM
<span class="fc" id="L221">        OdfName adaptedName = addNamespaceToDom(name, dom);</span>
<span class="fc" id="L222">        String newPrefix = adaptedName.getPrefix();</span>
        // in case the prefix was changed as it existed before
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">        if (oldPrefix != null</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">            &amp;&amp; !oldPrefix.equals(newPrefix)</span>
            // &quot;_1&quot; is the suffix added by OdfFileDom to an existing Namespace
<span class="fc bfc" id="L227" title="All 2 branches covered.">            &amp;&amp; newPrefix.indexOf(&quot;__&quot;) == -1) {</span>
          // look up again if there is a class registered for this prefix
<span class="fc" id="L229">          element = newOdfElement(dom, adaptedName);</span>
        } else {
<span class="fc" id="L231">          element = (OdfElement) new OdfAlienElement(dom, adaptedName);</span>
<span class="fc" id="L232">          Logger.getLogger(OdfXMLFactory.class.getName())</span>
<span class="fc" id="L233">              .log(Level.FINER, &quot;None-ODF element created for {0}&quot;, adaptedName.getQName());</span>
        }
<span class="fc" id="L235">      } else {</span>
<span class="fc" id="L236">        element = (OdfElement) new OdfAlienElement(dom, name);</span>
<span class="fc" id="L237">        Logger.getLogger(OdfXMLFactory.class.getName())</span>
<span class="fc" id="L238">            .log(Level.FINER, &quot;None-ODF element created for {0}&quot;, name.getQName());</span>
      }
    }
<span class="fc" id="L241">    return element;</span>
  }

  public static OdfAttribute newOdfAttribute(OdfFileDom dom, OdfName name) throws DOMException {
<span class="fc" id="L245">    OdfAttribute attr = null;</span>

    // lookup registered attribute class for qname

    // SJ: but there exists elements &amp; attributes having the same qName (&quot;style:style&quot;)
    // so it is not ensured to get a OdfAttribute ... in case of &quot;style:style&quot; you get a
    // OdfStyle which is not a OdfAttribute :-(
<span class="fc" id="L252">    Class attributeClass = getOdfAttributeClass(name);</span>

    // if a class was registered create an instance of that class
<span class="fc bfc" id="L255" title="All 2 branches covered.">    if (attributeClass != null) {</span>
<span class="fc" id="L256">      Object node = getNodeFromClass(dom, attributeClass);</span>
<span class="fc bfc" id="L257" title="All 2 branches covered.">      if (node instanceof OdfAttribute) {</span>
<span class="fc" id="L258">        return (OdfAttribute) node;</span>
      }
    }
    // add a namespace unless it is a xmlns attribute (no attr value to set the uri)
<span class="fc" id="L262">    String prefix = name.getPrefix();</span>
<span class="fc bfc" id="L263" title="All 4 branches covered.">    if (prefix != null &amp;&amp; !prefix.equals(&quot;xmlns&quot;)) {</span>
      // check if the namespace prefix is correct or add potential namespace to DOM
<span class="fc" id="L265">      OdfName adaptedName = addNamespaceToDom(name, dom);</span>
<span class="fc" id="L266">      String newPrefix = adaptedName.getPrefix();</span>
      // in case the prefix was changed as it existed before
<span class="fc bfc" id="L268" title="All 4 branches covered.">      if (!prefix.equals(newPrefix) &amp;&amp; newPrefix.indexOf(&quot;__&quot;) == -1) {</span>
        // look up again if there is a class registered for this prefix
<span class="fc" id="L270">        attr = newOdfAttribute(dom, adaptedName);</span>
      } else {
<span class="fc" id="L272">        attr = (OdfAttribute) new OdfAlienAttribute(dom, name);</span>
<span class="fc" id="L273">        Logger.getLogger(OdfXMLFactory.class.getName())</span>
<span class="fc" id="L274">            .log(Level.FINER, &quot;None-ODF attribute created for {0}&quot;, adaptedName.getQName());</span>
      }
<span class="fc" id="L276">    } else {</span>
      // create an alien attribute for namespace attribute &quot;xmlns:*&quot;
<span class="fc" id="L278">      attr = (OdfAttribute) new OdfAlienAttribute(dom, name);</span>
    }
<span class="fc" id="L280">    return attr;</span>
  }

  private static OdfName addNamespaceToDom(OdfName name, OdfFileDom dom) {
<span class="fc" id="L284">    OdfNamespace newNS = dom.setNamespace(name.getPrefix(), name.getUri());</span>
<span class="fc" id="L285">    return OdfName.newName(newNS, name.getLocalName());</span>
  }

  /**
   * @param dom the XML DOM file where the node should be created on.
   * @param nodeClass being an XMLNode the Java class of the instance to be created.
   * @return an object instance of the XML node class being provided (usually an attribute or
   *     element).
   */
  static Object getNodeFromClass(OdfFileDom dom, Class nodeClass) {
<span class="fc" id="L295">    Object o = null;</span>
    try {
<span class="fc" id="L297">      Constructor ctor = nodeClass.getConstructor(new Class[] {OdfFileDom.class});</span>
<span class="fc" id="L298">      o = ctor.newInstance(new Object[] {dom});</span>
<span class="nc" id="L299">    } catch (Exception cause) {</span>
      // an exception at this point is a bug. Throw an Error
<span class="nc" id="L301">      throw new Error(&quot;ODF DOM error in attribute factory&quot;, cause);</span>
<span class="fc" id="L302">    }</span>
<span class="fc" id="L303">    return o;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>